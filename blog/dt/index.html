<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <link rel="stylesheet" href="/assets/css/basic.css">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>åŠ¨æ€ - å¤¸å…‹åšå®¢</title>
    <link rel="stylesheet" href="/assets/css/dt.css">

    <link rel="icon" href="/assets/img/logo_blue.png" type="image/png">
    <link rel="stylesheet" href="/assets/css/cursor.css">
    <script src="/assets/js/cursor-trail.js"></script>
    <script src="/assets/js/qq-emotion-parser.min.js"></script>
    <link rel="stylesheet" href="/assets/css/nav.css">
    <script src="/assets/js/nav.js"></script>
    <meta name="referrer" content="never">
</head>
<style>
    body {
        background: url('/assets/img/bg.png') no-repeat center center fixed;
        background-size: cover;
    }
</style>

<body>
    <div class="dynamic-container">
        <div class="dynamic-header">
            <h1 class="page-title">åŠ¨æ€ / Life Updates</h1>
        </div>

        <div class="dynamic-layout">
            <!-- ä¾§è¾¹æ ï¼šæœˆå† -->
            <aside class="dynamic-sidebar" id="calendar-sidebar">
                <!-- æœˆå†å†…å®¹ç”±JavaScriptåŠ¨æ€ç”Ÿæˆ -->
            </aside>

            <!-- ä¸»å†…å®¹åŒº -->
            <main class="dynamic-main">
                <div id="dynamic-content"></div>

                <!-- åˆ†é¡µ -->
                <div id="pagination-container" class="pagination-container">
                    <!-- åˆ†é¡µå†…å®¹ç”±JavaScriptåŠ¨æ€ç”Ÿæˆ -->
                </div>
            </main>
        </div>

        <a href="/" class="back-home">â† è¿”å›ä¸»é¡µ</a>
    </div>

    <script src="https://cdn.bootcdn.net/ajax/libs/marked/4.0.0/marked.min.js"></script>

    <script>
        // å…¨å±€å˜é‡
        let allEntries = [];
        let currentPage = 1;
        const entriesPerPage = 10;
        let monthData = {};

        marked.setOptions({
            breaks: true,
            gfm: true
        });

        async function loadDynamic() {
            try {
                const response = await fetch('dt.md');
                const mdContent = await response.text();
                allEntries = parseDynamicEntries(mdContent);

                // åˆ†ææœˆä»½æ•°æ®
                analyzeMonthData();

                // åˆå§‹åŒ–æ˜¾ç¤º
                renderCalendar();
                renderPage(1);
            } catch (error) {
                document.getElementById('dynamic-content').innerHTML = `
            <div class="dynamic-card">
                <h3>åŠ¨æ€åŠ è½½å¤±è´¥</h3>
                <p>${error.message}</p>
            </div>
        `;
            }
        }

        function parseDynamicEntries(content) {
            return content.split(/\n(?=# )/g).map(entry => {
                const [header, ...body] = entry.split('\n');
                const titleMatch = header.match(/^# (.*)/);
                const dateMatch = body.join('\n').match(/## æ—¥æœŸï¼š(.+)/);

                // æå–å›¾ç‰‡URL
                const imageMatches = body.join('\n').match(/!\[.*?\]\((.*?)\)/g);
                const images = imageMatches ? imageMatches.map(img => {
                    const match = img.match(/!\[.*?\]\((.*?)\)/);
                    return match ? match[1] : null;
                }).filter(Boolean) : [];

                // è§£ææ—¥æœŸ
                const dateStr = dateMatch ? dateMatch[1].trim() : '';
                let monthKey = '';
                let year = '';
                let month = '';

                if (dateStr) {
                    const date = new Date(dateStr);
                    if (!isNaN(date.getTime())) {
                        year = date.getFullYear();
                        month = date.getMonth() + 1;
                        monthKey = `${year}-${month.toString().padStart(2, '0')}`;
                    }
                }

                return {
                    title: titleMatch ? titleMatch[1].trim() : 'æœªå‘½ååŠ¨æ€',
                    date: dateStr,
                    year: year,
                    month: month,
                    monthKey: monthKey,
                    content: body.join('\n').replace(/## æ—¥æœŸï¼š.+\n?/, '').trim(),
                    images: images
                };
            }).filter(entry => entry.title);
        }

        // åˆ†ææœˆä»½æ•°æ®
        function analyzeMonthData() {
            monthData = {};

            allEntries.forEach((entry, index) => {
                if (entry.monthKey) {
                    if (!monthData[entry.monthKey]) {
                        monthData[entry.monthKey] = {
                            count: 0,
                            latestIndex: index,
                            year: entry.year,
                            month: entry.month
                        };
                    }
                    monthData[entry.monthKey].count++;

                    // ä¿ç•™æœ€æ–°çš„åŠ¨æ€ç´¢å¼•ï¼ˆå› ä¸ºallEntriesæ˜¯ååºçš„ï¼Œæ‰€ä»¥ç¬¬ä¸€ä¸ªå°±æ˜¯æœ€æ–°çš„ï¼‰
                    monthData[entry.monthKey].latestIndex = index;
                }
            });
        }

        // æ¸²æŸ“æœˆå†
        function renderCalendar() {
            const sidebar = document.getElementById('calendar-sidebar');
            const monthKeys = Object.keys(monthData).sort((a, b) => b.localeCompare(a));

            let calendarHTML = '<div class="calendar-widget">';
            calendarHTML += '<h3 class="calendar-title">ğŸ“… åŠ¨æ€æœˆå†</h3>';
            calendarHTML += '<div class="month-list">';

            if (monthKeys.length === 0) {
                calendarHTML += '<div class="month-item">æš‚æ— åŠ¨æ€</div>';
            } else {
                monthKeys.forEach(key => {
                    const data = monthData[key];
                    const monthNames = ['ä¸€æœˆ', 'äºŒæœˆ', 'ä¸‰æœˆ', 'å››æœˆ', 'äº”æœˆ', 'å…­æœˆ',
                        'ä¸ƒæœˆ', 'å…«æœˆ', 'ä¹æœˆ', 'åæœˆ', 'åä¸€æœˆ', 'åäºŒæœˆ'];
                    const monthName = `${data.year}å¹´ ${monthNames[data.month - 1]}`;

                    calendarHTML += `
                    <a href="javascript:void(0)" class="month-item" data-month-key="${key}">
                        <span class="month-name">${monthName}</span>
                        <span class="month-count">${data.count}</span>
                    </a>
                    `;
                });
            }

            calendarHTML += '</div></div>';
            sidebar.innerHTML = calendarHTML;

            // æ·»åŠ æœˆä»½ç‚¹å‡»äº‹ä»¶
            document.querySelectorAll('.month-item[data-month-key]').forEach(item => {
                item.addEventListener('click', function () {
                    const monthKey = this.getAttribute('data-month-key');
                    jumpToMonth(monthKey);
                });
            });
        }

        // è·³è½¬åˆ°æŒ‡å®šæœˆä»½çš„æœ€æ–°åŠ¨æ€
        function jumpToMonth(monthKey) {
            const data = monthData[monthKey];
            if (!data) return;

            // è®¡ç®—è¯¥åŠ¨æ€æ‰€åœ¨çš„é¡µæ•°
            const entryIndex = data.latestIndex;
            const page = Math.floor(entryIndex / entriesPerPage) + 1;

            // æ»šåŠ¨åˆ°é¡¶éƒ¨
            window.scrollTo({ top: 0, behavior: 'smooth' });

            // æ¸²æŸ“è¯¥é¡µ
            renderPage(page);

            // é«˜äº®å½“å‰æœˆä»½
            document.querySelectorAll('.month-item').forEach(item => {
                item.classList.remove('active');
            });
            document.querySelector(`.month-item[data-month-key="${monthKey}"]`).classList.add('active');
        }

        // æ¸²æŸ“æŒ‡å®šé¡µ
        function renderPage(page) {
            currentPage = page;
            const startIndex = (page - 1) * entriesPerPage;
            const endIndex = Math.min(startIndex + entriesPerPage, allEntries.length);
            const pageEntries = allEntries.slice(startIndex, endIndex);

            renderDynamicEntries(pageEntries);
            renderPagination();
        }

        function renderDynamicEntries(entries) {
            const container = document.getElementById('dynamic-content');
            const emotionParser = new QQEmotionParser();

            container.innerHTML = entries.map((entry, index) => {
                let contentWithoutImages = entry.content.replace(/!\[.*?\]\((.*?)\)/g, '');
                let parsedContent = emotionParser.parse(contentWithoutImages);
                const htmlContent = marked.parse(parsedContent, {
                    breaks: true,
                    gfm: true
                });

                const globalIndex = allEntries.findIndex(e =>
                    e.title === entry.title && e.date === entry.date
                );

                return `
        <div class="dynamic-card" data-entry-index="${globalIndex}">
            <h2 class="dynamic-title">${entry.title}</h2>
            ${entry.date ? `<div class="dynamic-date">ğŸ“… ${entry.date}</div>` : ''}
            <div class="dynamic-content">
                ${htmlContent}
            </div>
            ${entry.images.length > 0 ? renderImageGallery(entry.images, globalIndex) : ''}
        </div>
        `;
            }).join('');

            // åˆå§‹åŒ–æ‰€æœ‰ç”»å»Š
            document.querySelectorAll('.gallery-container').forEach(initGallery);
        }

        // æ¸²æŸ“åˆ†é¡µ
        function renderPagination() {
            const totalPages = Math.ceil(allEntries.length / entriesPerPage);
            const container = document.getElementById('pagination-container');

            if (totalPages <= 1) {
                container.innerHTML = '';
                return;
            }

            let paginationHTML = '<div class="pagination">';

            // ä¸Šä¸€é¡µæŒ‰é’®
            paginationHTML += `
                <button class="page-btn prev-btn" ${currentPage === 1 ? 'disabled' : ''}
                        onclick="changePage(${currentPage - 1})">ä¸Šä¸€é¡µ</button>
            `;

            // é¡µç æŒ‰é’®
            const maxVisible = 5;
            let startPage = Math.max(1, currentPage - Math.floor(maxVisible / 2));
            let endPage = Math.min(totalPages, startPage + maxVisible - 1);

            if (endPage - startPage + 1 < maxVisible) {
                startPage = Math.max(1, endPage - maxVisible + 1);
            }

            if (startPage > 1) {
                paginationHTML += `<button class="page-btn" onclick="changePage(1)">1</button>`;
                if (startPage > 2) {
                    paginationHTML += `<span class="page-btn" style="cursor:default">...</span>`;
                }
            }

            for (let i = startPage; i <= endPage; i++) {
                paginationHTML += `
                    <button class="page-btn ${i === currentPage ? 'active' : ''}" 
                            onclick="changePage(${i})">${i}</button>
                `;
            }

            if (endPage < totalPages) {
                if (endPage < totalPages - 1) {
                    paginationHTML += `<span class="page-btn" style="cursor:default">...</span>`;
                }
                paginationHTML += `<button class="page-btn" onclick="changePage(${totalPages})">${totalPages}</button>`;
            }

            // ä¸‹ä¸€é¡µæŒ‰é’®
            paginationHTML += `
                <button class="page-btn next-btn" ${currentPage === totalPages ? 'disabled' : ''}
                        onclick="changePage(${currentPage + 1})">ä¸‹ä¸€é¡µ</button>
            `;

            paginationHTML += '</div>';

            // æ·»åŠ é¡µé¢ä¿¡æ¯
            const startEntry = (currentPage - 1) * entriesPerPage + 1;
            const endEntry = Math.min(currentPage * entriesPerPage, allEntries.length);
            paginationHTML += `
                <div class="page-info">
                    æ˜¾ç¤º ${startEntry}-${endEntry} æ¡ï¼Œå…± ${allEntries.length} æ¡åŠ¨æ€
                </div>
            `;

            container.innerHTML = paginationHTML;
        }

        // åˆ‡æ¢é¡µé¢
        function changePage(page) {
            if (page < 1 || page > Math.ceil(allEntries.length / entriesPerPage)) return;

            // æ»šåŠ¨åˆ°é¡¶éƒ¨
            window.scrollTo({ top: 0, behavior: 'smooth' });

            // æ¸²æŸ“æ–°é¡µé¢
            renderPage(page);
        }

        // ä»¥ä¸‹ä¸ºåŸæœ‰çš„å›¾ç‰‡ç”»å»Šç›¸å…³å‡½æ•°ï¼Œä¿æŒä¸å˜
        function renderImageGallery(images, entryIndex) {
            const totalImages = images.length;
            let colsPerRow;

            if (totalImages <= 4) {
                colsPerRow = 2;
            } else {
                colsPerRow = 3;
            }

            const rows = Math.ceil(totalImages / colsPerRow);

            let galleryHTML = '<div class="gallery-container">';

            for (let row = 0; row < rows; row++) {
                galleryHTML += '<div class="gallery-row">';
                const startIdx = row * colsPerRow;
                const endIdx = Math.min(startIdx + colsPerRow, totalImages);

                for (let i = startIdx; i < endIdx; i++) {
                    galleryHTML += `
                <div class="gallery-item" data-entry-index="${entryIndex}" data-img-index="${i}">
                    <img src="${images[i]}" 
                         alt="åŠ¨æ€å›¾ç‰‡" 
                         loading="lazy"
                         onclick="openGallery(${entryIndex}, ${i})">
                </div>
            `;
                }
                galleryHTML += '</div>';
            }

            galleryHTML += '</div>';
            return galleryHTML;
        }

        function initGallery(container) {
            // åˆå§‹åŒ–é€»è¾‘
        }

        function openGallery(entryIndex, imgIndex) {
            const entry = document.querySelector(`[data-entry-index="${entryIndex}"]`);
            const images = entry.querySelectorAll('.gallery-item img');
            const imageUrls = Array.from(images).map(img => img.src);

            const modal = document.createElement('div');
            modal.className = 'gallery-modal';
            modal.innerHTML = `
        <div class="gallery-modal-content">
            <span class="close-btn" onclick="closeGallery()">&times;</span>
            <div class="gallery-modal-main">
                <img src="${imageUrls[imgIndex]}" class="current-image" alt="å…¨å±å›¾ç‰‡">
                <div class="gallery-nav">
                    ${imgIndex > 0 ? `<button class="nav-btn prev-btn" onclick="changeImage(${imgIndex - 1}, ${entryIndex})">â®</button>` : ''}
                    <span class="image-counter">${imgIndex + 1} / ${imageUrls.length}</span>
                    ${imgIndex < imageUrls.length - 1 ? `<button class="nav-btn next-btn" onclick="changeImage(${imgIndex + 1}, ${entryIndex})">â¯</button>` : ''}
                </div>
            </div>
            <div class="gallery-thumbnails">
                ${imageUrls.map((url, index) => `
                    <img src="${url}" 
                         class="thumbnail ${index === imgIndex ? 'active' : ''}" 
                         onclick="changeImage(${index}, ${entryIndex})"
                         alt="ç¼©ç•¥å›¾ ${index + 1}">
                `).join('')}
            </div>
        </div>
    `;

            document.body.appendChild(modal);
            document.body.style.overflow = 'hidden';
        }

        function closeGallery() {
            const modal = document.querySelector('.gallery-modal');
            if (modal) {
                modal.remove();
                document.body.style.overflow = 'auto';
            }
        }

        function changeImage(newIndex, entryIndex) {
            const entry = document.querySelector(`[data-entry-index="${entryIndex}"]`);
            const images = entry.querySelectorAll('.gallery-item img');
            const imageUrls = Array.from(images).map(img => img.src);

            if (newIndex >= 0 && newIndex < imageUrls.length) {
                const modal = document.querySelector('.gallery-modal');
                if (modal) {
                    modal.querySelector('.current-image').src = imageUrls[newIndex];
                    modal.querySelector('.image-counter').textContent = `${newIndex + 1} / ${imageUrls.length}`;

                    modal.querySelectorAll('.thumbnail').forEach((thumb, index) => {
                        thumb.classList.toggle('active', index === newIndex);
                    });

                    const prevBtn = modal.querySelector('.prev-btn');
                    const nextBtn = modal.querySelector('.next-btn');

                    if (prevBtn) {
                        prevBtn.onclick = () => changeImage(newIndex - 1, entryIndex);
                        prevBtn.style.visibility = newIndex > 0 ? 'visible' : 'hidden';
                    }

                    if (nextBtn) {
                        nextBtn.onclick = () => changeImage(newIndex + 1, entryIndex);
                        nextBtn.style.visibility = newIndex < imageUrls.length - 1 ? 'visible' : 'hidden';
                    }
                }
            }
        }

        // æ·»åŠ ESCé”®å…³é—­åŠŸèƒ½
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') {
                closeGallery();
            }
        });

        loadDynamic();
    </script>
    <script src="/assets/js/disable-right-click.js"></script>
</body>

</html>
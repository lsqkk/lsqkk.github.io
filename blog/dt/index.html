<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <link rel="stylesheet" href="/assets/css/basic.css">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>åŠ¨æ€ - å¤¸å…‹åšå®¢</title>
    <link rel="stylesheet" href="/assets/css/dt.css">

    <link rel="icon" href="/assets/img/logo_blue.png" type="image/png">
    <link rel="stylesheet" href="/assets/css/cursor.css">
    <script src="/assets/js/cursor-trail.js"></script>
    <script src="/assets/js/qq-emotion-parser.min.js"></script>
    <link rel="stylesheet" href="/assets/css/nav.css">
    <script src="/assets/js/nav.js"></script>
    <meta name="referrer" content="never">
</head>
<style>
    body {
        background: url('/assets/img/bg.png') no-repeat center center fixed;
        background-size: cover;
    }
</style>

<body>
    <div class="dynamic-container">
        <div class="dynamic-header">
            <h1 class="page-title">åŠ¨æ€ / Life Updates</h1>
        </div>
        <div id="dynamic-content"></div>
        <a href="/" class="back-home">â† è¿”å›ä¸»é¡µ</a>
    </div>

    <script src="https://cdn.bootcdn.net/ajax/libs/marked/4.0.0/marked.min.js"></script>

    <script>
        marked.setOptions({
            breaks: true,
            gfm: true
        });

        async function loadDynamic() {
            try {
                const response = await fetch('dt.md');
                const mdContent = await response.text();
                const entries = parseDynamicEntries(mdContent);
                renderDynamicEntries(entries);
            } catch (error) {
                document.getElementById('dynamic-content').innerHTML = `
            <div class="dynamic-card">
                <h3>åŠ¨æ€åŠ è½½å¤±è´¥</h3>
                <p>${error.message}</p>
            </div>
        `;
            }
        }

        function parseDynamicEntries(content) {
            // ä½¿ç”¨æ­£åˆ™è¡¨è¾¾å¼åœ¨#å‰åˆ†å‰²ï¼ˆæ­£å‘å…ˆè¡Œæ–­è¨€ï¼‰
            return content.split(/\n(?=# )/g).map(entry => {
                const [header, ...body] = entry.split('\n');
                const titleMatch = header.match(/^# (.*)/);
                const dateMatch = body.join('\n').match(/## æ—¥æœŸï¼š(.+)/);

                // æå–å›¾ç‰‡URL
                const imageMatches = body.join('\n').match(/!\[.*?\]\((.*?)\)/g);
                const images = imageMatches ? imageMatches.map(img => {
                    const match = img.match(/!\[.*?\]\((.*?)\)/);
                    return match ? match[1] : null;
                }).filter(Boolean) : [];

                return {
                    title: titleMatch ? titleMatch[1].trim() : 'æœªå‘½ååŠ¨æ€',
                    date: dateMatch ? dateMatch[1].trim() : '',
                    content: body.join('\n').replace(/## æ—¥æœŸï¼š.+\n?/, '').trim(),
                    images: images
                };
            }).filter(entry => entry.title).reverse();
        }

        function renderDynamicEntries(entries) {
            const container = document.getElementById('dynamic-content');

            // åˆ›å»ºQQè¡¨æƒ…è§£æå™¨å®ä¾‹
            const emotionParser = new QQEmotionParser();

            container.innerHTML = entries.map((entry, index) => {
                // å…ˆç§»é™¤markdownå›¾ç‰‡è¯­æ³•ï¼Œé¿å…å½±å“è¡¨æƒ…è§£æ
                let contentWithoutImages = entry.content.replace(/!\[.*?\]\((.*?)\)/g, '');

                // è§£æè¡¨æƒ…ä»£ç ä¸ºHTML
                let parsedContent = emotionParser.parse(contentWithoutImages);

                // ä½¿ç”¨markedè§£æå‰©ä½™çš„markdownï¼ˆç°åœ¨ä¸åŒ…å«å›¾ç‰‡å’Œè¡¨æƒ…ä»£ç ï¼‰
                // æ³¨æ„ï¼šmarkedä¼šå¤„ç†markdownè¯­æ³•ï¼Œä½†è¡¨æƒ…å·²ç»æ˜¯HTMLäº†ï¼Œæ‰€ä»¥éœ€è¦ç¡®ä¿markedä¸è½¬ä¹‰HTML
                const htmlContent = marked.parse(parsedContent, {
                    breaks: true,  // å¯ç”¨æ¢è¡Œç¬¦è½¬æ¢ä¸º<br>
                    gfm: true      // å¯ç”¨GitHubé£æ ¼çš„Markdown
                });

                return `
        <div class="dynamic-card" data-entry-index="${index}">
            <h2 class="dynamic-title">${entry.title}</h2>
            ${entry.date ? `<div class="dynamic-date">ğŸ“… ${entry.date}</div>` : ''}
            <div class="dynamic-content">
                ${htmlContent}
            </div>
            ${entry.images.length > 0 ? renderImageGallery(entry.images, index) : ''}
        </div>
        `;
            }).join('');

            // åˆå§‹åŒ–æ‰€æœ‰ç”»å»Š
            document.querySelectorAll('.gallery-container').forEach(initGallery);
        }

        function renderImageGallery(images, entryIndex) {
            const totalImages = images.length;
            let colsPerRow;

            if (totalImages <= 4) {
                colsPerRow = 2; // 1-4å¼ å›¾ç‰‡ï¼Œæ¯è¡Œ2ä¸ª
            } else {
                colsPerRow = 3; // å¤§äº4å¼ å›¾ç‰‡ï¼Œæ¯è¡Œ3ä¸ª
            }

            // è®¡ç®—éœ€è¦å¤šå°‘è¡Œ
            const rows = Math.ceil(totalImages / colsPerRow);

            let galleryHTML = '<div class="gallery-container">';

            for (let row = 0; row < rows; row++) {
                galleryHTML += '<div class="gallery-row">';
                const startIdx = row * colsPerRow;
                const endIdx = Math.min(startIdx + colsPerRow, totalImages);

                for (let i = startIdx; i < endIdx; i++) {
                    galleryHTML += `
                <div class="gallery-item" data-entry-index="${entryIndex}" data-img-index="${i}">
                    <img src="${images[i]}" 
                         alt="åŠ¨æ€å›¾ç‰‡" 
                         loading="lazy"
                         onclick="openGallery(${entryIndex}, ${i})">
                </div>
            `;
                }
                galleryHTML += '</div>';
            }

            galleryHTML += '</div>';
            return galleryHTML;
        }

        function initGallery(container) {
            // è¿™é‡Œå¯ä»¥æ·»åŠ ç”»å»Šçš„åˆå§‹åŒ–é€»è¾‘
            // ä¾‹å¦‚ï¼šå›¾ç‰‡æ‡’åŠ è½½ã€ç‚¹å‡»äº‹ä»¶ç­‰
        }

        function openGallery(entryIndex, imgIndex) {
            const entry = document.querySelector(`[data-entry-index="${entryIndex}"]`);
            const images = entry.querySelectorAll('.gallery-item img');
            const imageUrls = Array.from(images).map(img => img.src);

            // åˆ›å»ºç”»å»Šæ¨¡æ€æ¡†
            const modal = document.createElement('div');
            modal.className = 'gallery-modal';
            modal.innerHTML = `
        <div class="gallery-modal-content">
            <span class="close-btn" onclick="closeGallery()">&times;</span>
            <div class="gallery-modal-main">
                <img src="${imageUrls[imgIndex]}" class="current-image" alt="å…¨å±å›¾ç‰‡">
                <div class="gallery-nav">
                    ${imgIndex > 0 ? `<button class="nav-btn prev-btn" onclick="changeImage(${imgIndex - 1}, ${entryIndex})">â®</button>` : ''}
                    <span class="image-counter">${imgIndex + 1} / ${imageUrls.length}</span>
                    ${imgIndex < imageUrls.length - 1 ? `<button class="nav-btn next-btn" onclick="changeImage(${imgIndex + 1}, ${entryIndex})">â¯</button>` : ''}
                </div>
            </div>
            <div class="gallery-thumbnails">
                ${imageUrls.map((url, index) => `
                    <img src="${url}" 
                         class="thumbnail ${index === imgIndex ? 'active' : ''}" 
                         onclick="changeImage(${index}, ${entryIndex})"
                         alt="ç¼©ç•¥å›¾ ${index + 1}">
                `).join('')}
            </div>
        </div>
    `;

            document.body.appendChild(modal);
            document.body.style.overflow = 'hidden'; // é˜²æ­¢èƒŒæ™¯æ»šåŠ¨
        }

        function closeGallery() {
            const modal = document.querySelector('.gallery-modal');
            if (modal) {
                modal.remove();
                document.body.style.overflow = 'auto';
            }
        }

        function changeImage(newIndex, entryIndex) {
            const entry = document.querySelector(`[data-entry-index="${entryIndex}"]`);
            const images = entry.querySelectorAll('.gallery-item img');
            const imageUrls = Array.from(images).map(img => img.src);

            if (newIndex >= 0 && newIndex < imageUrls.length) {
                const modal = document.querySelector('.gallery-modal');
                if (modal) {
                    // æ›´æ–°ä¸»å›¾
                    modal.querySelector('.current-image').src = imageUrls[newIndex];

                    // æ›´æ–°è®¡æ•°å™¨
                    modal.querySelector('.image-counter').textContent = `${newIndex + 1} / ${imageUrls.length}`;

                    // æ›´æ–°ç¼©ç•¥å›¾æ¿€æ´»çŠ¶æ€
                    modal.querySelectorAll('.thumbnail').forEach((thumb, index) => {
                        thumb.classList.toggle('active', index === newIndex);
                    });

                    // æ›´æ–°å¯¼èˆªæŒ‰é’®
                    const prevBtn = modal.querySelector('.prev-btn');
                    const nextBtn = modal.querySelector('.next-btn');

                    if (prevBtn) {
                        prevBtn.onclick = () => changeImage(newIndex - 1, entryIndex);
                        prevBtn.style.visibility = newIndex > 0 ? 'visible' : 'hidden';
                    }

                    if (nextBtn) {
                        nextBtn.onclick = () => changeImage(newIndex + 1, entryIndex);
                        nextBtn.style.visibility = newIndex < imageUrls.length - 1 ? 'visible' : 'hidden';
                    }
                }
            }
        }

        // æ·»åŠ ESCé”®å…³é—­åŠŸèƒ½
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') {
                closeGallery();
            }
        });
        loadDynamic();
    </script>
    <script src="/assets/js/disable-right-click.js"></script>
</body>

</html>
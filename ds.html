<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>DeepSeek - 夸克博客</title>
  <style>
    /* 基础样式 */
    *{margin:0;padding:0;box-sizing:border-box}body{font-family:Arial,sans-serif;background:linear-gradient(135deg,#1e1e2f,#2a2a40);margin:0;color:#fff;overflow-x:hidden}

    #main-container{display:flex;max-width:1200px;margin:0 auto;height:100vh}

    /* 左侧栏样式 */
    #sidebar{
      width:250px;
      background:rgba(0,0,0,0.3);
      border-right:1px solid rgba(255,255,255,0.1);
      padding:20px;
      transition:transform 0.3s ease;
      overflow-y:auto;
      display:flex;flex-direction:column}
    #sidebar.collapsed{transform:translateX(-100%);width:60px}
    #sidebar-toggle{position:absolute;right:-30px;top:20px;background:none;border:none;color:#fff;font-size:24px;cursor:pointer;z-index:100;display:block}
    #sidebar-header{margin-bottom:20px;padding-bottom:10px;border-bottom:1px solid rgba(255,255,255,0.1)}
    #history-list{flex:1;overflow-y:auto;max-height:calc(100vh - 200px)}
    .history-item{padding:10px;border-radius:8px;margin-bottom:10px;background:rgba(255,255,255,0.1);cursor:pointer;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
    .history-item:hover{background:rgba(255,255,255,0.2)}
    #new-chat-btn{margin-top:15px;padding:10px;width:100%;background:linear-gradient(135deg,#007bff,#0056b3);color:#fff;border:none;border-radius:8px;cursor:pointer}
    @media(max-width:768px){#sidebar:not(.collapsed){transform:translateX(0);position:absolute;top:0;left:0;bottom:0;z-index:1000}}

    /* 右侧主内容区样式 */
    #chat-container{flex:1;margin:20px;padding:20px;background:rgba(255,255,255,0.1);border-radius:16px;backdrop-filter:blur(10px);box-shadow:0 4px 30px rgba(0,0,0,0.1);display:flex;flex-direction:column;height:100%}
    h1{margin-bottom:20px;font-size:24px;color:#fff}
    #chat-history{flex:1;overflow-y:auto;border:1px solid rgba(255,255,255,0.1);border-radius:12px;padding:15px;margin-bottom:15px;background:rgba(255,255,255,0.05);max-height:calc(100vh - 200px)}
    .user-msg,.bot-msg{margin:10px 0;padding:12px;border-radius:12px;position:relative}
    .user-msg{background:rgba(0,123,255,0.1);color:#007bff;margin-left:25%;text-align:right}
    .bot-msg{background:rgba(255,255,255,0.1);color:#fff;margin-right:25%}
    .think-content{margin-top:10px;padding:10px;background:rgba(255,255,255,0.05);border-radius:8px;border-left:3px solid #007bff;color:#aaa;font-size:0.9em;margin-left:10px;margin-right:10px}
    .copy-btn{position:absolute;right:10px;bottom:10px;background:rgba(255,255,255,0.1);border:none;color:#fff;padding:4px 8px;border-radius:4px;cursor:pointer}
    .copy-btn:hover{background:rgba(255,255,255,0.2)}
    .input-container{display:flex;gap:10px;margin-top:auto}
    #model-selector{padding:10px;border:1px solid rgba(255,255,255,0.1);border-radius:8px;background:rgba(255,255,255,0.05);color:#fff}
    #user-input{flex:1;padding:10px;border:1px solid rgba(255,255,255,0.1);border-radius:8px;background:rgba(255,255,255,0.05);color:#fff}
    #send-btn{padding:10px 20px;background:linear-gradient(135deg,#007bff,#0056b3);color:#fff;border:none;border-radius:8px;cursor:pointer}
    #send-btn:hover{background:linear-gradient(135deg,#0056b3,#003d80)}
    .loading{color:#666;font-style:italic}
    .error{color:#ff0000;font-weight:bold}
       .thinking-container {
      margin: 10px 0;
      padding: 12px;
      background: rgba(255,255,255,0.05);
      border-radius: 8px;
      border-left: 3px solid #007bff;
      color: #aaa;
    }
  </style>
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>
</head>
<body>
  <div id="main-container">
    <!-- 左侧栏 -->
    <div id="sidebar">
      <button id="sidebar-toggle">></button>
      <div id="sidebar-header">
        <h2>会话管理</h2>
      </div>
      <div id="history-list"></div>
      <button id="new-chat-btn">新建会话</button>
    </div>

    <!-- 右侧主内容区 -->
    <div id="chat-container">
      <h1>DeepSeek-R1 (夸克博客满血版)</h1>
      <div id="chat-history">
        <div class="bot-msg">你好！我是 DeepSeek，请问有什么可以帮您？</div>
      </div>
      <div class="input-container">
        <select id="model-selector">
          <option value="deepseek-reasoner">R1 模型</option>
          <option value="deepseek-chat">V3 模型</option>
        </select>
        <input type="text" id="user-input" placeholder="输入你的问题...">
        <button id="send-btn" onclick="sendMessage()">发送</button>
      </div>
    </div>
  </div>

<script>
  // 配置
  const WORKER_URL = 'https://deepseek-proxy.jsxzznz.workers.dev';
  const CORRECT_PASSWORD_HASH = "fc5e038d38a57032085441e7fe7010b0";
  let currentChatId = null;
  let buffer = ""; // 新增缓冲区用于处理数据分片

  // 密码验证部分保持不变
  window.onload = function () {
    const password = prompt("请输入密码：");
    if (!password) {
      alert("密码不能为空！");
      disablePage();
      return;
    }

    const hashedPassword = CryptoJS.MD5(password).toString();
    if (hashedPassword !== CORRECT_PASSWORD_HASH) {
      alert("密码错误！");
      disablePage();
    } else {
      loadHistoryList();
    }
  };

  // 禁用页面功能（保持不变）
  function disablePage() {
    const input = document.getElementById('user-input');
    const sendBtn = document.getElementById('send-btn');
    input.disabled = true;
    sendBtn.disabled = true;
    document.getElementById('chat-container').innerHTML += '<div class="error">密码错误，无法使用该页面。</div>';
  }

  // 会话管理部分保持不变
  document.getElementById('new-chat-btn').addEventListener('click', function() {
    if (confirm('确定要创建新会话吗？当前会话将会保存。')) {
      createNewChat();
    }
  });

  // 历史记录加载（保持不变）
  function loadHistoryList() {
    const historyList = document.getElementById('history-list');
    historyList.innerHTML = '';
    const savedChats = JSON.parse(localStorage.getItem('deepseekChats') || '[]');
    
    if (savedChats.length === 0) {
      historyList.innerHTML = '<div style="text-align:center;padding:20px;color:#aaa">暂无历史会话</div>';
      currentChatId = null;
      return;
    }

    savedChats.forEach((chat, index) => {
      const userMessage = chat.messages.find(m => m.role === 'user');
      const title = userMessage ? userMessage.content.substring(0, 6) : '新会话';
      
      const historyItem = document.createElement('div');
      historyItem.className = 'history-item';
      historyItem.textContent = title;
      historyItem.onclick = () => loadChat(index);
      historyList.appendChild(historyItem);
    });

    currentChatId = savedChats.length - 1;
  }

  // 新会话创建（保持不变）
  function createNewChat() {
    saveCurrentChat();
    currentChatId = null;
    const chatHistory = document.getElementById('chat-history');
    chatHistory.innerHTML = '<div class="bot-msg">你好！我是 DeepSeek，请问有什么可以帮您？</div>';
    chatHistory.scrollTop = chatHistory.scrollHeight;
  }

  // 保存会话（保持不变）
  function saveCurrentChat() {
    const chatHistory = document.getElementById('chat-history');
    const messages = [];
    const allMessages = chatHistory.querySelectorAll('.user-msg, .bot-msg');

    Array.from(allMessages).forEach(msg => {
      if (msg.classList.contains('error') || msg.classList.contains('loading')) return;
      messages.push({
        role: msg.classList.contains('user-msg') ? 'user' : 'assistant',
        content: msg.textContent.trim()
      });
    });

    if (messages.length > 0) {
      const savedChats = JSON.parse(localStorage.getItem('deepseekChats') || '[]');
      
      if (currentChatId !== null && savedChats[currentChatId]) {
        savedChats[currentChatId].messages = messages;
      } else {
        savedChats.push({ messages });
        currentChatId = savedChats.length - 1;
      }
      
      localStorage.setItem('deepseekChats', JSON.stringify(savedChats));
      loadHistoryList();
    }
  }

  // 加载会话（增加Markdown解析）
  function loadChat(index) {
    const savedChats = JSON.parse(localStorage.getItem('deepseekChats') || '[]');
    if (index >= 0 && index < savedChats.length) {
      currentChatId = index;
      const chatHistory = document.getElementById('chat-history');
      chatHistory.innerHTML = '';
      const chat = savedChats[index];
      chat.messages.forEach(msg => {
        const div = document.createElement('div');
        div.className = msg.role === 'user' ? 'user-msg' : 'bot-msg';
        div.innerHTML = `<div class="markdown-content">${marked.parse(msg.content)}</div>`; // 增加Markdown解析
        chatHistory.appendChild(div);
      });
      chatHistory.scrollTop = chatHistory.scrollHeight;
    }
  }

  // 核心修改部分：消息发送处理
  async function sendMessage() {
    const input = document.getElementById('user-input');
    const historyDiv = document.getElementById('chat-history');
    const sendBtn = document.getElementById('send-btn');
    const modelSelector = document.getElementById('model-selector');

    sendBtn.disabled = true;
    const userMessage = input.value.trim();
    if (!userMessage) {
      sendBtn.disabled = false;
      return;
    }
    
    // 添加用户消息
    const userMsgDiv = document.createElement('div');
    userMsgDiv.className = 'user-msg';
    userMsgDiv.textContent = userMessage;
    historyDiv.appendChild(userMsgDiv);

    // 创建双容器结构
    const thinkingContainer = document.createElement('div');
    thinkingContainer.className = 'thinking-container';
    const botMsgDiv = document.createElement('div');
    botMsgDiv.className = 'bot-msg';
    
    // 思考过程容器
    const thinkingHeader = document.createElement('h4');
    thinkingHeader.textContent = 'DeepSeek-R1 深度思考中...';
    const thinkingContent = document.createElement('div');
    thinkingContent.style.color = '#aaa';
    thinkingContainer.appendChild(thinkingHeader);
    thinkingContainer.appendChild(thinkingContent);
    
    // 正式回答容器
    const answerContent = document.createElement('div');
    answerContent.className = 'markdown-content';
    botMsgDiv.appendChild(answerContent);
    
    historyDiv.appendChild(thinkingContainer);
    historyDiv.appendChild(botMsgDiv);
    historyDiv.scrollTop = historyDiv.scrollHeight;

    try {
      const payload = {
        model: modelSelector.value,
        messages: [{ role: "user", content: userMessage }],
        stream: true
      };

      const response = await fetch(WORKER_URL, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(payload)
      });

      const reader = response.body.getReader();
      const decoder = new TextDecoder();
      buffer = ""; // 重置缓冲区
      let isThinkingRendered = false;

      while (true) {
        const { done, value } = await reader.read();
        if (done) break;

        buffer += decoder.decode(value, { stream: true });
        const lines = buffer.split('\n');
        buffer = lines.pop() || "";

        for (const line of lines) {
          if (!line.startsWith('data:')) continue;
          const jsonStr = line.slice(5).trim();
          if (jsonStr === '[DONE]') continue;

          try {
            const data = JSON.parse(jsonStr);
            const content = data.choices[0]?.delta?.content || "";

            if (content) {
              // 处理可能的分片标记
              if (content.includes('</think>')) {
                const [thinkPart, answerPart] = content.split('</think>');
                thinkingContent.innerHTML += marked.parse(thinkPart);
                answerContent.innerHTML += marked.parse(answerPart);
                isThinkingRendered = true;
              } else if (isThinkingRendered) {
                answerContent.innerHTML += marked.parse(content);
              } else {
                thinkingContent.innerHTML += marked.parse(content);
              }

              // 自动滚动
              historyDiv.scrollTop = historyDiv.scrollHeight;
            }
          } catch (err) {
            console.error('JSON解析错误:', err);
          }
        }
      }

      // 处理剩余缓冲区内容
      if (buffer) {
        if (buffer.includes('</sy_think>')) {
          const [thinkPart, answerPart] = buffer.split('</sy_think>');
          thinkingContent.innerHTML += marked.parse(thinkPart);
          answerContent.innerHTML += marked.parse(answerPart);
        } else if (isThinkingRendered) {
          answerContent.innerHTML += marked.parse(buffer);
        } else {
          thinkingContent.innerHTML += marked.parse(buffer);
        }
      }

      // 添加复制按钮
      const copyButton = document.createElement('button');
      copyButton.className = 'copy-btn';
      copyButton.innerText = '复制';
      copyButton.onclick = () => {
        navigator.clipboard.writeText(answerContent.textContent);
        copyButton.innerText = '已复制';
        setTimeout(() => copyButton.innerText = '复制', 2000);
      };
      botMsgDiv.appendChild(copyButton);

    } catch (err) {
      const errDiv = document.createElement('div');
      errDiv.className = 'error';
      errDiv.textContent = `错误：${err.message}`;
      historyDiv.appendChild(errDiv);
    } finally {
      input.value = '';
      sendBtn.disabled = false;
      historyDiv.scrollTop = historyDiv.scrollHeight;
      saveCurrentChat();
      // 移除思考容器（保留正式回答）
      thinkingContainer.remove();
    }
  }

  // 侧边栏切换（保持不变）
  document.getElementById('sidebar-toggle').addEventListener('click', function() {
    const sidebar = document.getElementById('sidebar');
    sidebar.classList.toggle('collapsed');
    this.textContent = sidebar.classList.contains('collapsed') ? '<' : '>';
  });

  // 响应式处理（保持不变）
  window.addEventListener('resize', function() {
    if (window.innerWidth <= 768) {
      document.getElementById('sidebar').classList.add('collapsed');
      document.getElementById('sidebar-toggle').textContent = '<';
    }
  });
  
  if (window.innerWidth <= 768) {
    document.getElementById('sidebar').classList.add('collapsed');
    document.getElementById('sidebar-toggle').textContent = '<';
  }
</script>
</html>

<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>DeepSeek - å¤¸å…‹åšå®¢</title>
  <style>
    :root {
      --bg-color: #f5f5f5;
      --text-color: #333;
      --primary-color: #007bff;
      --sidebar-bg: #ffffff;
      --chat-bg: #ffffff;
      --msg-bg: #f0f0f0;
      --user-msg-bg: #e3f2fd;
      --bot-msg-bg: #f5f5f5;
      --input-bg: #ffffff;
      --border-color: #e0e0e0;
    }

    .dark-mode {
      --bg-color: #1e1e2f;
      --text-color: #ffffff;
      --primary-color: #007bff;
      --sidebar-bg: #2a2a40;
      --chat-bg: rgba(255, 255, 255, 0.1);
      --msg-bg: rgba(255, 255, 255, 0.1);
      --user-msg-bg: rgba(0, 123, 255, 0.1);
      --bot-msg-bg: rgba(255, 255, 255, 0.1);
      --input-bg: rgba(255, 255, 255, 0.05);
      --border-color: rgba(255, 255, 255, 0.1);
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: Arial, sans-serif;
      background: var(--bg-color);
      color: var(--text-color);
      transition: background 0.3s, color 0.3s;
    }

    #main-container {
      display: flex;
      max-width: 1200px;
      margin: 0 auto;
      height: 100vh;
      overflow: hidden;
    }

    /* å·¦ä¾§æ æ ·å¼ */
    #sidebar {
      width: 280px;
      min-width: 280px;
      background: var(--sidebar-bg);
      border-right: 1px solid var(--border-color);
      padding: 20px;
      transition: transform 0.3s ease;
      overflow-y: auto;
      display: flex;
      flex-direction: column;
      position: relative;
      z-index: 100;
    }

    #sidebar.collapsed {
      transform: translateX(-100%);
      position: absolute;
      height: 100%;
    }

    #sidebar-toggle {
      position: absolute;
      right: -40px;
      top: 20px;
      background: var(--primary-color);
      border: none;
      color: #fff;
      width: 32px;
      height: 32px;
      border-radius: 0 4px 4px 0;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 101;
    }

    #sidebar-header {
      margin-bottom: 20px;
      padding-bottom: 10px;
      border-bottom: 1px solid var(--border-color);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    #theme-toggle {
      background: none;
      border: none;
      color: var(--text-color);
      cursor: pointer;
      font-size: 20px;
    }

    #history-list {
      flex: 1;
      overflow-y: auto;
    }

    .history-section {
      margin-bottom: 15px;
    }

    .section-title {
      font-size: 0.9em;
      color: var(--text-color);
      opacity: 0.7;
      margin-bottom: 8px;
      padding-left: 5px;
    }

    .history-item {
      padding: 10px;
      border-radius: 8px;
      margin-bottom: 5px;
      background: var(--msg-bg);
      cursor: pointer;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      position: relative;
      padding-right: 40px;
      transition: background 0.2s;
    }

    .history-item:hover {
      background: var(--primary-color);
      color: #fff;
    }

    .history-item.active {
      background: var(--primary-color);
      color: #fff;
    }

    .history-item-actions {
      position: absolute;
      right: 5px;
      top: 50%;
      transform: translateY(-50%);
      display: none;
    }

    .history-item:hover .history-item-actions {
      display: flex;
      gap: 5px;
    }

    .history-item-btn {
      background: none;
      border: none;
      color: inherit;
      cursor: pointer;
      font-size: 12px;
      opacity: 0.7;
    }

    .history-item-btn:hover {
      opacity: 1;
    }

    #new-chat-btn {
      margin-top: 15px;
      padding: 10px;
      width: 100%;
      background: var(--primary-color);
      color: #fff;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      transition: opacity 0.2s;
    }

    #new-chat-btn:hover {
      opacity: 0.9;
    }

    /* å³ä¾§ä¸»å†…å®¹åŒºæ ·å¼ */
    #chat-container {
      flex: 1;
      margin: 0;
      padding: 20px;
      background: var(--chat-bg);
      display: flex;
      flex-direction: column;
      height: 100vh;
      position: relative;
    }

    #chat-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
      padding-bottom: 10px;
      border-bottom: 1px solid var(--border-color);
    }

    #model-controls {
      display: flex;
      gap: 10px;
      align-items: center;
    }

    #chat-history {
      flex: 1;
      overflow-y: auto;
      padding: 10px 0;
    }

    /* éšè—æ»šåŠ¨æ¡ä½†ä¿æŒæ»šåŠ¨åŠŸèƒ½ */
    #chat-history::-webkit-scrollbar,
    #history-list::-webkit-scrollbar {
      width: 6px;
      height: 6px;
    }

    #chat-history::-webkit-scrollbar-thumb,
    #history-list::-webkit-scrollbar-thumb {
      background: rgba(0, 0, 0, 0.2);
      border-radius: 3px;
    }

    .user-msg, .bot-msg {
      margin: 10px 0;
      padding: 12px 16px;
      border-radius: 12px;
      position: relative;
      max-width: 85%;
      word-wrap: break-word;
    }

    .user-msg {
      background: var(--user-msg-bg);
      color: var(--primary-color);
      margin-left: auto;
      text-align: right;
    }

    .bot-msg {
      background: var(--bot-msg-bg);
      margin-right: auto;
    }

    .copy-btn {
      position: absolute;
      right: 12px;
      bottom: 12px;
      background: rgba(0, 0, 0, 0.1);
      padding: 2px 8px;
      border-radius: 4px;
      border: none;
      color: inherit;
      cursor: pointer;
      font-size: 12px;
      opacity: 0;
      transition: opacity 0.2s;
    }

    .bot-msg:hover .copy-btn,
    .user-msg:hover .copy-btn {
      opacity: 1;
    }

    .copy-btn:hover {
      background: rgba(0, 0, 0, 0.2);
    }

    /* è¾“å…¥åŒºåŸŸæ ·å¼ */
    #input-area {
      display: flex;
      flex-direction: column;
      gap: 10px;
      margin-top: auto;
      padding-top: 15px;
      border-top: 1px solid var(--border-color);
    }

    #input-controls {
      display: flex;
      gap: 10px;
    }

    #file-buttons {
      display: flex;
      gap: 5px;
    }

    .file-btn {
      padding: 8px 12px;
      background: var(--msg-bg);
      border: none;
      border-radius: 8px;
      color: var(--text-color);
      cursor: pointer;
      font-size: 14px;
      display: flex;
      align-items: center;
      gap: 5px;
    }

    .file-btn:hover {
      background: var(--primary-color);
      color: #fff;
    }

    #user-input {
      flex: 1;
      padding: 12px 16px;
      border: 1px solid var(--border-color);
      border-radius: 8px;
      background: var(--input-bg);
      color: var(--text-color);
      font-size: 16px;
      resize: none;
      min-height: 50px;
      max-height: 150px;
    }

    #user-input:focus {
      outline: none;
      border-color: var(--primary-color);
    }

    #send-btn {
      padding: 0 20px;
      background: var(--primary-color);
      color: #fff;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-weight: bold;
      transition: opacity 0.2s;
      height: 50px;
    }

    #send-btn:hover {
      opacity: 0.9;
    }

    .loading {
      color: var(--text-color);
      opacity: 0.7;
      font-style: italic;
      padding: 10px;
    }

    .error {
      color: #ff4444;
      font-weight: bold;
      padding: 10px;
    }

    /* æ¨ç†éƒ¨åˆ†æ ·å¼ */
    .reasoning-container {
      background: var(--msg-bg);
      border-radius: 8px;
      padding: 12px;
      margin: 10px 0;
      border-left: 3px solid var(--primary-color);
    }

    .reasoning-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 8px;
    }

    .reasoning-title {
      color: var(--primary-color);
      font-weight: 500;
      font-size: 0.95em;
    }

    .reasoning-toggle {
      color: var(--text-color);
      font-size: 12px;
      cursor: pointer;
      user-select: none;
      opacity: 0.7;
    }

    .reasoning-toggle:hover {
      opacity: 1;
    }

    .reasoning-content {
      color: var(--text-color);
      font-size: 0.9em;
      line-height: 1.6;
    }

    /* æ¨¡å‹åˆ‡æ¢æŒ‰é’® */
    .model-toggle {
      display: flex;
      align-items: center;
      background: rgba(0, 123, 255, 0.1);
      border-radius: 8px;
      padding: 8px 12px;
      color: var(--primary-color);
      cursor: pointer;
      user-select: none;
      transition: background 0.2s;
      border: none;
    }

    .model-toggle:hover {
      background: rgba(0, 123, 255, 0.2);
    }

    .model-toggle.off {
      background: var(--msg-bg);
      color: var(--text-color);
      opacity: 0.7;
    }

    /* ç§»åŠ¨ç«¯é€‚é… */
    @media (max-width: 768px) {
      #sidebar {
        position: absolute;
        top: 0;
        left: 0;
        bottom: 0;
        z-index: 1000;
        width: 80%;
        min-width: 0;
      }

      #sidebar.collapsed {
        transform: translateX(-100%);
      }

      #sidebar-toggle {
        right: -40px;
      }

      .user-msg, .bot-msg {
        max-width: 90%;
      }
    }
  </style>
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>
</head>
<body>
  <div id="main-container">
    <!-- å·¦ä¾§æ  -->
    <div id="sidebar">
      <button id="sidebar-toggle">â‰¡</button>
      <div id="sidebar-header">
        <h2>ä¼šè¯ç®¡ç†</h2>
        <button id="theme-toggle">ğŸŒ“</button>
      </div>
      <div id="history-list"></div>
      <button id="new-chat-btn">æ–°å»ºä¼šè¯</button>
    </div>

    <!-- å³ä¾§ä¸»å†…å®¹åŒº -->
    <div id="chat-container">
      <div id="chat-header">
        <h1>DeepSeek Chat</h1>
        <div id="model-controls">
          <button class="model-toggle" id="model-toggle">
            <span>æ·±åº¦æ€è€ƒ</span>
          </button>
        </div>
      </div>
      
      <div id="chat-history">
        <div class="bot-msg">ä½ å¥½ï¼æˆ‘æ˜¯ DeepSeekï¼Œè¯·é—®æœ‰ä»€ä¹ˆå¯ä»¥å¸®æ‚¨ï¼Ÿ</div>
      </div>
      
      <div id="input-area">
        <div id="input-controls">
          <div id="file-buttons">
            <button class="file-btn">ğŸ“· å›¾ç‰‡</button>
            <button class="file-btn">ğŸ“ é™„ä»¶</button>
          </div>
          <textarea id="user-input" placeholder="è¾“å…¥ä½ çš„é—®é¢˜..." rows="1"></textarea>
          <button id="send-btn" onclick="sendMessage()">å‘é€</button>
        </div>
      </div>
    </div>
  </div>

<script>
const WORKER_URL = 'https://deepseek-proxy.jsxzznz.workers.dev';
const CORRECT_PASSWORD_HASH = "fc5e038d38a57032085441e7fe7010b0";
let currentChatId = null;
let currentModel = "deepseek-reasoner";
let isDarkMode = false;

// åˆå§‹åŒ–å‡½æ•°
window.onload = function() {
  const password = prompt("è¯·è¾“å…¥å¯†ç ï¼š");
  if (password) {
    if (CryptoJS.MD5(password).toString() !== CORRECT_PASSWORD_HASH) {
      alert("å¯†ç é”™è¯¯ï¼");
      disablePage();
    } else {
      initApp();
    }
  } else {
    alert("å¯†ç ä¸èƒ½ä¸ºç©ºï¼");
    disablePage();
  }
};

function initApp() {
  // åˆå§‹åŒ–äº‹ä»¶ç›‘å¬
  document.getElementById('model-toggle').addEventListener('click', toggleModel);
  document.getElementById('new-chat-btn').addEventListener('click', createNewChat);
  document.getElementById('sidebar-toggle').addEventListener('click', toggleSidebar);
  document.getElementById('theme-toggle').addEventListener('click', toggleTheme);
  document.getElementById('user-input').addEventListener('keydown', handleKeyDown);
  
  // åŠ è½½å†å²è®°å½•
  loadHistoryList();
  
  // åˆå§‹åŒ–ä¾§è¾¹æ çŠ¶æ€
  if (window.innerWidth <= 768) {
    document.getElementById('sidebar').classList.add("collapsed");
  }
}

function disablePage() {
  document.getElementById('user-input').disabled = true;
  document.getElementById('send-btn').disabled = true;
  document.getElementById('chat-container').innerHTML += '<div class="error">å¯†ç é”™è¯¯ï¼Œæ— æ³•ä½¿ç”¨è¯¥é¡µé¢ã€‚</div>';
}

function toggleTheme() {
  isDarkMode = !isDarkMode;
  document.body.classList.toggle("dark-mode", isDarkMode);
  localStorage.setItem('darkMode', isDarkMode ? 'true' : 'false');
}

function toggleModel() {
  const toggleBtn = document.getElementById('model-toggle');
  toggleBtn.classList.toggle("off");
  currentModel = toggleBtn.classList.contains("off") ? "deepseek-chat" : "deepseek-reasoner";
}

function toggleSidebar() {
  const sidebar = document.getElementById('sidebar');
  sidebar.classList.toggle("collapsed");
}

function handleKeyDown(e) {
  if (e.key === 'Enter' && !e.shiftKey) {
    e.preventDefault();
    sendMessage();
  }
}

function formatTime(timestamp) {
  if (!timestamp) return "æœªçŸ¥æ—¶é—´";
  const now = new Date();
  const date = new Date(timestamp);
  const diffInDays = Math.floor((now - date) / (1000 * 60 * 60 * 24));
  
  if (diffInDays === 0) return "ä»Šå¤©";
  if (diffInDays === 1) return "æ˜¨å¤©";
  if (diffInDays < 7) return "ä¸€å‘¨å†…";
  if (diffInDays < 30) return "ä¸€ä¸ªæœˆå†…";
  return "å¾ˆä¹…ä¹‹å‰";
}

function groupChatsByTime(chats) {
  const now = new Date();
  const today = new Date(now.setHours(0, 0, 0, 0));
  const yesterday = new Date(today);
  yesterday.setDate(yesterday.getDate() - 1);
  const lastWeek = new Date(today);
  lastWeek.setDate(lastWeek.getDate() - 7);
  const lastMonth = new Date(today);
  lastMonth.setMonth(lastMonth.getMonth() - 1);
  
  const groups = {
    today: [],
    yesterday: [],
    lastWeek: [],
    lastMonth: [],
    older: []
  };
  
  chats.forEach(chat => {
    const timestamp = chat.timestamp || chat.messages[0]?.timestamp || Date.now();
    const date = new Date(timestamp);
    
    if (date >= today) {
      groups.today.push({...chat, timestamp});
    } else if (date >= yesterday) {
      groups.yesterday.push({...chat, timestamp});
    } else if (date >= lastWeek) {
      groups.lastWeek.push({...chat, timestamp});
    } else if (date >= lastMonth) {
      groups.lastMonth.push({...chat, timestamp});
    } else {
      groups.older.push({...chat, timestamp});
    }
  });
  
  return groups;
}

function loadHistoryList() {
  try {
    const historyList = document.getElementById('history-list');
    const chats = JSON.parse(localStorage.getItem('deepseekChats') || '[]');
    const groupedChats = groupChatsByTime(chats);
    
    historyList.innerHTML = '';
    
    // æŒ‰æ—¶é—´åˆ†ç»„æ˜¾ç¤º
    const sections = [
      { title: "ä»Šå¤©", key: "today", chats: groupedChats.today },
      { title: "æ˜¨å¤©", key: "yesterday", chats: groupedChats.yesterday },
      { title: "ä¸€å‘¨å†…", key: "lastWeek", chats: groupedChats.lastWeek },
      { title: "ä¸€ä¸ªæœˆå†…", key: "lastMonth", chats: groupedChats.lastMonth },
      { title: "æ›´æ—©", key: "older", chats: groupedChats.older }
    ];
    
    sections.forEach(section => {
      if (section.chats.length === 0) return;
      
      const sectionDiv = document.createElement('div');
      sectionDiv.className = 'history-section';
      
      const titleDiv = document.createElement('div');
      titleDiv.className = 'section-title';
      titleDiv.textContent = section.title;
      sectionDiv.appendChild(titleDiv);
      
      section.chats.forEach((chat, index) => {
        const globalIndex = chats.findIndex(c => c.timestamp === chat.timestamp);
        const firstUserMessage = chat.messages.find(m => m.role === "user");
        let chatName = firstUserMessage ? 
          (firstUserMessage.content.length > 6 ? firstUserMessage.content.substring(0, 6) + "..." : firstUserMessage.content) : 
          "æ–°ä¼šè¯";
        
        // å¦‚æœæœ‰è‡ªå®šä¹‰åç§°åˆ™ä½¿ç”¨
        if (chat.name) {
          chatName = chat.name.length > 10 ? chat.name.substring(0, 10) + "..." : chat.name;
        }
        
        const itemDiv = document.createElement('div');
        itemDiv.className = 'history-item';
        if (globalIndex === currentChatId) {
          itemDiv.classList.add("active");
        }
        itemDiv.textContent = chatName;
        itemDiv.onclick = () => loadChat(globalIndex);
        
        const actionsDiv = document.createElement('div');
        actionsDiv.className = 'history-item-actions';
        
        const renameBtn = document.createElement('button');
        renameBtn.className = 'history-item-btn';
        renameBtn.innerHTML = 'âœï¸';
        renameBtn.title = 'é‡å‘½å';
        renameBtn.onclick = (e) => {
          e.preventDefault();
          e.stopImmediatePropagation();
          renameChat(globalIndex);
        };
        
        const deleteBtn = document.createElement('button');
        deleteBtn.className = 'history-item-btn';
        deleteBtn.innerHTML = 'ğŸ—‘ï¸';
        deleteBtn.title = 'åˆ é™¤';
        deleteBtn.onclick = (e) => {
          e.preventDefault();
          e.stopImmediatePropagation();
          deleteChat(globalIndex);
        };
        
        actionsDiv.appendChild(renameBtn);
        actionsDiv.appendChild(deleteBtn);
        itemDiv.appendChild(actionsDiv);
        sectionDiv.appendChild(itemDiv);
      });
      
      historyList.appendChild(sectionDiv);
    });
    
    if (chats.length === 0) {
      historyList.innerHTML = '<div style="text-align:center;padding:20px;color:var(--text-color);opacity:0.7">æš‚æ— å†å²ä¼šè¯</div>';
      currentChatId = null;
    }
  } catch (e) {
    console.error('åŠ è½½å†å²è®°å½•å¤±è´¥:', e);
    localStorage.removeItem('deepseekChats');
    loadHistoryList();
  }
}

function renameChat(index) {
  const chats = JSON.parse(localStorage.getItem('deepseekChats') || '[]');
  if (index >= 0 && index < chats.length) {
    const currentName = chats[index].name || 
      (chats[index].messages.find(m => m.role === "user")?.content.substring(0, 10) + "...") || 
      "æ–°ä¼šè¯";
    const newName = prompt("è¯·è¾“å…¥æ–°çš„ä¼šè¯åç§°ï¼š", currentName);
    if (newName !== null && newName.trim() !== "") {
      chats[index].name = newName.trim();
      localStorage.setItem('deepseekChats', JSON.stringify(chats));
      loadHistoryList();
    }
  }
}

function deleteChat(index) {
  if (confirm('ç¡®å®šè¦åˆ é™¤æ­¤ä¼šè¯å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ’¤é”€ã€‚')) {
    const chats = JSON.parse(localStorage.getItem('deepseekChats') || '[]');
    if (index >= 0 && index < chats.length) {
      chats.splice(index, 1);
      localStorage.setItem('deepseekChats', JSON.stringify(chats));
      
      if (currentChatId === index) {
        currentChatId = null;
        document.getElementById('chat-history').innerHTML = '<div class="bot-msg">ä½ å¥½ï¼æˆ‘æ˜¯ DeepSeekï¼Œè¯·é—®æœ‰ä»€ä¹ˆå¯ä»¥å¸®æ‚¨ï¼Ÿ</div>';
      } else if (currentChatId > index) {
        currentChatId--;
      }
      loadHistoryList();
    }
  }
}

function createNewChat() {
  saveCurrentChat();
  currentChatId = null;
  const chatHistory = document.getElementById('chat-history');
  chatHistory.innerHTML = '<div class="bot-msg">ä½ å¥½ï¼æˆ‘æ˜¯ DeepSeekï¼Œè¯·é—®æœ‰ä»€ä¹ˆå¯ä»¥å¸®æ‚¨ï¼Ÿ</div>';
  chatHistory.scrollTop = chatHistory.scrollHeight;
}

function saveCurrentChat() {
  const chatHistory = document.getElementById('chat-history');
  const messages = [];
  
  chatHistory.querySelectorAll('.user-msg, .bot-msg, .reasoning-container').forEach(msg => {
    if (msg.classList.contains("error") || msg.classList.contains("loading")) return;
    
    const timestamp = Date.now();
    
    if (msg.classList.contains("user-msg")) {
      messages.push({
        role: "user",
        content: msg.textContent.trim(),
        timestamp: timestamp
      });
    } else if (msg.classList.contains("bot-msg")) {
      messages.push({
        role: "assistant",
        content: msg.querySelector('.markdown-content')?.textContent.trim() || msg.textContent.trim(),
        timestamp: timestamp
      });
    }
  });
  
  if (messages.length > 0) {
    let chats = JSON.parse(localStorage.getItem('deepseekChats') || '[]');
    
    if (currentChatId !== null && chats[currentChatId]) {
      chats[currentChatId].messages = messages;
      chats[currentChatId].timestamp = messages[0].timestamp;
    } else {
      chats.push({
        messages,
        timestamp: messages[0].timestamp
      });
      currentChatId = chats.length - 1;
    }
    
    localStorage.setItem('deepseekChats', JSON.stringify(chats));
    loadHistoryList();
  }
}

function loadChat(index) {
  const chats = JSON.parse(localStorage.getItem('deepseekChats') || '[]');
  if (index >= 0 && index < chats.length) {
    currentChatId = index;
    const chatHistory = document.getElementById('chat-history');
    chatHistory.innerHTML = "";
    const messages = chats[index].messages;
    
    messages.forEach(msg => {
      if (msg.role === "user") {
        const msgDiv = document.createElement("div");
        msgDiv.className = "user-msg";
        msgDiv.textContent = msg.content;
        chatHistory.appendChild(msgDiv);
      } else {
        const msgDiv = document.createElement("div");
        msgDiv.className = "bot-msg";
        msgDiv.innerHTML = '<div class="markdown-content"></div>';
        msgDiv.querySelector('.markdown-content').innerHTML = marked.parse(msg.content);
        
        const copyBtn = document.createElement("button");
        copyBtn.className = "copy-btn";
        copyBtn.innerText = "å¤åˆ¶";
        copyBtn.onclick = () => {
          navigator.clipboard.writeText(msg.content);
          copyBtn.innerText = "å·²å¤åˆ¶";
          setTimeout(() => copyBtn.innerText = "å¤åˆ¶", 2000);
        };
        msgDiv.appendChild(copyBtn);
        
        chatHistory.appendChild(msgDiv);
      }
    });
    
    chatHistory.scrollTop = chatHistory.scrollHeight;
  }
}

async function sendMessage() {
  const userInput = document.getElementById('user-input');
  const chatHistory = document.getElementById('chat-history');
  const sendBtn = document.getElementById('send-btn');
  
  if (sendBtn.disabled) return;
  sendBtn.disabled = true;
  
  if (userInput.value.trim()) {
    const message = userInput.value.trim();
    const userMsgDiv = document.createElement("div");
    userMsgDiv.className = "user-msg";
    userMsgDiv.textContent = message;
    chatHistory.appendChild(userMsgDiv);
    
    const loadingDiv = document.createElement("div");
    loadingDiv.className = "loading";
    loadingDiv.textContent = "æ€è€ƒä¸­...";
    chatHistory.appendChild(loadingDiv);
    chatHistory.scrollTop = chatHistory.scrollHeight;
    
    try {
      const requestData = {
        model: currentModel,
        messages: [{ role: "user", content: message }],
        stream: true
      };
      
      const response = await fetch(WORKER_URL, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(requestData)
      });
      
      if (!response.ok) {
        throw new Error(`è¯·æ±‚å¤±è´¥: ${response.status}`);
      }
      
      const reader = await response.body.getReader();
      const decoder = new TextDecoder();
      let botResponse = "";
      let reasoningContent = "";
      
      // åˆ›å»ºæ¶ˆæ¯å®¹å™¨
      const reasoningContainer = document.createElement("div");
      reasoningContainer.className = "reasoning-container";
      
      const reasoningHeader = document.createElement("div");
      reasoningHeader.className = "reasoning-header";
      
      const reasoningTitle = document.createElement("div");
      reasoningTitle.className = "reasoning-title";
      reasoningTitle.textContent = "ğŸ¤” æ¨¡å‹æ€è€ƒè¿‡ç¨‹";
      
      const reasoningToggle = document.createElement("div");
      reasoningToggle.className = "reasoning-toggle";
      reasoningToggle.textContent = "æ”¶èµ·";
      reasoningToggle.onclick = () => {
        const content = reasoningContainer.querySelector('.reasoning-content');
        content.style.display = content.style.display === 'none' ? 'block' : 'none';
        reasoningToggle.textContent = content.style.display === 'none' ? 'å±•å¼€' : 'æ”¶èµ·';
      };
      
      const reasoningContentDiv = document.createElement("div");
      reasoningContentDiv.className = "reasoning-content";
      reasoningContentDiv.innerHTML = '<div class="markdown-content"></div>';
      
      reasoningHeader.appendChild(reasoningTitle);
      reasoningHeader.appendChild(reasoningToggle);
      reasoningContainer.appendChild(reasoningHeader);
      reasoningContainer.appendChild(reasoningContentDiv);
      
      // å¦‚æœæ˜¯R1æ¨¡å‹ï¼Œæ˜¾ç¤ºæ¨ç†è¿‡ç¨‹åœ¨æ¶ˆæ¯ä¸Šæ–¹
      if (currentModel === "deepseek-reasoner") {
        chatHistory.appendChild(reasoningContainer);
      }
      
      const botMsgDiv = document.createElement("div");
      botMsgDiv.className = "bot-msg";
      botMsgDiv.innerHTML = '<div class="markdown-content"></div>';
      chatHistory.appendChild(botMsgDiv);
      
      while (true) {
        const { done, value } = await reader.read();
        if (done) break;
        
        const chunk = decoder.decode(value);
        const lines = chunk.split('\n');
        
        for (const line of lines) {
          if (line.trim() === "data: [DONE]") continue;
          
          if (line.startsWith("data:")) {
            try {
              const data = JSON.parse(line.slice(5));
              const content = data.choices[0].delta.content || "";
              const reasoning = data.choices[0].delta.reasoning_content || "";
              
              if (content) {
                botResponse += content;
                botMsgDiv.querySelector('.markdown-content').innerHTML = marked.parse(botResponse);
                chatHistory.scrollTop = chatHistory.scrollHeight;
              }
              
              if (reasoning && currentModel === "deepseek-reasoner") {
                reasoningContent += reasoning;
                reasoningContentDiv.querySelector('.markdown-content').innerHTML = marked.parse(reasoningContent);
              }
            } catch (e) {
              console.error("JSONè§£æé”™è¯¯:", e);
            }
          }
        }
      }
      
      loadingDiv.remove();
      
      // å¦‚æœæ²¡æœ‰æ¨ç†å†…å®¹æˆ–ä¸æ˜¯R1æ¨¡å‹ï¼Œç§»é™¤æ¨ç†å®¹å™¨
      if (!reasoningContent || currentModel !== "deepseek-reasoner") {
        reasoningContainer.remove();
      }
      
      const copyBtn = document.createElement("button");
      copyBtn.className = "copy-btn";
      copyBtn.innerText = "å¤åˆ¶";
      copyBtn.onclick = () => {
        navigator.clipboard.writeText(botResponse);
        copyBtn.innerText = "å·²å¤åˆ¶";
        setTimeout(() => copyBtn.innerText = "å¤åˆ¶", 2000);
      };
      botMsgDiv.appendChild(copyBtn);
    } catch (error) {
      document.querySelector('.loading')?.remove();
      const errorDiv = document.createElement("div");
      errorDiv.className = "error";
      errorDiv.textContent = `é”™è¯¯ï¼š${error.message}`;
      chatHistory.appendChild(errorDiv);
    } finally {
      userInput.value = "";
      sendBtn.disabled = false;
      chatHistory.scrollTop = chatHistory.scrollHeight;
      saveCurrentChat();
    }
  } else {
    sendBtn.disabled = false;
  }
}

// ä¼˜åŒ–çª—å£å¤§å°å˜åŒ–æ—¶çš„ä¾§è¾¹æ è¡Œä¸º
let resizeTimer;
window.addEventListener("resize", () => {
  clearTimeout(resizeTimer);
  resizeTimer = setTimeout(() => {
    const sidebar = document.getElementById('sidebar');
    const sidebarToggle = document.getElementById('sidebar-toggle');
    
    if (window.innerWidth <= 768) {
      if (!sidebar.classList.contains("collapsed")) {
        sidebar.classList.add("collapsed");
      }
    } else {
      // åœ¨çª—å£æ”¾å¤§æ—¶æ¢å¤ä¾§è¾¹æ çŠ¶æ€
      sidebar.classList.remove("collapsed");
    }
  }, 200);
});

// è‡ªåŠ¨è°ƒæ•´è¾“å…¥æ¡†é«˜åº¦
document.getElementById('user-input').addEventListener('input', function() {
  this.style.height = 'auto';
  this.style.height = (this.scrollHeight) + 'px';
});
</script>
</body>
</html>

<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>DeepSeek - 夸克博客</title>
  <style>
    /* 基础样式 */
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    body {
      font-family: Arial, sans-serif;
      background: linear-gradient(135deg, #1e1e2f, #2a2a40);
      margin: 0;
      color: #fff;
      overflow-x: hidden;
    }

    #main-container {
      display: flex;
      max-width: 1200px;
      margin: 0 auto;
      height: 100vh;
    }

    /* 左侧栏样式 */
    #sidebar {
      width: 250px;
      background: rgba(0, 0, 0, 0.3);
      border-right: 1px solid rgba(255, 255, 255, 0.1);
      padding: 20px;
      transition: transform 0.3s ease, width 0.3s ease;
      overflow-y: auto;
      display: flex;
      flex-direction: column;
      position: relative;
    }
    #sidebar.collapsed {
      width: 60px;
    }
    #sidebar-toggle {
      position: absolute;
      right: -30px;
      top: 20px;
      background: rgba(0, 0, 0, 0.5);
      border: none;
      color: #fff;
      font-size: 18px;
      width: 30px;
      height: 30px;
      border-radius: 0 5px 5px 0;
      cursor: pointer;
      z-index: 100;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    #sidebar-header {
      margin-bottom: 20px;
      padding-bottom: 10px;
      border-bottom: 1px solid rgba(255, 255, 255, 0.1);
      white-space: nowrap;
      overflow: hidden;
    }
    #sidebar.collapsed #sidebar-header h2 {
      display: none;
    }
    #history-list {
      flex: 1;
      overflow-y: auto;
      max-height: calc(100vh - 200px);
    }
    .history-section {
      margin-bottom: 15px;
    }
    .section-title {
      font-size: 0.9em;
      color: rgba(255, 255, 255, 0.6);
      margin-bottom: 8px;
      padding-left: 5px;
    }
    .history-item {
      padding: 10px;
      border-radius: 8px;
      margin-bottom: 5px;
      background: rgba(255, 255, 255, 0.1);
      cursor: pointer;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      position: relative;
      padding-right: 40px;
    }
    .history-item:hover {
      background: rgba(255, 255, 255, 0.2);
    }
    .history-item-actions {
      position: absolute;
      right: 5px;
      top: 50%;
      transform: translateY(-50%);
      display: none;
    }
    .history-item:hover .history-item-actions {
      display: flex;
      gap: 5px;
    }
    .history-item-btn {
      background: none;
      border: none;
      color: rgba(255, 255, 255, 0.6);
      cursor: pointer;
      font-size: 12px;
    }
    .history-item-btn:hover {
      color: #fff;
    }
    #new-chat-btn {
      margin-top: 15px;
      padding: 10px;
      width: 100%;
      background: linear-gradient(135deg, #007bff, #0056b3);
      color: #fff;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      transition: opacity 0.2s;
    }
    #new-chat-btn:hover {
      opacity: 0.9;
    }
    #sidebar.collapsed #new-chat-btn span {
      display: none;
    }
    #sidebar.collapsed #new-chat-btn::after {
      content: "+";
      font-size: 18px;
    }

    /* 右侧主内容区样式 */
    #chat-container {
      flex: 1;
      margin: 20px;
      padding: 20px;
      background: rgba(255, 255, 255, 0.1);
      border-radius: 16px;
      backdrop-filter: blur(10px);
      box-shadow: 0 4px 30px rgba(0, 0, 0, 0.1);
      display: flex;
      flex-direction: column;
      height: calc(100vh - 40px);
    }
    h1 {
      margin-bottom: 20px;
      font-size: 24px;
      color: #fff;
    }
    #chat-history {
      flex: 1;
      overflow-y: auto;
      border: 1px solid rgba(255, 255, 255, 0.1);
      border-radius: 12px;
      padding: 15px;
      margin-bottom: 15px;
      background: rgba(255, 255, 255, 0.05);
    }
    /* 隐藏滚动条但保持滚动功能 */
    #chat-history::-webkit-scrollbar,
    #history-list::-webkit-scrollbar {
      width: 0;
      height: 0;
    }
    .user-msg, .bot-msg {
      margin: 10px 0;
      padding: 12px;
      border-radius: 12px;
      position: relative;
    }
    .user-msg {
      background: rgba(0, 123, 255, 0.1);
      color: #007bff;
      margin-left: 25%;
      text-align: right;
    }
    .bot-msg {
      margin-top: 15px;
      position: relative;
      background: rgba(255, 255, 255, 0.1);
      border-radius: 12px;
      padding: 15px;
    }
    .copy-btn {
      position: absolute;
      right: 12px;
      bottom: 12px;
      background: rgba(255, 255, 255, 0.15);
      padding: 4px 10px;
      border-radius: 4px;
      border: none;
      color: rgba(255, 255, 255, 0.7);
      cursor: pointer;
      font-size: 12px;
    }
    .copy-btn:hover {
      background: rgba(255, 255, 255, 0.2);
      color: #fff;
    }
    .input-container {
      display: flex;
      gap: 10px;
      margin-top: auto;
    }
    #user-input {
      flex: 1;
      padding: 12px;
      border: 1px solid rgba(255, 255, 255, 0.1);
      border-radius: 8px;
      background: rgba(255, 255, 255, 0.05);
      color: #fff;
      font-size: 16px;
    }
    #user-input:focus {
      outline: none;
      border-color: rgba(0, 123, 255, 0.5);
    }
    #send-btn {
      padding: 12px 20px;
      background: linear-gradient(135deg, #007bff, #0056b3);
      color: #fff;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-weight: bold;
      transition: opacity 0.2s;
    }
    #send-btn:hover {
      opacity: 0.9;
    }
    .loading {
      color: #666;
      font-style: italic;
    }
    .error {
      color: #ff0000;
      font-weight: bold;
    }
    /* 推理部分样式 */
    .reasoning-toggle {
      display: flex;
      align-items: center;
      color: rgba(255, 255, 255, 0.7);
      font-size: 14px;
      margin-top: 10px;
      cursor: pointer;
      user-select: none;
    }
    .reasoning-toggle::before {
      content: "▼";
      font-size: 10px;
      margin-right: 5px;
      transition: transform 0.2s;
    }
    .reasoning-toggle.collapsed::before {
      transform: rotate(-90deg);
    }
    .reasoning-content {
      margin-top: 8px;
      padding: 12px;
      background: rgba(255, 255, 255, 0.05);
      border-radius: 8px;
      color: rgba(255, 255, 255, 0.8);
      font-size: 0.9em;
      line-height: 1.6;
      overflow: hidden;
      transition: max-height 0.3s ease;
    }
    .reasoning-content.collapsed {
      max-height: 0;
      padding-top: 0;
      padding-bottom: 0;
      margin-top: 0;
    }
    /* 模型切换按钮 */
    .model-toggle {
      position: relative;
      display: flex;
      align-items: center;
      background: rgba(0, 123, 255, 0.1);
      border-radius: 8px;
      padding: 8px 12px;
      color: #007bff;
      cursor: pointer;
      user-select: none;
      margin-right: 10px;
      transition: background 0.2s;
    }
    .model-toggle:hover {
      background: rgba(0, 123, 255, 0.2);
    }
    .model-toggle::before {
      content: "✓";
      margin-right: 6px;
      font-size: 14px;
    }
    .model-toggle.off::before {
      content: "";
    }
    .model-toggle.off {
      color: rgba(255, 255, 255, 0.6);
    }
    .model-tooltip {
      position: absolute;
      bottom: 100%;
      left: 50%;
      transform: translateX(-50%);
      background: rgba(0, 0, 0, 0.8);
      color: #fff;
      padding: 5px 10px;
      border-radius: 4px;
      font-size: 12px;
      white-space: nowrap;
      margin-bottom: 5px;
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.2s;
    }
    .model-toggle:hover .model-tooltip {
      opacity: 1;
    }
  </style>
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>
</head>
<body>
  <div id="main-container">
    <!-- 左侧栏 -->
    <div id="sidebar">
      <button id="sidebar-toggle">≡</button>
      <div id="sidebar-header">
        <h2>会话管理</h2>
      </div>
      <div id="history-list"></div>
      <button id="new-chat-btn"><span>新建会话</span></button>
    </div>

    <!-- 右侧主内容区 -->
    <div id="chat-container">
      <h1>DeepSeek-R1 (夸克博客满血版)</h1>
      <div id="chat-history">
        <div class="bot-msg">你好！我是 DeepSeek，请问有什么可以帮您？</div>
      </div>
      <div class="input-container">
        <div class="model-toggle" id="model-toggle" title="深度思考模式">
          <span>深度思考</span>
          <div class="model-tooltip">使用R1推理模型</div>
        </div>
        <input type="text" id="user-input" placeholder="输入你的问题..." autocomplete="off">
        <button id="send-btn" onclick="sendMessage()">发送</button>
      </div>
    </div>
  </div>

<script>
const WORKER_URL = 'https://deepseek-proxy.jsxzznz.workers.dev';
const CORRECT_PASSWORD_HASH = "fc5e038d38a57032085441e7fe7010b0";
let currentChatId = null;
let currentModel = "deepseek-reasoner";

window.onload = function() {
  const password = prompt("请输入密码：");
  if (password) {
    if (CryptoJS.MD5(password).toString() !== CORRECT_PASSWORD_HASH) {
      alert("密码错误！");
      disablePage();
    } else {
      loadHistoryList();
    }
  } else {
    alert("密码不能为空！");
    disablePage();
  }
  
  // 初始化模型切换按钮
  document.getElementById('model-toggle').addEventListener('click', toggleModel);
};

function disablePage() {
  document.getElementById('user-input').disabled = true;
  document.getElementById('send-btn').disabled = true;
  document.getElementById('chat-container').innerHTML += '<div class="error">密码错误，无法使用该页面。</div>';
}

function toggleModel() {
  const toggleBtn = document.getElementById('model-toggle');
  toggleBtn.classList.toggle('off');
  currentModel = toggleBtn.classList.contains('off') ? "deepseek-chat" : "deepseek-reasoner";
  toggleBtn.querySelector('.model-tooltip').textContent = 
    toggleBtn.classList.contains('off') ? "使用V3聊天模型" : "使用R1推理模型";
}

function formatTime(timestamp) {
  if (!timestamp) return "未知时间";
  const now = new Date();
  const date = new Date(timestamp);
  const diffInDays = Math.floor((now - date) / (1000 * 60 * 60 * 24));
  
  if (diffInDays === 0) return "今天";
  if (diffInDays === 1) return "昨天";
  if (diffInDays < 7) return "一周内";
  if (diffInDays < 30) return "一个月内";
  return "很久之前";
}

function groupChatsByTime(chats) {
  const now = new Date();
  const today = new Date(now.setHours(0, 0, 0, 0));
  const yesterday = new Date(today);
  yesterday.setDate(yesterday.getDate() - 1);
  const lastWeek = new Date(today);
  lastWeek.setDate(lastWeek.getDate() - 7);
  const lastMonth = new Date(today);
  lastMonth.setMonth(lastMonth.getMonth() - 1);
  
  const groups = {
    today: [],
    yesterday: [],
    lastWeek: [],
    lastMonth: [],
    older: []
  };
  
  chats.forEach(chat => {
    const timestamp = chat.timestamp || chat.messages[0]?.timestamp || Date.now();
    const date = new Date(timestamp);
    
    if (date >= today) {
      groups.today.push({...chat, timestamp});
    } else if (date >= yesterday) {
      groups.yesterday.push({...chat, timestamp});
    } else if (date >= lastWeek) {
      groups.lastWeek.push({...chat, timestamp});
    } else if (date >= lastMonth) {
      groups.lastMonth.push({...chat, timestamp});
    } else {
      groups.older.push({...chat, timestamp});
    }
  });
  
  return groups;
}

function loadHistoryList() {
  const historyList = document.getElementById('history-list');
  const chats = JSON.parse(localStorage.getItem('deepseekChats') || '[]');
  const groupedChats = groupChatsByTime(chats);
  
  historyList.innerHTML = '';
  
  // 按时间分组显示
  const sections = [
    { title: "今天", key: "today", chats: groupedChats.today },
    { title: "昨天", key: "yesterday", chats: groupedChats.yesterday },
    { title: "一周内", key: "lastWeek", chats: groupedChats.lastWeek },
    { title: "一个月内", key: "lastMonth", chats: groupedChats.lastMonth },
    { title: "更早", key: "older", chats: groupedChats.older }
  ];
  
  sections.forEach(section => {
    if (section.chats.length === 0) return;
    
    const sectionDiv = document.createElement('div');
    sectionDiv.className = 'history-section';
    
    const titleDiv = document.createElement('div');
    titleDiv.className = 'section-title';
    titleDiv.textContent = section.title;
    sectionDiv.appendChild(titleDiv);
    
    section.chats.forEach((chat, index) => {
      const globalIndex = chats.findIndex(c => c.timestamp === chat.timestamp);
      const firstUserMessage = chat.messages.find(m => m.role === "user");
      const chatName = firstUserMessage ? 
        (firstUserMessage.content.length > 6 ? firstUserMessage.content.substring(0, 6) + "..." : firstUserMessage.content) : 
        "新会话";
      
      const itemDiv = document.createElement('div');
      itemDiv.className = 'history-item';
      if (globalIndex === currentChatId) {
        itemDiv.style.background = 'rgba(0, 123, 255, 0.2)';
      }
      itemDiv.textContent = chatName;
      itemDiv.onclick = () => loadChat(globalIndex);
      
      const actionsDiv = document.createElement('div');
      actionsDiv.className = 'history-item-actions';
      
      const renameBtn = document.createElement('button');
      renameBtn.className = 'history-item-btn';
      renameBtn.innerHTML = '✏️';
      renameBtn.title = '重命名';
      renameBtn.onclick = (e) => {
        e.stopPropagation();
        renameChat(globalIndex);
      };
      
      const deleteBtn = document.createElement('button');
      deleteBtn.className = 'history-item-btn';
      deleteBtn.innerHTML = '🗑️';
      deleteBtn.title = '删除';
      deleteBtn.onclick = (e) => {
        e.stopPropagation();
        deleteChat(globalIndex);
      };
      
      actionsDiv.appendChild(renameBtn);
      actionsDiv.appendChild(deleteBtn);
      itemDiv.appendChild(actionsDiv);
      sectionDiv.appendChild(itemDiv);
    });
    
    historyList.appendChild(sectionDiv);
  });
  
  if (chats.length === 0) {
    historyList.innerHTML = '<div style="text-align:center;padding:20px;color:#aaa">暂无历史会话</div>';
    currentChatId = null;
  }
}

function renameChat(index) {
  const chats = JSON.parse(localStorage.getItem('deepseekChats') || '[]');
  if (index >= 0 && index < chats.length) {
    const newName = prompt("请输入新的会话名称：", chats[index].name || "");
    if (newName !== null) {
      chats[index].name = newName;
      localStorage.setItem('deepseekChats', JSON.stringify(chats));
      loadHistoryList();
    }
  }
}

function deleteChat(index) {
  if (confirm('确定要删除此会话吗？此操作不可撤销。')) {
    const chats = JSON.parse(localStorage.getItem('deepseekChats') || '[]');
    if (index >= 0 && index < chats.length) {
      chats.splice(index, 1);
      localStorage.setItem('deepseekChats', JSON.stringify(chats));
      if (currentChatId === index) {
        currentChatId = null;
        document.getElementById('chat-history').innerHTML = '<div class="bot-msg">你好！我是 DeepSeek，请问有什么可以帮您？</div>';
      } else if (currentChatId > index) {
        currentChatId--;
      }
      loadHistoryList();
    }
  }
}

document.getElementById('new-chat-btn').addEventListener('click', () => {
  if (confirm('确定要创建新会话吗？当前会话将会保存。')) {
    createNewChat();
  }
});

function createNewChat() {
  saveCurrentChat();
  currentChatId = null;
  const chatHistory = document.getElementById('chat-history');
  chatHistory.innerHTML = '<div class="bot-msg">你好！我是 DeepSeek，请问有什么可以帮您？</div>';
  chatHistory.scrollTop = chatHistory.scrollHeight;
}

function saveCurrentChat() {
  const chatHistory = document.getElementById('chat-history');
  const messages = [];
  
  chatHistory.querySelectorAll('.user-msg, .bot-msg, .reasoning-content').forEach(msg => {
    if (msg.classList.contains("error") || msg.classList.contains("loading")) return;
    
    if (msg.classList.contains("user-msg")) {
      messages.push({
        role: "user",
        content: msg.textContent.trim(),
        timestamp: Date.now()
      });
    } else if (msg.classList.contains("bot-msg")) {
      messages.push({
        role: "assistant",
        content: msg.querySelector('.markdown-content')?.textContent.trim() || msg.textContent.trim(),
        timestamp: Date.now()
      });
    }
  });
  
  if (messages.length > 0) {
    let chats = JSON.parse(localStorage.getItem('deepseekChats') || '[]');
    chats = JSON.parse(chats);
    
    if (currentChatId !== null && chats[currentChatId]) {
      chats[currentChatId].messages = messages;
      chats[currentChatId].timestamp = messages[0].timestamp;
    } else {
      chats.push({
        messages,
        timestamp: messages[0].timestamp
      });
      currentChatId = chats.length - 1;
    }
    
    localStorage.setItem('deepseekChats', JSON.stringify(chats));
    loadHistoryList();
  }
}

function loadChat(index) {
  const chats = JSON.parse(localStorage.getItem('deepseekChats') || '[]');
  if (index >= 0 && index < chats.length) {
    currentChatId = index;
    const chatHistory = document.getElementById('chat-history');
    chatHistory.innerHTML = "";
    const messages = chats[index].messages;
    
    messages.forEach(msg => {
      const msgDiv = document.createElement("div");
      msgDiv.className = msg.role === "user" ? "user-msg" : "bot-msg";
      msgDiv.innerHTML = '<div class="markdown-content"></div>';
      msgDiv.querySelector('.markdown-content').innerHTML = marked.parse(msg.content);
      chatHistory.appendChild(msgDiv);
    });
    
    chatHistory.scrollTop = chatHistory.scrollHeight;
  }
}

async function sendMessage() {
  const userInput = document.getElementById('user-input');
  const chatHistory = document.getElementById('chat-history');
  const sendBtn = document.getElementById('send-btn');
  
  if (sendBtn.disabled) return;
  sendBtn.disabled = true;
  
  if (userInput.value.trim()) {
    const message = userInput.value.trim();
    const userMsgDiv = document.createElement("div");
    userMsgDiv.className = "user-msg";
    userMsgDiv.textContent = message;
    chatHistory.appendChild(userMsgDiv);
    
    const loadingDiv = document.createElement("div");
    loadingDiv.className = "loading";
    loadingDiv.textContent = "思考中...";
    chatHistory.appendChild(loadingDiv);
    chatHistory.scrollTop = chatHistory.scrollHeight;
    
    try {
      const requestData = {
        model: currentModel,
        messages: [{ role: "user", content: message }],
        stream: true
      };
      
      const response = await fetch(WORKER_URL, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(requestData)
      });
      
      const reader = await response.body.getReader();
      const decoder = new TextDecoder();
      let botResponse = "";
      let reasoningContent = "";
      
      const botMsgDiv = document.createElement("div");
      botMsgDiv.className = "bot-msg";
      botMsgDiv.innerHTML = '<div class="markdown-content"></div>';
      chatHistory.appendChild(botMsgDiv);
      
      const reasoningToggle = document.createElement("div");
      reasoningToggle.className = "reasoning-toggle";
      reasoningToggle.textContent = "显示推理过程";
      reasoningToggle.onclick = () => {
        reasoningToggle.classList.toggle("collapsed");
        reasoningDiv.classList.toggle("collapsed");
      };
      
      const reasoningDiv = document.createElement("div");
      reasoningDiv.className = "reasoning-content collapsed";
      reasoningDiv.innerHTML = '<div class="markdown-content"></div>';
      
      chatHistory.appendChild(reasoningToggle);
      chatHistory.appendChild(reasoningDiv);
      
      while (true) {
        const { done, value } = await reader.read();
        if (done) break;
        
        const chunk = decoder.decode(value);
        const lines = chunk.split('\n');
        
        for (const line of lines) {
          if (line.trim() === "data: [DONE]") continue;
          
          if (line.startsWith("data:")) {
            try {
              const data = JSON.parse(line.slice(5));
              const content = data.choices[0].delta.content || "";
              const reasoning = data.choices[0].delta.reasoning_content || "";
              
              if (content) {
                botResponse += content;
                botMsgDiv.querySelector('.markdown-content').innerHTML = marked.parse(botResponse);
                chatHistory.scrollTop = chatHistory.scrollHeight;
              }
              
              if (reasoning) {
                reasoningContent += reasoning;
                reasoningDiv.querySelector('.markdown-content').innerHTML = marked.parse(reasoningContent);
              }
            } catch (e) {
              console.error("JSON解析错误:", e);
            }
          }
        }
      }
      
      loadingDiv.remove();
      
      // 如果没有推理内容，隐藏相关元素
      if (!reasoningContent) {
        reasoningToggle.remove();
        reasoningDiv.remove();
      }
      
      const copyBtn = document.createElement("button");
      copyBtn.className = "copy-btn";
      copyBtn.innerText = "复制";
      copyBtn.onclick = () => {
        navigator.clipboard.writeText(botResponse);
        copyBtn.innerText = "已复制";
        setTimeout(() => copyBtn.innerText = "复制", 2000);
      };
      botMsgDiv.appendChild(copyBtn);
    } catch (error) {
      document.querySelector('.loading')?.remove();
      const errorDiv = document.createElement("div");
      errorDiv.className = "error";
      errorDiv.textContent = `错误：${error.message}`;
      chatHistory.appendChild(errorDiv);
    } finally {
      userInput.value = "";
      sendBtn.disabled = false;
      chatHistory.scrollTop = chatHistory.scrollHeight;
      saveCurrentChat();
    }
  } else {
    sendBtn.disabled = false;
  }
}

// 侧边栏切换
document.getElementById('sidebar-toggle').addEventListener('click', function() {
  const sidebar = document.getElementById('sidebar');
  sidebar.classList.toggle("collapsed");
  this.textContent = sidebar.classList.contains("collapsed") ? "≡" : "≡";
});

// 优化窗口大小变化时的侧边栏行为
let resizeTimer;
window.addEventListener("resize", () => {
  clearTimeout(resizeTimer);
  resizeTimer = setTimeout(() => {
    const sidebar = document.getElementById('sidebar');
    const sidebarToggle = document.getElementById('sidebar-toggle');
    
    if (window.innerWidth <= 768) {
      if (!sidebar.classList.contains("collapsed")) {
        sidebar.classList.add("collapsed");
        sidebarToggle.textContent = "≡";
      }
    } else {
      // 在窗口放大时恢复侧边栏状态
      sidebar.classList.remove("collapsed");
      sidebarToggle.textContent = "≡";
    }
  }, 200);
});

// 初始化侧边栏状态
if (window.innerWidth <= 768) {
  document.getElementById('sidebar').classList.add("collapsed");
  document.getElementById('sidebar-toggle').textContent = "≡";
}
</script>
</body>
</html>

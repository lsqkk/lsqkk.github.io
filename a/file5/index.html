<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>夸克闪传 | QuakeShare P2P</title>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
    <style>
        /* 1. 极简毛玻璃 CSS (必须) */
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            margin: 0;
            padding: 0;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            background-color: #f0f2f5;
            /* 极浅背景色 */
            color: #333;
            transition: background-color 0.3s;
        }

        /* 2. 容器和卡片样式 */
        .container {
            width: 90%;
            max-width: 480px;
            padding: 20px;
        }

        .card {
            background-color: rgba(255, 255, 255, 0.6);
            /* 半透明白色 */
            border-radius: 12px;
            box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.15);
            /* 柔和阴影 */
            backdrop-filter: blur(10px);
            /* 核心：毛玻璃效果 */
            -webkit-backdrop-filter: blur(10px);
            /* 兼容性 */
            border: 1px solid rgba(255, 255, 255, 0.18);
            /* 柔和边框 */
            padding: 30px;
            text-align: center;
            margin-bottom: 20px;
        }

        h2 {
            margin-top: 0;
            margin-bottom: 20px;
            font-weight: 500;
            color: #1a1a1a;
        }

        /* 3. 输入框和按钮样式 */
        input[type="text"],
        input[type="file"],
        button {
            width: 100%;
            padding: 12px;
            margin-bottom: 15px;
            border-radius: 8px;
            box-sizing: border-box;
            font-size: 16px;
            transition: all 0.2s;
        }

        input[type="text"] {
            border: 1px solid rgba(0, 0, 0, 0.1);
            background-color: rgba(255, 255, 255, 0.8);
        }

        button {
            border: none;
            background-color: #007aff;
            /* iOS 蓝色 */
            color: white;
            cursor: pointer;
            font-weight: 600;
        }

        button:disabled {
            background-color: #a0c4ff;
            cursor: not-allowed;
        }

        button:active:not(:disabled) {
            transform: translateY(1px);
        }

        /* 4. 状态和进度显示 */
        #status {
            margin-top: 20px;
            padding: 10px;
            background-color: rgba(255, 255, 255, 0.8);
            border-radius: 8px;
            text-align: left;
            white-space: pre-wrap;
            word-break: break-all;
            border: 1px solid rgba(0, 0, 0, 0.05);
        }

        .progress-bar-container {
            height: 8px;
            background-color: rgba(0, 0, 0, 0.1);
            border-radius: 4px;
            margin-top: 10px;
            overflow: hidden;
        }

        .progress-bar {
            height: 100%;
            width: 0%;
            background-color: #34c759;
            /* 绿色 */
            transition: width 0.1s;
        }

        /* 5. 移动端优化 (简洁布局，无需顶栏) */
        @media (max-width: 600px) {
            .container {
                padding: 10px;
            }

            .card {
                padding: 20px;
            }
        }
    </style>
</head>

<body>

    <div class="container">

        <div class="card" id="join-section">
            <h2>连接设备</h2>
            <input type="text" id="room-code-input" placeholder="输入三位连接码 (如 ABC)" maxlength="3"
                style="text-transform: uppercase;">
            <button id="join-btn">加入房间并接收</button>
            <button id="create-btn">生成连接码并发送</button>
        </div>

        <div class="card" id="transfer-section" style="display: none;">
            <h2 id="transfer-title">等待连接...</h2>
            <div id="file-selection-area">
                <input type="file" id="file-input">
                <button id="send-btn" disabled>等待连接...</button>
            </div>
            <div id="download-area" style="display: none;">
                <p id="received-filename">已接收文件：</p>
                <a id="download-link" download style="display: none;">点击下载</a>
            </div>

            <div class="progress-bar-container">
                <div id="progress-bar" class="progress-bar"></div>
            </div>
        </div>

        <div class="card" id="status-card">
            <h2>状态信息</h2>
            <div id="status">连接状态：未连接</div>
        </div>

    </div>

    <script>
        // -----------------------------------------------------------
        // 1. Firebase 配置
        // -----------------------------------------------------------
        const firebaseConfig = {
            apiKey: "AIzaSyAeSI1akqwsPBrVyv7YKirV06fqdkL3YNI",
            authDomain: "quark-b7305.firebaseapp.com",
            projectId: "quark-b7305",
            storageBucket: "quark-b7305.firebasestorage.app",
            messagingSenderId: "843016834358",
            appId: "1:843016834358:web:9438c729be28c4d492f797",
            measurementId: "G-5BVT26KRT6"
        };

        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();

        // -----------------------------------------------------------
        // 2. 全局变量与 DOM 元素
        // -----------------------------------------------------------
        let peerConnection;
        let dataChannel;
        let isSender = false;
        let currentRoomCode = null;
        let fileToSend = null;
        let fileBuffer = [];
        let receivedFileSize = 0;
        let fileName = '';

        // File Chunk Settings
        const CHUNK_SIZE = 64 * 1024; // 64KB per chunk
        const METADATA_LABEL = 'metadata';

        const joinSection = document.getElementById('join-section');
        const transferSection = document.getElementById('transfer-section');
        const transferTitle = document.getElementById('transfer-title');
        const roomCodeInput = document.getElementById('room-code-input');
        const joinBtn = document.getElementById('join-btn');
        const createBtn = document.getElementById('create-btn');
        const fileInput = document.getElementById('file-input');
        const sendBtn = document.getElementById('send-btn');
        const statusDiv = document.getElementById('status');
        const progressBar = document.getElementById('progress-bar');
        const downloadArea = document.getElementById('download-area');
        const receivedFilenameP = document.getElementById('received-filename');
        const downloadLink = document.getElementById('download-link');

        // -----------------------------------------------------------
        // 3. 核心函数：状态更新与实用工具
        // -----------------------------------------------------------

        /** 记录状态 */
        function logStatus(message) {
            statusDiv.innerHTML = `[${new Date().toLocaleTimeString()}] ${message}\n` + statusDiv.innerHTML;
            console.log(message);
        }

        /** 生成三位随机大写字母码 */
        function generateRoomCode() {
            let result = '';
            const characters = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ';
            for (let i = 0; i < 3; i++) {
                result += characters.charAt(Math.floor(Math.random() * characters.length));
            }
            return result;
        }

        /** 更新进度条 */
        function updateProgress(percentage) {
            progressBar.style.width = `${Math.min(100, percentage)}%`;
        }

        // -----------------------------------------------------------
        // 4. WebRTC 初始化
        // -----------------------------------------------------------

        /** 初始化 RTCPeerConnection */
        function createPeerConnection(roomCode, isSenderDevice) {
            // 使用 Google STUN 服务器 (公共且免费)
            const iceServers = [{ urls: 'stun:stun.l.google.com:19302' }];
            peerConnection = new RTCPeerConnection({ iceServers });
            currentRoomCode = roomCode;
            isSender = isSenderDevice;

            logStatus(`创建 WebRTC 连接，身份: ${isSender ? '发送方' : '接收方'}。`);

            // 1. 处理 ICE 候选者
            peerConnection.onicecandidate = async (event) => {
                if (event.candidate) {
                    // 将 ICE 候选者发送给对方
                    const role = isSender ? 'sender' : 'receiver';
                    const candidatesRef = database.ref(`rooms/${roomCode}/${role}/iceCandidates`);
                    await candidatesRef.push(event.candidate.toJSON());
                    logStatus('发送 ICE 候选者...');
                }
            };

            // 2. 处理连接状态变化
            peerConnection.oniceconnectionstatechange = () => {
                logStatus(`ICE 连接状态: ${peerConnection.iceConnectionState}`);
                if (peerConnection.iceConnectionState === 'connected') {
                    logStatus('✅ P2P 连接建立成功！');
                    if (isSender) {
                        sendBtn.textContent = '选择文件并发送';
                        sendBtn.disabled = false;
                    } else {
                        transferTitle.textContent = '等待发送方传输文件...';
                    }
                } else if (peerConnection.iceConnectionState === 'failed' || peerConnection.iceConnectionState === 'closed') {
                    logStatus('❌ P2P 连接断开或失败。请重试。');
                }
            };

            // 3. 处理 DataChannel (发送方创建，接收方接收)
            if (isSender) {
                // 发送方创建 DataChannel
                dataChannel = peerConnection.createDataChannel('fileTransfer', { ordered: true });
                setupDataChannel(dataChannel);
                logStatus('已创建 DataChannel...');
            } else {
                // 接收方监听 DataChannel
                peerConnection.ondatachannel = (event) => {
                    dataChannel = event.channel;
                    setupDataChannel(dataChannel);
                    logStatus('已接收 DataChannel...');
                };
            }
        }

        /** DataChannel 的通用设置 */
        function setupDataChannel(channel) {
            channel.onopen = () => {
                logStatus('DataChannel 打开，可以开始传输数据。');
            };
            channel.onclose = () => {
                logStatus('DataChannel 关闭。');
            };
            channel.onerror = (error) => {
                logStatus(`DataChannel 错误: ${error}`);
            };

            // 接收方处理接收到的数据
            if (!isSender) {
                channel.onmessage = handleDataChannelMessage;
            }
        }

        // -----------------------------------------------------------
        // 5. 信令：发送方 (Offer)
        // -----------------------------------------------------------

        async function createSenderOffer(roomCode) {
            createPeerConnection(roomCode, true);
            transferTitle.textContent = `连接码：${roomCode}`;
            logStatus(`请将连接码 ${roomCode} 发送给接收方。`);

            try {
                // 1. 创建 Offer SDP
                const offer = await peerConnection.createOffer();
                await peerConnection.setLocalDescription(offer);

                // 2. 将 Offer SDP 写入 Firebase
                await database.ref(`rooms/${roomCode}/sender/sdp`).set(peerConnection.localDescription.toJSON());
                logStatus('Offer SDP 已发送至 Firebase。');

                // 3. 监听接收方 Answer SDP
                database.ref(`rooms/${roomCode}/receiver/sdp`).on('value', async (snapshot) => {
                    const answer = snapshot.val();
                    if (answer && !peerConnection.currentRemoteDescription) {
                        logStatus('接收到 Answer SDP，设置远程描述...');
                        await peerConnection.setRemoteDescription(new RTCSessionDescription(answer));
                        listenForIceCandidates(roomCode, 'receiver'); // 开始监听对方的 ICE
                    }
                });

            } catch (e) {
                logStatus(`❌ 发送方 Offer 失败: ${e.message}`);
            }
        }

        // -----------------------------------------------------------
        // 6. 信令：接收方 (Answer)
        // -----------------------------------------------------------

        async function createReceiverAnswer(roomCode) {
            createPeerConnection(roomCode, false);
            transferTitle.textContent = `连接码：${roomCode}`;

            // 1. 监听发送方 Offer SDP
            database.ref(`rooms/${roomCode}/sender/sdp`).once('value').then(async (snapshot) => {
                const offer = snapshot.val();
                if (!offer) {
                    logStatus(`❌ 房间 ${roomCode} 不存在 Offer。`);
                    return;
                }

                try {
                    // 2. 设置远程 Offer SDP
                    logStatus('接收到 Offer SDP，设置远程描述...');
                    await peerConnection.setRemoteDescription(new RTCSessionDescription(offer));

                    // 3. 创建 Answer SDP
                    const answer = await peerConnection.createAnswer();
                    await peerConnection.setLocalDescription(answer);

                    // 4. 将 Answer SDP 写入 Firebase
                    await database.ref(`rooms/${roomCode}/receiver/sdp`).set(peerConnection.localDescription.toJSON());
                    logStatus('Answer SDP 已发送至 Firebase。');

                    listenForIceCandidates(roomCode, 'sender'); // 开始监听对方的 ICE

                } catch (e) {
                    logStatus(`❌ 接收方 Answer 失败: ${e.message}`);
                }
            });
        }

        // -----------------------------------------------------------
        // 7. 信令：ICE 监听
        // -----------------------------------------------------------

        /** 监听对方的 ICE 候选者 */
        function listenForIceCandidates(roomCode, remoteRole) {
            database.ref(`rooms/${roomCode}/${remoteRole}/iceCandidates`).on('child_added', (snapshot) => {
                const candidate = snapshot.val();
                if (candidate) {
                    try {
                        // 添加远程 ICE 候选者
                        peerConnection.addIceCandidate(new RTCIceCandidate(candidate));
                        logStatus(`收到并添加了 ${remoteRole} 的 ICE 候选者。`);
                    } catch (e) {
                        logStatus(`❌ 添加 ICE 候选者失败: ${e.message}`);
                    }
                }
            });
        }

        // -----------------------------------------------------------
        // 8. 文件传输逻辑 (发送方)
        // -----------------------------------------------------------

        /** 发送文件 */
        async function sendFile(file) {
            if (dataChannel.readyState !== 'open') {
                logStatus('❌ DataChannel 未打开或未连接。');
                return;
            }

            const fileSize = file.size;
            let offset = 0;
            let chunksSent = 0;

            // 1. 发送文件元数据
            const metadata = {
                label: METADATA_LABEL,
                fileName: file.name,
                fileSize: fileSize,
                chunkSize: CHUNK_SIZE
            };
            dataChannel.send(JSON.stringify(metadata));
            logStatus(`开始传输文件: ${file.name} (${(fileSize / 1024 / 1024).toFixed(2)} MB)`);

            sendBtn.disabled = true;

            // 2. 分块发送文件
            const fileReader = new FileReader();

            fileReader.onload = async (e) => {
                // 发送数据块
                dataChannel.send(e.target.result);
                offset += e.target.result.byteLength;
                chunksSent++;

                // 更新进度条
                const percentage = (offset / fileSize) * 100;
                updateProgress(percentage);
                transferTitle.textContent = `发送中: ${file.name} | ${percentage.toFixed(1)}%`;

                if (offset < fileSize) {
                    readSlice(offset);
                } else {
                    logStatus('✅ 文件发送完成！');
                    sendBtn.disabled = false;
                    sendBtn.textContent = '传输完成，可重新选择文件';
                    // 清理 Firebase 房间信息 (可选，但推荐)
                    database.ref(`rooms/${currentRoomCode}`).remove();
                }
            };

            fileReader.onerror = (error) => {
                logStatus(`❌ 文件读取失败: ${error}`);
            };

            const readSlice = (start) => {
                const slice = file.slice(start, start + CHUNK_SIZE);
                fileReader.readAsArrayBuffer(slice);
            };

            readSlice(0); // 开始读取第一个块
        }

        // -----------------------------------------------------------
        // 9. 文件传输逻辑 (接收方)
        // -----------------------------------------------------------

        /** 处理接收到的 DataChannel 消息 */
        function handleDataChannelMessage(event) {
            const data = event.data;

            if (typeof data === 'string') {
                try {
                    const metadata = JSON.parse(data);
                    if (metadata.label === METADATA_LABEL) {
                        // 接收到元数据
                        fileName = metadata.fileName;
                        receivedFileSize = metadata.fileSize;
                        fileBuffer = [];
                        logStatus(`开始接收文件：${fileName} (大小: ${(receivedFileSize / 1024 / 1024).toFixed(2)} MB)`);
                        transferTitle.textContent = `接收中: ${fileName} | 0.0%`;
                        downloadArea.style.display = 'none';
                        return;
                    }
                } catch (e) {
                    // 忽略非元数据的字符串消息
                }
            } else if (data instanceof ArrayBuffer) {
                // 接收到数据块
                fileBuffer.push(data);
                const totalBytesReceived = fileBuffer.reduce((sum, chunk) => sum + chunk.byteLength, 0);
                const percentage = (totalBytesReceived / receivedFileSize) * 100;

                updateProgress(percentage);
                transferTitle.textContent = `接收中: ${fileName} | ${percentage.toFixed(1)}%`;

                if (totalBytesReceived >= receivedFileSize) {
                    // 所有块接收完毕
                    logStatus('✅ 文件接收完成！正在合成...');

                    // 使用 Blob 将 ArrayBuffer 数组合成文件
                    const fullFile = new Blob(fileBuffer);
                    const downloadUrl = URL.createObjectURL(fullFile);

                    receivedFilenameP.textContent = `已接收文件: ${fileName} (点击下载)`;
                    downloadLink.href = downloadUrl;
                    downloadLink.download = fileName; // 设置下载文件名
                    downloadLink.textContent = `点击下载 ${fileName}`;
                    downloadLink.style.display = 'block';
                    downloadArea.style.display = 'block';
                    transferTitle.textContent = `文件接收完毕！`;

                    // 清理 Firebase 房间信息 (可选，但推荐)
                    database.ref(`rooms/${currentRoomCode}`).remove();
                }
            }
        }

        // -----------------------------------------------------------
        // 10. 事件监听器
        // -----------------------------------------------------------

        // 监听：点击“生成连接码并发送”
        createBtn.addEventListener('click', () => {
            const roomCode = generateRoomCode();
            roomCodeInput.value = roomCode; // 自动填充
            joinSection.style.display = 'none';
            transferSection.style.display = 'block';
            createSenderOffer(roomCode);
        });

        // 监听：点击“加入房间并接收”
        joinBtn.addEventListener('click', () => {
            const roomCode = roomCodeInput.value.toUpperCase().trim();
            if (roomCode.length !== 3) {
                logStatus('❌ 连接码必须是三位大写字母。');
                return;
            }
            joinSection.style.display = 'none';
            transferSection.style.display = 'block';
            createReceiverAnswer(roomCode);
        });

        // 监听：文件选择
        fileInput.addEventListener('change', (e) => {
            fileToSend = e.target.files[0];
            if (fileToSend) {
                sendBtn.textContent = `发送 ${fileToSend.name}`;
                sendBtn.disabled = false;
            } else {
                sendBtn.textContent = '选择文件并发送';
                sendBtn.disabled = true;
            }
        });

        // 监听：点击发送按钮
        sendBtn.addEventListener('click', () => {
            if (fileToSend) {
                sendFile(fileToSend);
            } else {
                logStatus('❌ 请先选择要发送的文件。');
            }
        });

    </script>

</body>

</html>
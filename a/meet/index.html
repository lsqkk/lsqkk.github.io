<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WebRTC å¤šäººä¼šè®®å®¤ - P2P å…±äº«</title>
    <!-- åŠ è½½ Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- å¼•å…¥ Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>

    <style>
        /* --- 1. æ ·å¼å˜é‡ (ä¸ nav.css é£æ ¼ç»Ÿä¸€) --- */
        :root {
            /* æ¨¡ä»¿ nav.css çš„èƒŒæ™¯è‰² */
            --glass-bg-color: 122, 189, 154;
            /* ç»¿è‰²ç³» */
            --surface-bg-color: 255, 255, 255;
            --main-text-color: #1f2937;
            --main-accent-color: #4f46e5;
        }

        /* å…¨å±€èƒŒæ™¯å’Œæ¯›ç»ç’ƒæ•ˆæœ */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f0f2f5;
            /* ææµ…èƒŒæ™¯è‰² */
            color: var(--main-text-color);
            min-height: 100vh;
        }

        /* é€šç”¨æ¯›ç»ç’ƒå¡ç‰‡æ ·å¼ (ä½¿ç”¨ glass-card ç±»åä»¥é¿å…å†²çª) */
        .glass-card {
            background: rgba(var(--surface-bg-color), 0.2);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border-radius: 1rem;
            border: 1px solid rgba(var(--surface-bg-color), 0.3);
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1), inset 0 1px 0 rgba(var(--surface-bg-color), 0.5);
        }

        /* è§†é¢‘å®¹å™¨ */
        #video-grid {
            display: grid;
            gap: 1.5rem;
            padding: 1.5rem;
            min-height: calc(100vh - 8rem);
            /* å‡å»åº•éƒ¨æ§åˆ¶æ é«˜åº¦ */
            align-content: start;
        }

        /* è§†é¢‘æµä½“å¸ƒå±€ */
        .video-wrapper-item {
            aspect-ratio: 16 / 9;
            width: 100%;
            border-radius: 0.75rem;
            overflow: hidden;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
            background-color: #000;
        }

        .video-wrapper-item video {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        /* å“åº”å¼ç½‘æ ¼å¸ƒå±€ */
        @media (min-width: 640px) {
            #video-grid[data-count="1"] {
                grid-template-columns: 1fr;
            }

            #video-grid[data-count="2"] {
                grid-template-columns: 1fr 1fr;
            }

            #video-grid[data-count="3"] {
                grid-template-columns: 1fr 1fr;
            }

            #video-grid[data-count="4"] {
                grid-template-columns: repeat(2, minmax(0, 1fr));
            }

            #video-grid[data-count="5"],
            #video-grid[data-count="6"] {
                grid-template-columns: repeat(3, minmax(0, 1fr));
            }
        }

        /* ç§»åŠ¨ç«¯æ¨ªå±æ—¶ï¼Œå¦‚æœäººæ•°å°‘ï¼Œè§†é¢‘å¯ä»¥æ›´å¤§ */
        @media (orientation: landscape) and (max-width: 1024px) {
            #video-grid[data-count="1"] {
                min-height: calc(100vh - 4rem);
            }
        }

        /* æŒ‰é’®å’Œè¾“å…¥æ¡†æ ·å¼ä¿®æ­£ï¼Œé¿å…ä¸ nav.css å†²çª */
        .ui-btn {
            transition: all 0.2s;
        }

        .ui-btn:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 8px 15px rgba(0, 0, 0, 0.2);
        }

        .ui-input {
            background: rgba(var(--surface-bg-color), 0.5);
            color: var(--main-text-color);
            border: 1px solid rgba(var(--surface-bg-color), 0.6);
        }

        /* æ§åˆ¶æ çš„æ¯›ç»ç’ƒæ ·å¼ */
        #control-bar {
            background: rgba(var(--glass-bg-color), 0.3);
            /* æ²¿ç”¨ nav.css çš„ç»¿è‰²ç³»åŠé€æ˜ */
            backdrop-filter: blur(15px);
            -webkit-backdrop-filter: blur(15px);
            border-top: 1px solid rgba(255, 255, 255, 0.3);
            box-shadow: 0 -4px 6px rgba(0, 0, 0, 0.1);
        }

        /* åˆ‡æ¢æŒ‰é’®çš„æ ·å¼ */
        .toggle-btn.is-off {
            background-color: #ef4444;
            /* çº¢è‰²è¡¨ç¤ºå…³é—­æˆ–ç¦ç”¨ */
            color: white;
        }

        .toggle-btn:not(.is-off) {
            background-color: white;
            color: var(--main-accent-color);
        }
    </style>

    <!-- å¼•å…¥ Firebase v9/v11 å…¼å®¹æ€§ SDK -->
    <script type="module">
        // ä¿®æ­£: å¿…é¡»å®Œæ•´å¯¼å…¥æ‰€æœ‰ç”¨åˆ°çš„ Firestore æ–¹æ³•
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import {
            getFirestore,
            doc,
            setDoc,
            deleteDoc,
            onSnapshot,
            collection
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- ç”¨æˆ·çš„ RTDB é…ç½® ---
        const firebaseConfig = {
            apiKey: "AIzaSyAeSI1akqwsPBrVyv7YKirV06fqdkL3YNI",
            authDomain: "quark-b7305.firebaseapp.com",
            databaseURL: "https://quark-b7305-default-rtdb.firebaseio.com",
            projectId: "quark-b7305",
            storageBucket: "quark-b7305.firebasestorage.app",
            messagingSenderId: "843016834358",
            appId: "1:843016834358:web:9438c729be28c4d492f797",
            measurementId: "G-5BVT26KRT6"
        };

        // å¦‚æœå…¨å±€å˜é‡å­˜åœ¨ï¼ˆCanvasç¯å¢ƒï¼‰ï¼Œåˆ™ä½¿ç”¨å…¨å±€å˜é‡
        const appId = typeof __app_id !== 'undefined' ? __app_id : firebaseConfig.projectId;
        const configToUse = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : firebaseConfig;

        window.firebaseApp = initializeApp(configToUse);
        window.db = getFirestore(window.firebaseApp);
        window.appId = appId;

        // ä¿®æ­£: å¿…é¡»å°†å¯¼å…¥çš„å‡½æ•°æŒ‚è½½åˆ° window ä¸Šæˆ–åœ¨å…¨å±€èŒƒå›´å†…å¯ç”¨ï¼Œä¾›å…¶ä»– script tag ä½¿ç”¨
        // ç”±äºè¿™é‡Œä½¿ç”¨äº† type="module"ï¼Œå®ƒå†…éƒ¨çš„å˜é‡ä¸ä¼šæš´éœ²ç»™å¤–éƒ¨æ™®é€š scriptï¼Œ
        // ä½†ç”±äºæ•´ä¸ª JS ä»£ç éƒ½åœ¨ä¸€ä¸ª type="module" å—å†…ï¼Œæ‰€ä»¥åªéœ€è¦å°†å®ƒä»¬å®šä¹‰ä¸º window å±æ€§å³å¯
        window.doc = doc;
        window.setDoc = setDoc;
        window.deleteDoc = deleteDoc;
        window.onSnapshot = onSnapshot;
        window.collection = collection;

    </script>
</head>

<body>
    <main class="min-h-screen pt-4 pb-24">
        <!-- æˆ¿é—´è¿æ¥ç•Œé¢ -->
        <div id="setup-section" class="max-w-xl mx-auto p-6 glass-card space-y-6 m-4">
            <h1 class="text-3xl font-bold text-center text-gray-800 flex items-center justify-center">
                <i data-lucide="video" class="w-8 h-8 mr-3 text-indigo-600"></i>
                WebRTC ä¼šè®®å®¤
            </h1>
            <p class="text-md text-gray-600 text-center">è¾“å…¥ä¸‰ä½ä¼šè®®ç åŠ å…¥æˆ–åˆ›å»ºæˆ¿é—´ï¼Œå¼€å§‹è§†é¢‘/å±å¹•å…±äº«ã€‚</p>

            <input type="text" id="room-code-input" maxlength="3" placeholder="ä¾‹å¦‚: ABC"
                class="ui-input w-full p-4 rounded-xl text-center text-3xl tracking-widest uppercase focus:ring-indigo-500 focus:border-indigo-500 shadow-inner" />

            <button id="join-room-btn"
                class="ui-btn w-full bg-indigo-600 text-white p-4 rounded-xl font-extrabold text-lg hover:bg-indigo-700 shadow-lg"
                disabled>
                åŠ å…¥/åˆ›å»ºæˆ¿é—´
            </button>

            <div class="flex justify-between items-center text-sm">
                <span id="status-message" class="min-h-6 font-medium text-gray-600">ç­‰å¾…è¾“å…¥ä¼šè®®ç ...</span>
                <button id="clean-room-btn"
                    class="ui-btn p-2 text-red-500 hover:bg-red-100 rounded-lg hidden text-xs font-semibold"
                    title="æ¸…ç†æˆ¿é—´ä¿¡ä»¤æ•°æ®">
                    <i data-lucide="trash-2" class="w-4 h-4 mr-1 inline"></i>æ¸…ç†æˆ¿é—´
                </button>
            </div>

        </div>

        <!-- ä¼šè®®æ§åˆ¶ç•Œé¢ -->
        <div id="conference-section" class="hidden">
            <h2 id="room-display" class="text-center text-xl font-semibold mb-4 text-gray-700"></h2>

            <!-- è§†é¢‘æµå®¹å™¨ -->
            <div id="video-grid" data-count="0">
                <!-- è§†é¢‘æµå°†åœ¨è¿™é‡ŒåŠ¨æ€æ·»åŠ  -->
            </div>

            <!-- æ§åˆ¶æ  (å›ºå®šåœ¨åº•éƒ¨ï¼Œæ¯›ç»ç’ƒæ•ˆæœ) -->
            <div id="control-bar"
                class="fixed bottom-0 left-0 right-0 p-3 flex justify-center items-center space-x-6 z-20">
                <!-- æ‘„åƒå¤´ -->
                <button id="toggle-camera" class="toggle-btn p-4 rounded-full shadow-lg" title="åˆ‡æ¢æ‘„åƒå¤´">
                    <i data-lucide="video" class="w-6 h-6"></i>
                </button>
                <!-- éº¦å…‹é£ -->
                <button id="toggle-mic" class="toggle-btn p-4 rounded-full shadow-lg" title="åˆ‡æ¢éº¦å…‹é£">
                    <i data-lucide="mic" class="w-6 h-6"></i>
                </button>
                <!-- å±å¹•å…±äº« -->
                <button id="toggle-screenshare" class="toggle-btn p-4 rounded-full shadow-lg" title="åˆ‡æ¢å±å¹•å…±äº«">
                    <i data-lucide="monitor" class="w-6 h-6"></i>
                </button>
                <!-- æŒ‚æ–­ -->
                <button id="leave-room" class="ui-btn p-4 bg-red-600 text-white rounded-full hover:bg-red-700 shadow-lg"
                    title="ç¦»å¼€ä¼šè®®">
                    <i data-lucide="phone-off" class="w-6 h-6"></i>
                </button>
            </div>
        </div>
    </main>

    <script type="module">
        // -------------------------------------------------------------------
        // 1. å…¨å±€é…ç½®ä¸çŠ¶æ€
        // -------------------------------------------------------------------
        const roomCodeInput = document.getElementById('room-code-input');
        const joinRoomBtn = document.getElementById('join-room-btn');
        const statusMessage = document.getElementById('status-message');
        const roomDisplay = document.getElementById('room-display');
        const videoGrid = document.getElementById('video-grid');
        const cleanRoomBtn = document.getElementById('clean-room-btn');

        const toggleCameraBtn = document.getElementById('toggle-camera');
        const toggleMicBtn = document.getElementById('toggle-mic');
        const toggleScreenshareBtn = document.getElementById('toggle-screenshare');
        const leaveRoomBtn = document.getElementById('leave-room');

        let localPeerConnection = null; // æ­¤å˜é‡ä¸å†ç”¨äº Meshï¼Œä½†ä¿ç•™
        let localStream = null;         // æœ¬åœ°åª’ä½“æµ (æ‘„åƒå¤´/éº¦å…‹é£)
        let screenStream = null;        // æœ¬åœ°å±å¹•å…±äº«æµ
        let currentRoomCode = null;     // å½“å‰æˆ¿é—´ç 
        // ä¸ºç¡®ä¿ç”¨æˆ· ID å”¯ä¸€æ€§ä¸”èƒ½è¯†åˆ«ï¼Œä½¿ç”¨æ—¶é—´æˆ³+éšæœºæ•°
        let localUserId = 'user_' + Date.now().toString(36) + Math.random().toString(36).substr(2, 5);
        let peerConnections = {};       // å­˜å‚¨æ‰€æœ‰è¿œç«¯ç”¨æˆ·çš„ RTCPeerConnection {remoteUserId: RTCPeerConnection}
        let signalingUnsubscribers = []; // å­˜å‚¨ Firestore ç›‘å¬å–æ¶ˆå‡½æ•°

        // åª’ä½“æµçŠ¶æ€
        let isCameraOn = false;
        let isMicOn = false;
        let isScreensharing = false;

        // ä¿®æ­£: ä½¿ç”¨ window ä¸Šçš„å…¨å±€å¯¼å…¥
        let db = window.db;
        let appId = window.appId;
        const doc = window.doc;
        const setDoc = window.setDoc;
        const deleteDoc = window.deleteDoc;
        const onSnapshot = window.onSnapshot;
        const collection = window.collection;

        // -------------------------------------------------------------------
        // 2. è¾…åŠ©å‡½æ•°
        // -------------------------------------------------------------------

        /**
         * è®°å½•çŠ¶æ€ä¿¡æ¯å¹¶æ›´æ–° UI
         * @param {string} msg 
         * @param {string} color 
         */
        function logStatus(msg, color = 'text-gray-600') {
            statusMessage.textContent = msg;
            statusMessage.className = `min-h-6 font-medium ${color}`;
            console.log(`[STATUS] ${msg}`);
        }

        /**
         * ç”Ÿæˆ P2P è¿æ¥çš„ ICE æœåŠ¡å™¨é…ç½®
         * @returns {object} RTCIceServer åˆ—è¡¨
         */
        function getIceServers() {
            // ä½¿ç”¨ Google çš„å…¬å…± STUN æœåŠ¡å™¨ï¼Œç¡®ä¿ P2P è¿æ¥æˆåŠŸ
            return {
                iceServers: [
                    { urls: 'stun:stun.l.google.com:19302' }
                ]
            };
        }

        /**
         * åˆ›å»ºä¸€ä¸ªè§†é¢‘å…ƒç´ å¹¶æ·»åŠ åˆ°å®¹å™¨ä¸­
         * @param {string} id - è§†é¢‘å…ƒç´ çš„ID
         * @param {boolean} isLocal - æ˜¯å¦ä¸ºæœ¬åœ°è§†é¢‘
         * @returns {HTMLVideoElement}
         */
        function createVideoElement(id, isLocal) {
            let videoWrapper = document.getElementById(`wrapper-${id}`);
            if (videoWrapper) return videoWrapper.querySelector('video');

            videoWrapper = document.createElement('div');
            videoWrapper.id = `wrapper-${id}`;
            videoWrapper.className = 'video-wrapper-item relative';

            const video = document.createElement('video');
            video.id = `video-${id}`;
            video.autoplay = true;
            video.playsInline = true;
            video.muted = isLocal; // æœ¬åœ°è§†é¢‘é™éŸ³
            video.className = 'shadow-lg bg-gray-800';

            // ç¡®ä¿æœ¬åœ°è§†é¢‘æœ‰ audio/video çŠ¶æ€å›¾æ ‡
            const iconId = isLocal ? 'local-media-icons' : `remote-media-icons-${id}`;
            const labelText = isLocal ? `æˆ‘ (${id.substring(id.length - 4)})` : `ç”¨æˆ· (${id.substring(id.length - 4)})`;

            const labelContainer = document.createElement('div');
            labelContainer.className = 'absolute top-2 left-2 text-xs font-bold bg-black bg-opacity-60 text-white px-2 py-1 rounded-full flex items-center space-x-2';
            labelContainer.textContent = labelText;

            const iconContainer = document.createElement('div');
            iconContainer.id = iconId;
            iconContainer.className = 'flex space-x-1 ml-2';

            labelContainer.appendChild(iconContainer);


            videoWrapper.appendChild(video);
            videoWrapper.appendChild(labelContainer);

            videoGrid.appendChild(videoWrapper);
            updateVideoLayout();

            // è§¦å‘è§†é¢‘åŠ è½½ï¼Œç¡®ä¿ isLocal å¯ä»¥çœ‹åˆ°è‡ªå·±
            if (isLocal) {
                video.addEventListener('loadedmetadata', () => {
                    video.play();
                });
            }

            return video;
        }

        /**
         * æ›´æ–°è§†é¢‘ç½‘æ ¼å¸ƒå±€
         */
        function updateVideoLayout() {
            const count = videoGrid.children.length;
            videoGrid.setAttribute('data-count', count);
        }

        /**
         * æ›´æ–°ç”¨æˆ·åª’ä½“çŠ¶æ€å›¾æ ‡
         * @param {string} userId 
         * @param {boolean} isVideoOn 
         * @param {boolean} isAudioOn 
         * @param {boolean} isScreenOn 
         */
        function updateMediaIcons(userId, isVideoOn, isAudioOn, isScreenOn) {
            const iconContainer = document.getElementById(userId === localUserId ? 'local-media-icons' : `remote-media-icons-${userId}`);
            if (!iconContainer) return;

            // ä¿®æ­£: Lucide icons ä¼šå°† <i> æ›¿æ¢ä¸º SVGï¼Œè¿™é‡Œéœ€è¦é‡æ–°æ¸²æŸ“
            iconContainer.innerHTML = '';

            // è§†é¢‘å›¾æ ‡
            if (isScreenOn) {
                iconContainer.innerHTML += `<i data-lucide="monitor" class="w-4 h-4 text-yellow-400"></i>`;
            } else if (isVideoOn) {
                iconContainer.innerHTML += `<i data-lucide="video" class="w-4 h-4 text-green-400"></i>`;
            } else {
                iconContainer.innerHTML += `<i data-lucide="video-off" class="w-4 h-4 text-red-500"></i>`;
            }

            // éŸ³é¢‘å›¾æ ‡
            if (isAudioOn) {
                iconContainer.innerHTML += `<i data-lucide="mic" class="w-4 h-4 text-green-400"></i>`;
            } else {
                iconContainer.innerHTML += `<i data-lucide="mic-off" class="w-4 h-4 text-red-500"></i>`;
            }

            // é‡æ–°æ¸²æŸ“ Lucide å›¾æ ‡
            if (window.lucide) {
                window.lucide.createIcons({ attrs: { class: 'w-4 h-4' } });
            }
        }

        /**
         * æ¸…ç†æˆ¿é—´æ•°æ®ï¼ˆæ¸…é™¤ Firebase ä¸­çš„æ‰€æœ‰ä¿¡ä»¤æ•°æ®ï¼‰
         * @param {string} code - æˆ¿é—´ç 
         */
        async function cleanRoomData(code) {
            if (!code || !db || !doc || !deleteDoc) return;
            logStatus('ğŸ—‘ï¸ æ­£åœ¨æ¸…ç†æˆ¿é—´ä¿¡ä»¤æ•°æ®...', 'text-red-500');

            // è·¯å¾„: /artifacts/{appId}/public/data/rooms/{code}
            const roomRef = doc(db, 'artifacts', appId, 'public/data/rooms', code);
            try {
                // åˆ é™¤æ•´ä¸ª room æ–‡æ¡£ï¼ŒåŒ…æ‹¬å­é›†åˆ members å’Œ signals
                await deleteDoc(roomRef);
                logStatus(`âœ… æˆ¿é—´ ${code} æ•°æ®æ¸…ç†å®Œæˆã€‚`, 'text-green-600');
            } catch (error) {
                logStatus(`âŒ æ¸…ç†æˆ¿é—´æ•°æ®å¤±è´¥: ${error.message}`, 'text-red-500');
            }
        }

        // -------------------------------------------------------------------
        // 3. åª’ä½“æµæ§åˆ¶
        // -------------------------------------------------------------------

        /**
         * è·å–æœ¬åœ°åª’ä½“æµ
         */
        async function getLocalMediaStream() {
            const constraints = { video: true, audio: true };
            try {
                if (localStream) {
                    localStream.getTracks().forEach(track => track.stop());
                }

                // è·å–æ‘„åƒå¤´å’Œéº¦å…‹é£æµ
                localStream = await navigator.mediaDevices.getUserMedia(constraints);

                // é»˜è®¤å…³é—­è½¨é“ï¼Œç­‰å¾…ç”¨æˆ·ç‚¹å‡»æŒ‰é’®å¼€å¯
                localStream.getVideoTracks().forEach(track => track.enabled = false);
                localStream.getAudioTracks().forEach(track => track.enabled = false);

                const localVideo = createVideoElement(localUserId, true);
                localVideo.srcObject = localStream;
                logStatus('âœ… æœ¬åœ°åª’ä½“æµè·å–æˆåŠŸï¼Œç­‰å¾…åŠ å…¥æˆ¿é—´ã€‚', 'text-green-600');

                // åˆå§‹åŒ–æœ¬åœ°å›¾æ ‡çŠ¶æ€
                updateMediaIcons(localUserId, false, false, false);

                return localStream;
            } catch (e) {
                logStatus(`âŒ æ— æ³•è·å–æœ¬åœ°åª’ä½“: ${e.message}. è¯·æ£€æŸ¥æ‘„åƒå¤´/éº¦å…‹é£æƒé™ã€‚`, 'text-red-500');
                throw e;
            }
        }

        /**
         * åˆ‡æ¢æ‘„åƒå¤´çŠ¶æ€
         */
        function toggleCamera() {
            if (!localStream) return;
            const videoTrack = localStream.getVideoTracks()[0];
            if (!videoTrack) return;

            // å¦‚æœæ­£åœ¨å±å¹•å…±äº«ï¼Œåˆ™ä¸å…è®¸å¼€å¯æ‘„åƒå¤´
            if (isScreensharing) {
                logStatus('âš ï¸ è¯·å…ˆå…³é—­å±å¹•å…±äº«å†å¼€å¯æ‘„åƒå¤´ã€‚', 'text-yellow-600');
                return;
            }

            isCameraOn = !isCameraOn;
            videoTrack.enabled = isCameraOn;

            // æ›´æ–°æŒ‰é’®æ ·å¼å’Œå›¾æ ‡
            toggleCameraBtn.classList.toggle('is-off', !isCameraOn);
            // ä¿®æ­£: ç¡®ä¿è·å–åˆ°çš„æ˜¯ SVG å…ƒç´ ï¼ˆå¦‚æœ Lucide å·²è½¬æ¢ï¼‰æˆ– <i> å…ƒç´ 
            const iconElement = toggleCameraBtn.querySelector('i') || toggleCameraBtn.querySelector('svg');
            if (iconElement) {
                // ä¿®æ­£: ä½¿ç”¨ data-lucide å±æ€§æ¥è§¦å‘é‡æ–°æ¸²æŸ“
                if (iconElement.tagName === 'I') {
                    iconElement.setAttribute('data-lucide', isCameraOn ? 'video' : 'video-off');
                } else {
                    // å¦‚æœå·²ç»æ˜¯ SVGï¼Œåˆ™ç›´æ¥æ›¿æ¢æ•´ä¸ªæŒ‰é’®å†…å®¹å¹¶é‡æ–°æ¸²æŸ“ Lucide
                    toggleCameraBtn.innerHTML = `<i data-lucide="${isCameraOn ? 'video' : 'video-off'}" class="w-6 h-6"></i>`;
                    window.lucide.createIcons({ attrs: { class: 'w-6 h-6' } });
                }
            }

            updateMediaIcons(localUserId, isCameraOn, isMicOn, isScreensharing);

            logStatus(`æ‘„åƒå¤´å·²${isCameraOn ? 'å¼€å¯' : 'å…³é—­'}`);

            // é€šçŸ¥æ‰€æœ‰è¿œç«¯è¿æ¥è½¨é“çŠ¶æ€å·²æ”¹å˜
            Object.values(peerConnections).forEach(pc => {
                pc.getSenders().forEach(sender => {
                    if (sender.track && sender.track.kind === 'video' && sender.track.label !== 'screen') {
                        sender.track.enabled = isCameraOn;
                    }
                });
            });
            // å‘é€æ›´æ–°çŠ¶æ€ä¿¡ä»¤
            sendSignalingMessageToAll({ type: 'media_state', state: { video: isCameraOn, audio: isMicOn, screen: isScreensharing } });
        }

        /**
         * åˆ‡æ¢éº¦å…‹é£çŠ¶æ€
         */
        function toggleMic() {
            if (!localStream) return;
            const audioTrack = localStream.getAudioTracks()[0];
            if (!audioTrack) return;

            isMicOn = !isMicOn;
            audioTrack.enabled = isMicOn;

            // æ›´æ–°æŒ‰é’®æ ·å¼å’Œå›¾æ ‡
            toggleMicBtn.classList.toggle('is-off', !isMicOn);
            const iconElement = toggleMicBtn.querySelector('i') || toggleMicBtn.querySelector('svg');
            if (iconElement) {
                if (iconElement.tagName === 'I') {
                    iconElement.setAttribute('data-lucide', isMicOn ? 'mic' : 'mic-off');
                } else {
                    toggleMicBtn.innerHTML = `<i data-lucide="${isMicOn ? 'mic' : 'mic-off'}" class="w-6 h-6"></i>`;
                    window.lucide.createIcons({ attrs: { class: 'w-6 h-6' } });
                }
            }

            updateMediaIcons(localUserId, isCameraOn, isMicOn, isScreensharing);

            logStatus(`éº¦å…‹é£å·²${isMicOn ? 'å¼€å¯' : 'å…³é—­'}`);

            // é€šçŸ¥æ‰€æœ‰è¿œç«¯è¿æ¥è½¨é“çŠ¶æ€å·²æ”¹å˜
            Object.values(peerConnections).forEach(pc => {
                pc.getSenders().forEach(sender => {
                    if (sender.track && sender.track.kind === 'audio') {
                        sender.track.enabled = isMicOn;
                    }
                });
            });
            // å‘é€æ›´æ–°çŠ¶æ€ä¿¡ä»¤
            sendSignalingMessageToAll({ type: 'media_state', state: { video: isCameraOn, audio: isMicOn, screen: isScreensharing } });
        }

        /**
         * åˆ‡æ¢å±å¹•å…±äº«
         */
        async function toggleScreenshare() {
            if (!localStream) return;

            if (isScreensharing) {
                // --- åœæ­¢å±å¹•å…±äº« ---
                screenStream.getTracks().forEach(track => track.stop());
                screenStream = null;
                isScreensharing = false;
                logStatus('å±å¹•å…±äº«å·²å…³é—­ã€‚');

                // æ¢å¤æ‘„åƒå¤´æµçš„è½¨é“ï¼ˆå¦‚æœæ‘„åƒå¤´æ˜¯å¼€å¯çŠ¶æ€ï¼‰
                const cameraTrack = localStream.getVideoTracks()[0];
                if (cameraTrack) cameraTrack.enabled = isCameraOn;

                // æ›¿æ¢æ‰€æœ‰ PeerConnection ä¸­çš„å±å¹•å…±äº«è½¨é“ä¸ºæ‘„åƒå¤´è½¨é“
                Object.values(peerConnections).forEach(pc => {
                    pc.getSenders().forEach(sender => {
                        if (sender.track && sender.track.kind === 'video') {
                            sender.replaceTrack(cameraTrack);
                        }
                    });
                });

                // é‡æ–°å¯ç”¨æ‘„åƒå¤´æŒ‰é’®ï¼Œå¹¶å…³é—­æ¿€æ´»çŠ¶æ€
                toggleCameraBtn.disabled = false;
                toggleScreenshareBtn.classList.remove('is-off');
                toggleScreenshareBtn.innerHTML = `<i data-lucide="monitor" class="w-6 h-6"></i>`;

                // æ¢å¤æ‘„åƒå¤´æŒ‰é’®çŠ¶æ€
                toggleCameraBtn.classList.toggle('is-off', !isCameraOn);
                toggleCameraBtn.innerHTML = `<i data-lucide="${isCameraOn ? 'video' : 'video-off'}" class="w-6 h-6"></i>`;


            } else {
                // --- å¼€å§‹å±å¹•å…±äº« ---
                try {
                    // å¼ºåˆ¶å…³é—­æ‘„åƒå¤´
                    if (isCameraOn) {
                        isCameraOn = false;
                        localStream.getVideoTracks().forEach(track => track.enabled = false);
                        toggleCameraBtn.classList.add('is-off');
                        toggleCameraBtn.innerHTML = `<i data-lucide="video-off" class="w-6 h-6"></i>`;
                    }

                    // è·å–å±å¹•å…±äº«æµ
                    const audioTracks = localStream.getAudioTracks();
                    const displayMediaOptions = { video: true, audio: audioTracks.length > 0 }; // å±å¹•å…±äº«æ—¶ï¼Œå¯é€‰æ˜¯å¦åŒ…å«ç³»ç»ŸéŸ³é¢‘
                    screenStream = await navigator.mediaDevices.getDisplayMedia(displayMediaOptions);
                    isScreensharing = true;
                    logStatus('å±å¹•å…±äº«å·²å¼€å¯ã€‚', 'text-indigo-600');

                    // æ›¿æ¢æ‰€æœ‰ PeerConnection ä¸­çš„æ‘„åƒå¤´è½¨é“ä¸ºå±å¹•å…±äº«è½¨é“
                    const screenTrack = screenStream.getVideoTracks()[0];
                    Object.values(peerConnections).forEach(pc => {
                        pc.getSenders().forEach(sender => {
                            if (sender.track && sender.track.kind === 'video') {
                                sender.replaceTrack(screenTrack);
                            }
                        });
                    });

                    // ç›‘å¬å±å¹•å…±äº«åœæ­¢äº‹ä»¶
                    screenStream.getVideoTracks()[0].onended = () => {
                        if (isScreensharing) {
                            toggleScreenshare(); // è‡ªåŠ¨è°ƒç”¨å…³é—­é€»è¾‘
                        }
                    };

                    // ç¦ç”¨æ‘„åƒå¤´æŒ‰é’®ï¼Œå¹¶å¼€å¯å±å¹•å…±äº«æ¿€æ´»çŠ¶æ€
                    toggleCameraBtn.disabled = true;
                    toggleScreenshareBtn.classList.add('is-off');
                    toggleScreenshareBtn.innerHTML = `<i data-lucide="monitor-stop" class="w-6 h-6"></i>`;

                } catch (err) {
                    logStatus(`âŒ å±å¹•å…±äº«å¤±è´¥: ${err.message}`, 'text-red-500');
                    isScreensharing = false;
                }
            }

            // æ¯æ¬¡åˆ‡æ¢åéƒ½éœ€è¦é‡æ–°æ¸²æŸ“ Lucide å›¾æ ‡
            if (window.lucide) {
                window.lucide.createIcons({ attrs: { class: 'w-6 h-6' } });
            }

            updateMediaIcons(localUserId, isCameraOn, isMicOn, isScreensharing);
            sendSignalingMessageToAll({ type: 'media_state', state: { video: isCameraOn, audio: isMicOn, screen: isScreensharing } });
        }

        // -------------------------------------------------------------------
        // 4. WebRTC ä¿¡ä»¤ä¸è¿æ¥
        // -------------------------------------------------------------------

        /**
         * åˆ›å»ºä¸€ä¸ªæ–°çš„ RTCPeerConnection å¹¶è®¾ç½®äº‹ä»¶ç›‘å¬å™¨
         * @param {string} remoteUserId - è¿œç«¯ç”¨æˆ·çš„ ID
         * @returns {RTCPeerConnection}
         */
        function createPeerConnection(remoteUserId) {
            const pc = new RTCPeerConnection(getIceServers());
            peerConnections[remoteUserId] = pc;

            // ç›‘å¬ ICE å€™é€‰è€… (Candidates)
            pc.onicecandidate = (event) => {
                if (event.candidate) {
                    sendSignalingMessage(remoteUserId, { type: 'candidate', candidate: event.candidate });
                }
            };

            // ç›‘å¬è¿œç«¯æµ
            pc.ontrack = (event) => {
                if (event.streams && event.streams[0]) {
                    const remoteVideo = createVideoElement(remoteUserId, false);
                    remoteVideo.srcObject = event.streams[0];
                    logStatus(`âœ… æ”¶åˆ°æ¥è‡ª ${remoteUserId.substring(remoteUserId.length - 4)} çš„åª’ä½“æµã€‚`, 'text-green-600');
                }
            };

            // ç›‘å¬è¿æ¥å…³é—­
            pc.oniceconnectionstatechange = () => {
                if (pc.iceConnectionState === 'disconnected' || pc.iceConnectionState === 'failed' || pc.iceConnectionState === 'closed') {
                    logStatus(`âš ï¸ ä¸ ${remoteUserId.substring(remoteUserId.length - 4)} çš„è¿æ¥çŠ¶æ€: ${pc.iceConnectionState}`);
                }
            };

            // å°†æœ¬åœ°æµï¼ˆæ‘„åƒå¤´/éº¦å…‹é£ï¼‰æ·»åŠ åˆ°è¿æ¥ä¸­
            if (localStream) {
                // ç¡®ä¿æ·»åŠ çš„æ˜¯å½“å‰æ´»åŠ¨æµï¼ˆå¯èƒ½æ˜¯ screenStream çš„è§†é¢‘è½¨é“ï¼‰
                const activeVideoTrack = isScreensharing && screenStream ? screenStream.getVideoTracks()[0] : (localStream.getVideoTracks().length > 0 ? localStream.getVideoTracks()[0] : null);
                const audioTrack = localStream.getAudioTracks().length > 0 ? localStream.getAudioTracks()[0] : null;

                if (activeVideoTrack) pc.addTrack(activeVideoTrack, localStream);
                if (audioTrack) pc.addTrack(audioTrack, localStream);
            }

            logStatus(`ğŸ› ï¸ å·²ä¸ºç”¨æˆ· ${remoteUserId.substring(remoteUserId.length - 4)} åˆ›å»ºæ–°çš„ PeerConnectionã€‚`);
            return pc;
        }

        /**
         * å°†ä¿¡ä»¤æ¶ˆæ¯ (Offer/Answer/Candidate/State) å‘é€åˆ° Firestore
         * @param {string} targetUserId - ç›®æ ‡ç”¨æˆ·ID
         * @param {object} message - ä¿¡ä»¤æ¶ˆæ¯
         */
        async function sendSignalingMessage(targetUserId, message) {
            if (!db || !currentRoomCode || !doc || !setDoc) return;

            // è·¯å¾„: /artifacts/{appId}/public/data/rooms/{roomCode}/signals/{targetUserId}
            const signalRef = doc(db, 'artifacts', appId, 'public/data/rooms', currentRoomCode, 'signals', targetUserId);

            const payload = {
                senderId: localUserId,
                message: message,
                timestamp: Date.now()
            };

            // ä½¿ç”¨ set() è¦†ç›–æ—§çš„ä¿¡ä»¤ï¼Œé˜²æ­¢æ¶ˆæ¯ç§¯å‹
            await setDoc(signalRef, payload).catch(console.error);
        }

        /**
         * å‘æ‰€æœ‰å·²è¿æ¥çš„ Peer å‘é€ä¿¡ä»¤æ¶ˆæ¯
         * @param {object} message - ä¿¡ä»¤æ¶ˆæ¯
         */
        function sendSignalingMessageToAll(message) {
            Object.keys(peerConnections).forEach(remoteUserId => {
                sendSignalingMessage(remoteUserId, message);
            });
        }


        /**
         * ç›‘å¬è¿œç«¯ç”¨æˆ·å‘æ¥çš„ä¿¡ä»¤æ¶ˆæ¯
         */
        function startSignalingListener() {
            if (!db || !currentRoomCode || !doc || !onSnapshot || !deleteDoc) return;

            // ç›‘å¬æˆ‘è‡ªå·±çš„ä¿¡ä»¤æ–‡æ¡£
            const signalRef = doc(db, 'artifacts', appId, 'public/data/rooms', currentRoomCode, 'signals', localUserId);

            const unsubscribe = onSnapshot(signalRef, async (docSnap) => {
                if (!docSnap.exists()) return;

                const data = docSnap.data();
                const senderId = data.senderId;
                const message = data.message;

                if (senderId === localUserId) return; // å¿½ç•¥è‡ªå·±å‘é€çš„æ¶ˆæ¯

                let pc = peerConnections[senderId];

                switch (message.type) {
                    case 'offer':
                        if (!pc) {
                            pc = createPeerConnection(senderId);
                        }
                        await pc.setRemoteDescription(new RTCSessionDescription(message.offer));
                        const answer = await pc.createAnswer();
                        await pc.setLocalDescription(answer);
                        sendSignalingMessage(senderId, { type: 'answer', answer: pc.localDescription });
                        break;

                    case 'answer':
                        if (pc && pc.remoteDescription === null) {
                            await pc.setRemoteDescription(new RTCSessionDescription(message.answer));
                        }
                        break;

                    case 'candidate':
                        if (pc) {
                            await pc.addIceCandidate(new RTCIceCandidate(message.candidate)).catch(e => {
                                console.error('Error adding received ICE candidate:', e);
                            });
                        }
                        break;

                    case 'media_state':
                        // è¿œç«¯ç”¨æˆ·æ›´æ–°åª’ä½“çŠ¶æ€
                        const state = message.state;
                        updateMediaIcons(senderId, state.video, state.audio, state.screen);
                        break;

                    case 'leave':
                        // è¿œç«¯ç”¨æˆ·ä¸»åŠ¨å‘é€çš„ç¦»å¼€æ¶ˆæ¯
                        if (pc) {
                            pc.close();
                            delete peerConnections[senderId];
                            document.getElementById(`wrapper-${senderId}`)?.remove();
                            logStatus(`ğŸ‘‹ ç”¨æˆ· ${senderId.substring(senderId.length - 4)} ç¦»å¼€äº†ä¼šè®®ã€‚`);
                            updateVideoLayout();
                        }
                        break;
                }

                // å¤„ç†å®Œä¿¡ä»¤åï¼Œæ¸…é™¤è¯¥ä¿¡ä»¤ï¼Œé˜²æ­¢é‡å¤å¤„ç†
                deleteDoc(signalRef);
            }, (error) => {
                console.error("Firestore ä¿¡ä»¤ç›‘å¬é”™è¯¯:", error);
            });
            signalingUnsubscribers.push(unsubscribe);
        }

        /**
         * åˆ›å»ºå¹¶å‘é€ Offer
         * @param {string} remoteUserId - ç›®æ ‡è¿œç«¯ç”¨æˆ·ID
         */
        async function createAndSendOffer(remoteUserId) {
            const pc = createPeerConnection(remoteUserId);

            try {
                const offer = await pc.createOffer();
                await pc.setLocalDescription(offer);
                sendSignalingMessage(remoteUserId, { type: 'offer', offer: pc.localDescription });
                logStatus(`âœ‰ï¸ å·²å‘ ${remoteUserId.substring(remoteUserId.length - 4)} å‘é€ Offerã€‚`);
            } catch (e) {
                console.error('Error creating or sending offer:', e);
                logStatus(`âŒ æ— æ³•å‘ ${remoteUserId.substring(remoteUserId.length - 4)} å‘é€ Offer: ${e.message}`, 'text-red-500');
            }
        }

        /**
         * ç›‘å¬æˆ¿é—´æˆå‘˜å˜åŒ–ï¼Œå¹¶ä¸æ–°æˆå‘˜å»ºç«‹è¿æ¥ (Mesh æ‹“æ‰‘)
         */
        function startRoomMemberListener() {
            if (!db || !currentRoomCode || !collection || !onSnapshot) return;

            // ç›‘å¬æˆ¿é—´æˆå‘˜é›†åˆ 
            const membersRef = collection(db, 'artifacts', appId, 'public/data/rooms', currentRoomCode, 'members');

            const unsubscribe = onSnapshot(membersRef, (snapshot) => {
                snapshot.docChanges().forEach(async (change) => {
                    const remoteUserId = change.doc.id;

                    if (remoteUserId === localUserId) return; // å¿½ç•¥è‡ªå·±

                    if (change.type === 'added') {
                        // æ–°æˆå‘˜åŠ å…¥ï¼Œé€šè¿‡ ID å­—å…¸åºå†³å®šè°å‘èµ· Offer
                        if (!peerConnections[remoteUserId]) {
                            logStatus(`ğŸ”” æ–°ç”¨æˆ· ${remoteUserId.substring(remoteUserId.length - 4)} åŠ å…¥æˆ¿é—´ã€‚`);

                            // è§„åˆ™ï¼šID å­—å…¸åºå°çš„å‘èµ· Offer
                            if (localUserId < remoteUserId) {
                                await createAndSendOffer(remoteUserId);
                            }
                        }
                    } else if (change.type === 'removed') {
                        // æˆå‘˜ç¦»å¼€
                        if (peerConnections[remoteUserId]) {
                            peerConnections[remoteUserId].close();
                            delete peerConnections[remoteUserId];
                            document.getElementById(`wrapper-${remoteUserId}`)?.remove();
                            logStatus(`ğŸ‘‹ ç”¨æˆ· ${remoteUserId.substring(remoteUserId.length - 4)} ç¦»å¼€äº†ä¼šè®®ã€‚`);
                            updateVideoLayout();
                        }
                    }
                });
            }, (error) => {
                console.error("Firestore æˆå‘˜ç›‘å¬é”™è¯¯:", error);
            });
            signalingUnsubscribers.push(unsubscribe);
        }

        // -------------------------------------------------------------------
        // 5. æˆ¿é—´ç®¡ç†
        // -------------------------------------------------------------------

        /**
         * åŠ å…¥æˆ–åˆ›å»ºæˆ¿é—´
         * @param {string} code - æˆ¿é—´ç 
         */
        async function joinRoom(code) {
            if (!doc || !setDoc) {
                logStatus('âŒ Firebase ä¾èµ–æœªå®Œå…¨åŠ è½½ï¼Œæ— æ³•åŠ å…¥æˆ¿é—´ã€‚', 'text-red-500');
                return;
            }

            currentRoomCode = code;

            // 1. UI åˆ‡æ¢
            document.getElementById('setup-section').classList.add('hidden');
            document.getElementById('conference-section').classList.remove('hidden');
            roomDisplay.textContent = `ä¼šè®®ç : ${code}`;
            cleanRoomBtn.classList.remove('hidden');

            // 2. å°†è‡ªå·±æ·»åŠ åˆ°æˆ¿é—´æˆå‘˜åˆ—è¡¨ä¸­
            // è·¯å¾„: /artifacts/{appId}/public/data/rooms/{code}/members/{localUserId}
            const memberRef = doc(db, 'artifacts', appId, 'public/data/rooms', currentRoomCode, 'members', localUserId);
            await setDoc(memberRef, { joinedAt: Date.now(), userId: localUserId });

            // 3. å¯åŠ¨ç›‘å¬å™¨
            startSignalingListener();
            startRoomMemberListener();

            // 4. é»˜è®¤å¼€å¯æ‘„åƒå¤´å’Œéº¦å…‹é£
            isCameraOn = true;
            isMicOn = true;

            // å¯ç”¨åª’ä½“è½¨é“
            if (localStream && localStream.getVideoTracks().length > 0) localStream.getVideoTracks()[0].enabled = true;
            if (localStream && localStream.getAudioTracks().length > 0) localStream.getAudioTracks()[0].enabled = true;

            // æ›´æ–°æŒ‰é’®çŠ¶æ€
            toggleCameraBtn.classList.remove('is-off');
            toggleMicBtn.classList.remove('is-off');
            toggleScreenshareBtn.classList.remove('is-off');

            // ä¿®æ­£: ç¡®ä¿æŒ‰é’®çš„ Lucide å›¾æ ‡çŠ¶æ€æ­£ç¡®
            toggleCameraBtn.innerHTML = `<i data-lucide="video" class="w-6 h-6"></i>`;
            toggleMicBtn.innerHTML = `<i data-lucide="mic" class="w-6 h-6"></i>`;
            if (window.lucide) {
                window.lucide.createIcons({ attrs: { class: 'w-6 h-6' } });
            }

            updateMediaIcons(localUserId, true, true, false);

            // 5. æé†’ç”¨æˆ·
            logStatus(`ğŸ‰ æˆåŠŸåŠ å…¥æˆ¿é—´ ${code}ï¼Œç­‰å¾…å…¶ä»–æˆå‘˜è¿æ¥...`, 'text-indigo-600');

            // 6. æ³¨å†Œ beforeunload äº‹ä»¶ï¼Œç¡®ä¿ç¦»å¼€æ—¶æ¸…ç†æˆå‘˜åˆ—è¡¨
            window.addEventListener('beforeunload', leaveRoom);
        }

        /**
         * ç¦»å¼€æˆ¿é—´
         */
        function leaveRoom() {
            if (currentRoomCode) {
                // 1. å‘æ‰€æœ‰ Peer å‘é€ç¦»å¼€ä¿¡ä»¤
                sendSignalingMessageToAll({ type: 'leave' });

                // 2. å…³é—­æ‰€æœ‰ Peer Connections
                Object.values(peerConnections).forEach(pc => pc.close());
                peerConnections = {};

                // 3. åœæ­¢æœ¬åœ°åª’ä½“æµ
                if (localStream) {
                    localStream.getTracks().forEach(track => track.stop());
                }
                if (screenStream) {
                    screenStream.getTracks().forEach(track => track.stop());
                }

                // 4. æ¸…ç† Firestore ç›‘å¬å™¨
                signalingUnsubscribers.forEach(unsubscribe => unsubscribe());
                signalingUnsubscribers = [];

                // 5. æ¸…ç† UI
                // ä¿®æ­£: ä½¿ç”¨æ­£ç¡®çš„ videoGrid å˜é‡
                videoGrid.innerHTML = '';
                videoGrid.setAttribute('data-count', 0);
                document.getElementById('setup-section').classList.remove('hidden');
                document.getElementById('conference-section').classList.add('hidden');
                roomDisplay.textContent = '';
                cleanRoomBtn.classList.add('hidden');
                logStatus('ä¼šè®®å·²ç»“æŸã€‚', 'text-gray-600');

                // 6. ä»æˆå‘˜åˆ—è¡¨ä¸­ç§»é™¤è‡ªå·±
                if (doc && deleteDoc) {
                    const memberRef = doc(db, 'artifacts', appId, 'public/data/rooms', currentRoomCode, 'members', localUserId);
                    deleteDoc(memberRef).catch(console.error);
                }

                currentRoomCode = null;
                window.removeEventListener('beforeunload', leaveRoom);
            }
        }

        // -------------------------------------------------------------------
        // 6. åˆå§‹åŒ–ä¸äº‹ä»¶ç›‘å¬å™¨
        // -------------------------------------------------------------------

        // å¿…é¡»åœ¨ window.onload ä¹‹åæ‰èƒ½ç¡®ä¿ db å’Œ appId è¢«åˆå§‹åŒ–
        window.onload = async () => {
            // 1. åˆå§‹åŒ– Lucide Icons
            if (window.lucide) {
                window.lucide.createIcons();
            }

            // 2. æ£€æŸ¥å…¨å±€å˜é‡æ˜¯å¦å·²è®¾ç½®
            if (typeof window.db === 'undefined' || typeof window.appId === 'undefined') {
                logStatus('âŒ Firebase é…ç½®ç¼ºå¤±ã€‚è¯·æ£€æŸ¥æ§åˆ¶å°ï¼Œå¹¶ç¡®ä¿åœ¨ script type="module" ä¸­æ­£ç¡®åˆå§‹åŒ–äº† Firebaseã€‚', 'text-red-600');
                // å³ä½¿é…ç½®ç¼ºå¤±ï¼Œä»å°è¯•è·å–åª’ä½“æµä»¥æ–¹ä¾¿è°ƒè¯•
            }
            // é‡æ–°èµ‹å€¼å…¨å±€å˜é‡ (ç¡®ä¿åœ¨ window.onload ä¸­è·å–åˆ°)
            db = window.db;
            appId = window.appId;

            // 3. é¢„å…ˆè·å–æœ¬åœ°åª’ä½“æµï¼Œå¹¶åœ¨ UI ä¸­æ˜¾ç¤º
            try {
                await getLocalMediaStream();
                joinRoomBtn.disabled = false;
            } catch (e) {
                joinRoomBtn.disabled = true;
                // æ— æ³•è·å–åª’ä½“æµï¼Œç¦ç”¨æŒ‰é’®ï¼Œé˜»æ­¢åŠ å…¥ä¼šè®®
            }

            // --- ç»‘å®šäº‹ä»¶ ---

            roomCodeInput.addEventListener('input', () => {
                const code = roomCodeInput.value.toUpperCase().trim();
                roomCodeInput.value = code;
                joinRoomBtn.disabled = code.length !== 3 || !localStream; // å¿…é¡»æœ‰æµæ‰èƒ½åŠ å…¥
            });

            joinRoomBtn.addEventListener('click', async () => {
                const code = roomCodeInput.value.toUpperCase().trim();
                if (code.length === 3) {
                    await joinRoom(code);
                }
            });

            toggleCameraBtn.addEventListener('click', toggleCamera);
            toggleMicBtn.addEventListener('click', toggleMic);
            toggleScreenshareBtn.addEventListener('click', toggleScreenshare);
            leaveRoomBtn.addEventListener('click', leaveRoom);
            cleanRoomBtn.addEventListener('click', () => {
                if (currentRoomCode) cleanRoomData(currentRoomCode);
            });
        };
    </script>
</body>

</html>
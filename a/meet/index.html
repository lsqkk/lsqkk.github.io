<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WebRTC ä¼šè®® | è§†é¢‘ä¸å±å¹•å…±äº«</title>
    <link rel="stylesheet" href="nav.css">

    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>

    <style>
        /* 1. å˜é‡å’ŒåŸºç¡€æ ·å¼ */
        :root {
            --header-height: 60px;
            /* é¢„ç•™é¡¶æ ç©ºé—´ */
            --main-blue: #007aff;
            /* iOS è“è‰² */
            --main-green: #34c759;
            /* æˆåŠŸç»¿è‰² */
            --main-red: #ff3b30;
            /* è­¦å‘Šçº¢è‰² */
            --bg-light: #f0f2f5;
            /* ææµ…èƒŒæ™¯è‰² */
            --card-bg-opacity: 0.8;
            --card-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.15);
            --card-border: 1px solid rgba(255, 255, 255, 0.3);
            --control-bg: rgba(255, 255, 255, 0.1);
            /* æ§åˆ¶åŒºåŠé€æ˜èƒŒæ™¯ */
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            margin: 0;
            padding: 0;
            /* ä½¿ç”¨ä¸ nav.css åè°ƒçš„åŠé€æ˜èƒŒæ™¯ */
            background: rgba(122, 189, 154, 0.8);
            /* ç¤ºä¾‹èƒŒæ™¯ï¼Œæ‚¨å¯ä»¥æ›¿æ¢ä¸º /image/bg.png */
            color: #333;
            transition: background-color 0.3s;
        }

        /* æ ¸å¿ƒä¿®æ”¹ï¼šç¡®ä¿å†…å®¹åœ¨å›ºå®šé¡¶æ ä¸‹æ–¹ï¼Œä¸”å±…ä¸­æ˜¾ç¤º */
        .meeting-wrapper {
            padding-top: var(--header-height);
            /* ç•™å‡ºå›ºå®šé¡¶æ çš„ç©ºé—´ */
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding-bottom: 50px;
        }

        /* 2. å®¹å™¨å’Œå¡ç‰‡æ ·å¼ (æ²¿ç”¨æ¯›ç»ç’ƒé£æ ¼) */
        .meeting-container {
            width: 95%;
            max-width: 1200px;
            padding: 20px;
            display: flex;
            gap: 20px;
        }

        /* ä¼šè®®æ§åˆ¶å¡ç‰‡ */
        .control-card {
            background-color: rgba(255, 255, 255, var(--card-bg-opacity));
            border-radius: 12px;
            box-shadow: var(--card-shadow);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border: var(--card-border);
            padding: 20px;
            flex: 0 0 300px;
            /* å›ºå®šå®½åº¦ */
            max-height: 80vh;
            overflow-y: auto;
        }

        /* è§†é¢‘æ˜¾ç¤ºåŒºåŸŸ */
        .video-display-area {
            flex-grow: 1;
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .video-player-container {
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
            min-height: 400px;
            /* æœ€å°é«˜åº¦ä¿è¯æ˜¾ç¤ºæ•ˆæœ */
        }

        /* è§†é¢‘æ’­æ”¾å™¨å¡ç‰‡ */
        .video-card {
            background-color: rgba(0, 0, 0, 0.5);
            /* è§†é¢‘èƒŒæ™¯é€šå¸¸ç”¨æ·±è‰² */
            border-radius: 12px;
            box-shadow: var(--card-shadow);
            overflow: hidden;
            position: relative;
            flex: 1 1 45%;
            /* æ¡Œé¢ç«¯é»˜è®¤åŒåˆ—å¸ƒå±€ */
            min-width: 300px;
            aspect-ratio: 16 / 9;
            /* ä¿æŒè§†é¢‘æ¯”ä¾‹ */
        }

        .video-card video {
            width: 100%;
            height: 100%;
            object-fit: cover;
            /* å¡«å……æ•´ä¸ªå®¹å™¨ï¼Œå¯èƒ½è£å‰ª */
        }

        .video-label {
            position: absolute;
            bottom: 10px;
            left: 10px;
            color: white;
            background-color: rgba(0, 0, 0, 0.5);
            padding: 5px 10px;
            border-radius: 5px;
            font-size: 0.9em;
        }

        /* 3. ä¼šè®®æ§åˆ¶å…ƒç´ æ ·å¼ (é¿å…ä¸ nav.css å†²çª) */
        h2 {
            margin-top: 0;
            margin-bottom: 20px;
            font-weight: 600;
            color: #1a1a1a;
            border-bottom: 1px solid rgba(0, 0, 0, 0.1);
            padding-bottom: 10px;
        }

        .meeting-input-group {
            margin-bottom: 20px;
        }

        .meeting-input {
            width: 100%;
            padding: 12px;
            margin-bottom: 10px;
            border-radius: 8px;
            box-sizing: border-box;
            font-size: 16px;
            transition: all 0.2s;
            border: 1px solid rgba(0, 0, 0, 0.1);
            background-color: rgba(255, 255, 255, 0.95);
            color: #333;
        }

        .meeting-input::placeholder {
            color: #999;
        }

        .meeting-action-button {
            width: 100%;
            padding: 12px;
            margin-bottom: 10px;
            border-radius: 8px;
            box-sizing: border-box;
            font-size: 16px;
            transition: all 0.2s;
            border: none;
            background-color: var(--main-blue);
            color: white;
            cursor: pointer;
            font-weight: 600;
            box-shadow: 0 2px 4px rgba(0, 122, 255, 0.4);
        }

        .meeting-action-button:hover {
            opacity: 0.9;
        }

        .meeting-action-button:disabled {
            background-color: #a0c4ff;
            cursor: not-allowed;
            box-shadow: none;
        }

        .meeting-action-button.red-btn {
            background-color: var(--main-red);
            box-shadow: 0 2px 4px rgba(255, 59, 48, 0.4);
        }

        /* è®¾å¤‡æ§åˆ¶æŒ‰é’®ç»„ */
        .device-controls {
            display: flex;
            flex-wrap: wrap;
            justify-content: space-around;
            gap: 10px;
            margin-top: 20px;
            padding-top: 15px;
            border-top: 1px solid rgba(0, 0, 0, 0.1);
        }

        .device-btn {
            flex: 1 1 45%;
            /* åŒåˆ—å¸ƒå±€ */
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 10px 5px;
            border: none;
            border-radius: 8px;
            background-color: var(--control-bg);
            color: #333;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 14px;
            font-weight: 500;
        }

        .device-btn:hover:not(:disabled) {
            background-color: rgba(255, 255, 255, 0.4);
        }

        .device-btn.active {
            background-color: var(--main-green);
            color: white;
        }

        .device-btn.active:hover {
            background-color: #2ab74d;
        }

        .device-btn i {
            font-size: 1.5em;
            margin-bottom: 5px;
        }

        .status-log {
            padding: 10px;
            background-color: rgba(0, 0, 0, 0.05);
            border-radius: 8px;
            max-height: 150px;
            overflow-y: auto;
            white-space: pre-wrap;
            word-break: break-all;
            font-size: 0.8em;
            color: #555;
            margin-top: 15px;
        }

        /* 4. ç§»åŠ¨ç«¯å’Œå“åº”å¼ */
        @media (max-width: 800px) {
            .meeting-container {
                flex-direction: column;
                padding: 10px;
                gap: 10px;
            }

            .control-card {
                flex: 1 1 auto;
                max-height: none;
                /* ç§»åŠ¨ç«¯ä¸é™åˆ¶é«˜åº¦ */
            }

            .video-player-container {
                flex-direction: column;
                min-height: 200px;
            }

            .video-card {
                flex: 1 1 100%;
                /* ç§»åŠ¨ç«¯å•åˆ—å¸ƒå±€ */
            }
        }

        /* æ¨ªå±ä¼˜åŒ– (å¯é€‰) */
        @media (orientation: landscape) and (max-width: 900px) {
            .video-card {
                aspect-ratio: 16 / 9;
                /* ä¿æŒæ¯”ä¾‹ */
            }
        }

        /* å¼•å…¥ Font Awesome å›¾æ ‡ (ç”¨äºè®¾å¤‡æ§åˆ¶æŒ‰é’®) */
    </style>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
</head>

<body>
    <div class="meeting-wrapper">

        <div class="meeting-container">

            <div class="control-card">
                <h2>ğŸŒ åŠ å…¥/åˆ›å»ºä¼šè®®</h2>
                <div class="meeting-input-group">
                    <input type="text" id="room-code-input" class="meeting-input" placeholder="è¾“å…¥ä¸‰ä½ä¼šè®®ç  (å¦‚ XYZ)"
                        maxlength="3" style="text-transform: uppercase;">
                    <button id="create-room-btn" class="meeting-action-button">ç”Ÿæˆä¼šè®®ç å¹¶ä¸»æŒ</button>
                    <button id="join-room-btn" class="meeting-action-button">åŠ å…¥æˆ¿é—´å¹¶å‚ä¼š</button>
                </div>

                <div id="controls-section" style="display: none;">
                    <h2>ğŸ™ï¸ è®¾å¤‡æ§åˆ¶</h2>
                    <div class="device-controls">
                        <button id="camera-btn" class="device-btn">
                            <i class="fas fa-video"></i>
                            <span>æ‰“å¼€æ‘„åƒå¤´</span>
                        </button>
                        <button id="mic-btn" class="device-btn">
                            <i class="fas fa-microphone"></i>
                            <span>å¯ç”¨éº¦å…‹é£</span>
                        </button>
                        <button id="screen-share-btn" class="device-btn">
                            <i class="fas fa-desktop"></i>
                            <span>å…±äº«å±å¹•</span>
                        </button>
                        <button id="hangup-btn" class="meeting-action-button red-btn" style="margin-top: 15px;">
                            <i class="fas fa-phone-slash"></i>
                            ç»“æŸä¼šè®®
                        </button>
                    </div>
                </div>

                <h2>ğŸ’¬ çŠ¶æ€æ—¥å¿—</h2>
                <pre id="status-log" class="status-log">çŠ¶æ€ï¼šæœªè¿æ¥</pre>
            </div>

            <div class="video-display-area">
                <h1 id="meeting-title" style="color: white; text-shadow: 0 2px 4px rgba(0,0,0,0.5);">WebRTC è§†é¢‘ä¼šè®®</h1>
                <div class="video-player-container">
                    <div class="video-card" id="local-video-card">
                        <video id="local-video" autoplay muted playsinline></video>
                        <span class="video-label">æˆ‘çš„è§†é¢‘</span>
                    </div>

                    <div class="video-card" id="remote-video-card" style="display: none;">
                        <video id="remote-video" autoplay playsinline></video>
                        <span class="video-label">å¯¹æ–¹è§†é¢‘</span>
                    </div>
                </div>
            </div>

        </div>
    </div>

    <script>
        // -----------------------------------------------------------
        // 1. Firebase é…ç½®ä¸ STUN/TURN æœåŠ¡å™¨
        // -----------------------------------------------------------
        const firebaseConfig = {
            apiKey: "AIzaSyAeSI1akqwsPBrVyv7YKirV06fqdkL3YNI",
            authDomain: "quark-b7305.firebaseapp.com",
            projectId: "quark-b7305",
            storageBucket: "quark-b7305.firebasestorage.app",
            messagingSenderId: "843016834358",
            appId: "1:843016834358:web:9438c729be28c4d492f797",
            measurementId: "G-5BVT26KRT6"
        };

        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();

        const STUN_SERVERS = [
            { urls: 'stun:stun.l.google.com:19302' },
            { urls: 'stun:stun.minisipserver.com' },
            { urls: 'turn:numb.viagenie.ca', username: 'webrtc@live.com', credential: 'webrtc' } // TURN
        ];

        // -----------------------------------------------------------
        // 2. å…¨å±€å˜é‡ä¸ DOM å…ƒç´ 
        // -----------------------------------------------------------
        let peerConnection;
        let localStream = null; // åŒ…å«æ‘„åƒå¤´/éº¦å…‹é£/å±å¹•çš„æµ
        let currentRoomCode = null;
        let isCreator = false;

        // åª’ä½“çŠ¶æ€
        let isCameraOn = false;
        let isMicOn = false;
        let isScreenSharing = false;

        // DOM å…ƒç´ 
        const roomCodeInput = document.getElementById('room-code-input');
        const createRoomBtn = document.getElementById('create-room-btn');
        const joinRoomBtn = document.getElementById('join-room-btn');
        const controlsSection = document.getElementById('controls-section');
        const localVideo = document.getElementById('local-video');
        const remoteVideo = document.getElementById('remote-video');
        const remoteVideoCard = document.getElementById('remote-video-card');
        const statusLogDiv = document.getElementById('status-log');
        const cameraBtn = document.getElementById('camera-btn');
        const micBtn = document.getElementById('mic-btn');
        const screenShareBtn = document.getElementById('screen-share-btn');
        const hangupBtn = document.getElementById('hangup-btn');
        const meetingTitle = document.getElementById('meeting-title');


        // -----------------------------------------------------------
        // 3. UI/å·¥å…·å‡½æ•°
        // -----------------------------------------------------------

        /** è®°å½•çŠ¶æ€ */
        function logStatus(message) {
            statusLogDiv.innerHTML = `[${new Date().toLocaleTimeString()}] ${message}\n` + statusLogDiv.innerHTML;
            console.log(message);
        }

        /** ç”Ÿæˆä¸‰ä½éšæœºå¤§å†™å­—æ¯ç  */
        function generateRoomCode() {
            let result = '';
            const characters = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ';
            for (let i = 0; i < 3; i++) {
                result += characters.charAt(Math.floor(Math.random() * characters.length));
            }
            return result;
        }

        /** æ›´æ–°æŒ‰é’®çŠ¶æ€å’Œæ–‡æœ¬ */
        function updateButton(btn, state, iconOn, iconOff, textOn, textOff) {
            if (state) {
                btn.classList.add('active');
                btn.innerHTML = `<i class="${iconOn}"></i> <span>${textOn}</span>`;
            } else {
                btn.classList.remove('active');
                btn.innerHTML = `<i class="${iconOff}"></i> <span>${textOff}</span>`;
            }
        }

        /** é‡ç½®ä¼šè®® UI å’ŒçŠ¶æ€ */
        function resetUI() {
            createRoomBtn.disabled = false;
            joinRoomBtn.disabled = false;
            roomCodeInput.disabled = false;
            controlsSection.style.display = 'none';
            remoteVideoCard.style.display = 'none';

            localVideo.srcObject = null;
            remoteVideo.srcObject = null;

            isCameraOn = false;
            isMicOn = false;
            isScreenSharing = false;
            updateButton(cameraBtn, isCameraOn, 'fas fa-video', 'fas fa-video-slash', 'å…³é—­æ‘„åƒå¤´', 'æ‰“å¼€æ‘„åƒå¤´');
            updateButton(micBtn, isMicOn, 'fas fa-microphone', 'fas fa-microphone-slash', 'é™éŸ³', 'å¯ç”¨éº¦å…‹é£');
            updateButton(screenShareBtn, isScreenSharing, 'fas fa-desktop', 'fas fa-desktop', 'åœæ­¢å…±äº«', 'å…±äº«å±å¹•');

            if (peerConnection) {
                peerConnection.close();
                peerConnection = null;
            }
            if (localStream) {
                localStream.getTracks().forEach(track => track.stop());
                localStream = null;
            }
            currentRoomCode = null;
            logStatus('ä¼šè¯å·²ç»“æŸæˆ–é‡ç½®ã€‚');
        }


        // -----------------------------------------------------------
        // 4. åª’ä½“æµå’Œè½¨é“ç®¡ç†
        // -----------------------------------------------------------

        /** è·å–å¹¶æ·»åŠ æœ¬åœ°åª’ä½“æµ (æ‘„åƒå¤´/éº¦å…‹é£) */
        async function getLocalMedia(video = true, audio = true) {
            try {
                // å¼ºåˆ¶åªè·å–ä¸€ä¸ªæ–°æµï¼Œé˜²æ­¢è½¨é“æ··ä¹±
                const stream = await navigator.mediaDevices.getUserMedia({ video, audio });

                // å¦‚æœå·²ç»æœ‰æµåœ¨ç”¨ï¼Œå…ˆåœæ­¢å®ƒ
                if (localStream) {
                    localStream.getTracks().forEach(track => track.stop());
                }

                localStream = stream;
                localVideo.srcObject = localStream;
                isCameraOn = video;
                isMicOn = audio;

                // **å…³é”®ï¼šæ›¿æ¢æ‰€æœ‰å‘é€å™¨çš„è½¨é“**
                if (peerConnection) {
                    // ç§»é™¤æ—§è½¨é“
                    peerConnection.getSenders().forEach(sender => {
                        peerConnection.removeTrack(sender);
                    });

                    // æ·»åŠ æ–°è½¨é“
                    localStream.getTracks().forEach(track => {
                        peerConnection.addTrack(track, localStream);
                    });

                    // é‡æ–°åˆ›å»º Offer/Answer æ¥é€šçŸ¥è¿œç«¯æ–°è½¨é“
                    if (isCreator) {
                        await createOffer(currentRoomCode);
                    } else {
                        // æ¥æ”¶æ–¹é€šå¸¸éœ€è¦ç­‰å¾…å‘é€æ–¹é‡æ–°å‘é€ offer
                        logStatus("å‘é€æ–¹è¯·ç¨å€™é‡æ–°åˆ›å»º Offer...");
                    }
                }

                logStatus(`âœ… æœ¬åœ°åª’ä½“æµå·²æ›´æ–°ã€‚è§†é¢‘: ${video}, éŸ³é¢‘: ${audio}`);
            } catch (e) {
                logStatus(`âŒ è·å–æœ¬åœ°åª’ä½“å¤±è´¥: ${e.name}: ${e.message}`);
                // å¦‚æœå¤±è´¥ï¼Œæ›´æ–°çŠ¶æ€ä¸ºå…³é—­
                isCameraOn = false;
                isMicOn = false;
            } finally {
                // æ— è®ºæˆåŠŸå¤±è´¥ï¼Œéƒ½æ›´æ–°æŒ‰é’®çŠ¶æ€
                updateButton(cameraBtn, isCameraOn, 'fas fa-video', 'fas fa-video-slash', 'å…³é—­æ‘„åƒå¤´', 'æ‰“å¼€æ‘„åƒå¤´');
                updateButton(micBtn, isMicOn, 'fas fa-microphone', 'fas fa-microphone-slash', 'é™éŸ³', 'å¯ç”¨éº¦å…‹é£');
                isScreenSharing = false; // å±å¹•å…±äº«çŠ¶æ€é‡ç½®
                updateButton(screenShareBtn, isScreenSharing, 'fas fa-desktop', 'fas fa-desktop', 'åœæ­¢å…±äº«', 'å…±äº«å±å¹•');
            }
        }

        /** åˆ‡æ¢å±å¹•å…±äº« */
        async function toggleScreenShare() {
            if (isScreenSharing) {
                // åœæ­¢å±å¹•å…±äº«ï¼Œæ¢å¤æ‘„åƒå¤´/éº¦å…‹é£
                logStatus('åœæ­¢å±å¹•å…±äº«ï¼Œæ¢å¤æ‘„åƒå¤´/éº¦å…‹é£...');
                await getLocalMedia(isCameraOn, isMicOn); // æ¢å¤ä¹‹å‰çš„çŠ¶æ€
                isScreenSharing = false;
            } else {
                // å¼€å§‹å±å¹•å…±äº«
                try {
                    // è·å–å±å¹•å…±äº«æµ
                    const screenStream = await navigator.mediaDevices.getDisplayMedia({ video: true, audio: true });

                    // åœæ­¢æ—§æµçš„è½¨é“
                    if (localStream) {
                        localStream.getTracks().forEach(track => track.stop());
                    }
                    localStream = screenStream;
                    localVideo.srcObject = localStream;

                    // æ›¿æ¢å‘é€å™¨ä¸­çš„è§†é¢‘å’ŒéŸ³é¢‘è½¨é“
                    peerConnection.getSenders().forEach(sender => {
                        const track = localStream.getTracks().find(t => t.kind === sender.track.kind);
                        if (track) {
                            sender.replaceTrack(track);
                        } else {
                            // å¦‚æœå±å¹•å…±äº«æ²¡æœ‰éŸ³é¢‘ï¼Œä½†æ—§æµæœ‰éŸ³é¢‘ï¼Œåˆ™ç§»é™¤æ—§éŸ³é¢‘è½¨é“
                            if (sender.track && sender.track.kind === 'audio') {
                                peerConnection.removeTrack(sender);
                            }
                        }
                    });

                    // ç›‘å¬å±å¹•å…±äº«ç»“æŸäº‹ä»¶ (å¦‚ç”¨æˆ·ç‚¹å‡»æµè§ˆå™¨åœæ­¢æŒ‰é’®)
                    screenStream.getVideoTracks()[0].onended = () => {
                        logStatus('å±å¹•å…±äº«å·²é€šè¿‡æµè§ˆå™¨æ§ä»¶åœæ­¢ã€‚');
                        // æ¢å¤åˆ°æ‘„åƒå¤´/éº¦å…‹é£çŠ¶æ€
                        toggleScreenShare(); // è‡ªåŠ¨è°ƒç”¨åœæ­¢é€»è¾‘
                    };

                    logStatus('âœ… å±å¹•å…±äº«å·²å¼€å§‹ã€‚');
                    isScreenSharing = true;
                    isCameraOn = false; // å…±äº«å±å¹•æ—¶ï¼Œæ‘„åƒå¤´çŠ¶æ€è§†ä¸ºå…³é—­
                } catch (err) {
                    logStatus(`âŒ å±å¹•å…±äº«å¤±è´¥: ${err.message}`);
                    isScreenSharing = false;
                }
            }
            // æ›´æ–°æŒ‰é’® UI
            updateButton(screenShareBtn, isScreenSharing, 'fas fa-desktop', 'fas fa-desktop', 'åœæ­¢å…±äº«', 'å…±äº«å±å¹•');
            updateButton(cameraBtn, isCameraOn, 'fas fa-video', 'fas fa-video-slash', 'å…³é—­æ‘„åƒå¤´', 'æ‰“å¼€æ‘„åƒå¤´');
            updateButton(micBtn, isMicOn, 'fas fa-microphone', 'fas fa-microphone-slash', 'é™éŸ³', 'å¯ç”¨éº¦å…‹é£');
        }


        // -----------------------------------------------------------
        // 5. WebRTC ä¿¡ä»¤ä¸è¿æ¥
        // -----------------------------------------------------------

        /** åˆå§‹åŒ– RTCPeerConnection */
        function createPeerConnection(roomCode, isCreatorDevice) {
            peerConnection = new RTCPeerConnection({ iceServers: STUN_SERVERS });
            currentRoomCode = roomCode;
            isCreator = isCreatorDevice;

            logStatus(`åˆ›å»º WebRTC è¿æ¥ï¼Œèº«ä»½: ${isCreator ? 'ä¼šè®®ä¸»æŒ' : 'å‚ä¼šè€…'}ã€‚è¿æ¥ç : ${roomCode}`);
            meetingTitle.textContent = `ä¼šè®®ä¸­ï¼š${roomCode}`;
            createRoomBtn.disabled = true;
            joinRoomBtn.disabled = true;
            roomCodeInput.disabled = true;
            controlsSection.style.display = 'block';

            // 1. ICE å€™é€‰è€…å‘é€
            peerConnection.onicecandidate = async (event) => {
                if (event.candidate) {
                    const role = isCreator ? 'creator' : 'joiner';
                    const candidatesRef = database.ref(`rooms/${roomCode}/${role}/iceCandidates`);
                    await candidatesRef.push(event.candidate.toJSON());
                    logStatus('å‘é€ ICE å€™é€‰è€…...');
                }
            };

            // 2. è¿œç«¯æµæ¥æ”¶
            peerConnection.ontrack = (event) => {
                if (remoteVideo.srcObject !== event.streams[0]) {
                    remoteVideo.srcObject = event.streams[0];
                    remoteVideoCard.style.display = 'block';
                    logStatus('âœ… æ¥æ”¶åˆ°è¿œç«¯åª’ä½“æµã€‚');
                }
            };

            // 3. è¿æ¥çŠ¶æ€å˜æ›´
            peerConnection.oniceconnectionstatechange = () => {
                logStatus(`ICE è¿æ¥çŠ¶æ€: ${peerConnection.iceConnectionState}`);
                if (peerConnection.iceConnectionState === 'connected') {
                    logStatus('ğŸ‰ P2P è¿æ¥å»ºç«‹æˆåŠŸï¼');
                } else if (peerConnection.iceConnectionState === 'failed' || peerConnection.iceConnectionState === 'closed') {
                    logStatus('âŒ P2P è¿æ¥æ–­å¼€æˆ–å¤±è´¥ã€‚');
                }
            };
        }

        /** ç›‘å¬è¿œç«¯ä¿¡ä»¤ */
        function listenForRemoteSignals(roomCode, remoteRole) {
            // ç›‘å¬ ICE å€™é€‰è€…
            database.ref(`rooms/${roomCode}/${remoteRole}/iceCandidates`).on('child_added', (snapshot) => {
                const candidate = snapshot.val();
                if (candidate) {
                    try {
                        peerConnection.addIceCandidate(new RTCIceCandidate(candidate));
                    } catch (e) {
                        logStatus(`âŒ æ·»åŠ  ICE å€™é€‰è€…å¤±è´¥: ${e.message}`);
                    }
                }
            });
        }

        /** ä¸»æŒæ–¹åˆ›å»º Offer */
        async function createOffer(roomCode) {
            try {
                const offer = await peerConnection.createOffer();
                await peerConnection.setLocalDescription(offer);
                await database.ref(`rooms/${roomCode}/creator/sdp`).set(peerConnection.localDescription.toJSON());
                logStatus('âœ… å‘é€ Offer å®Œæˆã€‚ç­‰å¾…å‚ä¼šè€… Answer...');

                // ç›‘å¬å‚ä¼šè€…çš„ Answer
                database.ref(`rooms/${roomCode}/joiner/sdp`).once('value').then(async (snapshot) => {
                    const answer = snapshot.val();
                    if (answer && !peerConnection.currentRemoteDescription) {
                        await peerConnection.setRemoteDescription(new RTCSessionDescription(answer));
                        logStatus('âœ… æ¥æ”¶åˆ° Answerï¼Œè®¾ç½®è¿œç«¯æè¿°ã€‚');
                        listenForRemoteSignals(roomCode, 'joiner');
                    }
                });
            } catch (e) {
                logStatus(`âŒ åˆ›å»º Offer å¤±è´¥: ${e.message}`);
            }
        }

        /** å‚ä¼šæ–¹åˆ›å»º Answer */
        async function createAnswer(roomCode) {
            try {
                // ç›‘å¬ä¸»æŒæ–¹çš„ Offer
                database.ref(`rooms/${roomCode}/creator/sdp`).once('value').then(async (snapshot) => {
                    const offer = snapshot.val();
                    if (!offer) {
                        logStatus(`âŒ æˆ¿é—´ ${roomCode} ä¸å­˜åœ¨ Offerã€‚`);
                        resetUI();
                        return;
                    }

                    await peerConnection.setRemoteDescription(new RTCSessionDescription(offer));
                    logStatus('âœ… æ¥æ”¶åˆ° Offerï¼Œå¼€å§‹åˆ›å»º Answer...');

                    const answer = await peerConnection.createAnswer();
                    await peerConnection.setLocalDescription(answer);
                    await database.ref(`rooms/${roomCode}/joiner/sdp`).set(peerConnection.localDescription.toJSON());
                    logStatus('âœ… å‘é€ Answer å®Œæˆã€‚');

                    listenForRemoteSignals(roomCode, 'creator');
                });
            } catch (e) {
                logStatus(`âŒ åˆ›å»º Answer å¤±è´¥: ${e.message}`);
            }
        }


        // -----------------------------------------------------------
        // 6. äº‹ä»¶ç›‘å¬å™¨
        // -----------------------------------------------------------

        // ç›‘å¬ï¼šåˆ›å»ºæˆ¿é—´
        createRoomBtn.addEventListener('click', async () => {
            const roomCode = generateRoomCode();
            roomCodeInput.value = roomCode;

            // æ¸…ç†æ—§çš„æˆ¿é—´æ•°æ®
            await database.ref(`rooms/${roomCode}`).remove();
            logStatus(`æ­£åœ¨åˆå§‹åŒ–æˆ¿é—´ ${roomCode} çš„ä¿¡ä»¤æ•°æ®...`);

            // 1. åˆå§‹åŒ– WebRTC
            createPeerConnection(roomCode, true);

            // 2. è·å–å¹¶æ·»åŠ åˆå§‹åª’ä½“æµ (é»˜è®¤åªå¼€éº¦å…‹é£)
            await getLocalMedia(false, true);

            // 3. å°†æœ¬åœ°æµçš„è½¨é“æ·»åŠ åˆ° PeerConnection
            if (localStream) {
                localStream.getTracks().forEach(track => {
                    peerConnection.addTrack(track, localStream);
                });
            }

            // 4. å‘é€ Offer
            await createOffer(roomCode);
        });

        // ç›‘å¬ï¼šåŠ å…¥æˆ¿é—´
        joinRoomBtn.addEventListener('click', async () => {
            const roomCode = roomCodeInput.value.toUpperCase().trim();
            if (roomCode.length !== 3) {
                logStatus('âŒ ä¼šè®®ç å¿…é¡»æ˜¯ä¸‰ä½å¤§å†™å­—æ¯ã€‚');
                return;
            }

            // 1. åˆå§‹åŒ– WebRTC
            createPeerConnection(roomCode, false);

            // 2. è·å–å¹¶æ·»åŠ åˆå§‹åª’ä½“æµ (é»˜è®¤åªå¼€éº¦å…‹é£)
            await getLocalMedia(false, true);

            // 3. å°†æœ¬åœ°æµçš„è½¨é“æ·»åŠ åˆ° PeerConnection
            if (localStream) {
                localStream.getTracks().forEach(track => {
                    peerConnection.addTrack(track, localStream);
                });
            }

            // 4. å‘é€ Answer
            await createAnswer(roomCode);
        });

        // ç›‘å¬ï¼šæŒ‚æ–­
        hangupBtn.addEventListener('click', () => {
            if (currentRoomCode) {
                // æ¸…ç† Firebase æ•°æ®
                database.ref(`rooms/${currentRoomCode}`).remove();
            }
            resetUI();
        });

        // ç›‘å¬ï¼šæ‘„åƒå¤´å¼€å…³
        cameraBtn.addEventListener('click', async () => {
            isCameraOn = !isCameraOn;
            await getLocalMedia(isCameraOn, isMicOn || isScreenSharing);
        });

        // ç›‘å¬ï¼šéº¦å…‹é£å¼€å…³
        micBtn.addEventListener('click', async () => {
            isMicOn = !isMicOn;
            // æ‰¾åˆ°éŸ³é¢‘è½¨é“å¹¶å¯ç”¨/ç¦ç”¨
            if (localStream) {
                const audioTrack = localStream.getAudioTracks()[0];
                if (audioTrack) {
                    audioTrack.enabled = isMicOn;
                } else {
                    // å¦‚æœæµä¸­æ²¡æœ‰éŸ³é¢‘ï¼Œé‡æ–°è·å–åª’ä½“æµ
                    await getLocalMedia(isCameraOn, isMicOn);
                }
            } else {
                await getLocalMedia(isCameraOn, isMicOn);
            }
            updateButton(micBtn, isMicOn, 'fas fa-microphone', 'fas fa-microphone-slash', 'é™éŸ³', 'å¯ç”¨éº¦å…‹é£');
        });

        // ç›‘å¬ï¼šå±å¹•å…±äº«
        screenShareBtn.addEventListener('click', toggleScreenShare);

    </script>
</body>

</html>
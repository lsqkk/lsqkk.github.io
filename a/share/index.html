<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å¤¸å…‹é—ªä¼  | Quarkhare P2P</title>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
    <link rel="stylesheet" href="/css/basic.css">
    <style>
        /* 1. æç®€æ¯›ç»ç’ƒ CSS - ä½¿ç”¨ qs- å‰ç¼€éš”ç¦»æ ·å¼ */
        body {
            margin: 0;
            padding: 0;
            /* --- ä¿®æ”¹ç‚¹ 1ï¼šç§»é™¤å›ºå®šå±…ä¸­æ ·å¼ --- */
            /* ç§»é™¤äº† display: flex, justify-content: center, align-items: center */
            /* ç§»é™¤äº† min-height: 100vh; å’Œ html, body { height: 100%; } */

            /* èƒŒæ™¯è‰²å¾®è°ƒï¼Œç¡®ä¿ä¸é¡¶æ é¢œè‰²åŒºåˆ†ï¼Œä¿æŒçº¯å‡€å¤§æ–¹ */
            background: url('/image/bg.png') no-repeat center center fixed;
            background-size: cover;
            color: #333;
            transition: background-color 0.3s;
        }

        /* 2. å®¹å™¨å’Œå¡ç‰‡æ ·å¼ - æ ¸å¿ƒä¿®æ”¹ï¼šç¡®ä¿é¡¶éƒ¨é—´è·å’Œå†…å®¹å±…ä¸­ (å¦‚æœå†…å®¹å®½åº¦æœ‰é™åˆ¶) */
        .qs-container {
            width: 90%;
            max-width: 480px;
            /* è®©å†…å®¹åœ¨é¡µé¢ä¸Šå±…ä¸­æ˜¾ç¤º (å¦‚æœ width < 100%) */
            margin: 0 auto;
            padding: 20px;

            /* --- ä¿®æ”¹ç‚¹ 2ï¼šä¿æŒè¶³å¤Ÿçš„é¡¶éƒ¨ padding é¿å…é®æŒ¡ --- */
            /* é€‚é… nav.css ä¸­ header çš„é«˜åº¦ (çº¦60px) + 20px é¢å¤–é—´è· */
            padding-top: 80px;
            padding-bottom: 40px;
            /* åº•éƒ¨ç•™ç™½ */
            box-sizing: border-box;
        }

        .qs-card {
            /* ä¿æŒæç®€æ¯›ç»ç’ƒæ•ˆæœ */
            background-color: rgba(255, 255, 255, 0.7);
            border-radius: 16px;
            box-shadow: 0 10px 40px 0 rgba(31, 38, 135, 0.18);
            backdrop-filter: blur(15px);
            -webkit-backdrop-filter: blur(15px);
            border: 1px solid rgba(255, 255, 255, 0.3);
            padding: 30px;
            text-align: center;
            margin-bottom: 25px;
            transition: box-shadow 0.3s ease;
        }

        .qs-card:hover {
            box-shadow: 0 12px 50px 0 rgba(31, 38, 135, 0.25);
        }

        /* æ ‡é¢˜æ ·å¼ä¼˜åŒ– */
        .qs-main-title {
            font-size: 32px;
            font-weight: 800;
            color: white;
            margin-bottom: 35px;
            text-shadow: 1px 1px 3px rgba(0, 0, 0, 0.1);
        }

        .qs-card h2 {
            margin-top: 0;
            margin-bottom: 25px;
            font-weight: 600;
            color: #1a1a1a;
            font-size: 22px;
        }

        /* 3. è¾“å…¥æ¡†å’ŒæŒ‰é’®æ ·å¼ (å…¨éƒ¨ä½¿ç”¨ qs- å‰ç¼€ï¼Œé¿å…ä¸ nav.css ç±»åå†²çª) */
        .qs-input-field,
        .qs-btn {
            width: 100%;
            padding: 14px;
            margin-bottom: 15px;
            border-radius: 10px;
            box-sizing: border-box;
            font-size: 16px;
            transition: all 0.2s;
        }

        .qs-input-field {
            border: 1px solid rgba(0, 0, 0, 0.2);
            background-color: rgba(255, 255, 255, 0.95);
            color: #333;
        }

        .qs-input-field:focus {
            border-color: #007aff;
            box-shadow: 0 0 0 3px rgba(0, 122, 255, 0.3);
            outline: none;
        }

        #file-input {
            display: none;
        }

        .qs-file-select-label {
            display: block;
            background-color: #34c759;
            color: white;
            padding: 14px;
            margin-bottom: 15px;
            border-radius: 10px;
            font-size: 16px;
            font-weight: 700;
            cursor: pointer;
            transition: background-color 0.2s, box-shadow 0.2s;
        }

        .qs-file-select-label:hover {
            background-color: #28a745;
            box-shadow: 0 3px 6px rgba(52, 199, 89, 0.4);
        }

        .qs-btn {
            border: none;
            background-color: #007aff;
            color: white;
            cursor: pointer;
            font-weight: 700;
            box-shadow: 0 3px 6px rgba(0, 122, 255, 0.3);
        }

        .qs-btn:hover:not(:disabled) {
            background-color: #005bb5;
            box-shadow: 0 4px 8px rgba(0, 122, 255, 0.4);
        }

        .qs-btn:disabled {
            background-color: #a0c4ff;
            cursor: not-allowed;
            box-shadow: none;
        }

        .qs-secondary-btn {
            background-color: #ff3b30;
            margin-top: 10px;
            box-shadow: 0 3px 6px rgba(255, 59, 48, 0.3);
        }

        .qs-secondary-btn:hover:not(:disabled) {
            background-color: #d8291e;
            box-shadow: 0 4px 8px rgba(255, 59, 48, 0.4);
        }

        /* 4. çŠ¶æ€å’Œè¿›åº¦æ˜¾ç¤º */
        #status {
            margin-top: 20px;
            padding: 15px;
            background-color: rgba(255, 255, 255, 0.9);
            border-radius: 10px;
            text-align: left;
            white-space: pre-wrap;
            word-break: break-all;
            border: 1px solid rgba(0, 0, 0, 0.1);
            max-height: 250px;
            overflow-y: auto;
            font-size: 14px;
            color: #666;
            line-height: 1.5;
        }

        .qs-progress-container {
            height: 10px;
            background-color: rgba(0, 0, 0, 0.1);
            border-radius: 5px;
            margin-top: 15px;
            margin-bottom: 20px;
            overflow: hidden;
            box-shadow: inset 0 1px 3px rgba(0, 0, 0, 0.1);
        }

        .qs-progress-bar {
            height: 100%;
            width: 0%;
            background-color: #34c759;
            transition: width 0.1s;
            border-radius: 5px;
        }

        #file-list {
            text-align: left;
            margin-bottom: 20px;
            padding: 10px 15px;
            border: 1px dashed rgba(0, 0, 0, 0.15);
            border-radius: 10px;
            background-color: rgba(255, 255, 255, 0.85);
            font-size: 14px;
        }

        #file-list li {
            list-style-type: disc;
            margin-left: 20px;
            padding: 5px 0;
            border-bottom: 1px dotted rgba(0, 0, 0, 0.1);
            color: #444;
        }

        #file-list li:last-child {
            border-bottom: none;
        }

        .qs-download-list {
            text-align: left;
            margin-top: 15px;
        }

        .qs-download-list a {
            display: block;
            margin: 8px 0;
            padding: 10px;
            background-color: rgba(0, 122, 255, 0.1);
            border-radius: 8px;
            color: #007aff;
            text-decoration: none;
            font-weight: 500;
            transition: background-color 0.2s;
        }

        .qs-download-list a:hover {
            background-color: rgba(0, 122, 255, 0.2);
        }

        /* 5. ç§»åŠ¨ç«¯å…¼å®¹æ€§è°ƒæ•´ï¼šç¡®ä¿ç§»åŠ¨ç«¯ä¹Ÿç•™å‡ºé¡¶æ ç©ºé—´ */
        @media (max-width: 768px) {
            .qs-container {
                /* ç¡®ä¿ç§»åŠ¨ç«¯åœ¨ Hamburger èœå•åä¹Ÿèƒ½çœ‹åˆ°å†…å®¹ */
                padding-top: 80px;
            }
        }
    </style>
</head>

<body>
    <script src="/js/nav.js"></script>
    <div class="qs-container">
        <div class="qs-main-title">å¤¸å…‹é—ªä¼ </div>

        <div class="qs-card" id="join-section">
            <h2>è¿æ¥è®¾å¤‡</h2>
            <input type="text" id="room-code-input" class="qs-input-field" placeholder="è¾“å…¥ä¸‰ä½è¿æ¥ç  (å¦‚ ABC)" maxlength="3"
                style="text-transform: uppercase;">
            <button id="join-btn" class="qs-btn">åŠ å…¥æˆ¿é—´å¹¶æ¥æ”¶</button>
            <button id="create-btn" class="qs-btn">ç”Ÿæˆè¿æ¥ç å¹¶å‘é€</button>
        </div>

        <div class="qs-card" id="transfer-section" style="display: none;">
            <h2 id="transfer-title">ç­‰å¾…è¿æ¥...</h2>

            <div id="file-selection-area">
                <input type="file" id="file-input" multiple>
                <label for="file-input" class="qs-file-select-label">é€‰æ‹©æ–‡ä»¶ (å¯å¤šé€‰)</label>
                <ul id="file-list" style="display: none;"></ul>
                <button id="send-btn" class="qs-btn" disabled>ç­‰å¾…è¿æ¥...</button>
            </div>

            <p id="current-file-info" style="font-size: 14px; color: #666;"></p>
            <div class="qs-progress-container">
                <div id="progress-bar" class="qs-progress-bar"></div>
            </div>

            <div id="download-area" style="display: none;">
                <h2>å·²æ¥æ”¶æ–‡ä»¶åˆ—è¡¨</h2>
                <div id="download-list" class="qs-download-list"></div>
            </div>

            <button id="clean-room-btn" class="qs-btn qs-secondary-btn" style="display: none;">æ¸…é™¤æˆ¿é—´æ•°æ®å¹¶é‡ç½®</button>
        </div>

        <div class="qs-card" id="status-card">
            <h2>çŠ¶æ€ä¿¡æ¯</h2>
            <div id="status">è¿æ¥çŠ¶æ€ï¼šæœªè¿æ¥</div>
        </div>

    </div>

    <script>
        // -----------------------------------------------------------
        // 1. Firebase é…ç½®ä¸ STUN
        // -----------------------------------------------------------
        const firebaseConfig = {
            apiKey: "AIzaSyAeSI1akqwsPBrVyv7YKirV06fqdkL3YNI",
            authDomain: "quark-b7305.firebaseapp.com",
            projectId: "quark-b7305",
            storageBucket: "quark-b7305.firebasestorage.app",
            messagingSenderId: "843016834358",
            appId: "1:843016834358:web:9438c729be28c4d492f797",
            measurementId: "G-5BVT26KRT6"
        };

        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();

        const STUN_SERVERS = [
            { urls: 'stun:stun.minisipserver.com' },
            { urls: 'stun:stun.zoiper.com' },
            { urls: 'stun:stun.voipbuster.com' },
            { urls: 'stun:stun.sipgate.net' },
            { urls: 'stun:stun.schlund.de' },
            { urls: 'stun:stun.voipstunt.com' },
            { urls: 'stun:stun.1und1.de' },
            { urls: 'stun:stun.gmx.net' },
            { urls: 'stun:stun.l.google.com:19302' },
        ];


        // -----------------------------------------------------------
        // 2. å…¨å±€å˜é‡ä¸ DOM å…ƒç´ 
        // -----------------------------------------------------------
        let peerConnection;
        let dataChannel;
        let isSender = false;
        let currentRoomCode = null;
        let hasSentCodePrompt = false;

        // å‘é€ç›¸å…³
        let filesToSend = [];
        let currentFileIndex = 0;

        // æ¥æ”¶ç›¸å…³
        let currentFileBuffer = [];
        let currentFileName = '';
        let currentFileSize = 0;
        let totalFilesToReceive = 0;
        let filesReceivedCount = 0;

        const CHUNK_SIZE = 64 * 1024;
        const METADATA_LABEL = 'metadata';

        const joinSection = document.getElementById('join-section');
        const transferSection = document.getElementById('transfer-section');
        const transferTitle = document.getElementById('transfer-title');
        const roomCodeInput = document.getElementById('room-code-input');
        const joinBtn = document.getElementById('join-btn');
        const createBtn = document.getElementById('create-btn');
        const fileInput = document.getElementById('file-input');
        const fileListUL = document.getElementById('file-list');
        const sendBtn = document.getElementById('send-btn');
        const statusDiv = document.getElementById('status');
        const progressBar = document.getElementById('progress-bar');
        const downloadArea = document.getElementById('download-area');
        const downloadListDiv = document.getElementById('download-list');
        const cleanRoomBtn = document.getElementById('clean-room-btn');
        const currentFileInfoP = document.getElementById('current-file-info');

        // -----------------------------------------------------------
        // 3. æ ¸å¿ƒå‡½æ•°ï¼šUI å·¥å…·
        // -----------------------------------------------------------

        /** è®°å½•çŠ¶æ€ */
        function logStatus(message) {
            statusDiv.innerHTML = `[${new Date().toLocaleTimeString()}] ${message}\n` + statusDiv.innerHTML;
            if (statusDiv.scrollTop > 0) statusDiv.scrollTop = 0;
            console.log(message);
        }

        /** ç”Ÿæˆä¸‰ä½éšæœºå¤§å†™å­—æ¯ç  */
        function generateRoomCode() {
            let result = '';
            const characters = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ';
            for (let i = 0; i < 3; i++) {
                result += characters.charAt(Math.floor(Math.random() * characters.length));
            }
            return result;
        }

        /** æ›´æ–°è¿›åº¦æ¡ */
        function updateProgress(percentage) {
            progressBar.style.width = `${Math.min(100, percentage)}%`;
        }

        /** æ¸…ç†æˆ¿é—´æ•°æ®å¹¶é‡ç½® */
        async function cleanRoomData(roomCode) {
            if (roomCode) {
                logStatus(`æ­£åœ¨æ¸…ç†æˆ¿é—´ ${roomCode} çš„ Firebase æ•°æ®...`);
                try {
                    await database.ref(`rooms/${roomCode}`).remove();
                    logStatus('âœ… æˆ¿é—´æ•°æ®æ¸…ç†å®Œæ¯•ã€‚');
                } catch (e) {
                    logStatus(`âŒ æ¸…ç†å¤±è´¥: ${e.message}`);
                }
            }
            resetUI();
        }

        /** é‡ç½®ç•Œé¢åˆ°åˆå§‹çŠ¶æ€ */
        function resetUI() {
            joinSection.style.display = 'block';
            transferSection.style.display = 'none';
            transferTitle.textContent = 'ç­‰å¾…è¿æ¥...';
            sendBtn.textContent = 'ç­‰å¾…è¿æ¥...';
            sendBtn.disabled = true;
            fileInput.value = '';
            fileListUL.style.display = 'none';
            fileListUL.innerHTML = '';
            currentFileInfoP.textContent = '';
            downloadArea.style.display = 'none';
            downloadListDiv.innerHTML = '';
            cleanRoomBtn.style.display = 'none';

            currentRoomCode = null;
            filesToSend = [];
            currentFileIndex = 0;
            currentFileBuffer = [];
            totalFilesToReceive = 0;
            filesReceivedCount = 0;
            hasSentCodePrompt = false;

            if (peerConnection) {
                peerConnection.close();
                peerConnection = null;
            }
            if (dataChannel) {
                dataChannel.close();
                dataChannel = null;
            }
            logStatus('ç•Œé¢å·²é‡ç½®ã€‚');
        }

        // -----------------------------------------------------------
        // 4. WebRTC åˆå§‹åŒ–
        // -----------------------------------------------------------

        /** åˆå§‹åŒ– RTCPeerConnection */
        function createPeerConnection(roomCode, isSenderDevice) {
            peerConnection = new RTCPeerConnection({ iceServers: STUN_SERVERS.map(url => ({ urls: url.urls })) });
            currentRoomCode = roomCode;
            isSender = isSenderDevice;

            logStatus(`åˆ›å»º WebRTC è¿æ¥ï¼Œèº«ä»½: ${isSender ? 'å‘é€æ–¹' : 'æ¥æ”¶æ–¹'}ã€‚è¿æ¥ç : ${roomCode}`);
            cleanRoomBtn.style.display = 'block';

            peerConnection.onicecandidate = async (event) => {
                if (event.candidate) {
                    if (isSender && !hasSentCodePrompt) {
                        transferTitle.textContent = `ğŸ“¢ è¿æ¥ç ï¼š${roomCode}`;
                        logStatus('ICE å€™é€‰è€…æ­£åœ¨å‘é€ä¸­ï¼Œè¯·åœ¨æ¥æ”¶æ–¹è¾“å…¥è¿æ¥ç ã€‚');
                        hasSentCodePrompt = true;
                    }

                    const role = isSender ? 'sender' : 'receiver';
                    const candidatesRef = database.ref(`rooms/${roomCode}/${role}/iceCandidates`);
                    await candidatesRef.push(event.candidate.toJSON());
                    logStatus('å‘é€ ICE å€™é€‰è€…...');
                }
            };

            peerConnection.oniceconnectionstatechange = () => {
                logStatus(`ICE è¿æ¥çŠ¶æ€: ${peerConnection.iceConnectionState}`);
                if (peerConnection.iceConnectionState === 'connected') {
                    logStatus('âœ… P2P è¿æ¥å»ºç«‹æˆåŠŸï¼');
                    transferTitle.textContent = `è¿æ¥æˆåŠŸï¼`;
                    if (isSender) {
                        sendBtn.textContent = filesToSend.length > 0 ? `å‘é€ ${filesToSend.length} ä¸ªæ–‡ä»¶` : 'è¯·é€‰æ‹©æ–‡ä»¶';
                        sendBtn.disabled = filesToSend.length === 0;
                    } else {
                        transferTitle.textContent = 'ç­‰å¾…å‘é€æ–¹ä¼ è¾“æ–‡ä»¶...';
                    }
                } else if (peerConnection.iceConnectionState === 'failed' || peerConnection.iceConnectionState === 'closed') {
                    logStatus('âŒ P2P è¿æ¥æ–­å¼€æˆ–å¤±è´¥ã€‚è¯·æ£€æŸ¥è¿æ¥ç å’Œç½‘ç»œç¯å¢ƒã€‚');
                }
            };

            if (isSender) {
                dataChannel = peerConnection.createDataChannel('fileTransfer', { ordered: true });
                setupDataChannel(dataChannel);
                logStatus('å·²åˆ›å»º DataChannel...');
            } else {
                peerConnection.ondatachannel = (event) => {
                    dataChannel = event.channel;
                    setupDataChannel(dataChannel);
                    logStatus('å·²æ¥æ”¶ DataChannel...');
                };
            }
        }

        /** DataChannel çš„é€šç”¨è®¾ç½® */
        function setupDataChannel(channel) {
            channel.onopen = () => {
                logStatus('DataChannel æ‰“å¼€ï¼Œå¯ä»¥å¼€å§‹ä¼ è¾“æ•°æ®ã€‚');
            };
            channel.onclose = () => {
                logStatus('DataChannel å…³é—­ã€‚');
            };
            channel.onerror = (error) => {
                logStatus(`DataChannel é”™è¯¯: ${error}`);
            };

            if (!isSender) {
                channel.onmessage = handleDataChannelMessage;
            }
        }

        async function createSenderOffer(roomCode) {
            createPeerConnection(roomCode, true);
            transferTitle.textContent = `è¿æ¥ç ï¼š${roomCode}ã€‚æ­£åœ¨ç­‰å¾…ICEç”Ÿæˆ...`;

            try {
                const offer = await peerConnection.createOffer();
                await peerConnection.setLocalDescription(offer);
                await database.ref(`rooms/${roomCode}/sender/sdp`).set(peerConnection.localDescription.toJSON());

                database.ref(`rooms/${roomCode}/receiver/sdp`).on('value', async (snapshot) => {
                    const answer = snapshot.val();
                    if (answer && !peerConnection.currentRemoteDescription) {
                        await peerConnection.setRemoteDescription(new RTCSessionDescription(answer));
                        listenForIceCandidates(roomCode, 'receiver');
                    }
                });
            } catch (e) {
                logStatus(`âŒ å‘é€æ–¹ Offer å¤±è´¥: ${e.message}`);
            }
        }

        async function createReceiverAnswer(roomCode) {
            createPeerConnection(roomCode, false);
            transferTitle.textContent = `è¿æ¥ç ï¼š${roomCode}ã€‚æ­£åœ¨ç­‰å¾…å‘é€æ–¹å“åº”...`;

            database.ref(`rooms/${roomCode}/sender/sdp`).once('value').then(async (snapshot) => {
                const offer = snapshot.val();
                if (!offer) {
                    logStatus(`âŒ æˆ¿é—´ ${roomCode} ä¸å­˜åœ¨ Offerã€‚`);
                    return;
                }

                try {
                    await peerConnection.setRemoteDescription(new RTCSessionDescription(offer));
                    const answer = await peerConnection.createAnswer();
                    await peerConnection.setLocalDescription(answer);
                    await database.ref(`rooms/${roomCode}/receiver/sdp`).set(peerConnection.localDescription.toJSON());
                    listenForIceCandidates(roomCode, 'sender');
                } catch (e) {
                    logStatus(`âŒ æ¥æ”¶æ–¹ Answer å¤±è´¥: ${e.message}`);
                }
            });
        }

        function listenForIceCandidates(roomCode, remoteRole) {
            database.ref(`rooms/${roomCode}/${remoteRole}/iceCandidates`).on('child_added', (snapshot) => {
                const candidate = snapshot.val();
                if (candidate) {
                    try {
                        peerConnection.addIceCandidate(new RTCIceCandidate(candidate));
                    } catch (e) {
                        logStatus(`âŒ æ·»åŠ  ICE å€™é€‰è€…å¤±è´¥: ${e.message}`);
                    }
                }
            });
        }

        // -----------------------------------------------------------
        // 5. å¤šæ–‡ä»¶ä¼ è¾“é€»è¾‘ (å‘é€æ–¹)
        // -----------------------------------------------------------

        /** å¼€å§‹ä¼ è¾“ä¸‹ä¸€ä¸ªæ–‡ä»¶ */
        async function sendNextFile() {
            if (currentFileIndex < filesToSend.length) {
                const file = filesToSend[currentFileIndex];
                logStatus(`å¼€å§‹å‘é€æ–‡ä»¶ [${currentFileIndex + 1}/${filesToSend.length}]: ${file.name}`);
                await sendFileChunked(file, currentFileIndex, filesToSend.length);
            } else {
                // æ‰€æœ‰æ–‡ä»¶å‘é€å®Œæ¯•
                logStatus('âœ… æ‰€æœ‰æ–‡ä»¶å‘é€å®Œæˆï¼');
                transferTitle.textContent = 'æ‰€æœ‰æ–‡ä»¶ä¼ è¾“å®Œæˆï¼';
                currentFileInfoP.textContent = '';
                sendBtn.textContent = `é‡æ–°å‘é€ (${filesToSend.length} ä¸ªæ–‡ä»¶)`;
                sendBtn.disabled = false;

                cleanRoomData(currentRoomCode);
            }
        }

        /** åˆ†å—å‘é€å•ä¸ªæ–‡ä»¶ */
        async function sendFileChunked(file, index, total) {
            if (dataChannel.readyState !== 'open') {
                logStatus('âŒ DataChannel æœªæ‰“å¼€æˆ–æœªè¿æ¥ã€‚');
                currentFileIndex = total; // ç»ˆæ­¢å‘é€
                return;
            }

            const fileSize = file.size;
            let offset = 0;

            sendBtn.disabled = true;

            // 1. å‘é€æ–‡ä»¶å…ƒæ•°æ® (åŒ…å«å¤šæ–‡ä»¶ä¿¡æ¯)
            const metadata = {
                label: METADATA_LABEL,
                fileName: file.name,
                fileSize: fileSize,
                fileIndex: index + 1, // 1-based index
                totalFiles: total,
            };
            dataChannel.send(JSON.stringify(metadata));

            const fileReader = new FileReader();

            fileReader.onload = async (e) => {
                // ç¡®ä¿åœ¨ DataChannel å‘é€ç¼“å†²åŒºå…è®¸æ—¶æ‰å‘é€
                if (dataChannel.bufferedAmount < dataChannel.bufferedAmountLowThreshold) {
                    dataChannel.send(e.target.result);
                    offset += e.target.result.byteLength;

                    const percentage = (offset / fileSize) * 100;
                    updateProgress(percentage);

                    const sizeMB = (fileSize / (1024 * 1024)).toFixed(2);
                    currentFileInfoP.textContent = `æ–‡ä»¶ ${index + 1}/${total} - ${file.name} (${sizeMB} MB)`;
                    transferTitle.textContent = `å‘é€ä¸­: ${file.name} | ${percentage.toFixed(1)}%`;

                    if (offset < fileSize) {
                        readSlice(offset);
                    } else {
                        // å½“å‰æ–‡ä»¶å‘é€å®Œæ¯•ï¼Œå‡†å¤‡ä¸‹ä¸€ä¸ª
                        logStatus(`æ–‡ä»¶ [${index + 1}/${total}] å‘é€å®Œæ¯•ã€‚`);
                        currentFileIndex++;
                        await sendNextFile();
                    }
                } else {
                    // å¦‚æœç¼“å†²åŒºæ»¡äº†ï¼Œç­‰å¾… low buffer event
                    await new Promise(resolve => dataChannel.onbufferedamountlow = resolve);
                    fileReader.onload(e); // é‡æ–°è°ƒç”¨ onload å°è¯•å‘é€
                }
            };

            fileReader.onerror = (error) => {
                logStatus(`âŒ æ–‡ä»¶ [${index + 1}/${total}] è¯»å–å¤±è´¥: ${error}`);
                currentFileIndex++; // è·³è¿‡è¯¥æ–‡ä»¶
                sendNextFile();
            };

            const readSlice = (start) => {
                const slice = file.slice(start, start + CHUNK_SIZE);
                fileReader.readAsArrayBuffer(slice);
            };

            // ç›‘å¬ DataChannel ç¼“å†²åŒºä½æ°´ä½äº‹ä»¶
            dataChannel.onbufferedamountlow = () => {
                // è¿™æ˜¯ä¸€ä¸ªå…œåº•æœºåˆ¶ï¼Œæ–‡ä»¶å‘é€çš„æ§åˆ¶ä¸»è¦ä¾èµ– fileReader.onload å†…éƒ¨çš„æ£€æŸ¥ã€‚
            };

            readSlice(0); // å¼€å§‹è¯»å–ç¬¬ä¸€ä¸ªå—
        }


        // -----------------------------------------------------------
        // 6. å¤šæ–‡ä»¶ä¼ è¾“é€»è¾‘ (æ¥æ”¶æ–¹)
        // -----------------------------------------------------------

        /** å¤„ç†æ¥æ”¶åˆ°çš„ DataChannel æ¶ˆæ¯ */
        function handleDataChannelMessage(event) {
            const data = event.data;

            if (typeof data === 'string') {
                try {
                    const metadata = JSON.parse(data);
                    if (metadata.label === METADATA_LABEL) {
                        if (currentFileBuffer.length > 0) {
                            logStatus(`è­¦å‘Šï¼šæ–‡ä»¶ ${currentFileName} æœªå®Œæ•´æ¥æ”¶ï¼Œä½†æ”¶åˆ°äº†æ–°æ–‡ä»¶çš„å…ƒæ•°æ®ã€‚`);
                        }

                        currentFileName = metadata.fileName;
                        currentFileSize = metadata.fileSize;
                        totalFilesToReceive = metadata.totalFiles;
                        filesReceivedCount = metadata.fileIndex - 1;
                        currentFileBuffer = [];
                        downloadArea.style.display = 'block';

                        const sizeMB = (currentFileSize / (1024 * 1024)).toFixed(2);
                        logStatus(`å¼€å§‹æ¥æ”¶æ–‡ä»¶ [${metadata.fileIndex}/${totalFilesToReceive}]ï¼š${currentFileName} (${sizeMB} MB)`);
                        currentFileInfoP.textContent = `æ–‡ä»¶ ${metadata.fileIndex}/${totalFilesToReceive} - ${currentFileName} (${sizeMB} MB)`;
                        transferTitle.textContent = `æ¥æ”¶ä¸­: ${currentFileName} | 0.0%`;
                        updateProgress(0);
                        return;
                    }
                } catch (e) {
                    // å¿½ç•¥éå…ƒæ•°æ®çš„å­—ç¬¦ä¸²æ¶ˆæ¯
                }
            } else if (data instanceof ArrayBuffer) {
                // æ¥æ”¶åˆ°æ•°æ®å—
                currentFileBuffer.push(data);
                const totalBytesReceived = currentFileBuffer.reduce((sum, chunk) => sum + chunk.byteLength, 0);
                const percentage = (totalBytesReceived / currentFileSize) * 100;

                updateProgress(percentage);
                transferTitle.textContent = `æ¥æ”¶ä¸­: ${currentFileName} | ${percentage.toFixed(1)}%`;

                if (totalBytesReceived >= currentFileSize) {
                    // å½“å‰æ–‡ä»¶æ¥æ”¶å®Œæ¯•
                    logStatus(`âœ… æ–‡ä»¶ [${filesReceivedCount + 1}/${totalFilesToReceive}] æ¥æ”¶å®Œæˆï¼æ­£åœ¨åˆæˆ...`);

                    const fullFile = new Blob(currentFileBuffer);
                    const downloadUrl = URL.createObjectURL(fullFile);

                    // æ·»åŠ åˆ°ä¸‹è½½åˆ—è¡¨
                    const downloadElement = document.createElement('a');
                    downloadElement.href = downloadUrl;
                    downloadElement.download = currentFileName;
                    downloadElement.textContent = `ä¸‹è½½ ${currentFileName} (${(currentFileSize / 1024 / 1024).toFixed(2)} MB)`;
                    downloadListDiv.appendChild(downloadElement);

                    // é‡ç½®å½“å‰æ–‡ä»¶çŠ¶æ€ï¼Œå‡†å¤‡æ¥æ”¶ä¸‹ä¸€ä¸ª
                    currentFileBuffer = [];
                    filesReceivedCount++;

                    if (filesReceivedCount >= totalFilesToReceive) {
                        // æ‰€æœ‰æ–‡ä»¶æ¥æ”¶å®Œæ¯•
                        logStatus('ğŸ‰ æ‰€æœ‰æ–‡ä»¶ä¼ è¾“å®Œæˆï¼');
                        transferTitle.textContent = 'æ‰€æœ‰æ–‡ä»¶æ¥æ”¶å®Œæ¯•ï¼';
                        currentFileInfoP.textContent = '';
                        cleanRoomData(currentRoomCode);
                    } else {
                        transferTitle.textContent = `ç­‰å¾…å‘é€æ–¹å‘é€ä¸‹ä¸€ä¸ªæ–‡ä»¶ (${filesReceivedCount + 1}/${totalFilesToReceive})...`;
                    }
                }
            }
        }


        // -----------------------------------------------------------
        // 7. äº‹ä»¶ç›‘å¬å™¨
        // -----------------------------------------------------------

        // ç›‘å¬ï¼šæ–‡ä»¶é€‰æ‹©
        fileInput.addEventListener('change', (e) => {
            filesToSend = Array.from(e.target.files);
            fileListUL.innerHTML = '';
            currentFileIndex = 0;

            if (filesToSend.length > 0) {
                fileListUL.style.display = 'block';
                filesToSend.forEach(file => {
                    const li = document.createElement('li');
                    li.textContent = `${file.name} (${(file.size / (1024 * 1024)).toFixed(2)} MB)`;
                    fileListUL.appendChild(li);
                });

                if (peerConnection && peerConnection.iceConnectionState === 'connected') {
                    sendBtn.textContent = `å‘é€ ${filesToSend.length} ä¸ªæ–‡ä»¶`;
                    sendBtn.disabled = false;
                } else {
                    sendBtn.textContent = `å·²é€‰æ‹© ${filesToSend.length} ä¸ªæ–‡ä»¶ (ç­‰å¾…è¿æ¥)`;
                    sendBtn.disabled = true;
                }
            } else {
                fileListUL.style.display = 'none';
                sendBtn.textContent = 'è¯·é€‰æ‹©æ–‡ä»¶';
                sendBtn.disabled = true;
            }
        });

        // ç›‘å¬ï¼šç‚¹å‡»å‘é€æŒ‰é’®
        sendBtn.addEventListener('click', () => {
            if (filesToSend.length > 0 && dataChannel && dataChannel.readyState === 'open') {
                currentFileIndex = 0;
                sendNextFile();
            } else {
                logStatus('âŒ è¯·å…ˆé€‰æ‹©æ–‡ä»¶æˆ–ç­‰å¾…è¿æ¥å»ºç«‹ã€‚');
            }
        });

        // ç›‘å¬ï¼šåˆ›å»º/åŠ å…¥/æ¸…ç†æŒ‰é’®
        createBtn.addEventListener('click', () => {
            const roomCode = generateRoomCode();
            roomCodeInput.value = roomCode;
            joinSection.style.display = 'none';
            transferSection.style.display = 'block';
            createSenderOffer(roomCode);
        });

        joinBtn.addEventListener('click', () => {
            const roomCode = roomCodeInput.value.toUpperCase().trim();
            if (roomCode.length !== 3) {
                logStatus('âŒ è¿æ¥ç å¿…é¡»æ˜¯ä¸‰ä½å¤§å†™å­—æ¯ã€‚');
                return;
            }
            joinSection.style.display = 'none';
            transferSection.style.display = 'block';
            createReceiverAnswer(roomCode);
        });

        cleanRoomBtn.addEventListener('click', () => {
            cleanRoomData(currentRoomCode);
        });

    </script>

</body>

</html>
<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <link rel="stylesheet" href="/css/basic.css">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å¤¸å…‹é—ªä¼  | QuarkShare P2P</title>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
    <style>
        /* 1. æç®€æ¯›ç»ç’ƒ CSS - ä½¿ç”¨ qs- å‰ç¼€éš”ç¦»æ ·å¼ */
        body {
            margin: 0;
            padding: 0;
            /* å…è®¸é¡µé¢æ­£å¸¸æ»šåŠ¨ */
            background: url('/image/bg.png') no-repeat center center fixed;
            background-size: cover;
            color: #333;
            transition: background-color 0.3s;
        }

        /* 2. å®¹å™¨å’Œå¡ç‰‡æ ·å¼ - ç¡®ä¿é¡¶éƒ¨é—´è·å’Œå†…å®¹å±…ä¸­ (å†…å®¹å®½åº¦æœ‰é™åˆ¶) */
        .qs-container {
            width: 90%;
            max-width: 480px;
            /* è®©å†…å®¹åœ¨é¡µé¢ä¸Šå±…ä¸­æ˜¾ç¤º */
            margin: 0 auto;
            padding: 20px;

            /* ä¿æŒè¶³å¤Ÿçš„é¡¶éƒ¨ padding é¿å…è¢«å›ºå®šé¡¶æ é®æŒ¡ (çº¦ 60px é¡¶æ  + 20px é—´è· = 80px) */
            padding-top: 80px;
            padding-bottom: 40px;
            box-sizing: border-box;
        }

        .qs-card {
            /* ä¿æŒæç®€æ¯›ç»ç’ƒæ•ˆæœ */
            background-color: rgba(255, 255, 255, 0.7);
            border-radius: 16px;
            box-shadow: 0 10px 40px 0 rgba(31, 38, 135, 0.18);
            backdrop-filter: blur(15px);
            -webkit-backdrop-filter: blur(15px);
            border: 1px solid rgba(255, 255, 255, 0.3);
            padding: 30px;
            text-align: center;
            margin-bottom: 25px;
            transition: box-shadow 0.3s ease;
        }

        .qs-card:hover {
            box-shadow: 0 12px 50px 0 rgba(31, 38, 135, 0.25);
        }

        /* æ ‡é¢˜æ ·å¼ä¼˜åŒ– */
        .qs-main-title {
            font-size: 32px;
            font-weight: 800;
            color: white;
            margin-bottom: 35px;
            text-shadow: 1px 1px 3px rgba(0, 0, 0, 0.1);
        }

        .qs-card h2 {
            margin-top: 0;
            margin-bottom: 25px;
            font-weight: 600;
            color: #1a1a1a;
            font-size: 22px;
        }

        /* 3. è¾“å…¥æ¡†å’ŒæŒ‰é’®æ ·å¼ */
        .qs-input-field,
        .qs-btn {
            width: 100%;
            padding: 14px;
            margin-bottom: 15px;
            border-radius: 10px;
            box-sizing: border-box;
            font-size: 16px;
            transition: all 0.2s;
        }

        .qs-input-field {
            border: 1px solid rgba(0, 0, 0, 0.2);
            background-color: rgba(255, 255, 255, 0.95);
            color: #333;
        }

        .qs-input-field:focus {
            border-color: #007aff;
            box-shadow: 0 0 0 3px rgba(0, 122, 255, 0.3);
            outline: none;
        }

        #file-input {
            display: none;
        }

        .qs-file-select-label {
            display: block;
            background-color: #34c759;
            color: white;
            padding: 14px;
            margin-bottom: 15px;
            border-radius: 10px;
            font-size: 16px;
            font-weight: 700;
            cursor: pointer;
            transition: background-color 0.2s, box-shadow 0.2s;
        }

        .qs-file-select-label:hover {
            background-color: #28a745;
            box-shadow: 0 3px 6px rgba(52, 199, 89, 0.4);
        }

        .qs-btn {
            border: none;
            background-color: #007aff;
            color: white;
            cursor: pointer;
            font-weight: 700;
            box-shadow: 0 3px 6px rgba(0, 122, 255, 0.3);
        }

        .qs-btn:hover:not(:disabled) {
            background-color: #005bb5;
            box-shadow: 0 4px 8px rgba(0, 122, 255, 0.4);
        }

        .qs-btn:disabled {
            background-color: #a0c4ff;
            cursor: not-allowed;
            box-shadow: none;
        }

        .qs-secondary-btn {
            background-color: #ff3b30;
            margin-top: 10px;
            box-shadow: 0 3px 6px rgba(255, 59, 48, 0.3);
            display: inline-block;
            /* ç¡®ä¿ a æ ‡ç­¾èƒ½åº”ç”¨æ ·å¼ */
            text-decoration: none;
            text-align: center;
        }

        .qs-secondary-btn:hover:not(:disabled) {
            background-color: #d8291e;
            box-shadow: 0 4px 8px rgba(255, 59, 48, 0.4);
        }

        /* 4. çŠ¶æ€å’Œè¿›åº¦æ˜¾ç¤º */
        #status {
            margin-top: 20px;
            padding: 15px;
            background-color: rgba(255, 255, 255, 0.9);
            border-radius: 10px;
            text-align: left;
            white-space: pre-wrap;
            word-break: break-all;
            border: 1px solid rgba(0, 0, 0, 0.1);
            max-height: 250px;
            overflow-y: auto;
            font-size: 14px;
            color: #666;
            line-height: 1.5;
        }

        .qs-progress-container {
            height: 10px;
            background-color: rgba(0, 0, 0, 0.1);
            border-radius: 5px;
            margin-top: 15px;
            margin-bottom: 20px;
            overflow: hidden;
            box-shadow: inset 0 1px 3px rgba(0, 0, 0, 0.1);
        }

        .qs-progress-bar {
            height: 100%;
            width: 0%;
            background-color: #34c759;
            transition: width 0.1s;
            border-radius: 5px;
        }

        /* 5. ç§»åŠ¨ç«¯å…¼å®¹æ€§è°ƒæ•´ï¼šç¡®ä¿ç§»åŠ¨ç«¯ä¹Ÿç•™å‡ºé¡¶æ ç©ºé—´ */
        @media (max-width: 768px) {
            .qs-container {
                padding-top: 80px;
            }
        }
    </style>
</head>

<body>
    <script src="/js/nav.js"></script>
    <div class="qs-container">
        <div class="qs-main-title">å¤¸å…‹é—ªä¼ </div>

        <div class="qs-card" id="join-section">
            <h2>è¿æ¥è®¾å¤‡</h2>
            <input type="text" id="room-code-input" class="qs-input-field" placeholder="è¾“å…¥ä¸‰ä½è¿æ¥ç  (å¦‚ ABC)" maxlength="3"
                style="text-transform: uppercase;">
            <button id="join-btn" class="qs-btn">åŠ å…¥æˆ¿é—´å¹¶æ¥æ”¶</button>
            <button id="create-btn" class="qs-btn">ç”Ÿæˆè¿æ¥ç å¹¶å‘é€</button>
        </div>

        <div class="qs-card" id="transfer-section" style="display: none;">
            <h2 id="transfer-title">ç­‰å¾…è¿æ¥...</h2>

            <div id="file-selection-area">
                <input type="file" id="file-input">
                <label for="file-input" class="qs-file-select-label">é€‰æ‹©æ–‡ä»¶</label>
                <button id="send-btn" class="qs-btn" disabled>ç­‰å¾…è¿æ¥...</button>
            </div>

            <p id="current-file-info" style="font-size: 14px; color: #666;"></p>
            <div class="qs-progress-container">
                <div id="progress-bar" class="qs-progress-bar"></div>
            </div>

            <div id="download-area" style="display: none;">
                <h2>å·²æ¥æ”¶æ–‡ä»¶</h2>
                <p id="received-filename" style="font-size: 16px; color: #444;">å·²æ¥æ”¶æ–‡ä»¶ï¼š</p>
                <a id="download-link" download style="display: none;" class="qs-btn qs-secondary-btn">ç‚¹å‡»ä¸‹è½½æ–‡ä»¶</a>
            </div>

            <button id="clean-room-btn" class="qs-btn qs-secondary-btn" style="display: none;">æ¸…é™¤æˆ¿é—´æ•°æ®å¹¶é‡ç½®</button>
        </div>

        <div class="qs-card" id="status-card">
            <h2>çŠ¶æ€ä¿¡æ¯</h2>
            <div id="status">è¿æ¥çŠ¶æ€ï¼šæœªè¿æ¥</div>
        </div>

    </div>

    <script>
        // -----------------------------------------------------------
        // 1. Firebase é…ç½®ä¸ STUN
        // -----------------------------------------------------------
        const firebaseConfig = {
            apiKey: "AIzaSyAeSI1akqwsPBrVyv7YKirV06fqdkL3YNI",
            authDomain: "quark-b7305.firebaseapp.com",
            projectId: "quark-b7305",
            storageBucket: "quark-b7305.firebasestorage.app",
            messagingSenderId: "843016834358",
            appId: "1:843016834358:web:9438c729be28c4d492f797",
            measurementId: "G-5BVT26KRT6"
        };

        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();

        // ä½¿ç”¨å¤šä¸ª STUN æœåŠ¡å™¨æé«˜è¿æ¥æˆåŠŸç‡
        const STUN_SERVERS = [
            { urls: 'stun:stun.l.google.com:19302' }
        ];


        // -----------------------------------------------------------
        // 2. å…¨å±€å˜é‡ä¸ DOM å…ƒç´ 
        // -----------------------------------------------------------
        let peerConnection;
        let dataChannel;
        let isSender = false;
        let currentRoomCode = null;
        let hasSentCodePrompt = false;

        // å•æ–‡ä»¶å‘é€ç›¸å…³
        let fileToSend = null; // å­˜å‚¨å•ä¸ªæ–‡ä»¶å¯¹è±¡

        // å•æ–‡ä»¶æ¥æ”¶ç›¸å…³
        let fileBuffer = []; // å­˜å‚¨æ¥æ”¶åˆ°çš„ ArrayBuffer å—
        let fileName = '';
        let receivedFileSize = 0;


        const CHUNK_SIZE = 64 * 1024;
        const METADATA_LABEL = 'metadata';

        const joinSection = document.getElementById('join-section');
        const transferSection = document.getElementById('transfer-section');
        const transferTitle = document.getElementById('transfer-title');
        const roomCodeInput = document.getElementById('room-code-input');
        const joinBtn = document.getElementById('join-btn');
        const createBtn = document.getElementById('create-btn');
        const fileInput = document.getElementById('file-input');
        const sendBtn = document.getElementById('send-btn');
        const statusDiv = document.getElementById('status');
        const progressBar = document.getElementById('progress-bar');
        const downloadArea = document.getElementById('download-area');
        // æ–°å¢/ä¿®æ”¹çš„ä¸‹è½½å…ƒç´ 
        const receivedFilenameP = document.getElementById('received-filename');
        const downloadLink = document.getElementById('download-link');
        const cleanRoomBtn = document.getElementById('clean-room-btn');
        const currentFileInfoP = document.getElementById('current-file-info');

        // -----------------------------------------------------------
        // 3. æ ¸å¿ƒå‡½æ•°ï¼šUI å·¥å…·
        // -----------------------------------------------------------

        /** è®°å½•çŠ¶æ€ */
        function logStatus(message) {
            statusDiv.innerHTML = `[${new Date().toLocaleTimeString()}] ${message}\n` + statusDiv.innerHTML;
            if (statusDiv.scrollTop > 0) statusDiv.scrollTop = 0;
            console.log(message);
        }

        /** ç”Ÿæˆä¸‰ä½éšæœºå¤§å†™å­—æ¯ç  */
        function generateRoomCode() {
            let result = '';
            const characters = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ';
            for (let i = 0; i < 3; i++) {
                result += characters.charAt(Math.floor(Math.random() * characters.length));
            }
            return result;
        }

        /** æ›´æ–°è¿›åº¦æ¡ */
        function updateProgress(percentage) {
            progressBar.style.width = `${Math.min(100, percentage)}%`;
        }

        /** æ¸…ç†æˆ¿é—´æ•°æ®å¹¶é‡ç½® */
        async function cleanRoomData(roomCode) {
            if (roomCode) {
                logStatus(`æ­£åœ¨æ¸…ç†æˆ¿é—´ ${roomCode} çš„ Firebase æ•°æ®...`);
                try {
                    await database.ref(`rooms/${roomCode}`).remove();
                    logStatus('âœ… æˆ¿é—´æ•°æ®æ¸…ç†å®Œæ¯•ã€‚');
                } catch (e) {
                    logStatus(`âŒ æ¸…ç†å¤±è´¥: ${e.message}`);
                }
            }
            resetUI();
        }

        /** é‡ç½®ç•Œé¢åˆ°åˆå§‹çŠ¶æ€ */
        function resetUI() {
            joinSection.style.display = 'block';
            transferSection.style.display = 'none';
            transferTitle.textContent = 'ç­‰å¾…è¿æ¥...';
            sendBtn.textContent = 'é€‰æ‹©æ–‡ä»¶å¹¶å‘é€';
            sendBtn.disabled = true;
            fileInput.value = ''; // æ¸…ç©ºæ–‡ä»¶é€‰æ‹©

            currentFileInfoP.textContent = '';
            downloadArea.style.display = 'none';
            downloadLink.style.display = 'none'; // éšè—ä¸‹è½½é“¾æ¥
            receivedFilenameP.textContent = 'å·²æ¥æ”¶æ–‡ä»¶ï¼š'; // é‡ç½®æ¥æ”¶æ–‡ä»¶åæ–‡æœ¬

            cleanRoomBtn.style.display = 'none';

            // é‡ç½®å‘é€/æ¥æ”¶çŠ¶æ€å˜é‡
            currentRoomCode = null;
            fileToSend = null;
            fileBuffer = [];
            fileName = '';
            receivedFileSize = 0;
            hasSentCodePrompt = false;

            // é‡ç½®æ–‡ä»¶é€‰æ‹©æ ‡ç­¾æ–‡æœ¬
            const label = document.querySelector('.qs-file-select-label');
            label.textContent = `é€‰æ‹©æ–‡ä»¶`;


            if (peerConnection) {
                peerConnection.close();
                peerConnection = null;
            }
            if (dataChannel) {
                dataChannel.close();
                dataChannel = null;
            }
            logStatus('ç•Œé¢å·²é‡ç½®ã€‚');
        }

        // -----------------------------------------------------------
        // 4. WebRTC åˆå§‹åŒ–
        // -----------------------------------------------------------

        /** åˆå§‹åŒ– RTCPeerConnection */
        function createPeerConnection(roomCode, isSenderDevice) {
            peerConnection = new RTCPeerConnection({ iceServers: STUN_SERVERS.map(url => ({ urls: url.urls })) });
            currentRoomCode = roomCode;
            isSender = isSenderDevice;

            logStatus(`åˆ›å»º WebRTC è¿æ¥ï¼Œèº«ä»½: ${isSender ? 'å‘é€æ–¹' : 'æ¥æ”¶æ–¹'}ã€‚è¿æ¥ç : ${roomCode}`);
            cleanRoomBtn.style.display = 'block';

            peerConnection.onicecandidate = async (event) => {
                if (event.candidate) {
                    if (isSender && !hasSentCodePrompt) {
                        transferTitle.textContent = `ğŸ“¢ è¿æ¥ç ï¼š${roomCode}ã€‚è¯·å°†æ­¤ç å‘é€ç»™æ¥æ”¶æ–¹ã€‚`;
                        logStatus('ICE å€™é€‰è€…æ­£åœ¨å‘é€ä¸­ã€‚**è¯·å°†è¿æ¥ç å‘é€ç»™æ¥æ”¶æ–¹ã€‚**');
                        hasSentCodePrompt = true;
                    }

                    const role = isSender ? 'sender' : 'receiver';
                    const candidatesRef = database.ref(`rooms/${roomCode}/${role}/iceCandidates`);
                    await candidatesRef.push(event.candidate.toJSON());
                    logStatus('å‘é€ ICE å€™é€‰è€…...');
                }
            };

            peerConnection.oniceconnectionstatechange = () => {
                logStatus(`ICE è¿æ¥çŠ¶æ€: ${peerConnection.iceConnectionState}`);
                if (peerConnection.iceConnectionState === 'connected') {
                    logStatus('âœ… P2P è¿æ¥å»ºç«‹æˆåŠŸï¼');
                    transferTitle.textContent = `è¿æ¥æˆåŠŸï¼`;
                    if (isSender) {
                        sendBtn.textContent = fileToSend ? `å‘é€ ${fileToSend.name}` : 'è¯·é€‰æ‹©æ–‡ä»¶';
                        sendBtn.disabled = !fileToSend;
                    } else {
                        transferTitle.textContent = 'ç­‰å¾…å‘é€æ–¹ä¼ è¾“æ–‡ä»¶...';
                    }
                } else if (peerConnection.iceConnectionstate === 'failed' || peerConnection.iceConnectionstate === 'closed') {
                    logStatus('âŒ P2P è¿æ¥æ–­å¼€æˆ–å¤±è´¥ã€‚è¯·æ£€æŸ¥è¿æ¥ç å’Œç½‘ç»œç¯å¢ƒã€‚');
                }
            };

            if (isSender) {
                dataChannel = peerConnection.createDataChannel('fileTransfer', { ordered: true });
                setupDataChannel(dataChannel);
                logStatus('å·²åˆ›å»º DataChannel...');
            } else {
                peerConnection.ondatachannel = (event) => {
                    dataChannel = event.channel;
                    setupDataChannel(dataChannel);
                    logStatus('å·²æ¥æ”¶ DataChannel...');
                };
            }
        }

        /** DataChannel çš„é€šç”¨è®¾ç½® */
        function setupDataChannel(channel) {
            channel.onopen = () => {
                logStatus('DataChannel æ‰“å¼€ï¼Œå¯ä»¥å¼€å§‹ä¼ è¾“æ•°æ®ã€‚');
            };
            channel.onclose = () => {
                logStatus('DataChannel å…³é—­ã€‚');
            };
            channel.onerror = (error) => {
                logStatus(`DataChannel é”™è¯¯: ${error}`);
            };

            if (!isSender) {
                channel.onmessage = handleDataChannelMessage;
            }
        }

        // ... (createSenderOffer, createReceiverAnswer, listenForIceCandidates ä¿æŒä¸å˜) ...
        async function createSenderOffer(roomCode) {
            createPeerConnection(roomCode, true);
            transferTitle.textContent = `è¿æ¥ç ï¼š${roomCode}ã€‚æ­£åœ¨ç­‰å¾…ICEç”Ÿæˆ...`;

            try {
                const offer = await peerConnection.createOffer();
                await peerConnection.setLocalDescription(offer);
                await database.ref(`rooms/${roomCode}/sender/sdp`).set(peerConnection.localDescription.toJSON());

                database.ref(`rooms/${roomCode}/receiver/sdp`).on('value', async (snapshot) => {
                    const answer = snapshot.val();
                    if (answer && !peerConnection.currentRemoteDescription) {
                        await peerConnection.setRemoteDescription(new RTCSessionDescription(answer));
                        listenForIceCandidates(roomCode, 'receiver');
                    }
                });
            } catch (e) {
                logStatus(`âŒ å‘é€æ–¹ Offer å¤±è´¥: ${e.message}`);
            }
        }

        async function createReceiverAnswer(roomCode) {
            createPeerConnection(roomCode, false);
            transferTitle.textContent = `è¿æ¥ç ï¼š${roomCode}ã€‚æ­£åœ¨ç­‰å¾…å‘é€æ–¹å“åº”...`;

            database.ref(`rooms/${roomCode}/sender/sdp`).once('value').then(async (snapshot) => {
                const offer = snapshot.val();
                if (!offer) {
                    logStatus(`âŒ æˆ¿é—´ ${roomCode} ä¸å­˜åœ¨ Offerã€‚`);
                    return;
                }

                try {
                    await peerConnection.setRemoteDescription(new RTCSessionDescription(offer));
                    const answer = await peerConnection.createAnswer();
                    await peerConnection.setLocalDescription(answer);
                    await database.ref(`rooms/${roomCode}/receiver/sdp`).set(peerConnection.localDescription.toJSON());
                    listenForIceCandidates(roomCode, 'sender');
                } catch (e) {
                    logStatus(`âŒ æ¥æ”¶æ–¹ Answer å¤±è´¥: ${e.message}`);
                }
            });
        }

        function listenForIceCandidates(roomCode, remoteRole) {
            database.ref(`rooms/${roomCode}/${remoteRole}/iceCandidates`).on('child_added', (snapshot) => {
                const candidate = snapshot.val();
                if (candidate) {
                    try {
                        peerConnection.addIceCandidate(new RTCIceCandidate(candidate));
                    } catch (e) {
                        logStatus(`âŒ æ·»åŠ  ICE å€™é€‰è€…å¤±è´¥: ${e.message}`);
                    }
                }
            });
        }


        // -----------------------------------------------------------
        // 5. å•æ–‡ä»¶ä¼ è¾“é€»è¾‘ (å‘é€æ–¹)
        // -----------------------------------------------------------

        /** åˆ†å—å‘é€å•ä¸ªæ–‡ä»¶ */
        async function sendFile(file) {
            if (dataChannel.readyState !== 'open') {
                logStatus('âŒ DataChannel æœªæ‰“å¼€æˆ–æœªè¿æ¥ã€‚');
                return;
            }

            const fileSize = file.size;
            let offset = 0;

            sendBtn.disabled = true;

            // 1. å‘é€æ–‡ä»¶å…ƒæ•°æ®
            const metadata = {
                label: METADATA_LABEL,
                fileName: file.name,
                fileSize: fileSize,
            };
            dataChannel.send(JSON.stringify(metadata));
            logStatus(`å¼€å§‹ä¼ è¾“æ–‡ä»¶: ${file.name} (${(fileSize / (1024 * 1024)).toFixed(2)} MB)`);
            currentFileInfoP.textContent = `æ–‡ä»¶: ${file.name} | 0.0%`;


            const fileReader = new FileReader();

            fileReader.onload = async (e) => {
                // ç¡®ä¿åœ¨ DataChannel å‘é€ç¼“å†²åŒºå…è®¸æ—¶æ‰å‘é€
                if (dataChannel.bufferedAmount < dataChannel.bufferedAmountLowThreshold) {
                    dataChannel.send(e.target.result);
                    offset += e.target.result.byteLength;

                    const percentage = (offset / fileSize) * 100;
                    updateProgress(percentage);
                    transferTitle.textContent = `å‘é€ä¸­: ${file.name} | ${percentage.toFixed(1)}%`;
                    currentFileInfoP.textContent = `æ–‡ä»¶: ${file.name} | ${(offset / (1024 * 1024)).toFixed(2)} MB / ${(fileSize / (1024 * 1024)).toFixed(2)} MB`;


                    if (offset < fileSize) {
                        readSlice(offset);
                    } else {
                        // æ–‡ä»¶å‘é€å®Œæ¯•
                        logStatus('âœ… æ–‡ä»¶å‘é€å®Œæˆï¼');
                        transferTitle.textContent = 'æ–‡ä»¶ä¼ è¾“å®Œæˆï¼';
                        currentFileInfoP.textContent = '';
                        sendBtn.textContent = `é‡æ–°å‘é€ (${file.name})`;
                        sendBtn.disabled = false;
                    }
                } else {
                    // å¦‚æœç¼“å†²åŒºæ»¡äº†ï¼Œç­‰å¾… low buffer event
                    await new Promise(resolve => dataChannel.onbufferedamountlow = resolve);
                    fileReader.onload(e); // é‡æ–°è°ƒç”¨ onload å°è¯•å‘é€
                }
            };

            fileReader.onerror = (error) => {
                logStatus(`âŒ æ–‡ä»¶è¯»å–å¤±è´¥: ${error}`);
                sendBtn.disabled = false;
            };

            const readSlice = (start) => {
                const slice = file.slice(start, start + CHUNK_SIZE);
                fileReader.readAsArrayBuffer(slice);
            };

            // ç›‘å¬ DataChannel ç¼“å†²åŒºä½æ°´ä½äº‹ä»¶ (è¾…åŠ©æ§åˆ¶æµé‡)
            dataChannel.onbufferedamountlow = () => { };

            readSlice(0); // å¼€å§‹è¯»å–ç¬¬ä¸€ä¸ªå—
        }


        // -----------------------------------------------------------
        // 6. å•æ–‡ä»¶ä¼ è¾“é€»è¾‘ (æ¥æ”¶æ–¹)
        // -----------------------------------------------------------

        /** å¤„ç†æ¥æ”¶åˆ°çš„ DataChannel æ¶ˆæ¯ */
        function handleDataChannelMessage(event) {
            const data = event.data;

            if (typeof data === 'string') {
                try {
                    const metadata = JSON.parse(data);
                    if (metadata.label === METADATA_LABEL) {
                        if (fileBuffer.length > 0) {
                            logStatus(`è­¦å‘Šï¼šæ–‡ä»¶ ${fileName} æœªå®Œæ•´æ¥æ”¶ï¼Œä½†æ”¶åˆ°äº†æ–°æ–‡ä»¶çš„å…ƒæ•°æ®ã€‚`);
                        }

                        // é‡ç½®çŠ¶æ€
                        fileName = metadata.fileName;
                        receivedFileSize = metadata.fileSize;
                        fileBuffer = [];
                        downloadArea.style.display = 'none';
                        downloadLink.style.display = 'none';
                        receivedFilenameP.textContent = 'å·²æ¥æ”¶æ–‡ä»¶ï¼š';

                        const sizeMB = (receivedFileSize / (1024 * 1024)).toFixed(2);
                        logStatus(`å¼€å§‹æ¥æ”¶æ–‡ä»¶ï¼š${fileName} (${sizeMB} MB)`);
                        currentFileInfoP.textContent = `æ–‡ä»¶: ${fileName} (${sizeMB} MB)`;
                        transferTitle.textContent = `æ¥æ”¶ä¸­: ${fileName} | 0.0%`;
                        updateProgress(0);
                        return;
                    }
                } catch (e) {
                    // å¿½ç•¥éå…ƒæ•°æ®çš„å­—ç¬¦ä¸²æ¶ˆæ¯
                }
            } else if (data instanceof ArrayBuffer) {
                // æ¥æ”¶åˆ°æ•°æ®å—
                fileBuffer.push(data);
                const totalBytesReceived = fileBuffer.reduce((sum, chunk) => sum + chunk.byteLength, 0);
                const percentage = (totalBytesReceived / receivedFileSize) * 100;

                updateProgress(percentage);
                transferTitle.textContent = `æ¥æ”¶ä¸­: ${fileName} | ${percentage.toFixed(1)}%`;
                currentFileInfoP.textContent = `æ–‡ä»¶: ${fileName} | ${(totalBytesReceived / (1024 * 1024)).toFixed(2)} MB / ${(receivedFileSize / (1024 * 1024)).toFixed(2)} MB`;

                if (totalBytesReceived >= receivedFileSize) {
                    // æ–‡ä»¶æ¥æ”¶å®Œæ¯•
                    logStatus(`âœ… æ–‡ä»¶æ¥æ”¶å®Œæˆï¼æ­£åœ¨åˆæˆ...`);

                    const fullFile = new Blob(fileBuffer);
                    const downloadUrl = URL.createObjectURL(fullFile);
                    const sizeMB = (receivedFileSize / (1024 * 1024)).toFixed(2);

                    // æ›´æ–°ä¸‹è½½åŒºåŸŸ
                    receivedFilenameP.textContent = `å·²æ¥æ”¶æ–‡ä»¶: ${fileName} (${sizeMB} MB)`;
                    downloadLink.href = downloadUrl;
                    downloadLink.download = fileName;
                    downloadLink.textContent = `ç‚¹å‡»ä¸‹è½½ ${fileName}`;
                    downloadLink.style.display = 'block';
                    downloadArea.style.display = 'block';

                    transferTitle.textContent = 'æ–‡ä»¶æ¥æ”¶å®Œæ¯•ï¼';
                    currentFileInfoP.textContent = '';
                }
            }
        }


        // -----------------------------------------------------------
        // 7. äº‹ä»¶ç›‘å¬å™¨
        // -----------------------------------------------------------

        // ç›‘å¬ï¼šæ–‡ä»¶é€‰æ‹©
        fileInput.addEventListener('change', (e) => {
            fileToSend = e.target.files[0]; // åªè·å–ç¬¬ä¸€ä¸ªæ–‡ä»¶

            const label = document.querySelector('.qs-file-select-label');

            if (fileToSend) {
                const sizeMB = (fileToSend.size / (1024 * 1024)).toFixed(2);
                label.textContent = `å·²é€‰æ‹©ï¼š${fileToSend.name} (${sizeMB} MB)`;

                if (peerConnection && peerConnection.iceConnectionState === 'connected') {
                    sendBtn.textContent = `å‘é€ ${fileToSend.name}`;
                    sendBtn.disabled = false;
                } else {
                    sendBtn.textContent = `å·²é€‰æ‹©æ–‡ä»¶ (ç­‰å¾…è¿æ¥)`;
                    sendBtn.disabled = true;
                }
            } else {
                label.textContent = `é€‰æ‹©æ–‡ä»¶`;
                sendBtn.textContent = 'è¯·é€‰æ‹©æ–‡ä»¶';
                sendBtn.disabled = true;
            }
        });

        // ç›‘å¬ï¼šç‚¹å‡»å‘é€æŒ‰é’®
        sendBtn.addEventListener('click', () => {
            if (fileToSend && dataChannel && dataChannel.readyState === 'open') {
                sendFile(fileToSend);
            } else {
                logStatus('âŒ è¯·å…ˆé€‰æ‹©æ–‡ä»¶æˆ–ç­‰å¾…è¿æ¥å»ºç«‹ã€‚');
            }
        });

        // ç›‘å¬ï¼šåˆ›å»º/åŠ å…¥/æ¸…ç†æŒ‰é’®
        createBtn.addEventListener('click', () => {
            const roomCode = generateRoomCode();
            roomCodeInput.value = roomCode;
            joinSection.style.display = 'none';
            transferSection.style.display = 'block';
            createSenderOffer(roomCode);
        });

        joinBtn.addEventListener('click', () => {
            const roomCode = roomCodeInput.value.toUpperCase().trim();
            if (roomCode.length !== 3) {
                logStatus('âŒ è¿æ¥ç å¿…é¡»æ˜¯ä¸‰ä½å¤§å†™å­—æ¯ã€‚');
                return;
            }
            joinSection.style.display = 'none';
            transferSection.style.display = 'block';
            createReceiverAnswer(roomCode);
        });

        cleanRoomBtn.addEventListener('click', () => {
            cleanRoomData(currentRoomCode);
        });

    </script>

</body>

</html>
<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>夸克地图 - 夸克博客旗下产品</title>

    <!-- 引入Leaflet地图库 -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <!-- 引入Leaflet插件 -->
    <link rel="stylesheet"
        href="https://cdn.jsdelivr.net/npm/leaflet.locatecontrol@0.78.0/dist/L.Control.Locate.min.css" />
    <script src="https://cdn.jsdelivr.net/npm/leaflet.locatecontrol@0.78.0/dist/L.Control.Locate.min.js" defer></script>

    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body {
            overflow: hidden;
            height: 100vh;
            width: 100vw;
        }

        #map {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 1;
        }

        /* 顶部标题栏 */
        .header {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 60px;
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            display: flex;
            align-items: center;
            padding: 0 20px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            z-index: 1000;
        }

        .logo {
            display: flex;
            align-items: center;
            margin-right: 20px;
        }

        .logo h1 {
            font-size: 1.5rem;
            font-weight: 600;
            color: #0066cc;
        }

        .logo span {
            font-size: 0.9rem;
            color: #888;
            margin-left: 10px;
        }

        /* 侧边控制栏 */
        .control-panel {
            position: absolute;
            top: 70px;
            left: 20px;
            width: 300px;
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
            padding: 15px;
            z-index: 1000;
            transition: all 0.3s ease;
            max-height: calc(100vh - 90px);
            overflow-y: auto;
        }

        .panel-collapsed {
            width: 50px;
            overflow: hidden;
        }

        .panel-collapsed .panel-content {
            display: none;
        }

        .toggle-panel {
            position: absolute;
            top: 10px;
            right: 10px;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            background: #f0f0f0;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            border: none;
            font-size: 16px;
            z-index: 1010;
        }

        .panel-section {
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid #eee;
        }

        .panel-section:last-child {
            border-bottom: none;
        }

        .panel-section h3 {
            font-size: 1rem;
            margin-bottom: 12px;
            color: #333;
            display: flex;
            align-items: center;
        }

        .panel-section h3 i {
            margin-right: 8px;
            color: #0066cc;
        }

        .btn-group {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 8px;
            margin-bottom: 10px;
        }

        button {
            background: #f0f6ff;
            border: 1px solid #d0e2ff;
            border-radius: 8px;
            padding: 8px 12px;
            cursor: pointer;
            font-size: 0.9rem;
            color: #0066cc;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        button:hover {
            background: #e1efff;
        }

        button.active {
            background: #0066cc;
            color: white;
            border-color: #0066cc;
        }

        button i {
            margin-right: 5px;
        }

        .saved-items {
            max-height: 200px;
            overflow-y: auto;
        }

        .saved-item {
            padding: 8px 10px;
            background: #f9f9f9;
            border-radius: 6px;
            margin-bottom: 8px;
            font-size: 0.9rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .saved-item:hover {
            background: #f0f0f0;
        }

        .saved-item .actions {
            display: flex;
            gap: 5px;
        }

        .saved-item .actions button {
            padding: 4px 8px;
            font-size: 0.8rem;
        }

        /* 底部信息栏 */
        .info-bar {
            position: absolute;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            padding: 8px 15px;
            border-radius: 20px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            z-index: 1000;
            font-size: 0.9rem;
            color: #555;
            display: flex;
            align-items: center;
        }

        .info-bar i {
            margin-right: 5px;
            color: #0066cc;
        }

        /* 移动设备适配 */
        @media (max-width: 768px) {
            .control-panel {
                width: 90%;
                left: 5%;
                top: 70px;
            }

            .panel-collapsed {
                width: 50px;
                left: calc(100% - 70px);
            }

            .btn-group {
                grid-template-columns: 1fr;
            }
        }

        /* 加载动画 */
        .loader {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            z-index: 1001;
            background: rgba(255, 255, 255, 0.9);
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .spinner {
            width: 40px;
            height: 40px;
            border: 4px solid #f3f3f3;
            border-top: 4px solid #0066cc;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 10px;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }
    </style>
</head>

<body>
    <!-- 地图容器 -->
    <div id="map"></div>

    <!-- 顶部标题栏 -->
    <div class="header">
        <div class="logo">
            <h1>夸克地图</h1>
            <span>夸克博客旗下产品</span>
        </div>
    </div>

    <!-- 侧边控制栏 -->
    <div class="control-panel">
        <button class="toggle-panel">≡</button>

        <div class="panel-content">
            <div class="panel-section">
                <h3><i class="fas fa-layer-group"></i> 地图视图</h3>
                <div class="btn-group">
                    <button id="vector-btn" class="active">矢量地图</button>
                    <button id="satellite-btn">卫星影像</button>
                    <button id="terrain-btn">地形地图</button>
                    <button id="3d-btn">3D模式</button>
                </div>
            </div>

            <div class="panel-section">
                <h3><i class="fas fa-map-marker-alt"></i> 收藏地点</h3>
                <button id="add-marker-btn">添加标记</button>
                <div class="saved-items" id="saved-markers">
                    <!-- 保存的标记将在这里显示 -->
                </div>
            </div>

            <div class="panel-section">
                <h3><i class="fas fa-route"></i> 路线绘制</h3>
                <button id="draw-line-btn">绘制线路</button>
                <button id="clear-lines-btn">清除线路</button>
                <div class="saved-items" id="saved-routes">
                    <!-- 保存的路线将在这里显示 -->
                </div>
            </div>

            <div class="panel-section">
                <h3><i class="fas fa-ruler"></i> 测量工具</h3>
                <button id="measure-distance-btn">距离测量</button>
                <button id="measure-area-btn">面积测量</button>
            </div>
        </div>
    </div>

    <!-- 底部信息栏 -->
    <div class="info-bar">
        <i class="fas fa-info-circle"></i>
        <span id="location-info">正在获取位置信息...</span>
    </div>

    <!-- 加载动画 -->
    <div class="loader" id="loader">
        <div class="spinner"></div>
        <p>地图加载中...</p>
    </div>

    <!-- 引入Font Awesome图标 -->
    <script src="https://kit.fontawesome.com/a076d05399.js" crossorigin="anonymous"></script>

    <script>
        // 天地图密钥
        const TIANDITU_KEY = "6e5b0e71ae628b8c2ab60c9144a7848e";

        // 全局变量
        let map, currentLayer, userLocation, userMarker;
        let drawnItems = new L.FeatureGroup();
        let measureControl;
        let is3DMode = false;

        // 初始化地图
        function initMap() {
            // 创建地图实例
            map = L.map('map', {
                center: [39.9042, 116.4074], // 默认中心点（北京）
                zoom: 10,
                zoomControl: false
            });

            // 添加缩放控件
            L.control.zoom({
                position: 'bottomright'
            }).addTo(map);

            // 添加定位控件
            L.control.locate({
                position: 'bottomright',
                strings: {
                    title: "定位到我的位置"
                }
            }).addTo(map);

            // 添加比例尺
            L.control.scale({
                position: 'bottomleft',
                imperial: false
            }).addTo(map);

            // 初始化图层
            initLayers();

            // 添加绘制项目图层
            map.addLayer(drawnItems);

            // 定位用户位置
            locateUser();

            // 绑定事件
            bindEvents();

            // 加载保存的数据
            loadSavedData();

            // 隐藏加载动画
            document.getElementById('loader').style.display = 'none';
        }

        // 初始化图层
        function initLayers() {
            // 矢量图层
            const vectorLayer = L.tileLayer(`http://t{0-7}.tianditu.gov.cn/vec_w/wmts?tk=${TIANDITU_KEY}`, {
                maxZoom: 18,
                minZoom: 1,
                subdomains: ['t0', 't1', 't2', 't3', 't4', 't5', 't6', 't7']
            });

            // 矢量注记
            const vectorAnnotation = L.tileLayer(`http://t{0-7}.tianditu.gov.cn/cva_w/wmts?tk=${TIANDITU_KEY}`, {
                maxZoom: 18,
                minZoom: 1,
                subdomains: ['t0', 't1', 't2', 't3', 't4', 't5', 't6', 't7']
            });

            // 影像图层
            const imageLayer = L.tileLayer(`http://t{0-7}.tianditu.gov.cn/img_w/wmts?tk=${TIANDITU_KEY}`, {
                maxZoom: 18,
                minZoom: 1,
                subdomains: ['t0', 't1', 't2', 't3', 't4', 't5', 't6', 't7']
            });

            // 影像注记
            const imageAnnotation = L.tileLayer(`http://t{0-7}.tianditu.gov.cn/cia_w/wmts?tk=${TIANDITU_KEY}`, {
                maxZoom: 18,
                minZoom: 1,
                subdomains: ['t0', 't1', 't2', 't3', 't4', 't5', 't6', 't7']
            });

            // 地形图层
            const terrainLayer = L.tileLayer(`http://t{0-7}.tianditu.gov.cn/ter_w/wmts?tk=${TIANDITU_KEY}`, {
                maxZoom: 18,
                minZoom: 1,
                subdomains: ['t0', 't1', 't2', 't3', 't4', 't5', 't6', 't7']
            });

            // 地形注记
            const terrainAnnotation = L.tileLayer(`http://t{0-7}.tianditu.gov.cn/cta_w/wmts?tk=${TIANDITU_KEY}`, {
                maxZoom: 18,
                minZoom: 1,
                subdomains: ['t0', 't1', 't2', 't3', 't4', 't5', 't6', 't7']
            });

            // 图层组
            const baseLayers = {
                "矢量地图": L.layerGroup([vectorLayer, vectorAnnotation]),
                "卫星影像": L.layerGroup([imageLayer, imageAnnotation]),
                "地形地图": L.layerGroup([terrainLayer, terrainAnnotation])
            };

            // 添加默认图层
            currentLayer = baseLayers["矢量地图"];
            currentLayer.addTo(map);

            // 添加图层控制
            L.control.layers(baseLayers, null, {
                position: 'topright'
            }).addTo(map);
        }

        // 定位用户位置
        function locateUser() {
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(
                    function (position) {
                        const { latitude, longitude } = position.coords;
                        userLocation = [latitude, longitude];

                        // 添加用户位置标记
                        userMarker = L.marker([latitude, longitude], {
                            icon: L.divIcon({
                                className: 'user-location-marker',
                                html: '<div style="background-color:#0066cc; width:16px; height:16px; border-radius:50%; border:3px solid white; box-shadow:0 0 10px rgba(0,102,204,0.5);"></div>',
                                iconSize: [22, 22],
                                iconAnchor: [11, 11]
                            })
                        }).addTo(map);

                        // 显示位置信息
                        document.getElementById('location-info').textContent =
                            `当前位置: ${latitude.toFixed(6)}, ${longitude.toFixed(6)}`;

                        // 移动到用户位置
                        map.setView([latitude, longitude], 13);
                    },
                    function (error) {
                        console.error("定位失败:", error);
                        document.getElementById('location-info').textContent =
                            "定位失败，请检查浏览器位置权限";
                    },
                    {
                        enableHighAccuracy: true,
                        timeout: 10000,
                        maximumAge: 300000
                    }
                );
            } else {
                document.getElementById('location-info').textContent =
                    "您的浏览器不支持地理定位功能";
            }
        }

        // 绑定事件
        function bindEvents() {
            // 切换面板
            document.querySelector('.toggle-panel').addEventListener('click', function () {
                const panel = document.querySelector('.control-panel');
                panel.classList.toggle('panel-collapsed');
            });

            // 视图切换按钮
            document.getElementById('vector-btn').addEventListener('click', function () {
                switchLayer('矢量地图');
                setActiveButton(this);
            });

            document.getElementById('satellite-btn').addEventListener('click', function () {
                switchLayer('卫星影像');
                setActiveButton(this);
            });

            document.getElementById('terrain-btn').addEventListener('click', function () {
                switchLayer('地形地图');
                setActiveButton(this);
            });

            document.getElementById('3d-btn').addEventListener('click', function () {
                alert('3D模式需要加载额外资源，即将推出...');
                setActiveButton(this);
            });

            // 添加标记按钮
            document.getElementById('add-marker-btn').addEventListener('click', function () {
                if (!userLocation) {
                    alert('请先获取您的位置');
                    return;
                }

                const name = prompt('请输入地点名称:');
                if (name) {
                    addSavedMarker(userLocation, name);
                }
            });

            // 绘制线路按钮
            document.getElementById('draw-line-btn').addEventListener('click', function () {
                alert('线路绘制功能即将推出...');
            });

            // 清除线路按钮
            document.getElementById('clear-lines-btn').addEventListener('click', function () {
                clearLines();
            });

            // 测量按钮
            document.getElementById('measure-distance-btn').addEventListener('click', function () {
                alert('距离测量功能即将推出...');
            });

            document.getElementById('measure-area-btn').addEventListener('click', function () {
                alert('面积测量功能即将推出...');
            });
        }

        // 切换图层
        function switchLayer(layerName) {
            map.removeLayer(currentLayer);

            // 这里需要根据图层名称添加新图层
            // 简化实现，实际应根据initLayers中的图层组进行切换
            initLayers();
        }

        // 设置活动按钮
        function setActiveButton(button) {
            // 移除同组中其他按钮的active类
            const parent = button.parentElement;
            const siblings = parent.querySelectorAll('button');
            siblings.forEach(btn => btn.classList.remove('active'));

            // 添加active类到当前按钮
            button.classList.add('active');
        }

        // 添加保存的标记
        function addSavedMarker(latlng, name) {
            const marker = L.marker(latlng).addTo(map);
            marker.bindPopup(`<b>${name}</b><br>${latlng[0].toFixed(6)}, ${latlng[1].toFixed(6)}`);

            // 保存到localStorage
            const markers = JSON.parse(localStorage.getItem('savedMarkers') || '[]');
            markers.push({
                latlng: latlng,
                name: name
            });
            localStorage.setItem('savedMarkers', JSON.stringify(markers));

            // 更新UI
            updateSavedMarkersList();
        }

        // 清除线路
        function clearLines() {
            // 清除所有绘制的线路
            drawnItems.clearLayers();

            // 清除localStorage中的线路数据
            localStorage.removeItem('savedRoutes');

            // 更新UI
            updateSavedRoutesList();
        }

        // 加载保存的数据
        function loadSavedData() {
            updateSavedMarkersList();
            updateSavedRoutesList();
        }

        // 更新保存的标记列表
        function updateSavedMarkersList() {
            const container = document.getElementById('saved-markers');
            container.innerHTML = '';

            const markers = JSON.parse(localStorage.getItem('savedMarkers') || '[]');

            if (markers.length === 0) {
                container.innerHTML = '<p style="text-align:center;color:#888;padding:10px;">暂无收藏地点</p>';
                return;
            }

            markers.forEach((marker, index) => {
                const item = document.createElement('div');
                item.className = 'saved-item';
                item.innerHTML = `
                    <div>${marker.name}</div>
                    <div class="actions">
                        <button onclick="centerMap([${marker.latlng}])">定位</button>
                        <button onclick="deleteMarker(${index})">删除</button>
                    </div>
                `;
                container.appendChild(item);
            });
        }

        // 更新保存的路线列表
        function updateSavedRoutesList() {
            const container = document.getElementById('saved-routes');
            container.innerHTML = '';

            const routes = JSON.parse(localStorage.getItem('savedRoutes') || '[]');

            if (routes.length === 0) {
                container.innerHTML = '<p style="text-align:center;color:#888;padding:10px;">暂无保存路线</p>';
                return;
            }

            routes.forEach((route, index) => {
                const item = document.createElement('div');
                item.className = 'saved-item';
                item.innerHTML = `
                    <div>路线 ${index + 1}</div>
                    <div class="actions">
                        <button onclick="centerMap([${route.center}])">查看</button>
                        <button onclick="deleteRoute(${index})">删除</button>
                    </div>
                `;
                container.appendChild(item);
            });
        }

        // 居中地图到指定位置
        function centerMap(latlng) {
            map.setView(latlng, 15);
        }

        // 删除标记
        function deleteMarker(index) {
            const markers = JSON.parse(localStorage.getItem('savedMarkers') || '[]');
            markers.splice(index, 1);
            localStorage.setItem('savedMarkers', JSON.stringify(markers));
            updateSavedMarkersList();
        }

        // 删除路线
        function deleteRoute(index) {
            const routes = JSON.parse(localStorage.getItem('savedRoutes') || '[]');
            routes.splice(index, 1);
            localStorage.setItem('savedRoutes', JSON.stringify(routes));
            updateSavedRoutesList();
        }

        // 页面加载完成后初始化地图
        window.onload = initMap;
    </script>
</body>

</html>
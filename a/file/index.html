<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å¤¸å…‹é—ªä¼  | QuakeShare P2P</title>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
    <style>
        /* 1. æç®€æ¯›ç»ç’ƒ CSS (å¿…é¡») */
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            margin: 0;
            padding: 0;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            background-color: #f0f2f5;
            /* ææµ…èƒŒæ™¯è‰² */
            color: #333;
            transition: background-color 0.3s;
        }

        /* 2. å®¹å™¨å’Œå¡ç‰‡æ ·å¼ */
        .container {
            width: 90%;
            max-width: 480px;
            padding: 20px;
        }

        .card {
            background-color: rgba(255, 255, 255, 0.6);
            /* åŠé€æ˜ç™½è‰² */
            border-radius: 12px;
            box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.15);
            /* æŸ”å’Œé˜´å½± */
            backdrop-filter: blur(10px);
            /* æ ¸å¿ƒï¼šæ¯›ç»ç’ƒæ•ˆæœ */
            -webkit-backdrop-filter: blur(10px);
            /* å…¼å®¹æ€§ */
            border: 1px solid rgba(255, 255, 255, 0.18);
            /* æŸ”å’Œè¾¹æ¡† */
            padding: 30px;
            text-align: center;
            margin-bottom: 20px;
        }

        h2 {
            margin-top: 0;
            margin-bottom: 20px;
            font-weight: 500;
            color: #1a1a1a;
        }

        /* 3. è¾“å…¥æ¡†å’ŒæŒ‰é’®æ ·å¼ */
        input[type="text"],
        input[type="file"],
        button {
            width: 100%;
            padding: 12px;
            margin-bottom: 15px;
            border-radius: 8px;
            box-sizing: border-box;
            font-size: 16px;
            transition: all 0.2s;
        }

        input[type="text"] {
            border: 1px solid rgba(0, 0, 0, 0.1);
            background-color: rgba(255, 255, 255, 0.8);
        }

        button {
            border: none;
            background-color: #007aff;
            /* iOS è“è‰² */
            color: white;
            cursor: pointer;
            font-weight: 600;
        }

        button:disabled {
            background-color: #a0c4ff;
            cursor: not-allowed;
        }

        button:active:not(:disabled) {
            transform: translateY(1px);
        }

        .secondary-btn {
            background-color: #ff3b30;
            /* çº¢è‰²ç”¨äºå±é™©æ“ä½œ */
            margin-top: 10px;
        }

        /* 4. çŠ¶æ€å’Œè¿›åº¦æ˜¾ç¤º */
        #status {
            margin-top: 20px;
            padding: 10px;
            background-color: rgba(255, 255, 255, 0.8);
            border-radius: 8px;
            text-align: left;
            white-space: pre-wrap;
            word-break: break-all;
            border: 1px solid rgba(0, 0, 0, 0.05);
            max-height: 200px;
            /* é™åˆ¶é«˜åº¦ */
            overflow-y: auto;
            /* å…è®¸æ»šåŠ¨ */
        }

        .progress-bar-container {
            height: 8px;
            background-color: rgba(0, 0, 0, 0.1);
            border-radius: 4px;
            margin-top: 10px;
            overflow: hidden;
        }

        .progress-bar {
            height: 100%;
            width: 0%;
            background-color: #34c759;
            /* ç»¿è‰² */
            transition: width 0.1s;
        }

        /* 5. ç§»åŠ¨ç«¯ä¼˜åŒ– (ç®€æ´å¸ƒå±€ï¼Œæ— éœ€é¡¶æ ) */
        @media (max-width: 600px) {
            .container {
                padding: 10px;
            }

            .card {
                padding: 20px;
            }
        }
    </style>
</head>

<body>

    <div class="container">

        <div class="card" id="join-section">
            <h2>è¿æ¥è®¾å¤‡</h2>
            <input type="text" id="room-code-input" placeholder="è¾“å…¥ä¸‰ä½è¿æ¥ç  (å¦‚ ABC)" maxlength="3"
                style="text-transform: uppercase;">
            <button id="join-btn">åŠ å…¥æˆ¿é—´å¹¶æ¥æ”¶</button>
            <button id="create-btn">ç”Ÿæˆè¿æ¥ç å¹¶å‘é€</button>
        </div>

        <div class="card" id="transfer-section" style="display: none;">
            <h2 id="transfer-title">ç­‰å¾…è¿æ¥...</h2>
            <div id="file-selection-area">
                <input type="file" id="file-input">
                <button id="send-btn" disabled>ç­‰å¾…è¿æ¥...</button>
            </div>
            <div id="download-area" style="display: none;">
                <p id="received-filename">å·²æ¥æ”¶æ–‡ä»¶ï¼š</p>
                <a id="download-link" download style="display: none;">ç‚¹å‡»ä¸‹è½½</a>
            </div>

            <div class="progress-bar-container">
                <div id="progress-bar" class="progress-bar"></div>
            </div>

            <button id="clean-room-btn" class="secondary-btn" style="display: none;">æ¸…é™¤æˆ¿é—´æ•°æ®å¹¶é‡ç½®</button>
        </div>

        <div class="card" id="status-card">
            <h2>çŠ¶æ€ä¿¡æ¯</h2>
            <div id="status">è¿æ¥çŠ¶æ€ï¼šæœªè¿æ¥</div>
        </div>

    </div>

    <script>
        // -----------------------------------------------------------
        // 1. Firebase é…ç½®ä¸ STUN ä¼˜åŒ–
        // -----------------------------------------------------------
        const firebaseConfig = {
            apiKey: "AIzaSyAeSI1akqwsPBrVyv7YKirV06fqdkL3YNI",
            authDomain: "quark-b7305.firebaseapp.com",
            projectId: "quark-b7305",
            storageBucket: "quark-b7305.firebasestorage.app",
            messagingSenderId: "843016834358",
            appId: "1:843016834358:web:9438c729be28c4d492f797",
            measurementId: "G-5BVT26KRT6"
        };

        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();

        // ä¼˜åŒ–ï¼šä½¿ç”¨æ‚¨æä¾›çš„å›½å†…å’Œå…¬å…± STUN æœåŠ¡å™¨åˆ—è¡¨
        const STUN_SERVERS = [
            { urls: 'stun:stun.minisipserver.com' },
            { urls: 'stun:stun.zoiper.com' },
            { urls: 'stun:stun.voipbuster.com' },
            { urls: 'stun:stun.sipgate.net' },
            { urls: 'stun:stun.schlund.de' },
            { urls: 'stun:stun.voipstunt.com' },
            { urls: 'stun:stun.1und1.de' },
            { urls: 'stun:stun.gmx.net' },
            { urls: 'stun:stun.l.google.com:19302' }, // è°·æ­Œä½œä¸ºå¤‡ç”¨
        ];


        // -----------------------------------------------------------
        // 2. å…¨å±€å˜é‡ä¸ DOM å…ƒç´  (ä¿æŒä¸å˜)
        // -----------------------------------------------------------
        let peerConnection;
        let dataChannel;
        let isSender = false;
        let currentRoomCode = null;
        let fileToSend = null;
        let fileBuffer = [];
        let receivedFileSize = 0;
        let fileName = '';
        let hasSentCodePrompt = false; // æ–°å¢æ ‡è®°ï¼Œé˜²æ­¢å¤šæ¬¡æç¤º

        // File Chunk Settings
        const CHUNK_SIZE = 64 * 1024;
        const METADATA_LABEL = 'metadata';

        const joinSection = document.getElementById('join-section');
        const transferSection = document.getElementById('transfer-section');
        const transferTitle = document.getElementById('transfer-title');
        const roomCodeInput = document.getElementById('room-code-input');
        const joinBtn = document.getElementById('join-btn');
        const createBtn = document.getElementById('create-btn');
        const fileInput = document.getElementById('file-input');
        const sendBtn = document.getElementById('send-btn');
        const statusDiv = document.getElementById('status');
        const progressBar = document.getElementById('progress-bar');
        const downloadArea = document.getElementById('download-area');
        const receivedFilenameP = document.getElementById('received-filename');
        const downloadLink = document.getElementById('download-link');
        const cleanRoomBtn = document.getElementById('clean-room-btn');

        // -----------------------------------------------------------
        // 3. æ ¸å¿ƒå‡½æ•°ï¼šçŠ¶æ€æ›´æ–°ä¸å®ç”¨å·¥å…· (ç•¥å¾®ä¿®æ”¹ logStatus)
        // -----------------------------------------------------------

        /** è®°å½•çŠ¶æ€ */
        function logStatus(message) {
            statusDiv.innerHTML = `[${new Date().toLocaleTimeString()}] ${message}\n` + statusDiv.innerHTML;
            // è‡ªåŠ¨æ»šåŠ¨åˆ°é¡¶éƒ¨ï¼Œç¡®ä¿æœ€æ–°ä¿¡æ¯å¯è§
            if (statusDiv.scrollTop > 0) statusDiv.scrollTop = 0;
            console.log(message);
        }

        /** ç”Ÿæˆä¸‰ä½éšæœºå¤§å†™å­—æ¯ç  */
        function generateRoomCode() {
            let result = '';
            const characters = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ';
            for (let i = 0; i < 3; i++) {
                result += characters.charAt(Math.floor(Math.random() * characters.length));
            }
            return result;
        }

        /** æ›´æ–°è¿›åº¦æ¡ */
        function updateProgress(percentage) {
            progressBar.style.width = `${Math.min(100, percentage)}%`;
        }

        /** æ‰‹åŠ¨æ¸…ç†æˆ¿é—´æ•°æ® */
        async function cleanRoomData(roomCode) {
            if (!roomCode) {
                logStatus('æ— è¿æ¥ç ï¼Œæ— éœ€æ¸…ç†ã€‚');
                return;
            }
            logStatus(`æ­£åœ¨æ¸…ç†æˆ¿é—´ ${roomCode} çš„ Firebase æ•°æ®...`);
            try {
                await database.ref(`rooms/${roomCode}`).remove();
                logStatus('âœ… æˆ¿é—´æ•°æ®æ¸…ç†å®Œæ¯•ã€‚');
                resetUI();
            } catch (e) {
                logStatus(`âŒ æ¸…ç†å¤±è´¥: ${e.message}`);
            }
        }

        /** é‡ç½®ç•Œé¢åˆ°åˆå§‹çŠ¶æ€ */
        function resetUI() {
            joinSection.style.display = 'block';
            transferSection.style.display = 'none';
            transferTitle.textContent = 'ç­‰å¾…è¿æ¥...';
            sendBtn.textContent = 'ç­‰å¾…è¿æ¥...';
            sendBtn.disabled = true;
            fileInput.value = '';
            downloadArea.style.display = 'none';
            cleanRoomBtn.style.display = 'none';
            currentRoomCode = null;
            fileToSend = null;
            fileBuffer = [];
            receivedFileSize = 0;
            fileName = '';
            hasSentCodePrompt = false;

            // å°è¯•å…³é—­è¿æ¥
            if (peerConnection) {
                peerConnection.close();
                peerConnection = null;
            }
            if (dataChannel) {
                dataChannel.close();
                dataChannel = null;
            }
            logStatus('ç•Œé¢å·²é‡ç½®ã€‚');
        }

        // -----------------------------------------------------------
        // 4. WebRTC åˆå§‹åŒ– (ä¿®æ”¹ ICE Servers)
        // -----------------------------------------------------------

        /** åˆå§‹åŒ– RTCPeerConnection */
        function createPeerConnection(roomCode, isSenderDevice) {
            // ä½¿ç”¨ STUN_SERVERS æ•°ç»„
            peerConnection = new RTCPeerConnection({ iceServers: STUN_SERVERS.map(url => ({ urls: url.urls })) });
            currentRoomCode = roomCode;
            isSender = isSenderDevice;

            logStatus(`åˆ›å»º WebRTC è¿æ¥ï¼Œèº«ä»½: ${isSender ? 'å‘é€æ–¹' : 'æ¥æ”¶æ–¹'}ã€‚è¿æ¥ç : ${roomCode}`);
            cleanRoomBtn.style.display = 'block';

            // 1. å¤„ç† ICE å€™é€‰è€… (ä¼˜åŒ–æç¤ºé€»è¾‘)
            peerConnection.onicecandidate = async (event) => {
                if (event.candidate) {
                    // ****** æ ¸å¿ƒä¼˜åŒ–ç‚¹ï¼šICE å€™é€‰è€…å¼€å§‹å‘é€æ—¶æ‰æç¤ºç”¨æˆ·ä¼ é€’è¿æ¥ç  ******
                    if (isSender && !hasSentCodePrompt) {
                        transferTitle.textContent = `ğŸ“¢ è¿æ¥ç ï¼š${roomCode}ã€‚è¯·å°†æ­¤ç å‘é€ç»™æ¥æ”¶æ–¹ã€‚`;
                        logStatus('ICE å€™é€‰è€…æ­£åœ¨å‘é€ä¸­ã€‚**è¯·å°†è¿æ¥ç å‘é€ç»™æ¥æ”¶æ–¹ã€‚**');
                        hasSentCodePrompt = true;
                    }

                    // å°† ICE å€™é€‰è€…å‘é€ç»™å¯¹æ–¹
                    const role = isSender ? 'sender' : 'receiver';
                    const candidatesRef = database.ref(`rooms/${roomCode}/${role}/iceCandidates`);
                    await candidatesRef.push(event.candidate.toJSON());
                    logStatus('å‘é€ ICE å€™é€‰è€…...');
                }
            };

            // 2. å¤„ç†è¿æ¥çŠ¶æ€å˜åŒ– (ä¿æŒä¸å˜)
            peerConnection.oniceconnectionstatechange = () => {
                logStatus(`ICE è¿æ¥çŠ¶æ€: ${peerConnection.iceConnectionState}`);
                if (peerConnection.iceConnectionState === 'connected') {
                    logStatus('âœ… P2P è¿æ¥å»ºç«‹æˆåŠŸï¼');
                    transferTitle.textContent = `è¿æ¥æˆåŠŸï¼å¯ä»¥å¼€å§‹ä¼ è¾“ã€‚`;
                    if (isSender) {
                        sendBtn.textContent = 'é€‰æ‹©æ–‡ä»¶å¹¶å‘é€';
                        sendBtn.disabled = false;
                    } else {
                        transferTitle.textContent = 'ç­‰å¾…å‘é€æ–¹ä¼ è¾“æ–‡ä»¶...';
                    }
                } else if (peerConnection.iceConnectionState === 'failed' || peerConnection.iceConnectionState === 'closed') {
                    logStatus('âŒ P2P è¿æ¥æ–­å¼€æˆ–å¤±è´¥ã€‚è¯·æ£€æŸ¥è¿æ¥ç å’Œç½‘ç»œç¯å¢ƒã€‚');
                }
            };

            // 3. å¤„ç† DataChannel (ä¿æŒä¸å˜)
            if (isSender) {
                dataChannel = peerConnection.createDataChannel('fileTransfer', { ordered: true });
                setupDataChannel(dataChannel);
                logStatus('å·²åˆ›å»º DataChannel...');
            } else {
                peerConnection.ondatachannel = (event) => {
                    dataChannel = event.channel;
                    setupDataChannel(dataChannel);
                    logStatus('å·²æ¥æ”¶ DataChannel...');
                };
            }
        }

        /** DataChannel çš„é€šç”¨è®¾ç½® (ä¿æŒä¸å˜) */
        function setupDataChannel(channel) {
            // ... (å†…å®¹ä¿æŒä¸å˜ï¼Œè¯·æ²¿ç”¨ä¸Šä¸€ä¸ªå›å¤ä¸­çš„ setupDataChannel å‡½æ•°ä½“) ...
            channel.onopen = () => {
                logStatus('DataChannel æ‰“å¼€ï¼Œå¯ä»¥å¼€å§‹ä¼ è¾“æ•°æ®ã€‚');
            };
            channel.onclose = () => {
                logStatus('DataChannel å…³é—­ã€‚');
            };
            channel.onerror = (error) => {
                logStatus(`DataChannel é”™è¯¯: ${error}`);
            };

            if (!isSender) {
                channel.onmessage = handleDataChannelMessage;
            }
        }

        // -----------------------------------------------------------
        // 5. ä¿¡ä»¤ï¼šå‘é€æ–¹ (Offer) (ä¿®æ”¹æç¤ºé€»è¾‘)
        // -----------------------------------------------------------

        async function createSenderOffer(roomCode) {
            createPeerConnection(roomCode, true);
            transferTitle.textContent = `è¿æ¥ç ï¼š${roomCode}ã€‚æ­£åœ¨ç­‰å¾…ICEç”Ÿæˆ...`; // ç«‹å³æ˜¾ç¤ºè¿æ¥ç ï¼Œä½†æç¤ºåœ¨ç­‰å¾…

            try {
                const offer = await peerConnection.createOffer();
                await peerConnection.setLocalDescription(offer);

                await database.ref(`rooms/${roomCode}/sender/sdp`).set(peerConnection.localDescription.toJSON());
                logStatus('Offer SDP å·²å‘é€è‡³ Firebaseã€‚');

                database.ref(`rooms/${roomCode}/receiver/sdp`).on('value', async (snapshot) => {
                    const answer = snapshot.val();
                    if (answer && !peerConnection.currentRemoteDescription) {
                        logStatus('æ¥æ”¶åˆ° Answer SDPï¼Œè®¾ç½®è¿œç¨‹æè¿°...');
                        await peerConnection.setRemoteDescription(new RTCSessionDescription(answer));
                        listenForIceCandidates(roomCode, 'receiver');
                    }
                });

            } catch (e) {
                logStatus(`âŒ å‘é€æ–¹ Offer å¤±è´¥: ${e.message}`);
            }
        }

        // -----------------------------------------------------------
        // 6. ä¿¡ä»¤ï¼šæ¥æ”¶æ–¹ (Answer) (ä¿æŒä¸å˜)
        // -----------------------------------------------------------

        async function createReceiverAnswer(roomCode) {
            createPeerConnection(roomCode, false);
            transferTitle.textContent = `è¿æ¥ç ï¼š${roomCode}ã€‚æ­£åœ¨ç­‰å¾…å‘é€æ–¹å“åº”...`;

            // ... (å†…å®¹ä¿æŒä¸å˜ï¼Œè¯·æ²¿ç”¨ä¸Šä¸€ä¸ªå›å¤ä¸­çš„ createReceiverAnswer å‡½æ•°ä½“) ...
            database.ref(`rooms/${roomCode}/sender/sdp`).once('value').then(async (snapshot) => {
                const offer = snapshot.val();
                if (!offer) {
                    logStatus(`âŒ æˆ¿é—´ ${roomCode} ä¸å­˜åœ¨ Offerã€‚`);
                    return;
                }

                try {
                    logStatus('æ¥æ”¶åˆ° Offer SDPï¼Œè®¾ç½®è¿œç¨‹æè¿°...');
                    await peerConnection.setRemoteDescription(new RTCSessionDescription(offer));

                    const answer = await peerConnection.createAnswer();
                    await peerConnection.setLocalDescription(answer);

                    await database.ref(`rooms/${roomCode}/receiver/sdp`).set(peerConnection.localDescription.toJSON());
                    logStatus('Answer SDP å·²å‘é€è‡³ Firebaseã€‚');

                    listenForIceCandidates(roomCode, 'sender');

                } catch (e) {
                    logStatus(`âŒ æ¥æ”¶æ–¹ Answer å¤±è´¥: ${e.message}`);
                }
            });
        }

        // -----------------------------------------------------------
        // 7. ä¿¡ä»¤ï¼šICE ç›‘å¬ (ä¿æŒä¸å˜)
        // -----------------------------------------------------------

        /** ç›‘å¬å¯¹æ–¹çš„ ICE å€™é€‰è€… (å†…å®¹ä¿æŒä¸å˜ï¼Œè¯·æ²¿ç”¨ä¸Šä¸€ä¸ªå›å¤ä¸­çš„ listenForIceCandidates å‡½æ•°ä½“) */
        function listenForIceCandidates(roomCode, remoteRole) {
            database.ref(`rooms/${roomCode}/${remoteRole}/iceCandidates`).on('child_added', (snapshot) => {
                const candidate = snapshot.val();
                if (candidate) {
                    try {
                        peerConnection.addIceCandidate(new RTCIceCandidate(candidate));
                        logStatus(`æ”¶åˆ°å¹¶æ·»åŠ äº† ${remoteRole} çš„ ICE å€™é€‰è€…ã€‚`);
                    } catch (e) {
                        logStatus(`âŒ æ·»åŠ  ICE å€™é€‰è€…å¤±è´¥: ${e.message}`);
                    }
                }
            });
        }

        // -----------------------------------------------------------
        // 8. æ–‡ä»¶ä¼ è¾“é€»è¾‘ (å‘é€æ–¹) (ä¿æŒä¸å˜ï¼Œå¢åŠ æ¸…ç†)
        // -----------------------------------------------------------

        /** å‘é€æ–‡ä»¶ (å†…å®¹ä¿æŒä¸å˜ï¼Œè¯·æ²¿ç”¨ä¸Šä¸€ä¸ªå›å¤ä¸­çš„ sendFile å‡½æ•°ä½“) */
        async function sendFile(file) {
            // ... (æ–‡ä»¶å‘é€é€»è¾‘) ...
            if (dataChannel.readyState !== 'open') {
                logStatus('âŒ DataChannel æœªæ‰“å¼€æˆ–æœªè¿æ¥ã€‚');
                return;
            }

            const fileSize = file.size;
            let offset = 0;
            let chunksSent = 0;

            // 1. å‘é€æ–‡ä»¶å…ƒæ•°æ®
            const metadata = {
                label: METADATA_LABEL,
                fileName: file.name,
                fileSize: fileSize,
                chunkSize: CHUNK_SIZE
            };
            dataChannel.send(JSON.stringify(metadata));
            logStatus(`å¼€å§‹ä¼ è¾“æ–‡ä»¶: ${file.name} (${(fileSize / 1024 / 1024).toFixed(2)} MB)`);

            sendBtn.disabled = true;

            // 2. åˆ†å—å‘é€æ–‡ä»¶
            const fileReader = new FileReader();

            fileReader.onload = async (e) => {
                dataChannel.send(e.target.result);
                offset += e.target.result.byteLength;
                chunksSent++;

                const percentage = (offset / fileSize) * 100;
                updateProgress(percentage);
                transferTitle.textContent = `å‘é€ä¸­: ${file.name} | ${percentage.toFixed(1)}%`;

                if (offset < fileSize) {
                    readSlice(offset);
                } else {
                    logStatus('âœ… æ–‡ä»¶å‘é€å®Œæˆï¼');
                    sendBtn.disabled = false;
                    sendBtn.textContent = 'ä¼ è¾“å®Œæˆï¼Œå¯é‡æ–°é€‰æ‹©æ–‡ä»¶';
                    // å®Œæˆåæ¸…ç†æˆ¿é—´æ•°æ®
                    cleanRoomData(currentRoomCode);
                }
            };

            fileReader.onerror = (error) => {
                logStatus(`âŒ æ–‡ä»¶è¯»å–å¤±è´¥: ${error}`);
            };

            const readSlice = (start) => {
                const slice = file.slice(start, start + CHUNK_SIZE);
                fileReader.readAsArrayBuffer(slice);
            };

            readSlice(0);
        }

        // -----------------------------------------------------------
        // 9. æ–‡ä»¶ä¼ è¾“é€»è¾‘ (æ¥æ”¶æ–¹) (ä¿æŒä¸å˜ï¼Œå¢åŠ æ¸…ç†)
        // -----------------------------------------------------------

        /** å¤„ç†æ¥æ”¶åˆ°çš„ DataChannel æ¶ˆæ¯ (å†…å®¹ä¿æŒä¸å˜ï¼Œè¯·æ²¿ç”¨ä¸Šä¸€ä¸ªå›å¤ä¸­çš„ handleDataChannelMessage å‡½æ•°ä½“) */
        function handleDataChannelMessage(event) {
            const data = event.data;

            if (typeof data === 'string') {
                try {
                    const metadata = JSON.parse(data);
                    if (metadata.label === METADATA_LABEL) {
                        fileName = metadata.fileName;
                        receivedFileSize = metadata.fileSize;
                        fileBuffer = [];
                        logStatus(`å¼€å§‹æ¥æ”¶æ–‡ä»¶ï¼š${fileName} (å¤§å°: ${(receivedFileSize / 1024 / 1024).toFixed(2)} MB)`);
                        transferTitle.textContent = `æ¥æ”¶ä¸­: ${fileName} | 0.0%`;
                        downloadArea.style.display = 'none';
                        return;
                    }
                } catch (e) {
                    // å¿½ç•¥éå…ƒæ•°æ®çš„å­—ç¬¦ä¸²æ¶ˆæ¯
                }
            } else if (data instanceof ArrayBuffer) {
                fileBuffer.push(data);
                const totalBytesReceived = fileBuffer.reduce((sum, chunk) => sum + chunk.byteLength, 0);
                const percentage = (totalBytesReceived / receivedFileSize) * 100;

                updateProgress(percentage);
                transferTitle.textContent = `æ¥æ”¶ä¸­: ${fileName} | ${percentage.toFixed(1)}%`;

                if (totalBytesReceived >= receivedFileSize) {
                    logStatus('âœ… æ–‡ä»¶æ¥æ”¶å®Œæˆï¼æ­£åœ¨åˆæˆ...');

                    const fullFile = new Blob(fileBuffer);
                    const downloadUrl = URL.createObjectURL(fullFile);

                    receivedFilenameP.textContent = `å·²æ¥æ”¶æ–‡ä»¶: ${fileName} (ç‚¹å‡»ä¸‹è½½)`;
                    downloadLink.href = downloadUrl;
                    downloadLink.download = fileName;
                    downloadLink.textContent = `ç‚¹å‡»ä¸‹è½½ ${fileName}`;
                    downloadLink.style.display = 'block';
                    downloadArea.style.display = 'block';
                    transferTitle.textContent = `æ–‡ä»¶æ¥æ”¶å®Œæ¯•ï¼`;

                    // å®Œæˆåæ¸…ç†æˆ¿é—´æ•°æ®
                    cleanRoomData(currentRoomCode);
                }
            }
        }


        // -----------------------------------------------------------
        // 10. äº‹ä»¶ç›‘å¬å™¨ (æ–°å¢æ¸…ç†æŒ‰é’®äº‹ä»¶)
        // -----------------------------------------------------------

        // ç›‘å¬ï¼šç‚¹å‡»â€œç”Ÿæˆè¿æ¥ç å¹¶å‘é€â€
        createBtn.addEventListener('click', () => {
            const roomCode = generateRoomCode();
            roomCodeInput.value = roomCode;
            joinSection.style.display = 'none';
            transferSection.style.display = 'block';
            createSenderOffer(roomCode);
        });

        // ç›‘å¬ï¼šç‚¹å‡»â€œåŠ å…¥æˆ¿é—´å¹¶æ¥æ”¶â€
        joinBtn.addEventListener('click', () => {
            const roomCode = roomCodeInput.value.toUpperCase().trim();
            if (roomCode.length !== 3) {
                logStatus('âŒ è¿æ¥ç å¿…é¡»æ˜¯ä¸‰ä½å¤§å†™å­—æ¯ã€‚');
                return;
            }
            joinSection.style.display = 'none';
            transferSection.style.display = 'block';
            createReceiverAnswer(roomCode);
        });

        // ç›‘å¬ï¼šæ–‡ä»¶é€‰æ‹©
        fileInput.addEventListener('change', (e) => {
            fileToSend = e.target.files[0];
            if (fileToSend) {
                sendBtn.textContent = `å‘é€ ${fileToSend.name}`;
                // åªæœ‰å½“è¿æ¥çŠ¶æ€ä¸º connected æ—¶æ‰å¯ç”¨å‘é€æŒ‰é’®ï¼Œè¿™é‡Œåªå¤„ç†é€‰æ‹©æ–‡ä»¶ï¼Œå¯ç”¨é€»è¾‘åœ¨ oniceconnectionstatechange ä¸­
            } else {
                sendBtn.textContent = 'é€‰æ‹©æ–‡ä»¶å¹¶å‘é€';
            }
        });

        // ç›‘å¬ï¼šç‚¹å‡»å‘é€æŒ‰é’®
        sendBtn.addEventListener('click', () => {
            if (fileToSend) {
                sendFile(fileToSend);
            } else {
                logStatus('âŒ è¯·å…ˆé€‰æ‹©è¦å‘é€çš„æ–‡ä»¶ã€‚');
            }
        });

        // ç›‘å¬ï¼šæ‰‹åŠ¨æ¸…ç†æŒ‰é’®
        cleanRoomBtn.addEventListener('click', () => {
            if (currentRoomCode) {
                cleanRoomData(currentRoomCode);
            } else {
                resetUI(); // å¦‚æœæ²¡æœ‰è¿æ¥ç ï¼Œç›´æ¥é‡ç½®ç•Œé¢
            }
        });

    </script>

</body>

</html>
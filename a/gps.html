<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>全天轨迹记录器</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'PingFang SC', 'Microsoft YaHei', sans-serif;
        }
        
        body {
            background-color: #f5f7fa;
            color: #333;
            line-height: 1.6;
        }
        
        .container {
            max-width: 100%;
            height: 100vh;
            display: flex;
            flex-direction: column;
        }
        
        header {
            background: linear-gradient(135deg, #3498db, #2c3e50);
            color: white;
            padding: 15px 20px;
            text-align: center;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }
        
        h1 {
            font-size: 1.5rem;
            margin-bottom: 5px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        h1 i {
            margin-right: 10px;
        }
        
        .subtitle {
            font-size: 0.9rem;
            opacity: 0.9;
        }
        
        .main-content {
            display: flex;
            flex: 1;
            flex-direction: column;
            overflow: hidden;
        }
        
        #mapContainer {
            flex: 3;
            width: 100%;
            min-height: 300px;
            border-bottom: 2px solid #ddd;
        }
        
        .info-panel {
            flex: 2;
            padding: 15px;
            overflow-y: auto;
            background: white;
        }
        
        .stats {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-bottom: 20px;
        }
        
        .stat-card {
            background: white;
            border-radius: 10px;
            padding: 15px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.05);
            text-align: center;
            border-left: 4px solid #3498db;
        }
        
        .stat-card.primary {
            border-left-color: #e74c3c;
        }
        
        .stat-value {
            font-size: 1.8rem;
            font-weight: bold;
            color: #2c3e50;
            margin: 5px 0;
        }
        
        .stat-label {
            font-size: 0.9rem;
            color: #7f8c8d;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .stat-label i {
            margin-right: 5px;
        }
        
        .control-panel {
            background: white;
            padding: 15px;
            border-radius: 10px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.05);
            margin-bottom: 20px;
        }
        
        .btn-group {
            display: flex;
            gap: 10px;
        }
        
        button {
            flex: 1;
            padding: 12px;
            border: none;
            border-radius: 5px;
            font-weight: bold;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s;
        }
        
        button i {
            margin-right: 5px;
        }
        
        .btn-start {
            background: #2ecc71;
            color: white;
        }
        
        .btn-start:hover {
            background: #27ae60;
        }
        
        .btn-pause {
            background: #f39c12;
            color: white;
        }
        
        .btn-pause:hover {
            background: #d35400;
        }
        
        .btn-clear {
            background: #e74c3c;
            color: white;
        }
        
        .btn-clear:hover {
            background: #c0392b;
        }
        
        .history {
            margin-top: 20px;
        }
        
        .history h3 {
            margin-bottom: 10px;
            padding-bottom: 5px;
            border-bottom: 1px solid #eee;
            color: #2c3e50;
        }
        
        .history-item {
            padding: 10px 15px;
            background: #f8f9fa;
            border-radius: 5px;
            margin-bottom: 10px;
            display: flex;
            justify-content: space-between;
        }
        
        .history-date {
            font-weight: bold;
            color: #2c3e50;
        }
        
        .history-stats {
            font-size: 0.9rem;
            color: #7f8c8d;
        }
        
        footer {
            text-align: center;
            padding: 15px;
            font-size: 0.8rem;
            color: #7f8c8d;
            background: #ecf0f1;
        }
        
        .status-bar {
            display: flex;
            align-items: center;
            padding: 8px 15px;
            background: #34495e;
            color: white;
            font-size: 0.9rem;
        }
        
        .status-indicator {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: #2ecc71;
            margin-right: 8px;
        }
        
        .status-indicator.inactive {
            background: #e74c3c;
        }
        
        @media (min-width: 768px) {
            .main-content {
                flex-direction: row;
            }
            
            #mapContainer {
                flex: 2;
                border-right: 2px solid #ddd;
                border-bottom: none;
            }
            
            .info-panel {
                flex: 1;
            }
            
            .stats {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1><i class="bi bi-geo-alt-fill"></i>全天轨迹记录器</h1>
            <div class="subtitle">基于天地图的位置轨迹记录应用</div>
        </header>
        
        <div class="status-bar">
            <div class="status-indicator inactive" id="statusIndicator"></div>
            <span id="statusText">等待开始记录</span>
        </div>
        
        <div class="main-content">
            <div id="mapContainer"></div>
            
            <div class="info-panel">
                <div class="stats">
                    <div class="stat-card">
                        <div class="stat-label"><i class="bi bi-calendar-event"></i> 记录日期</div>
                        <div class="stat-value" id="currentDate">--</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label"><i class="bi bi-clock"></i> 开始时间</div>
                        <div class="stat-value" id="startTime">--:--</div>
                    </div>
                    <div class="stat-card primary">
                        <div class="stat-label"><i class="bi bi-stopwatch"></i> 记录时长</div>
                        <div class="stat-value" id="duration">00:00:00</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label"><i class="bi bi-signpost-split"></i> 里程(公里)</div>
                        <div class="stat-value" id="distance">0.00</div>
                    </div>
                </div>
                
                <div class="control-panel">
                    <div class="btn-group">
                        <button class="btn-start" id="btnStart"><i class="bi bi-play-fill"></i> 开始记录</button>
                        <button class="btn-pause" id="btnPause"><i class="bi bi-pause-fill"></i> 暂停记录</button>
                        <button class="btn-clear" id="btnClear"><i class="bi bi-trash-fill"></i> 清除记录</button>
                    </div>
                </div>
                
                <div class="history">
                    <h3><i class="bi bi-clock-history"></i> 历史记录</h3>
                    <div id="historyList">
                        <div class="history-item">
                            <div class="history-date">暂无记录</div>
                            <div class="history-stats">--</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <footer>
            <p>© 2023 全天轨迹记录器 | 使用天地图API | 位置数据仅存储在本地</p>
        </footer>
    </div>

    <!-- 天地图API -->
    <script type="text/javascript" src="https://api.tianditu.gov.cn/api?v=4.0&tk=	6e5b0e71ae628b8c2ab60c9144a7848e"></script>
    <script>
        // 注意：使用前请替换为您的天地图密钥
        // 申请地址: https://console.tianditu.gov.cn/api/
        
        // 全局变量
        let map, trackPoints = [], isRecording = false;
        let startTime = null, timerInterval = null, durationInterval = null;
        let totalDistance = 0;
        let currentPolyline = null;
        
        // 初始化地图
        function initMap() {
            // 设置地图中心点（默认北京）
            map = new T.Map('mapContainer');
            map.centerAndZoom(new T.LngLat(116.3974, 39.9093), 12);
            
            // 添加控件
            map.addControl(new T.Control.Zoom());
            map.addControl(new T.Control.Scale());
        }
        
        // 计算两点间距离（Haversine公式）
        function calculateDistance(lat1, lon1, lat2, lon2) {
            const R = 6371; // 地球半径（公里）
            const dLat = (lat2 - lat1) * Math.PI / 180;
            const dLon = (lon2 - lon1) * Math.PI / 180;
            const a = 
                Math.sin(dLat/2) * Math.sin(dLat/2) +
                Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) * 
                Math.sin(dLon/2) * Math.sin(dLon/2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
            return R * c;
        }
        
        // 更新统计信息
        function updateStats() {
            document.getElementById('currentDate').textContent = new Date().toLocaleDateString();
            
            if (startTime) {
                const now = new Date();
                const diff = now - startTime;
                const hours = Math.floor(diff / 3600000).toString().padStart(2, '0');
                const minutes = Math.floor((diff % 3600000) / 60000).toString().padStart(2, '0');
                const seconds = Math.floor((diff % 60000) / 1000).toString().padStart(2, '0');
                document.getElementById('duration').textContent = `${hours}:${minutes}:${seconds}`;
            }
            
            document.getElementById('distance').textContent = totalDistance.toFixed(2);
        }
        
        // 获取当前位置
        function getCurrentPosition() {
            if (!navigator.geolocation) {
                alert("您的浏览器不支持地理定位功能");
                return;
            }
            
            navigator.geolocation.getCurrentPosition(
                function(position) {
                    const lat = position.coords.latitude;
                    const lng = position.coords.longitude;
                    const accuracy = position.coords.accuracy;
                    
                    // 添加到轨迹点数组
                    const newPoint = { lat, lng, time: new Date() };
                    
                    // 计算距离（如果有上一个点）
                    if (trackPoints.length > 0) {
                        const lastPoint = trackPoints[trackPoints.length - 1];
                        const segmentDistance = calculateDistance(
                            lastPoint.lat, lastPoint.lng, lat, lng
                        );
                        totalDistance += segmentDistance;
                    }
                    
                    trackPoints.push(newPoint);
                    
                    // 更新地图上的轨迹
                    updateTrackOnMap();
                    
                    // 更新统计信息
                    updateStats();
                    
                    // 保存到本地存储
                    saveToLocalStorage();
                },
                function(error) {
                    console.error("获取位置失败:", error);
                    updateStatus("位置获取失败: " + error.message, false);
                },
                {
                    enableHighAccuracy: true,
                    timeout: 10000,
                    maximumAge: 30000
                }
            );
        }
        
        // 在地图上更新轨迹
        function updateTrackOnMap() {
            if (trackPoints.length < 2) return;
            
            // 清除旧轨迹
            if (currentPolyline) {
                map.removeOverLay(currentPolyline);
            }
            
            // 创建新轨迹
            const points = trackPoints.map(point => new T.LngLat(point.lng, point.lat));
            currentPolyline = new T.Polyline(points, {
                color: "#3498db",
                weight: 4,
                opacity: 0.8
            });
            
            map.addOverLay(currentPolyline);
            
            // 调整地图视野以适应轨迹
            const bounds = new T.LngLatBounds();
            points.forEach(point => bounds.extend(point));
            map.fitBounds(bounds, {padding: 50});
        }
        
        // 更新状态指示器
        function updateStatus(text, isActive) {
            const indicator = document.getElementById('statusIndicator');
            const statusText = document.getElementById('statusText');
            
            statusText.textContent = text;
            if (isActive) {
                indicator.classList.remove('inactive');
            } else {
                indicator.classList.add('inactive');
            }
        }
        
        // 保存到本地存储
        function saveToLocalStorage() {
            const trackData = {
                points: trackPoints,
                startTime: startTime,
                totalDistance: totalDistance
            };
            
            localStorage.setItem('lastTrack', JSON.stringify(trackData));
            
            // 同时保存到历史记录
            saveToHistory();
        }
        
        // 保存到历史记录
        function saveToHistory() {
            if (trackPoints.length === 0) return;
            
            const history = JSON.parse(localStorage.getItem('trackHistory') || '[]');
            
            // 检查是否已有今天记录
            const today = new Date().toLocaleDateString();
            const existingIndex = history.findIndex(item => item.date === today);
            
            const trackInfo = {
                date: today,
                startTime: startTime.toLocaleTimeString(),
                duration: document.getElementById('duration').textContent,
                distance: totalDistance.toFixed(2),
                points: trackPoints
            };
            
            if (existingIndex >= 0) {
                history[existingIndex] = trackInfo;
            } else {
                history.push(trackInfo);
            }
            
            localStorage.setItem('trackHistory', JSON.stringify(history));
            loadHistory();
        }
        
        // 加载历史记录
        function loadHistory() {
            const history = JSON.parse(localStorage.getItem('trackHistory') || '[]');
            const historyList = document.getElementById('historyList');
            
            if (history.length === 0) {
                historyList.innerHTML = `
                    <div class="history-item">
                        <div class="history-date">暂无记录</div>
                        <div class="history-stats">--</div>
                    </div>
                `;
                return;
            }
            
            // 按日期降序排列
            history.sort((a, b) => new Date(b.date) - new Date(a.date));
            
            historyList.innerHTML = history.map(item => `
                <div class="history-item">
                    <div class="history-date">${item.date}</div>
                    <div class="history-stats">${item.duration} | ${item.distance}公里</div>
                </div>
            `).join('');
        }
        
        // 从本地存储加载
        function loadFromLocalStorage() {
            const savedData = JSON.parse(localStorage.getItem('lastTrack') || 'null');
            
            if (savedData) {
                trackPoints = savedData.points || [];
                startTime = new Date(savedData.startTime);
                totalDistance = savedData.totalDistance || 0;
                
                // 更新UI
                document.getElementById('startTime').textContent = startTime.toLocaleTimeString();
                updateStats();
                updateTrackOnMap();
                
                if (trackPoints.length > 0) {
                    updateStatus("已加载上次记录", false);
                }
            }
            
            loadHistory();
        }
        
        // 开始记录
        function startRecording() {
            if (isRecording) return;
            
            isRecording = true;
            updateStatus("记录中...", true);
            
            // 设置开始时间（如果尚未设置）
            if (!startTime) {
                startTime = new Date();
                document.getElementById('startTime').textContent = startTime.toLocaleTimeString();
            }
            
            // 立即获取一次位置
            getCurrentPosition();
            
            // 设置定时器每30秒获取一次位置
            timerInterval = setInterval(getCurrentPosition, 30000);
            
            // 设置定时器每秒更新持续时间
            durationInterval = setInterval(updateStats, 1000);
        }
        
        // 暂停记录
        function pauseRecording() {
            if (!isRecording) return;
            
            isRecording = false;
            updateStatus("已暂停", false);
            
            clearInterval(timerInterval);
            clearInterval(durationInterval);
        }
        
        // 清除记录
        function clearRecording() {
            pauseRecording();
            
            if (!confirm("确定要清除当前记录吗？此操作不可撤销。")) return;
            
            trackPoints = [];
            startTime = null;
            totalDistance = 0;
            
            if (currentPolyline) {
                map.removeOverLay(currentPolyline);
                currentPolyline = null;
            }
            
            document.getElementById('startTime').textContent = '--:--';
            document.getElementById('duration').textContent = '00:00:00';
            document.getElementById('distance').textContent = '0.00';
            
            localStorage.removeItem('lastTrack');
            updateStatus("记录已清除", false);
        }
        
        // 初始化应用
        function initApp() {
            initMap();
            loadFromLocalStorage();
            
            // 设置事件监听器
            document.getElementById('btnStart').addEventListener('click', startRecording);
            document.getElementById('btnPause').addEventListener('click', pauseRecording);
            document.getElementById('btnClear').addEventListener('click', clearRecording);
            
            // 显示当前日期
            document.getElementById('currentDate').textContent = new Date().toLocaleDateString();
        }
        
        // 页面加载完成后初始化
        window.onload = initApp;
    </script>
</body>
</html>

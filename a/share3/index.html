<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å¤¸å…‹é—ªä¼  | QuarkShare P2P</title>
    <script src="/js/nav.js"></script>
    <link rel="stylesheet" href="nav.css">

    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
    <style>
        /* 1. æç®€æ¯›ç»ç’ƒ CSS å’Œ é¡¶æ å…¼å®¹æ€§å¤„ç† */
        :root {
            --header-height: 60px;
            --main-blue: #007aff;
            --main-green: #34c759;
            --bg-light: #f0f2f5;
            --card-bg-opacity: 0.8;
            --card-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.15);
            --card-border: 1px solid rgba(255, 255, 255, 0.3);
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            margin: 0;
            padding: 0;
            background: url('/image/bg.png') no-repeat center center fixed;
            background-size: cover;
            color: #333;
            transition: background-color 0.3s;
        }

        .main-content-wrapper {
            padding-top: var(--header-height);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: flex-start;
            padding-bottom: 50px;
        }

        /* 2. å®¹å™¨å’Œå¡ç‰‡æ ·å¼ */
        .container {
            width: 90%;
            max-width: 480px;
            padding: 30px 20px;
        }

        .card {
            background-color: rgba(255, 255, 255, var(--card-bg-opacity));
            border-radius: 12px;
            box-shadow: var(--card-shadow);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border: var(--card-border);
            padding: 30px;
            text-align: center;
            margin-bottom: 20px;
        }

        h2 {
            margin-top: 0;
            margin-bottom: 20px;
            font-weight: 500;
            color: #1a1a1a;
        }

        /* 3. è¾“å…¥æ¡†å’ŒæŒ‰é’®æ ·å¼ */
        .app-input {
            width: 100%;
            padding: 12px;
            margin-bottom: 15px;
            border-radius: 8px;
            box-sizing: border-box;
            font-size: 16px;
            transition: all 0.2s;
            border: 1px solid rgba(0, 0, 0, 0.1);
            background-color: rgba(255, 255, 255, 0.95);
            color: #333;
        }

        .app-input::placeholder {
            color: #999;
        }

        .file-select-label {
            display: block;
            background-color: var(--main-green);
            color: white;
            padding: 12px;
            margin-bottom: 15px;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: background-color 0.2s;
        }

        /* éšè—åŸç”Ÿæ–‡ä»¶é€‰æ‹©å™¨ */
        #file-input {
            display: none;
        }

        .app-button {
            width: 100%;
            padding: 12px;
            margin-bottom: 15px;
            border-radius: 8px;
            box-sizing: border-box;
            font-size: 16px;
            transition: all 0.2s;
            border: none;
            background-color: var(--main-blue);
            color: white;
            cursor: pointer;
            font-weight: 600;
            box-shadow: 0 2px 4px rgba(0, 122, 255, 0.4);
        }

        .app-button:disabled {
            background-color: #a0c4ff;
            cursor: not-allowed;
            box-shadow: none;
        }

        .app-button:active:not(:disabled) {
            transform: translateY(1px);
            box-shadow: 0 1px 2px rgba(0, 122, 255, 0.4);
        }

        /* 4. æ–‡ä»¶åˆ—è¡¨æ ·å¼ */
        #file-list {
            text-align: left;
            list-style: none;
            padding: 10px;
            margin: 0 0 15px 0;
            border: 1px dashed rgba(0, 0, 0, 0.1);
            border-radius: 8px;
            background-color: rgba(255, 255, 255, 0.7);
            font-size: 14px;
        }

        #file-list li {
            padding: 3px 0;
            border-bottom: 1px dotted rgba(0, 0, 0, 0.05);
            word-break: break-all;
        }

        #file-list li:last-child {
            border-bottom: none;
        }

        /* 5. çŠ¶æ€å’Œè¿›åº¦æ˜¾ç¤º */
        #status-card {
            margin-bottom: 40px;
        }

        #status {
            margin-top: 20px;
            padding: 15px;
            background-color: rgba(245, 245, 245, 0.9);
            border-radius: 8px;
            text-align: left;
            white-space: pre-wrap;
            word-break: break-all;
            border: 1px solid rgba(0, 0, 0, 0.05);
            font-size: 14px;
            max-height: 200px;
            overflow-y: auto;
        }

        .progress-bar-container {
            height: 8px;
            background-color: rgba(0, 0, 0, 0.1);
            border-radius: 4px;
            margin-top: 15px;
            margin-bottom: 15px;
            overflow: hidden;
        }

        .progress-bar {
            height: 100%;
            width: 0%;
            background-color: var(--main-green);
            transition: width 0.1s;
        }

        /* 6. ä¸‹è½½åŒºåŸŸç¾åŒ– */
        #download-area {
            margin-top: 20px;
            padding: 15px;
            background-color: rgba(52, 199, 89, 0.1);
            border-radius: 8px;
            border: 1px solid rgba(52, 199, 89, 0.3);
            text-align: left;
        }

        #download-area h3 {
            margin-top: 0;
            margin-bottom: 15px;
            color: var(--main-green);
            font-size: 1.1em;
        }

        #download-list a {
            display: block;
            margin: 5px 0;
            padding: 8px;
            background-color: rgba(0, 122, 255, 0.1);
            border-radius: 6px;
            color: var(--main-blue);
            text-decoration: none;
            font-weight: 500;
            transition: background-color 0.2s;
        }

        /* 7. ç§»åŠ¨ç«¯ä¼˜åŒ– */
        @media (max-width: 600px) {
            .container {
                width: 95%;
                padding: 10px 10px 30px 10px;
            }

            .card {
                padding: 20px;
            }
        }
    </style>
</head>

<body>
    <div class="main-content-wrapper">
        <div class="container">

            <div class="card" id="join-section">
                <h2>è¿æ¥è®¾å¤‡</h2>
                <input type="text" id="room-code-input" class="app-input" placeholder="è¾“å…¥ä¸‰ä½è¿æ¥ç  (å¦‚ ABC)" maxlength="3"
                    style="text-transform: uppercase;">
                <button id="join-btn" class="app-button">åŠ å…¥æˆ¿é—´å¹¶æ¥æ”¶</button>
                <button id="create-btn" class="app-button">ç”Ÿæˆè¿æ¥ç å¹¶å‘é€</button>
            </div>

            <div class="card" id="transfer-section" style="display: none;">
                <h2 id="transfer-title">ç­‰å¾…è¿æ¥...</h2>
                <div id="file-selection-area">
                    <input type="file" id="file-input" multiple>
                    <label for="file-input" class="file-select-label">é€‰æ‹©æ–‡ä»¶ (å¯å¤šé€‰)</label>
                    <ul id="file-list" style="display: none;"></ul>
                    <button id="send-btn" class="app-button" disabled>ç­‰å¾…è¿æ¥...</button>
                </div>

                <p id="current-file-info" style="font-size: 14px; color: #666; margin-top: 15px;"></p>
                <div class="progress-bar-container">
                    <div id="progress-bar" class="progress-bar"></div>
                </div>

                <div id="download-area" style="display: none;">
                    <h3>å·²æ¥æ”¶æ–‡ä»¶åˆ—è¡¨</h3>
                    <div id="download-list">
                    </div>
                </div>
            </div>

            <div class="card" id="status-card">
                <h2>çŠ¶æ€ä¿¡æ¯</h2>
                <div id="status">è¿æ¥çŠ¶æ€ï¼šæœªè¿æ¥</div>
            </div>

        </div>
    </div>

    <script>
        // -----------------------------------------------------------
        // 1. Firebase é…ç½®ä¸ STUN æœåŠ¡å™¨
        // -----------------------------------------------------------
        const firebaseConfig = {
            apiKey: "AIzaSyAeSI1akqwsPBrVyv7YKirV06fqdkL3YNI",
            authDomain: "quark-b7305.firebaseapp.com",
            projectId: "quark-b7305",
            storageBucket: "quark-b7305.firebasestorage.app",
            messagingSenderId: "843016834358",
            appId: "1:843016834358:web:9438c729be28c4d492f797",
            measurementId: "G-5BVT26KRT6"
        };

        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();

        // å®Œæ•´çš„ STUN æœåŠ¡å™¨åˆ—è¡¨
        const STUN_SERVERS = [
            { urls: 'stun:stun.minisipserver.com' },
            { urls: 'stun:stun.zoiper.com' },
            { urls: 'stun:stun.voipbuster.com' },
            { urls: 'stun:stun.sipgate.net' },
            { urls: 'stun:stun.schlund.de' },
            { urls: 'stun:stun.voipstunt.com' },
            { urls: 'stun:stun.1und1.de' },
            { urls: 'stun:stun.gmx.net' },
            { urls: 'stun:stun.l.google.com:19302' },
        ];


        // -----------------------------------------------------------
        // 2. å…¨å±€å˜é‡ä¸ DOM å…ƒç´  (å¤šæ–‡ä»¶ç‰ˆæœ¬æ›´æ–°)
        // -----------------------------------------------------------
        let peerConnection;
        let dataChannel;
        let isSender = false;
        let currentRoomCode = null;

        // å‘é€ç›¸å…³ (æ›´æ–°ä¸ºæ•°ç»„å’Œç´¢å¼•)
        let filesToSend = []; // å­˜å‚¨æ‰€æœ‰å¾…å‘é€çš„æ–‡ä»¶
        let currentFileIndex = 0; // å½“å‰æ­£åœ¨å‘é€çš„æ–‡ä»¶ç´¢å¼•

        // æ¥æ”¶ç›¸å…³ (æ›´æ–°ä¸ºå¤šæ–‡ä»¶æ”¯æŒ)
        let currentFileBuffer = []; // å½“å‰æ­£åœ¨æ¥æ”¶æ–‡ä»¶çš„ Buffer
        let currentFileName = '';
        let currentFileSize = 0;
        let totalFilesToReceive = 0;
        let filesReceivedCount = 0; // ç´¯è®¡å·²æ¥æ”¶çš„æ–‡ä»¶æ•°

        // File Chunk Settings
        const CHUNK_SIZE = 64 * 1024; // 64KB per chunk
        const METADATA_LABEL = 'metadata';

        const joinSection = document.getElementById('join-section');
        const transferSection = document.getElementById('transfer-section');
        const transferTitle = document.getElementById('transfer-title');
        const roomCodeInput = document.getElementById('room-code-input');
        const joinBtn = document.getElementById('join-btn');
        const createBtn = document.getElementById('create-btn');
        const fileInput = document.getElementById('file-input');
        const fileListUL = document.getElementById('file-list'); // æ–°å¢ï¼šæ–‡ä»¶åˆ—è¡¨
        const sendBtn = document.getElementById('send-btn');
        const statusDiv = document.getElementById('status');
        const progressBar = document.getElementById('progress-bar');
        const downloadArea = document.getElementById('download-area');
        const downloadListDiv = document.getElementById('download-list'); // æ–°å¢ï¼šä¸‹è½½åˆ—è¡¨
        const currentFileInfoP = document.getElementById('current-file-info'); // æ–°å¢ï¼šå½“å‰æ–‡ä»¶ä¿¡æ¯


        // -----------------------------------------------------------
        // 3. æ ¸å¿ƒå‡½æ•°ï¼šçŠ¶æ€æ›´æ–°ä¸å®ç”¨å·¥å…·
        // -----------------------------------------------------------

        /** è®°å½•çŠ¶æ€ */
        function logStatus(message) {
            statusDiv.innerHTML = `[${new Date().toLocaleTimeString()}] ${message}\n` + statusDiv.innerHTML;
            if (statusDiv.scrollTop > 0) statusDiv.scrollTop = 0;
            console.log(message);
        }

        /** ç”Ÿæˆä¸‰ä½éšæœºå¤§å†™å­—æ¯ç  */
        function generateRoomCode() {
            let result = '';
            const characters = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ';
            for (let i = 0; i < 3; i++) {
                result += characters.charAt(Math.floor(Math.random() * characters.length));
            }
            return result;
        }

        /** æ›´æ–°è¿›åº¦æ¡ */
        function updateProgress(percentage) {
            progressBar.style.width = `${Math.min(100, percentage)}%`;
        }

        /** é‡ç½®æ–‡ä»¶å’Œä¼ è¾“çŠ¶æ€ */
        function resetTransferState() {
            filesToSend = [];
            currentFileIndex = 0;
            currentFileBuffer = [];
            currentFileName = '';
            currentFileSize = 0;
            totalFilesToReceive = 0;
            filesReceivedCount = 0;
            fileInput.value = '';
            fileListUL.innerHTML = '';
            fileListUL.style.display = 'none';
            currentFileInfoP.textContent = '';
            updateProgress(0);
            downloadListDiv.innerHTML = '';
            downloadArea.style.display = 'none';
        }


        // -----------------------------------------------------------
        // 4. WebRTC åˆå§‹åŒ– (ä¿æŒ STUN åˆ—è¡¨ä¸å˜)
        // -----------------------------------------------------------

        /** åˆå§‹åŒ– RTCPeerConnection */
        function createPeerConnection(roomCode, isSenderDevice) {
            peerConnection = new RTCPeerConnection({ iceServers: STUN_SERVERS });
            currentRoomCode = roomCode;
            isSender = isSenderDevice;

            logStatus(`åˆ›å»º WebRTC è¿æ¥ï¼Œèº«ä»½: ${isSender ? 'å‘é€æ–¹' : 'æ¥æ”¶æ–¹'}ã€‚`);

            peerConnection.onicecandidate = async (event) => {
                if (event.candidate) {
                    const role = isSender ? 'sender' : 'receiver';
                    const candidatesRef = database.ref(`rooms/${roomCode}/${role}/iceCandidates`);
                    await candidatesRef.push(event.candidate.toJSON());
                    // logStatus('å‘é€ ICE å€™é€‰è€…...'); // é¿å…æ—¥å¿—è¿‡å¤š
                }
            };

            peerConnection.oniceconnectionstatechange = () => {
                logStatus(`ICE è¿æ¥çŠ¶æ€: ${peerConnection.iceConnectionState}`);
                if (peerConnection.iceConnectionState === 'connected') {
                    logStatus('âœ… P2P è¿æ¥å»ºç«‹æˆåŠŸï¼');
                    if (isSender) {
                        sendBtn.textContent = filesToSend.length > 0 ? `å‘é€ ${filesToSend.length} ä¸ªæ–‡ä»¶` : 'è¯·é€‰æ‹©æ–‡ä»¶';
                        sendBtn.disabled = filesToSend.length === 0;
                    } else {
                        transferTitle.textContent = 'ç­‰å¾…å‘é€æ–¹ä¼ è¾“æ–‡ä»¶...';
                    }
                } else if (peerConnection.iceConnectionState === 'failed' || peerConnection.iceConnectionState === 'closed') {
                    logStatus('âŒ P2P è¿æ¥æ–­å¼€æˆ–å¤±è´¥ã€‚è¯·é‡è¯•ã€‚');
                }
            };

            if (isSender) {
                dataChannel = peerConnection.createDataChannel('fileTransfer', { ordered: true });
                setupDataChannel(dataChannel);
                logStatus('å·²åˆ›å»º DataChannel...');
            } else {
                peerConnection.ondatachannel = (event) => {
                    dataChannel = event.channel;
                    setupDataChannel(dataChannel);
                    logStatus('å·²æ¥æ”¶ DataChannel...');
                };
            }
        }

        /** DataChannel çš„é€šç”¨è®¾ç½® */
        function setupDataChannel(channel) {
            channel.onopen = () => {
                logStatus('DataChannel æ‰“å¼€ï¼Œå¯ä»¥å¼€å§‹ä¼ è¾“æ•°æ®ã€‚');
            };
            channel.onclose = () => {
                logStatus('DataChannel å…³é—­ã€‚');
            };
            channel.onerror = (error) => {
                logStatus(`DataChannel é”™è¯¯: ${error}`);
            };

            if (!isSender) {
                channel.onmessage = handleDataChannelMessage;
            }
        }

        // -----------------------------------------------------------
        // 5. ä¿¡ä»¤å‡½æ•° (ä¿æŒä¸å˜)
        // -----------------------------------------------------------

        async function createSenderOffer(roomCode) {
            createPeerConnection(roomCode, true);
            transferTitle.textContent = `ğŸ“¢ è¿æ¥ç ï¼š${roomCode}`;
            logStatus(`è¯·å°†è¿æ¥ç  ${roomCode} å‘é€ç»™æ¥æ”¶æ–¹ã€‚`);

            try {
                const offer = await peerConnection.createOffer();
                await peerConnection.setLocalDescription(offer);
                await database.ref(`rooms/${roomCode}/sender/sdp`).set(peerConnection.localDescription.toJSON());

                database.ref(`rooms/${roomCode}/receiver/sdp`).on('value', async (snapshot) => {
                    const answer = snapshot.val();
                    if (answer && !peerConnection.currentRemoteDescription) {
                        logStatus('æ¥æ”¶åˆ° Answer SDPï¼Œè®¾ç½®è¿œç¨‹æè¿°...');
                        await peerConnection.setRemoteDescription(new RTCSessionDescription(answer));
                        listenForIceCandidates(roomCode, 'receiver');
                    }
                });

            } catch (e) {
                logStatus(`âŒ å‘é€æ–¹ Offer å¤±è´¥: ${e.message}`);
            }
        }

        async function createReceiverAnswer(roomCode) {
            createPeerConnection(roomCode, false);
            transferTitle.textContent = `è¿æ¥ç ï¼š${roomCode}`;

            database.ref(`rooms/${roomCode}/sender/sdp`).once('value').then(async (snapshot) => {
                const offer = snapshot.val();
                if (!offer) {
                    logStatus(`âŒ æˆ¿é—´ ${roomCode} ä¸å­˜åœ¨ Offerã€‚`);
                    return;
                }

                try {
                    await peerConnection.setRemoteDescription(new RTCSessionDescription(offer));
                    const answer = await peerConnection.createAnswer();
                    await peerConnection.setLocalDescription(answer);
                    await database.ref(`rooms/${roomCode}/receiver/sdp`).set(peerConnection.localDescription.toJSON());
                    listenForIceCandidates(roomCode, 'sender');

                } catch (e) {
                    logStatus(`âŒ æ¥æ”¶æ–¹ Answer å¤±è´¥: ${e.message}`);
                }
            });
        }

        function listenForIceCandidates(roomCode, remoteRole) {
            database.ref(`rooms/${roomCode}/${remoteRole}/iceCandidates`).on('child_added', (snapshot) => {
                const candidate = snapshot.val();
                if (candidate) {
                    try {
                        peerConnection.addIceCandidate(new RTCIceCandidate(candidate));
                    } catch (e) {
                        logStatus(`âŒ æ·»åŠ  ICE å€™é€‰è€…å¤±è´¥: ${e.message}`);
                    }
                }
            });
        }


        // -----------------------------------------------------------
        // 6. æ–‡ä»¶ä¼ è¾“é€»è¾‘ (å‘é€æ–¹ - é‡æ„ä¸ºå¤šæ–‡ä»¶æ”¯æŒ)
        // -----------------------------------------------------------

        /** å¼€å§‹ä¼ è¾“ä¸‹ä¸€ä¸ªæ–‡ä»¶ */
        async function sendNextFile() {
            if (currentFileIndex < filesToSend.length) {
                const file = filesToSend[currentFileIndex];
                logStatus(`å¼€å§‹å‘é€æ–‡ä»¶ [${currentFileIndex + 1}/${filesToSend.length}]: ${file.name}`);
                await sendFileChunked(file, currentFileIndex, filesToSend.length);
            } else {
                // æ‰€æœ‰æ–‡ä»¶å‘é€å®Œæ¯•
                logStatus('âœ… æ‰€æœ‰æ–‡ä»¶å‘é€å®Œæˆï¼');
                transferTitle.textContent = 'æ‰€æœ‰æ–‡ä»¶ä¼ è¾“å®Œæˆï¼';
                currentFileInfoP.textContent = '';
                sendBtn.textContent = `é‡æ–°å‘é€ (${filesToSend.length} ä¸ªæ–‡ä»¶)`;
                sendBtn.disabled = false;

                // ä¼ è¾“å®Œæˆåæ¸…ç† Firebase ä¿¡ä»¤æ•°æ®
                if (currentRoomCode) {
                    database.ref(`rooms/${currentRoomCode}`).remove();
                }
            }
        }

        /** åˆ†å—å‘é€å•ä¸ªæ–‡ä»¶ */
        async function sendFileChunked(file, index, total) {
            if (dataChannel.readyState !== 'open') {
                logStatus('âŒ DataChannel æœªæ‰“å¼€æˆ–æœªè¿æ¥ï¼Œæ— æ³•å‘é€æ–‡ä»¶ã€‚');
                currentFileIndex = total; // ç»ˆæ­¢å‘é€
                return;
            }

            const fileSize = file.size;
            let offset = 0;

            sendBtn.disabled = true;

            // 1. å‘é€æ–‡ä»¶å…ƒæ•°æ® (åŒ…å«å¤šæ–‡ä»¶ä¿¡æ¯)
            const metadata = {
                label: METADATA_LABEL,
                fileName: file.name,
                fileSize: fileSize,
                fileIndex: index + 1, // 1-based index
                totalFiles: total,
            };
            dataChannel.send(JSON.stringify(metadata));

            const fileReader = new FileReader();

            fileReader.onload = async (e) => {
                // ä¼˜åŒ–ï¼šç­‰å¾… DataChannel å‘é€ç¼“å†²åŒºä½æ°´ä½
                if (dataChannel.bufferedAmount > dataChannel.bufferedAmountLowThreshold) {
                    await new Promise(resolve => dataChannel.onbufferedamountlow = resolve);
                }

                dataChannel.send(e.target.result);
                offset += e.target.result.byteLength;

                const percentage = (offset / fileSize) * 100;
                updateProgress(percentage);

                const sizeMB = (fileSize / (1024 * 1024)).toFixed(2);
                currentFileInfoP.textContent = `æ–‡ä»¶ ${index + 1}/${total} - ${file.name} (${sizeMB} MB)`;
                transferTitle.textContent = `å‘é€ä¸­: ${file.name} | ${percentage.toFixed(1)}%`;

                if (offset < fileSize) {
                    readSlice(offset);
                } else {
                    // å½“å‰æ–‡ä»¶å‘é€å®Œæ¯•
                    logStatus(`æ–‡ä»¶ [${index + 1}/${total}] å‘é€å®Œæ¯•ã€‚`);
                    currentFileIndex++;
                    await sendNextFile(); // è‡ªåŠ¨å‘é€ä¸‹ä¸€ä¸ªæ–‡ä»¶
                }
            };

            fileReader.onerror = (error) => {
                logStatus(`âŒ æ–‡ä»¶ [${index + 1}/${total}] è¯»å–å¤±è´¥: ${error}`);
                currentFileIndex++; // è·³è¿‡è¯¥æ–‡ä»¶
                sendNextFile();
            };

            const readSlice = (start) => {
                const slice = file.slice(start, start + CHUNK_SIZE);
                fileReader.readAsArrayBuffer(slice);
            };

            readSlice(0); // å¼€å§‹è¯»å–ç¬¬ä¸€ä¸ªå—
        }


        // -----------------------------------------------------------
        // 7. æ–‡ä»¶ä¼ è¾“é€»è¾‘ (æ¥æ”¶æ–¹ - é‡æ„ä¸ºå¤šæ–‡ä»¶æ”¯æŒ)
        // -----------------------------------------------------------

        /** å¤„ç†æ¥æ”¶åˆ°çš„ DataChannel æ¶ˆæ¯ */
        function handleDataChannelMessage(event) {
            const data = event.data;

            if (typeof data === 'string') {
                try {
                    const metadata = JSON.parse(data);
                    if (metadata.label === METADATA_LABEL) {
                        // æ¥æ”¶åˆ°æ–°æ–‡ä»¶çš„å…ƒæ•°æ®

                        // æ£€æŸ¥ä¸Šä¸€ä¸ªæ–‡ä»¶æ˜¯å¦å®Œæ•´æ¥æ”¶ (ä»…ç”¨äºè°ƒè¯•/é”™è¯¯å¤„ç†)
                        if (currentFileBuffer.length > 0 && currentFileSize > 0) {
                            logStatus(`è­¦å‘Šï¼šä¸Šä¸€ä¸ªæ–‡ä»¶ (${currentFileName}) æœªå®Œæ•´æ¥æ”¶ï¼Œä½†æ”¶åˆ°äº†æ–°æ–‡ä»¶çš„å…ƒæ•°æ®ã€‚`);
                        }

                        currentFileName = metadata.fileName;
                        currentFileSize = metadata.fileSize;
                        totalFilesToReceive = metadata.totalFiles;
                        filesReceivedCount = metadata.fileIndex - 1; // å½“å‰æ–‡ä»¶æ˜¯ç¬¬ N ä¸ªï¼Œæ‰€ä»¥å·²æ¥æ”¶ N-1 ä¸ª
                        currentFileBuffer = [];
                        downloadArea.style.display = 'block';

                        const sizeMB = (currentFileSize / (1024 * 1024)).toFixed(2);
                        logStatus(`å¼€å§‹æ¥æ”¶æ–‡ä»¶ [${metadata.fileIndex}/${totalFilesToReceive}]ï¼š${currentFileName} (${sizeMB} MB)`);
                        currentFileInfoP.textContent = `æ–‡ä»¶ ${metadata.fileIndex}/${totalFilesToReceive} - ${currentFileName} (${sizeMB} MB)`;
                        transferTitle.textContent = `æ¥æ”¶ä¸­: ${currentFileName} | 0.0%`;
                        updateProgress(0);
                        return;
                    }
                } catch (e) {
                    // å¿½ç•¥éå…ƒæ•°æ®çš„å­—ç¬¦ä¸²æ¶ˆæ¯
                }
            } else if (data instanceof ArrayBuffer) {
                // æ¥æ”¶åˆ°æ•°æ®å—
                fileBuffer.push(data);
                const totalBytesReceived = fileBuffer.reduce((sum, chunk) => sum + chunk.byteLength, 0);
                const percentage = (totalBytesReceived / currentFileSize) * 100;

                updateProgress(percentage);
                transferTitle.textContent = `æ¥æ”¶ä¸­: ${currentFileName} | ${percentage.toFixed(1)}%`;

                if (totalBytesReceived >= currentFileSize) {
                    // å½“å‰æ–‡ä»¶æ¥æ”¶å®Œæ¯•
                    logStatus(`âœ… æ–‡ä»¶ [${filesReceivedCount + 1}/${totalFilesToReceive}] æ¥æ”¶å®Œæˆï¼æ­£åœ¨åˆæˆ...`);

                    const fullFile = new Blob(fileBuffer);
                    const downloadUrl = URL.createObjectURL(fullFile);

                    // æ·»åŠ åˆ°ä¸‹è½½åˆ—è¡¨
                    const downloadElement = document.createElement('a');
                    downloadElement.href = downloadUrl;
                    downloadElement.download = currentFileName;
                    downloadElement.textContent = `ä¸‹è½½ ${currentFileName} (${(currentFileSize / 1024 / 1024).toFixed(2)} MB)`;
                    downloadListDiv.appendChild(downloadElement);

                    // é‡ç½®å½“å‰æ–‡ä»¶çŠ¶æ€ï¼Œå‡†å¤‡æ¥æ”¶ä¸‹ä¸€ä¸ª
                    fileBuffer = [];
                    filesReceivedCount++;

                    if (filesReceivedCount >= totalFilesToReceive) {
                        // æ‰€æœ‰æ–‡ä»¶æ¥æ”¶å®Œæ¯•
                        logStatus('ğŸ‰ æ‰€æœ‰æ–‡ä»¶ä¼ è¾“å®Œæˆï¼');
                        transferTitle.textContent = 'æ‰€æœ‰æ–‡ä»¶æ¥æ”¶å®Œæ¯•ï¼';
                        currentFileInfoP.textContent = '';

                        // ä¼ è¾“å®Œæˆåæ¸…ç† Firebase ä¿¡ä»¤æ•°æ®
                        if (currentRoomCode) {
                            database.ref(`rooms/${currentRoomCode}`).remove();
                        }
                    } else {
                        // ç­‰å¾…ä¸‹ä¸€ä¸ªæ–‡ä»¶å…ƒæ•°æ®
                        transferTitle.textContent = `ç­‰å¾…å‘é€æ–¹å‘é€ä¸‹ä¸€ä¸ªæ–‡ä»¶ (${filesReceivedCount + 1}/${totalFilesToReceive})...`;
                    }
                }
            }
        }


        // -----------------------------------------------------------
        // 8. äº‹ä»¶ç›‘å¬å™¨ (æ›´æ–°ä¸ºå¤šæ–‡ä»¶æ”¯æŒ)
        // -----------------------------------------------------------

        // ç›‘å¬ï¼šç‚¹å‡»â€œç”Ÿæˆè¿æ¥ç å¹¶å‘é€â€
        createBtn.addEventListener('click', () => {
            const roomCode = generateRoomCode();
            roomCodeInput.value = roomCode; // è‡ªåŠ¨å¡«å……
            joinSection.style.display = 'none';
            transferSection.style.display = 'block';
            resetTransferState(); // é‡ç½®çŠ¶æ€
            createSenderOffer(roomCode);
        });

        // ç›‘å¬ï¼šç‚¹å‡»â€œåŠ å…¥æˆ¿é—´å¹¶æ¥æ”¶â€
        joinBtn.addEventListener('click', () => {
            const roomCode = roomCodeInput.value.toUpperCase().trim();
            if (roomCode.length !== 3) {
                logStatus('âŒ è¿æ¥ç å¿…é¡»æ˜¯ä¸‰ä½å¤§å†™å­—æ¯ã€‚');
                return;
            }
            joinSection.style.display = 'none';
            transferSection.style.display = 'block';
            resetTransferState(); // é‡ç½®çŠ¶æ€
            createReceiverAnswer(roomCode);
        });

        // ç›‘å¬ï¼šæ–‡ä»¶é€‰æ‹©
        fileInput.addEventListener('change', (e) => {
            filesToSend = Array.from(e.target.files);
            fileListUL.innerHTML = '';
            currentFileIndex = 0; // é‡ç½®ç´¢å¼•

            if (filesToSend.length > 0) {
                fileListUL.style.display = 'block';
                filesToSend.forEach(file => {
                    const li = document.createElement('li');
                    li.textContent = `${file.name} (${(file.size / (1024 * 1024)).toFixed(2)} MB)`;
                    fileListUL.appendChild(li);
                });

                if (peerConnection && peerConnection.iceConnectionState === 'connected') {
                    sendBtn.textContent = `å‘é€ ${filesToSend.length} ä¸ªæ–‡ä»¶`;
                    sendBtn.disabled = false;
                } else {
                    sendBtn.textContent = `å·²é€‰æ‹© ${filesToSend.length} ä¸ªæ–‡ä»¶ (ç­‰å¾…è¿æ¥)`;
                    sendBtn.disabled = true;
                }
            } else {
                fileListUL.style.display = 'none';
                sendBtn.textContent = 'è¯·é€‰æ‹©æ–‡ä»¶';
                sendBtn.disabled = true;
            }
        });

        // ç›‘å¬ï¼šç‚¹å‡»å‘é€æŒ‰é’®
        sendBtn.addEventListener('click', () => {
            if (filesToSend.length > 0 && dataChannel && dataChannel.readyState === 'open') {
                currentFileIndex = 0; // ç¡®ä¿ä»ç¬¬ä¸€ä¸ªæ–‡ä»¶å¼€å§‹å‘é€
                sendNextFile();
            } else if (filesToSend.length === 0) {
                logStatus('âŒ è¯·å…ˆé€‰æ‹©è¦å‘é€çš„æ–‡ä»¶ã€‚');
            } else {
                logStatus('âŒ è¯·ç­‰å¾…è¿æ¥å»ºç«‹æˆ– DataChannel æ‰“å¼€ã€‚');
            }
        });

    </script>

</body>

</html>
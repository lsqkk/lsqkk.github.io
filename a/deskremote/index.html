<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å¤¸å…‹è¿œç¨‹æ¡Œé¢ | WebRTC + Firebase æ§åˆ¶</title>

    <!-- å¼•å…¥ Firebase 8 SDK -->
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>

    <style>
        :root {
            --main-blue: #007aff;
            --main-red: #ff3b30;
            --main-green: #34c759;
            --main-orange: #ff9500;
            /* ç”¨äºè­¦å‘Š/è¿æ¥ä¸­ */
            --bg-light: #f0f2f5;
            --card-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
        }

        body {
            background-color: var(--bg-light);
            display: flex;
            justify-content: center;
            align-items: flex-start;
            min-height: 100vh;
            padding: 20px;
            margin: 0;
            line-height: 1.6;
        }

        .container {
            width: 100%;
            max-width: 900px;
            padding: 20px;
            background: #fff;
            border-radius: 14px;
            box-shadow: var(--card-shadow);
        }

        h1 {
            color: #333;
            text-align: center;
            margin-bottom: 20px;
            border-bottom: 2px solid var(--main-blue);
            padding-bottom: 10px;
        }

        .section-header {
            font-size: 1.2em;
            color: var(--main-blue);
            margin-top: 20px;
            margin-bottom: 10px;
            padding-left: 5px;
            border-left: 4px solid var(--main-blue);
        }

        input[type="text"] {
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 8px;
            width: 100%;
            box-sizing: border-box;
            margin-bottom: 10px;
            font-size: 16px;
        }

        button {
            padding: 10px 15px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            transition: background-color 0.2s, transform 0.1s;
            margin: 5px 2px;
            flex-grow: 1;
        }

        button:hover:not(:disabled) {
            transform: translateY(-1px);
        }

        button:active:not(:disabled) {
            transform: translateY(0);
        }

        button:disabled {
            background-color: #ccc !important;
            cursor: not-allowed;
        }

        #sharer-actions button {
            background-color: var(--main-green);
            color: white;
        }

        #controller-actions button {
            background-color: var(--main-blue);
            color: white;
        }

        .actions-group {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-bottom: 20px;
        }

        /* è§†é¢‘å®¹å™¨å’Œæ§åˆ¶åŒº */
        #video-container {
            position: relative;
            width: 100%;
            /* å“åº”å¼å®½åº¦ */
            max-width: 100%;
            margin-top: 20px;
            aspect-ratio: 16 / 9;
            /* ä¿æŒ 16:9 æ¯”ä¾‹ */
            background-color: #333;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: inset 0 0 10px rgba(0, 0, 0, 0.5);
        }

        #remote-video,
        #local-video {
            width: 100%;
            height: 100%;
            object-fit: contain;
            /* ç¡®ä¿è§†é¢‘å†…å®¹å¯è§ */
        }

        /* çŠ¶æ€æ—¥å¿— */
        #status-log {
            margin-top: 20px;
            padding: 15px;
            background-color: #f9f9f9;
            border: 1px solid #eee;
            border-radius: 8px;
            max-height: 200px;
            overflow-y: auto;
            white-space: pre-wrap;
            font-size: 0.9em;
        }

        .log-item {
            margin-bottom: 5px;
            border-bottom: 1px dotted #eee;
            padding-bottom: 2px;
        }

        .log-success {
            color: var(--main-green);
        }

        .log-error {
            color: var(--main-red);
            font-weight: bold;
        }

        .log-info {
            color: #555;
        }

        .log-warning {
            color: var(--main-orange);
        }

        /* ä¸“é—¨ç”¨äºæ˜¾ç¤ºæœ¬åœ°æ¡¥æ¥çŠ¶æ€çš„åŒºåŸŸ */
        #local-status-box {
            padding: 10px;
            border-radius: 8px;
            margin-bottom: 15px;
            font-weight: 600;
        }

        .status-ready {
            background-color: rgba(52, 199, 89, 0.1);
            /* æµ…ç»¿è‰²èƒŒæ™¯ */
            border: 1px solid var(--main-green);
        }

        .status-error {
            background-color: rgba(255, 59, 48, 0.1);
            /* æµ…çº¢è‰²èƒŒæ™¯ */
            border: 1px solid var(--main-red);
        }
    </style>
</head>

<body>
    <div class="container">
        <h1>ğŸ–¥ï¸ å¤¸å…‹è¿œç¨‹æ¡Œé¢æ§åˆ¶</h1>

        <div class="section-header">0. æ¡¥æ¥ç¨‹åºçŠ¶æ€ (æœ¬åœ°ç”µè„‘)</div>
        <!-- æ–°å¢ï¼šç”¨äºåœ¨é¡µé¢åŠ è½½æ—¶æ˜¾ç¤ºæ¡¥æ¥ç¨‹åºçŠ¶æ€ -->
        <div id="local-status-box" class="status-error">
            **æœ¬åœ°æ¡¥æ¥ç¨‹åº (ws://localhost:7070):** <span id="bridge-status-main" class="log-error">æ­£åœ¨æ£€æŸ¥...</span>
        </div>


        <div class="section-header">1. è¿æ¥é…ç½®</div>
        <input type="text" id="room-code-input" placeholder="è¾“å…¥æˆ–ç”Ÿæˆ 3 ä½è¿æ¥ç  (ä¾‹å¦‚: ABC)" maxlength="3">

        <div class="actions-group">
            <button id="start-sharer-btn">æˆä¸ºå…±äº«æ–¹ (Sharer)</button>
            <button id="join-controller-btn">æˆä¸ºæ§åˆ¶æ–¹ (Controller)</button>
            <button id="clean-room-btn" style="background-color: var(--main-red);">æ¸…ç†æˆ¿é—´</button>
        </div>

        <div id="sharer-info" style="display:none;">
            <div class="section-header">2. å…±äº«æ–¹çŠ¶æ€ (Sharer)</div>
            <p>1. è¯·åœ¨å¼¹çª—ä¸­é€‰æ‹©è¦å…±äº«çš„å±å¹•ã€‚</p>
            <p>2. **WebRTC è¿æ¥çŠ¶æ€:** <span id="webrtc-status-sharer" class="log-info">ç­‰å¾…å¯åŠ¨...</span></p>
            <video id="local-video" autoplay muted playsinline style="display: none;"></video>
        </div>

        <div id="controller-info" style="display:none;">
            <div class="section-header">2. æ§åˆ¶æ–¹çŠ¶æ€ (Controller)</div>
            <p>**WebRTC è¿æ¥çŠ¶æ€:** <span id="webrtc-status-controller" class="log-info">ç­‰å¾…å¯åŠ¨...</span></p>
            <p>ç‚¹å‡»ä¸‹æ–¹è§†é¢‘ç”»é¢å³å¯å‘é€é¼ æ ‡ç‚¹å‡»äº‹ä»¶ã€‚</p>
        </div>

        <div class="section-header">3. è¿œç¨‹ç”»é¢åŠæ“æ§åŒº</div>
        <div id="video-container">
            <!-- remote-video å¿…é¡»åœ¨å®¹å™¨å†…ï¼Œå¹¶ä¸”æ˜¯å”¯ä¸€å æ®ç©ºé—´çš„å…ƒç´  -->
            <video id="remote-video" autoplay playsinline></video>
            <div id="control-overlay"
                style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; cursor: crosshair; display: none;">
            </div>
        </div>

        <div class="section-header">4. çŠ¶æ€æ—¥å¿—</div>
        <div id="status-log"></div>
    </div>

    <script>
        // --- 1. å…¨å±€é…ç½®ä¸åˆå§‹åŒ– ---
        const FIREBASE_CONFIG = {
            // ä½¿ç”¨ç”¨æˆ·æä¾›çš„é…ç½®è¯¦æƒ…
            databaseURL: "https://quark-b7305-default-rtdb.firebaseio.com",
            projectId: "quark-b7305"
        };
        const WS_PORT = 7070; // æ¡¥æ¥ç¨‹åºç«¯å£
        const FIREBASE_PATH = 'remote-desktop'; // RTDB æ ¹è·¯å¾„

        firebase.initializeApp(FIREBASE_CONFIG);
        const db = firebase.database();

        let localStream = null;
        let peerConnection = null;
        let ws = null; // ç”¨äºå…±äº«æ–¹è¿æ¥æ¡¥æ¥ç¨‹åºçš„ WebSocket
        let currentRoomCode = null;
        let isSharer = false; // true: å±å¹•å…±äº«æ–¹, false: æ§åˆ¶æ–¹

        // UI Elements
        const logArea = document.getElementById('status-log');
        const roomCodeInput = document.getElementById('room-code-input');
        const videoContainer = document.getElementById('video-container');
        const remoteVideo = document.getElementById('remote-video');
        const controlOverlay = document.getElementById('control-overlay');
        const bridgeStatusMain = document.getElementById('bridge-status-main');
        const localStatusBox = document.getElementById('local-status-box');


        // Signaling paths
        const getRoomRef = (code) => db.ref(`${FIREBASE_PATH}/${code}`);
        const getOfferRef = (code) => getRoomRef(code).child('offer');
        const getAnswerRef = (code) => getRoomRef(code).child('answer');
        const getIceRef = (code, type) => getRoomRef(code).child(`ice/${type}`);
        const getControlRef = (code) => getRoomRef(code).child('control_command');


        // --- 2. è¾…åŠ©å‡½æ•° ---
        function logStatus(message, type = 'info') {
            const logItem = document.createElement('div');
            logItem.className = `log-item log-${type}`;
            logItem.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
            logArea.prepend(logItem); // æ–°æ¶ˆæ¯åœ¨é¡¶éƒ¨
        }

        function generateRoomCode() {
            const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ';
            let code = '';
            for (let i = 0; i < 3; i++) {
                code += chars.charAt(Math.floor(Math.random() * chars.length));
            }
            return code;
        }

        function updateStatus(elementId, message, type = 'info') {
            const el = document.getElementById(elementId);
            el.textContent = message;
            el.className = `log-${type}`;
        }

        /**
         * æ£€æŸ¥æœ¬åœ°æ¡¥æ¥ç¨‹åº (ws://localhost:7070) çš„è¿æ¥çŠ¶æ€
         */
        function checkBridgeConnection() {
            bridgeStatusMain.textContent = 'æ­£åœ¨è¿æ¥å¹¶æ£€æŸ¥...';
            localStatusBox.className = 'status-warning'; // ä¸´æ—¶æ˜¾ç¤ºä¸ºæ£€æŸ¥ä¸­é¢œè‰²

            const tempWs = new WebSocket(`ws://localhost:${WS_PORT}`);

            tempWs.onopen = () => {
                bridgeStatusMain.textContent = 'âœ… å·²è¿æ¥ï¼Œæœ¬åœ°æ¡¥æ¥ç¨‹åºæ­£åœ¨è¿è¡Œã€‚';
                localStatusBox.className = 'status-ready';
                logStatus('âœ… æœ¬åœ°æ¡¥æ¥ç¨‹åº (ws://localhost:7070) æ£€æŸ¥æˆåŠŸ!', 'success');
                tempWs.close();
            };

            tempWs.onerror = () => {
                // è¿æ¥å¤±è´¥ï¼Œè¿™å¯èƒ½æ˜¯ç”¨æˆ·é‡åˆ°çš„é—®é¢˜
                bridgeStatusMain.textContent = 'âŒ è¿æ¥å¤±è´¥ã€‚è¯·ç¡®è®¤ï¼š1. å·²è¿è¡Œ EXEã€‚2. æœ¬åœ°é˜²ç«å¢™æœªé˜»æ­¢ 7070 ç«¯å£ã€‚';
                localStatusBox.className = 'status-error';
                logStatus('âŒ æœ¬åœ°æ¡¥æ¥ç¨‹åºè¿æ¥æ£€æŸ¥å¤±è´¥ã€‚è¯·ç¡®ä¿ EXE å·²è¿è¡Œä¸”é˜²ç«å¢™æœªé˜»æ­¢ 7070 ç«¯å£ã€‚', 'error');
            };

            // ç¡®ä¿ WebSocket è¢«å…³é—­
            tempWs.onclose = () => {
                // å¦‚æœæ˜¯æˆåŠŸè¿æ¥åå…³é—­ï¼Œåˆ™å¿½ç•¥
                if (bridgeStatusMain.textContent.startsWith('æ­£åœ¨è¿æ¥')) {
                    // å¦‚æœåœ¨è¿æ¥æˆåŠŸå‰å…³é—­ï¼Œè¯´æ˜è¿æ¥å¤±è´¥
                    tempWs.onerror();
                }
            };
        }

        // --- 3. WebRTC è¿æ¥è®¾ç½® ---
        function createPeerConnection() {
            if (peerConnection) {
                peerConnection.close();
            }
            // ä½¿ç”¨ STUN æœåŠ¡å™¨è¿›è¡Œ NAT ç©¿é€
            const config = {
                iceServers: [
                    { urls: 'stun:stun.l.google.com:19302' },
                    { urls: 'stun:stun1.l.google.com:19302' }
                ]
            };
            peerConnection = new RTCPeerConnection(config);

            // ç›‘å¬ ICE å€™é€‰è€…ï¼Œå°†å…¶å‘é€åˆ° Firebase
            peerConnection.onicecandidate = ({ candidate }) => {
                if (candidate) {
                    const type = isSharer ? 'sharer' : 'controller';
                    getIceRef(currentRoomCode, type).push(candidate.toJSON())
                        .then(() => logStatus(`WebRTC: å‘é€ ${type} ICE å€™é€‰è€…`, 'info'))
                        .catch(e => logStatus(`WebRTC: å‘é€ ICE å¤±è´¥: ${e.message}`, 'error'));
                }
            };

            peerConnection.oniceconnectionstatechange = () => {
                const state = peerConnection.iceConnectionState;
                const statusEl = isSharer ? 'webrtc-status-sharer' : 'webrtc-status-controller';
                updateStatus(statusEl, `ICE çŠ¶æ€: ${state}`, state === 'connected' ? 'success' : (state === 'failed' ? 'error' : 'info'));

                if (state === 'connected' && !isSharer) {
                    // æ§åˆ¶æ–¹è¿æ¥æˆåŠŸåï¼Œæ¿€æ´»é¼ æ ‡æ§åˆ¶
                    logStatus('WebRTC è¿æ¥æˆåŠŸï¼æ‚¨ç°åœ¨å¯ä»¥ç‚¹å‡»ç”»é¢è¿›è¡Œè¿œç¨‹æ§åˆ¶ã€‚', 'success');
                    controlOverlay.style.display = 'block';
                }
            };

            if (!isSharer) {
                // æ§åˆ¶æ–¹ï¼šç›‘å¬è¿œç¨‹æµ
                peerConnection.ontrack = (event) => {
                    logStatus('WebRTC: æ¥æ”¶åˆ°è¿œç¨‹è§†é¢‘æµ!', 'success');
                    remoteVideo.srcObject = event.streams[0];
                };
            }
        }

        // --- 4. WebSocket (Sharer ä¸“ç”¨) ---
        function connectToBridge(roomCode) {
            if (ws) { ws.close(); }
            // ç¡®ä¿ä½¿ç”¨ ws åè®®è¿æ¥æœ¬åœ° Node.js æ¡¥æ¥ç¨‹åº
            ws = new WebSocket(`ws://localhost:${WS_PORT}`);

            ws.onopen = () => {
                // ç¡®ä¿ä¸»çŠ¶æ€æ˜¾ç¤ºæ­£ç¡®
                bridgeStatusMain.textContent = 'âœ… å·²è¿æ¥ï¼Œæœ¬åœ°æ¡¥æ¥ç¨‹åºæ­£åœ¨è¿è¡Œã€‚';
                localStatusBox.className = 'status-ready';

                logStatus(`WebRTCä¿¡ä»¤ç¨‹åºå·²è¿æ¥åˆ°æœ¬åœ°æ¡¥æ¥ç¨‹åº (ws://localhost:${WS_PORT})`, 'success');
                // å‘ŠçŸ¥æ¡¥æ¥ç¨‹åºç›‘å¬å“ªä¸ªæˆ¿é—´çš„æ§åˆ¶å‘½ä»¤
                ws.send(JSON.stringify({ type: 'START_CONTROL_LISTEN', code: roomCode }));
            };

            ws.onmessage = (event) => {
                try {
                    const data = JSON.parse(event.data);
                    if (data.status === 'LISTENING') {
                        logStatus(`æ¡¥æ¥ç¨‹åºå·²ç¡®è®¤å¹¶å¼€å§‹ç›‘å¬ Firebase æˆ¿é—´ ${data.code} çš„æ§åˆ¶å‘½ä»¤ã€‚`, 'success');
                    }
                } catch (e) {
                    logStatus(`WebSocket æ¥æ”¶åˆ°é JSON æ¶ˆæ¯: ${event.data}`, 'info');
                }
            };

            ws.onerror = (error) => {
                bridgeStatusMain.textContent = 'âŒ è¿æ¥é”™è¯¯/æ–­å¼€ã€‚è¯·ç¡®ä¿æ¡¥æ¥ç¨‹åºå·²è¿è¡Œï¼';
                localStatusBox.className = 'status-error';
                logStatus(`WebSocket é”™è¯¯æˆ–æ–­å¼€ï¼Œæ— æ³•è¿æ¥æœ¬åœ°æ¡¥æ¥ç¨‹åº: ${error.message}`, 'error');
            };

            ws.onclose = () => {
                bridgeStatusMain.textContent = 'âŒ è¿æ¥å·²å…³é—­ã€‚';
                localStatusBox.className = 'status-error';
                logStatus('WebSocket è¿æ¥å·²æ–­å¼€ã€‚', 'info');
            };
        }

        // --- 5. Sharer (å…±äº«æ–¹) é€»è¾‘ ---
        async function setupSharer(roomCode) {
            isSharer = true;
            currentRoomCode = roomCode;
            document.getElementById('sharer-info').style.display = 'block';
            document.getElementById('controller-info').style.display = 'none';
            logStatus(`ğŸš€ å¯åŠ¨å…±äº«æ–¹æ¨¡å¼ã€‚æˆ¿é—´ç : ${roomCode}`, 'info');

            // 1. å°è¯•è¿æ¥æœ¬åœ°æ¡¥æ¥ç¨‹åº (connectToBridge å·²ç»åœ¨ checkBridgeConnection ä¸­åˆå§‹åŒ–)

            createPeerConnection();

            try {
                // 2. è·å–å±å¹•å…±äº«æµ
                localStream = await navigator.mediaDevices.getDisplayMedia({ video: true, audio: false });
                logStatus('âœ… å·²æˆåŠŸæ•è·å±å¹•æµã€‚', 'success');

                // 3. å°†è½¨é“æ·»åŠ åˆ° PeerConnection
                localStream.getTracks().forEach(track => peerConnection.addTrack(track, localStream));

                // 4. åˆ›å»ºå¹¶å‘é€ Offer (SDP)
                const offer = await peerConnection.createOffer();
                await peerConnection.setLocalDescription(offer);

                await getOfferRef(roomCode).set(offer);
                updateStatus('webrtc-status-sharer', 'å·²å‘é€ Offerï¼Œç­‰å¾…æ§åˆ¶æ–¹åŠ å…¥...', 'warning');

                // 5. ç›‘å¬ Answer
                getAnswerRef(roomCode).on('value', async (snapshot) => {
                    const answer = snapshot.val();
                    if (answer && peerConnection.remoteDescription !== answer) {
                        logStatus('WebRTC: æ¥æ”¶åˆ° Answer (SDP)ã€‚', 'info');
                        // RTCSessionDescription æ„é€ å‡½æ•°æ¥å— Firebase è¿”å›çš„åŒ…å« type å’Œ sdp å±æ€§çš„å¯¹è±¡
                        await peerConnection.setRemoteDescription(new RTCSessionDescription(answer));
                        updateStatus('webrtc-status-sharer', 'å·²æ¥æ”¶ Answerã€‚æ­£åœ¨è¿æ¥...', 'warning');
                    }
                });

                // 6. ç›‘å¬ Controller ICE å€™é€‰è€…
                getIceRef(roomCode, 'controller').on('child_added', async (snapshot) => {
                    const candidate = snapshot.val();
                    if (candidate) {
                        logStatus('WebRTC: æ¥æ”¶åˆ° Controller ICE å€™é€‰è€…ã€‚', 'info');
                        await peerConnection.addIceCandidate(new RTCIceCandidate(candidate));
                    }
                });

                // 7. è¿æ¥æœ¬åœ°æ¡¥æ¥ç¨‹åº (ç¡®ä¿åœ¨å¯åŠ¨æµç¨‹ä¸­æ‰§è¡Œ)
                connectToBridge(roomCode);

            } catch (error) {
                logStatus(`âŒ å…±äº«å¯åŠ¨å¤±è´¥: ${error.name}: ${error.message}. (å¦‚æœæ‚¨çœ‹åˆ°äº† Firebase è¿æ¥é”™è¯¯ï¼Œè¯·æ£€æŸ¥æ‚¨çš„ç½‘ç»œå’Œé˜²ç«å¢™è®¾ç½®)`, 'error');
                updateStatus('webrtc-status-sharer', 'å¯åŠ¨å¤±è´¥', 'error');
            }
        }


        // --- 6. Controller (æ§åˆ¶æ–¹) é€»è¾‘ ---
        async function setupController(roomCode) {
            isSharer = false;
            currentRoomCode = roomCode;
            document.getElementById('sharer-info').style.display = 'none';
            document.getElementById('controller-info').style.display = 'block';
            logStatus(`ğŸ® å¯åŠ¨æ§åˆ¶æ–¹æ¨¡å¼ã€‚æˆ¿é—´ç : ${roomCode}`, 'info');

            createPeerConnection();

            try {
                // 1. ç›‘å¬ Offer
                getOfferRef(roomCode).on('value', async (snapshot) => {
                    const offer = snapshot.val();
                    if (offer) {
                        logStatus('WebRTC: æ¥æ”¶åˆ° Offer (SDP)ã€‚', 'info');
                        await peerConnection.setRemoteDescription(new RTCSessionDescription(offer));
                        updateStatus('webrtc-status-controller', 'å·²æ¥æ”¶ Offerã€‚æ­£åœ¨åˆ›å»º Answer...', 'warning');

                        // 2. åˆ›å»ºå¹¶å‘é€ Answer
                        const answer = await peerConnection.createAnswer();
                        await peerConnection.setLocalDescription(answer);

                        await getAnswerRef(roomCode).set(answer);
                        updateStatus('webrtc-status-controller', 'å·²å‘é€ Answerã€‚æ­£åœ¨å»ºç«‹è¿æ¥...', 'warning');
                    } else {
                        updateStatus('webrtc-status-controller', 'æˆ¿é—´ä¸å­˜åœ¨æˆ– Offer æœªå‘é€ã€‚', 'error');
                    }
                });

                // 3. ç›‘å¬ Sharer ICE å€™é€‰è€…
                getIceRef(roomCode, 'sharer').on('child_added', async (snapshot) => {
                    const candidate = snapshot.val();
                    if (candidate) {
                        logStatus('WebRTC: æ¥æ”¶åˆ° Sharer ICE å€™é€‰è€…ã€‚', 'info');
                        await peerConnection.addIceCandidate(new RTCIceCandidate(candidate));
                    }
                });

                // 4. æ·»åŠ æ§åˆ¶äº‹ä»¶ç›‘å¬å™¨
                controlOverlay.addEventListener('mousedown', sendRemoteControlCommand);
                document.addEventListener('keydown', sendRemoteKeyCommand);


            } catch (error) {
                logStatus(`âŒ æ§åˆ¶å¯åŠ¨å¤±è´¥: ${error.name}: ${error.message}. (å¦‚æœæ‚¨çœ‹åˆ°äº† Firebase è¿æ¥é”™è¯¯ï¼Œè¯·æ£€æŸ¥æ‚¨çš„ç½‘ç»œå’Œé˜²ç«å¢™è®¾ç½®)`, 'error');
                updateStatus('webrtc-status-controller', 'å¯åŠ¨å¤±è´¥', 'error');
            }
        }

        // --- 7. å‘é€æ§åˆ¶å‘½ä»¤ (Controller ä¸“ç”¨) ---

        /**
         * å‘é€é¼ æ ‡ç‚¹å‡»å‘½ä»¤åˆ° Firebase RTDB
         * @param {MouseEvent} event 
         */
        function sendRemoteControlCommand(event) {
            if (isSharer || !peerConnection || peerConnection.iceConnectionState !== 'connected') {
                logStatus('âš ï¸ åªæœ‰è¿æ¥æˆåŠŸçš„æ§åˆ¶æ–¹æ‰èƒ½å‘é€å‘½ä»¤ã€‚', 'info');
                return;
            }

            // è·å–è§†é¢‘å®¹å™¨å’Œè¿œç¨‹è§†é¢‘å…ƒç´ çš„å°ºå¯¸
            const containerRect = videoContainer.getBoundingClientRect();
            const videoRect = remoteVideo.getBoundingClientRect();

            // æ£€æŸ¥è§†é¢‘æµæ˜¯å¦å·²åŠ è½½
            if (remoteVideo.videoWidth === 0 || remoteVideo.videoHeight === 0) {
                logStatus('âš ï¸ è§†é¢‘æµæœªåŠ è½½æˆ–å°ºå¯¸ä¸ºé›¶ï¼Œæ— æ³•è®¡ç®—å‡†ç¡®åæ ‡ã€‚', 'warning');
                return;
            }

            // --- æ ¸å¿ƒä¿®å¤ V10ï¼šè®¡ç®—è§†é¢‘æµçš„ç¼©æ”¾å’Œåç§» ---
            // è§†é¢‘æµåŸå§‹æ¯”ä¾‹
            const videoRatio = remoteVideo.videoWidth / remoteVideo.videoHeight;
            // å®¹å™¨æ¯”ä¾‹
            const containerRatio = containerRect.width / containerRect.height;

            let displayedWidth, displayedHeight, offsetX, offsetY;

            if (videoRatio > containerRatio) {
                // è§†é¢‘æ¯”å®¹å™¨å®½ (é¡¶éƒ¨å’Œåº•éƒ¨æœ‰é»‘è¾¹) - object-fit: contain æŒ‰ç…§å®½åº¦ç¼©æ”¾
                displayedWidth = containerRect.width;
                displayedHeight = containerRect.width / videoRatio;
                offsetX = 0;
                offsetY = (containerRect.height - displayedHeight) / 2;
            } else {
                // è§†é¢‘æ¯”å®¹å™¨é«˜ (å·¦å³æœ‰é»‘è¾¹) - object-fit: contain æŒ‰ç…§é«˜åº¦ç¼©æ”¾
                displayedHeight = containerRect.height;
                displayedWidth = containerRect.height * videoRatio;
                offsetY = 0;
                offsetX = (containerRect.width - displayedWidth) / 2;
            }
            // --- æ ¸å¿ƒä¿®å¤ç»“æŸ ---

            // 1. è®¡ç®—ç›¸å¯¹äºå®¹å™¨çš„ç‚¹å‡»ä½ç½®
            const clickX = event.clientX - containerRect.left;
            const clickY = event.clientY - containerRect.top;

            // 2. ç§»é™¤é»‘è¾¹åç§»é‡ï¼Œè·å–ç›¸å¯¹äº**å®é™…è§†é¢‘ç”»é¢**çš„ç‚¹å‡»ä½ç½®
            const relativeX = clickX - offsetX;
            const relativeY = clickY - offsetY;

            // 3. æ£€æŸ¥ç‚¹å‡»æ˜¯å¦åœ¨å®é™…è§†é¢‘ç”»é¢åŒºåŸŸå†…ï¼ˆæ’é™¤é»‘è¾¹ï¼‰
            if (relativeX < 0 || relativeX > displayedWidth || relativeY < 0 || relativeY > displayedHeight) {
                logStatus('ç‚¹å‡»åœ¨è§†é¢‘æµçš„é»‘è¾¹åŒºåŸŸï¼Œä¸å‘é€æ§åˆ¶å‘½ä»¤ã€‚', 'info');
                return;
            }

            // 4. å°†åæ ‡æ˜ å°„åˆ° 0-1000 çš„æ ‡å‡†åŒ–èŒƒå›´ (åŸºäºè§†é¢‘æµå°ºå¯¸)
            // ç¡®ä¿ç»“æœåœ¨ 0 åˆ° 1000 ä¹‹é—´ï¼Œä»¥é˜²æµ®ç‚¹è¯¯å·®
            const normalizedX = Math.min(1000, Math.max(0, Math.round((relativeX / displayedWidth) * 1000)));
            const normalizedY = Math.min(1000, Math.max(0, Math.round((relativeY / displayedHeight) * 1000)));

            let button = 'left';
            if (event.button === 2) {
                button = 'right';
            } else if (event.button === 1) {
                button = 'middle';
            }

            const commandPayload = {
                type: "MOUSE_CLICK",
                x: normalizedX,
                y: normalizedY,
                button: button,
                timestamp: Date.now()
            };

            logStatus(`å‘é€é¼ æ ‡ ${button.toUpperCase()} ç‚¹å‡»å‘½ä»¤: (${normalizedX}, ${normalizedY})`, 'info');

            // ä½¿ç”¨ set() è¦†ç›–æ—§å‘½ä»¤
            getControlRef(currentRoomCode).set(commandPayload)
                .catch(error => {
                    logStatus(`âŒ å‘½ä»¤å‘é€å¤±è´¥: ${error.message}`, 'error');
                });
        }

        /**
         * å‘é€é”®ç›˜æŒ‰é”®å‘½ä»¤åˆ° Firebase RTDB
         * @param {KeyboardEvent} event 
         */
        function sendRemoteKeyCommand(event) {
            if (isSharer || !peerConnection || peerConnection.iceConnectionState !== 'connected') {
                return; // ä¸åœ¨æ§åˆ¶æ–¹æˆ–æœªè¿æ¥æ—¶ä¸å‘é€
            }

            // é˜»æ­¢æµè§ˆå™¨é»˜è®¤è¡Œä¸ºï¼Œä¾‹å¦‚ F5 åˆ·æ–°
            // ä»…é˜»æ­¢å¸¸ç”¨åŠŸèƒ½é”®ï¼Œé¿å…å½±å“æ™®é€šæ–‡æœ¬è¾“å…¥ï¼ˆè™½ç„¶ç›®å‰æ²¡æœ‰æ–‡æœ¬è¾“å…¥æ¡†ï¼‰
            if (event.key.length > 1 || event.ctrlKey || event.altKey) {
                event.preventDefault();
            }


            const commandPayload = {
                type: "KEY_PRESS",
                key: event.key, // ä¾‹å¦‚ "Enter", "a", "ArrowUp"
                code: event.code, // ä¾‹å¦‚ "KeyA", "ArrowUp"
                timestamp: Date.now()
            };

            logStatus(`å‘é€æŒ‰é”®å‘½ä»¤: ${event.key} (${event.code})`, 'info');

            getControlRef(currentRoomCode).set(commandPayload)
                .catch(error => {
                    logStatus(`âŒ é”®ç›˜å‘½ä»¤å‘é€å¤±è´¥: ${error.message}`, 'error');
                });
        }

        // --- 8. ç»‘å®šäº‹ä»¶ ---
        document.getElementById('start-sharer-btn').addEventListener('click', () => {
            let roomCode = roomCodeInput.value.toUpperCase().trim();
            if (roomCode.length !== 3) {
                roomCode = generateRoomCode();
                roomCodeInput.value = roomCode;
            }
            setupSharer(roomCode);
        });

        document.getElementById('join-controller-btn').addEventListener('click', () => {
            const roomCode = roomCodeInput.value.toUpperCase().trim();
            if (roomCode.length !== 3) {
                logStatus('âŒ è¿æ¥ç å¿…é¡»æ˜¯ä¸‰ä½å¤§å†™å­—æ¯ã€‚', 'error');
                return;
            }
            setupController(roomCode);
        });

        document.getElementById('clean-room-btn').addEventListener('click', () => {
            if (currentRoomCode) {
                cleanRoomData(currentRoomCode);
            } else {
                logStatus('è¯·å…ˆè¾“å…¥æˆ¿é—´ç æˆ–å¼€å§‹è¿æ¥ã€‚', 'info');
            }
        });

        function cleanRoomData(code) {
            getRoomRef(code).remove()
                .then(() => {
                    logStatus(`âœ… æˆ¿é—´ ${code} æ•°æ®å·²æ¸…ç†ã€‚`, 'success');
                    if (peerConnection) peerConnection.close();
                    if (localStream) localStream.getTracks().forEach(track => track.stop());
                    if (ws) ws.close();
                    // åˆ·æ–°é¡µé¢çŠ¶æ€
                    setTimeout(() => window.location.reload(), 1000);
                })
                .catch(error => logStatus(`âŒ æ¸…ç†æˆ¿é—´å¤±è´¥: ${error.message}`, 'error'));
        }

        // é˜»æ­¢æ§åˆ¶æ–¹å³é”®èœå•å¼¹å‡º
        controlOverlay.addEventListener('contextmenu', (e) => {
            if (!isSharer && peerConnection && peerConnection.iceConnectionState === 'connected') {
                e.preventDefault();
            }
        });

        // é¡µé¢åŠ è½½å®Œæ¯•åï¼Œç«‹å³æ£€æŸ¥æœ¬åœ°æ¡¥æ¥ç¨‹åºçŠ¶æ€
        window.addEventListener('load', checkBridgeConnection);

    </script>
</body>

</html>
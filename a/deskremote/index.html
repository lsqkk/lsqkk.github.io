<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>å¤¸å…‹è¿œç¨‹æ¡Œé¢æ§åˆ¶å™¨</title>
    <meta name="keywords" content="è¿œç¨‹æ¡Œé¢, é¥æ§, æ‰‹æœº, å‰ç«¯, firebase, ç”µè„‘, å¤¸å…‹åšå®¢">
    <meta name="description" content="å¤¸å…‹è¿œç¨‹æ¡Œé¢æ§åˆ¶å™¨ï¼Œé€šè¿‡ Firebase RTDB ä¸æœ¬åœ° Node.js æ¡¥æ¥ç¨‹åºé€šä¿¡ï¼Œå®ç°æ— ç•Œé¢è¿œç¨‹æ§åˆ¶ã€‚">

    <!-- å¼•å…¥ Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#3b82f6', // è“è‰²
                        secondary: '#10b981', // ç»¿è‰²
                    }
                }
            }
        }
    </script>

    <!-- Firebase SDK (ä½¿ç”¨ v8.10.0ï¼Œä¸ä¹‹å‰çš„é¡¹ç›®ä¿æŒä¸€è‡´) -->
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>

    <style>
        /* 1. æ ·å¼é‡ç½®ä¸æ’ç‰ˆ */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f7f7f9;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 1rem;
        }

        /* 2. å¡ç‰‡å®¹å™¨ */
        .card {
            background-color: white;
            padding: 1.5rem;
            border-radius: 1rem;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            max-width: 420px;
            width: 100%;
        }

        /* 3. è§¦æ§æ¿æ ·å¼ */
        #trackpad {
            touch-action: none;
            /* ç¦ç”¨é»˜è®¤è§¦æ‘¸æ“ä½œï¼Œé˜²æ­¢æ»šåŠ¨ */
            background-color: #e5e7eb;
            border: 2px solid #9ca3af;
            cursor: pointer;
            user-select: none;
            position: relative;
        }

        /* 4. æ‰‹æœºç«¯å…¨å±å¸ƒå±€ä¼˜åŒ– */
        @media (max-width: 640px) {
            body {
                padding: 0;
            }

            .card {
                max-width: 100%;
                border-radius: 0;
                box-shadow: none;
                flex-grow: 1;
                display: flex;
                flex-direction: column;
            }

            #trackpad-container {
                flex-grow: 1;
                min-height: 300px;
                /* ç¡®ä¿è§¦æ§æ¿æœ‰æœ€å°é«˜åº¦ */
                width: 100%;
                padding-bottom: 2rem;
            }

            #trackpad {
                height: 100%;
            }
        }
    </style>
</head>

<body>
    <div id="setup-view" class="card space-y-4">
        <h2 class="text-2xl font-bold text-center">è¿œç¨‹æ¡Œé¢æ§åˆ¶è®¾ç½®</h2>
        <div class="space-y-2">
            <label for="room-code-input" class="block text-sm font-medium text-gray-700">è¿æ¥ç  (3ä½å¤§å†™å­—æ¯)</label>
            <input type="text" id="room-code-input" maxlength="3"
                class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-primary focus:border-primary uppercase text-center text-xl tracking-widest"
                placeholder="NTP">
        </div>
        <button id="join-controller-btn"
            class="w-full bg-primary hover:bg-blue-600 text-white font-bold py-3 rounded-lg transition duration-150">
            è¿æ¥å¹¶å¼€å§‹æ§åˆ¶
        </button>
        <p class="text-sm text-gray-500 text-center">ç¡®ä¿æ‚¨å·²åœ¨ç”µè„‘ä¸Šè¿è¡Œ Node.js æ¡¥æ¥ç¨‹åºã€‚</p>
        <div id="status-log" class="text-xs mt-4 p-2 bg-gray-100 rounded-lg h-12 overflow-y-auto">
            ç­‰å¾…è¿æ¥æŒ‡ä»¤...
        </div>
    </div>

    <!-- æ§åˆ¶å™¨è§†å›¾ -->
    <div id="controller-view" class="card hidden flex-col space-y-4" style="flex-grow: 1;">
        <h2 class="text-xl font-bold text-center">æˆ¿é—´: <span id="current-room-code" class="text-primary">---</span></h2>

        <div id="trackpad-container" class="flex-grow">
            <!-- è§¦æ§æ¿åŒºåŸŸï¼šå…¨å±å“åº”å¼ -->
            <div id="trackpad" class="w-full h-full rounded-lg flex items-center justify-center text-gray-500 text-sm">
                è§¦æ‘¸/ç‚¹å‡»è¿›è¡Œé¼ æ ‡æ“ä½œ
            </div>
        </div>

        <!-- é”®ç›˜æ¨¡æ‹ŸåŒºåŸŸ -->
        <div class="grid grid-cols-3 gap-2 p-2 border-t pt-4">
            <button class="key-btn" data-key="Enter">Enter</button>
            <button class="key-btn" data-key="Escape">ESC</button>
            <button class="key-btn" data-key="Right">å³â†’</button>
            <button class="key-btn" data-key="Left">å·¦â†</button>
            <button class="key-btn" data-key="Shift">Shift</button>
            <button class="key-btn" data-key="Alt">Alt</button>
        </div>

        <p id="command-status" class="text-sm text-center text-secondary h-4">å°±ç»ª</p>
    </div>

    <script>
        // --- å…¨å±€å˜é‡ ---
        const roomCodeInput = document.getElementById('room-code-input');
        const statusLog = document.getElementById('status-log');
        const setupView = document.getElementById('setup-view');
        const controllerView = document.getElementById('controller-view');
        const trackpad = document.getElementById('trackpad');
        const roomCodeDisplay = document.getElementById('current-room-code');

        let firebaseConfig = {
            // è¯·æ ¹æ®æ‚¨çš„ firebase_config.json å¡«å…¥å®é™…é…ç½®
            apiKey: "AIzaSyAeSI1akqwsPBrVyv7YKirV06fqdkL3YNI",
            authDomain: "quark-b7305.firebaseapp.com",
            databaseURL: "https://quark-b7305-default-rtdb.firebaseio.com",
            projectId: "quark-b7305"
        };

        // ç¡®ä¿ Firebase å·²åˆå§‹åŒ–
        if (firebase.apps.length === 0) {
            firebase.initializeApp(firebaseConfig);
        }
        const database = firebase.database();
        const FIREBASE_PATH = 'remote-desktop';
        let commandRef = null;

        // --- è¾…åŠ©å‡½æ•° ---
        function logStatus(message) {
            const time = new Date().toLocaleTimeString('zh-CN', { hour12: false });
            statusLog.innerHTML += `<div>[${time}] ${message}</div>`;
            statusLog.scrollTop = statusLog.scrollHeight;
        }

        // -----------------------------------------------------------
        // æ ¸å¿ƒï¼šå‘é€æ§åˆ¶å‘½ä»¤åˆ° Firebase
        // -----------------------------------------------------------

        /**
         * å‘é€å®Œæ•´çš„æ§åˆ¶å‘½ä»¤åˆ° Firebaseã€‚
         * @param {string} type - å‘½ä»¤ç±»å‹ (MOUSE_CLICK, KEY_PRESS)
         * @param {object} payload - é™„åŠ æ•°æ® {x, y, button} æˆ– {key}
         */
        function sendCommand(type, payload) {
            if (!commandRef) {
                document.getElementById('command-status').textContent = 'âŒ æœªè¿æ¥åˆ°æˆ¿é—´ã€‚';
                return;
            }

            const commandPayload = {
                type: type, // ç¡®ä¿ bridge.js èƒ½è¯†åˆ«
                timestamp: Date.now(),
                ...payload
            };

            // ä½¿ç”¨ set() è¦†ç›–æ—§å‘½ä»¤ï¼Œç¡®ä¿ bridge.js æ¥æ”¶åˆ°æœ€æ–°ä¸”å®Œæ•´çš„å‘½ä»¤
            commandRef.set(commandPayload)
                .then(() => {
                    document.getElementById('command-status').textContent = `âœ… å‘½ä»¤ ${type} å‘é€æˆåŠŸï¼`;
                })
                .catch(error => {
                    document.getElementById('command-status').textContent = `âŒ å‘½ä»¤å‘é€å¤±è´¥: ${error.message}`;
                    logStatus(`âŒ å‘½ä»¤å‘é€å¤±è´¥: ${error.message}`);
                });
        }

        // -----------------------------------------------------------
        // è§†å›¾åˆ‡æ¢å’Œåˆå§‹åŒ–
        // -----------------------------------------------------------

        function setupController(roomCode) {
            roomCode = roomCode.toUpperCase().trim();
            roomCodeDisplay.textContent = roomCode;
            setupView.classList.add('hidden');
            controllerView.classList.remove('hidden');
            controllerView.classList.add('flex');

            // 1. è®¾ç½® Firebase å¼•ç”¨åˆ° control_command.json
            commandRef = database.ref(`${FIREBASE_PATH}/${roomCode}/control_command`);

            logStatus(`âœ… æˆåŠŸè¿æ¥åˆ° Firebase æˆ¿é—´ ${roomCode} çš„å‘½ä»¤é€šé“ã€‚`);

            // 2. è¿æ¥æœ¬åœ°æ¡¥æ¥ç¨‹åºï¼ˆWebSocketï¼‰
            connectBridge(roomCode);
        }

        function connectBridge(roomCode) {
            const ws = new WebSocket('ws://127.0.0.1:7070');

            ws.onopen = () => {
                logStatus('ğŸ“¡ WebSocket è¿æ¥æˆåŠŸã€‚æ­£åœ¨å‘é€ç›‘å¬æŒ‡ä»¤...');
                // å‘é€æŒ‡ä»¤ç»™ bridge.jsï¼Œè®©å®ƒå¼€å§‹ç›‘å¬æ­¤æˆ¿é—´çš„ Firebase
                ws.send(JSON.stringify({
                    type: 'START_CONTROL_LISTEN',
                    code: roomCode
                }));
            };

            ws.onmessage = (event) => {
                try {
                    const data = JSON.parse(event.data);
                    if (data.status === 'LISTENING') {
                        logStatus(`âœ… æ¡¥æ¥ç¨‹åºå·²å¼€å§‹ç›‘å¬ Firebase æˆ¿é—´ ${data.code}ã€‚`);
                    }
                } catch (e) {
                    logStatus(`âŒ WebSocket æ¥æ”¶é”™è¯¯: ${e.message}`);
                }
            };

            ws.onerror = (error) => {
                logStatus('âŒ WebSocket è¿æ¥é”™è¯¯ã€‚è¯·ç¡®è®¤ç”µè„‘å·²è¿è¡Œæ¡¥æ¥ç¨‹åºã€‚');
            };

            ws.onclose = () => {
                logStatus('ğŸ”Œ WebSocket è¿æ¥å·²å…³é—­ã€‚');
            };
        }

        // -----------------------------------------------------------
        // é¼ æ ‡å’Œé”®ç›˜äº‹ä»¶å¤„ç†
        // -----------------------------------------------------------

        let touchStartTime = 0; // ç”¨äºåˆ¤æ–­æ˜¯ç‚¹å‡»è¿˜æ˜¯æ»‘åŠ¨

        // é¼ æ ‡/è§¦æ‘¸ç‚¹å‡»äº‹ä»¶ (æ¨¡æ‹Ÿé¼ æ ‡å·¦é”®ç‚¹å‡»)
        trackpad.addEventListener('touchstart', (e) => {
            e.preventDefault(); // é˜»æ­¢æ»šåŠ¨
            touchStartTime = Date.now();
        });

        trackpad.addEventListener('touchend', (e) => {
            e.preventDefault(); // é˜»æ­¢é»˜è®¤è¡Œä¸º
            const touchDuration = Date.now() - touchStartTime;

            // ä»…åœ¨çŸ­æ—¶é—´å†…é‡Šæ”¾ï¼Œè§†ä¸ºç‚¹å‡» (å°äº 300ms)
            if (touchDuration < 300) {
                // è·å–æœ€åä¸€æ¬¡è§¦æ‘¸çš„ä½ç½®
                const touch = e.changedTouches[0];

                // 1. è·å–è§¦æ§æ¿çš„å°ºå¯¸å’Œä½ç½®
                const rect = trackpad.getBoundingClientRect();

                // 2. è®¡ç®—è§¦æ‘¸ç‚¹ç›¸å¯¹äºè§¦æ§æ¿å·¦ä¸Šè§’çš„åƒç´ åæ ‡
                const xPx = touch.clientX - rect.left;
                const yPx = touch.clientY - rect.top;

                // 3. å½’ä¸€åŒ–åæ ‡åˆ° 0-1000 èŒƒå›´
                const normalizedX = Math.round((xPx / rect.width) * 1000);
                const normalizedY = Math.round((yPx / rect.height) * 1000);

                // ç¡®ä¿åæ ‡åœ¨æœ‰æ•ˆèŒƒå›´å†…
                const x = Math.min(1000, Math.max(0, normalizedX));
                const y = Math.min(1000, Math.max(0, normalizedY));

                // 4. å‘é€é¼ æ ‡ç‚¹å‡»å‘½ä»¤
                sendCommand('MOUSE_CLICK', { x: x, y: y, button: 'left' });
            }
            touchStartTime = 0;
        });

        // é”®ç›˜æŒ‰é’®äº‹ä»¶
        document.querySelectorAll('.key-btn').forEach(button => {
            button.addEventListener('click', () => {
                const key = button.getAttribute('data-key');
                sendCommand('KEY_PRESS', { key: key });
            });
        });

        // ----------------------------------------------------------
        // å¯åŠ¨ç›‘å¬å™¨
        // ----------------------------------------------------------

        document.getElementById('join-controller-btn').addEventListener('click', () => {
            const roomCode = roomCodeInput.value.toUpperCase().trim();
            if (roomCode.length !== 3) {
                logStatus('âŒ è¿æ¥ç å¿…é¡»æ˜¯ä¸‰ä½å¤§å†™å­—æ¯ã€‚');
                return;
            }
            setupController(roomCode);
        });

    </script>
</body>

</html>
<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>蓝色奇夸克の博客</title>
    <!-- Meta 标签 -->
    <meta name="title" content="文章标题">
    <meta name="description" content="文章描述">
    <meta property="og:image" content="https://lsqkk.github.io/touxiang.png">
    <!-- 样式表 -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css">
    <link rel="stylesheet" href="style.css">
    <style>
        body { 
            max-width: 800px; 
            margin: 0 auto; 
            padding: 20px; 
            background: url('https://cn.bing.com/th?id=OHR.LlanberisSnowdoniaSunset_ZH-CN6682238671_UHD.jpg') no-repeat center center; 
            background-size: cover; 
            position: relative; 
            background-attachment: fixed;
        }
        .post-content { 
            line-height: 1.6;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Helvetica, Arial, sans-serif;
        }
        code { background-color: #f6f8fa; padding: 2px 4px; border-radius: 4px; }
        pre { 
            background-color: #f6f8fa; 
            padding: 16px; 
            overflow: auto;
            border-radius: 6px;
            line-height: 1.45;
        }
        .header { margin-bottom: 20px; }
        .share-button {
            background-color: #99ddf3;
            padding: 5px 10px;
            border-radius: 5px;
            text-decoration: none;
            color: #007bff;
            cursor: pointer;
        }
        /* 新增错误提示样式 */
        .error-toast {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: #ff4444;
            color: white;
            padding: 10px 20px;
            border-radius: 5px;
            display: none;
        }
    </style>
</head>
<body>
    <!-- 错误提示容器 -->
    <div class="error-toast" id="errorToast"></div>
    
    <div class="header">
        <a href="index.html" style="text-decoration: none; color:white;"><h2 style="display: inline;">蓝色奇夸克の博客</h2> </a>
        &emsp;&emsp;
        <a href="article-list.html" style="background-color: #99ddf3; padding: 5px 10px; border-radius: 5px; text-decoration: none;color: #007bff; ">返回列表</a>
        &emsp;&emsp;
        <a class="share-button" onclick="shareToQZone()">分享到QQ空间</a>
    </div>

    <div class="moren" style="box-shadow: 0 0 10px 10px rgba(255,255,255,0.3);">
        <div id="content" class="post-content"></div>
    </div>

    <!-- 依赖库 -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/contrib/auto-render.min.js"></script>

    <script>
        // 获取URL参数
        function getQueryParam(param) {
            const urlParams = new URLSearchParams(window.location.search);
            return urlParams.get(param);
        }

        // Markdown渲染配置
        const renderer = {
            code(code, infostring) {
                if (infostring === 'math') {
                    return `<div class="math-block">${code}</div>`;
                }
                return false;
            }
        };
        marked.use({ renderer });

        // 加载文章内容
        async function loadPost() {
            const filename = getQueryParam('file');
            if (!filename) {
                document.getElementById('content').innerHTML = '<p>文章未找到</p>';
                return;
            }

            try {
                const mdContent = await fetch(`${filename}`).then(r => r.text());
                const htmlContent = marked.parse(mdContent);
                document.getElementById('content').innerHTML = htmlContent;
                
                renderMathInElement(document.getElementById('content'), {
                    delimiters: [
                        { left: '$$', right: '$$', display: true },
                        { left: '$', right: '$', display: false }
                    ],
                    throwOnError: false
                });
            } catch (error) {
                document.getElementById('content').innerHTML = '<p>加载文章失败</p>';
            }
        }

        // 分享到QQ空间（带短链生成）
        async function shareToQZone() {
            const errorToast = document.getElementById('errorToast');
            try {
                // 使用HTTPS协议并添加CORS代理
                const proxyUrl = 'https://cors-anywhere.herokuapp.com/'; // CORS代理
                const longUrl = encodeURIComponent(window.location.href);
                const apiKey = "67bda62825cb302232dfd67295@0600f2d2abf20a43beb969c73eb07075";
                const expireDate = "2025-01-01";
                const domain = "your-domain.com";  // 替换实际域名
                
                // 构造API请求（通过代理）
                const apiUrl = `https://api.suolink.cn/api?format=json&url=${longUrl}&key=${apiKey}&expireDate=${expireDate}&domain=${domain}`;
                
                const response = await fetch(proxyUrl + apiUrl, {
                    headers: {
                        'X-Requested-With': 'XMLHttpRequest' // 部分代理需要此头
                    }
                });
                
                // 检查HTTP状态码
                if (!response.ok) {
                    throw new Error(`API请求失败: ${response.status} ${response.statusText}`);
                }

                const result = await response.json();
                if (result.err) throw new Error(result.err);

                // 构造分享链接（验证短链有效性）
                if (!result.url.startsWith('http')) {
                    throw new Error('无效的短链格式');
                }

                const shareUrl = `https://sns.qzone.qq.com/cgi-bin/qzshare/cgi_qzshare_onekey?url=${encodeURIComponent(result.url)}&title=${encodeURIComponent(document.title)}&desc=${encodeURIComponent(document.querySelector('meta[name="description"]').content)}&pics=${document.querySelector('img') ? encodeURIComponent(document.querySelector('img').src) : encodeURIComponent("https://lsqkk.github.io/touxiang.png")}`;
                
                // 新窗口打开前验证
                const testWindow = window.open('', '_blank');
                if (testWindow === null) {
                    throw new Error('弹出窗口被浏览器阻止，请允许本站点弹出窗口');
                }
                testWindow.close();
                
                window.open(shareUrl, '_blank');

            } catch (error) {
                console.error("分享失败详情:", {
                    error: error.stack,  // 输出完整错误堆栈
                    timestamp: new Date().toISOString()
                });
                errorToast.textContent = `分享失败: ${error.message.replace(/\.?$/, '，请检查网络或稍后重试')}`;
                errorToast.style.display = 'block';
                setTimeout(() => { errorToast.style.display = 'none' }, 7000);
            }
        }
    </script>
    
    <hr>
    <div class="moren">
        <a href="post.html?file=copyright.md" style="text-decoration: none; color: black;">© 2025 蓝色奇夸克 - 个人博客</a>
    </div>
</body>
</html>

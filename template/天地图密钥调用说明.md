# 安全引入天地图密钥 - 使用说明

## 功能概述
通过调用安全API (`https://api.lsqkk.space/api/tianditu-key`) 动态获取天地图API密钥，避免密钥在前端代码中硬编码泄露。

## 快速开始

### 1. 引入密钥
在需要使用天地图的HTML页面中，**在初始化地图的JavaScript代码之前**，添加以下`<script>`标签：

```html
<script src="https://api.lsqkk.space/api/tianditu-key"></script>
```

### 2. 使用密钥
引入上述脚本后，密钥将作为全局变量 `window.TIANDITU_KEY` 可用。请在使用前检查其是否已成功加载。

```html
<script>
// 方式一：直接使用（最简单）
if (typeof TIANDITU_KEY !== 'undefined') {
    // 在此处编写初始化天地图的代码
    // 示例：var map = new T.Map('mapContainer', { key: TIANDITU_KEY });
} else {
    alert('地图服务加载失败，请刷新页面重试。');
}

// 方式二：封装为异步函数（推荐用于复杂应用）
async function initTiandituMap() {
    // 确保密钥已加载
    if (typeof TIANDITU_KEY === 'undefined') {
        // 动态加载密钥脚本
        await loadScript('https://api.lsqkk.space/api/tianditu-key');
    }
    
    // 初始化地图
    const map = new T.Map('mapContainer', {
        key: TIANDITU_KEY,
        // ... 其他配置
    });
    return map;
}

// 动态加载脚本的辅助函数
function loadScript(src) {
    return new Promise((resolve, reject) => {
        const script = document.createElement('script');
        script.src = src;
        script.onload = resolve;
        script.onerror = reject;
        document.head.appendChild(script);
    });
}
</script>
```

## 注意事项

1.  **引入顺序**：密钥脚本必须在**任何使用 `TIANDITU_KEY` 的代码之前**引入。
2.  **可用性检查**：始终在使用前检查 `if (typeof TIANDITU_KEY !== 'undefined')`，以防加载失败。
3.  **缓存机制**：API响应设置了24小时缓存，密钥更新后前端可能不会立即生效。如需强制更新，可在API链接后添加版本号：`/api/tianditu-key?v=2`
4.  **错误处理**：如果地图无法加载，请检查浏览器控制台是否有CORS或404错误，并确保 `api.lsqkk.space` 域名可访问。
5.  **密钥更新**：如需更换密钥，只需在Vercel环境变量中更新 `TIANDITU_KEY` 的值，无需修改前端代码。

## 迁移状态
- [x] API接口已部署：`https://api.lsqkk.space/api/tianditu-key`
- [x] 环境变量 `TIANDITU_KEY` 已设置
- [ ] 前端所有硬编码的 `TIANDITU_KEY` 已替换为API调用
<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>实时对话 - DeepSeek 集成</title>
  <link rel="stylesheet" href="styles.css"> <!-- 引入外部 CSS -->
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script> <!-- Markdown 解析 -->
</head>
<body>
  <div id="chat-container">
    <h1>实时对话 - DeepSeek</h1>
    <div id="chat-history">
      <div class="bot-msg">你好！我是 DeepSeek，请问有什么可以帮您？</div>
    </div>
    <div class="input-container">
      <input type="text" id="user-input" placeholder="输入你的问题...">
      <button id="send-btn" onclick="sendMessage()">发送</button>
    </div>
  </div>

  <script>
    // 配置
    const WORKER_URL = 'https://deepseek-proxy.jsxzznz.workers.dev'; // 替换为你的 Cloudflare Worker 地址

    // 发送消息
    async function sendMessage() {
      const input = document.getElementById('user-input');
      const historyDiv = document.getElementById('chat-history');
      const sendBtn = document.getElementById('send-btn');

      // 禁用按钮，防止重复提交
      sendBtn.disabled = true;

      // 添加用户消息
      const userMessage = input.value.trim();
      if (!userMessage) return; // 空消息不处理
      historyDiv.innerHTML += `<div class="user-msg">${userMessage}</div>`;
      historyDiv.innerHTML += `<div class="loading">思考中...</div>`;
      historyDiv.scrollTop = historyDiv.scrollHeight; // 滚动到底部

      try {
        // 构造请求体
        const payload = {
          model: "deepseek-reasoner", // 修改为 deepseek-reasoner
          messages: [{
            role: "user",
            content: userMessage
          }],
          stream: true // 启用流式输出
        };

        // 发送请求
        const response = await fetch(WORKER_URL, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload)
        });

        // 流式读取响应
        const reader = response.body.getReader();
        const decoder = new TextDecoder();
        let botMessage = '';

        historyDiv.innerHTML = historyDiv.innerHTML.replace('<div class="loading">思考中...</div>', '');
        historyDiv.innerHTML += `<div class="bot-msg"><div class="markdown-content"></div></div>`;
        const markdownDiv = historyDiv.querySelector('.bot-msg:last-child .markdown-content');

        while (true) {
          const { done, value } = await reader.read();
          if (done) break;

          // 解析流式数据
          const chunk = decoder.decode(value);
          const lines = chunk.split('\n');
          for (const line of lines) {
            if (line.startsWith('data:')) {
              const data = JSON.parse(line.slice(5));
              if (data.choices[0].delta.content) {
                botMessage += data.choices[0].delta.content;
                markdownDiv.innerHTML = marked.parse(botMessage); // 渲染 Markdown
                historyDiv.scrollTop = historyDiv.scrollHeight; // 滚动到底部
              }
            }
          }
        }

        // 添加复制按钮
        const copyButton = document.createElement('button');
        copyButton.className = 'copy-btn';
        copyButton.innerText = '复制';
        copyButton.onclick = () => {
          navigator.clipboard.writeText(botMessage);
          copyButton.innerText = '已复制';
          setTimeout(() => copyButton.innerText = '复制', 2000);
        };
        historyDiv.querySelector('.bot-msg:last-child').appendChild(copyButton);
      } catch (err) {
        historyDiv.innerHTML = historyDiv.innerHTML.replace('<div class="loading">思考中...</div>', '');
        historyDiv.innerHTML += `<div class="error">错误：${err.message}</div>`;
      } finally {
        // 清空输入框并启用按钮
        input.value = '';
        sendBtn.disabled = false;
        historyDiv.scrollTop = historyDiv.scrollHeight; // 滚动到底部
      }
    }

    // 支持回车键发送
    document.getElementById('user-input').addEventListener('keypress', function (e) {
      if (e.key === 'Enter') {
        sendMessage();
      }
    });
  </script>
</body>
</html>
<!DOCTYPE html>
<html>
<head>
    <title>手机陀螺仪乒乓球</title>
    <style>
        body { margin: 0; overflow: hidden; }
        #gameCanvas { display: block; }
        #instructions {
            position: absolute;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0,0,0,0.7);
            color: white;
            padding: 10px;
            border-radius: 5px;
        }
    </style>
</head>
<body>
    <div id="instructions">旋转手机控制平板</div>
    <canvas id="gameCanvas"></canvas>

    <script>
        // 初始化
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        
        // 设置画布大小
        function resizeCanvas() {
            canvas.width = window.innerWidth;
            canvas.height = window.innerHeight;
        }
        resizeCanvas();
        window.addEventListener('resize', resizeCanvas);

        // 游戏对象
        const game = {
            paddle: {
                x: canvas.width / 2 - 50,
                y: canvas.height - 40,
                width: 100,
                height: 20,
                angle: 0 // 平板倾斜角度
            },
            ball: {
                x: canvas.width / 2,
                y: canvas.height / 2,
                radius: 15,
                dx: 5,
                dy: -5
            },
            isDeviceReady: false
        };

        // 陀螺仪数据
        let gyroData = {
            beta: 0,   // 前后倾斜
            gamma: 0,  // 左右倾斜
            lastUpdate: 0
        };

        // 请求设备方向权限
        function requestDeviceOrientation() {
            if (typeof DeviceOrientationEvent !== 'undefined' && 
                typeof DeviceOrientationEvent.requestPermission === 'function') {
                
                DeviceOrientationEvent.requestPermission()
                    .then(permissionState => {
                        if (permissionState === 'granted') {
                            startGyroTracking();
                        }
                    })
                    .catch(console.error);
            } else {
                startGyroTracking();
            }
        }

        function startGyroTracking() {
            window.addEventListener('deviceorientation', handleOrientation);
            game.isDeviceReady = true;
            document.getElementById('instructions').textContent = 
                "已启用陀螺仪！旋转手机控制平板";
        }

        function handleOrientation(event) {
            gyroData = {
                beta: event.beta || 0,   // 前后倾斜（手机前后倾斜）
                gamma: event.gamma || 0,  // 左右倾斜（手机左右倾斜）
                lastUpdate: Date.now()
            };
        }

        // 物理更新
        function update() {
            // 更新平板角度（使用gamma值控制左右倾斜）
            const tiltFactor = 0.5;
            game.paddle.angle = gyroData.gamma * tiltFactor;
            
            // 限制平板移动范围
            game.paddle.x = canvas.width / 2 + gyroData.gamma * 2;
            game.paddle.x = Math.max(0, 
                Math.min(canvas.width - game.paddle.width, game.paddle.x));

            // 球的位置更新
            game.ball.x += game.ball.dx;
            game.ball.y += game.ball.dy;

            // 边界碰撞
            if (game.ball.x + game.ball.radius > canvas.width || 
                game.ball.x - game.ball.radius < 0) {
                game.ball.dx *= -1;
            }
            if (game.ball.y - game.ball.radius < 0) {
                game.ball.dy *= -1;
            }

            // 球与平板碰撞检测
            const paddleTop = game.paddle.y;
            const paddleBottom = game.paddle.y + game.paddle.height;
            const paddleLeft = game.paddle.x;
            const paddleRight = game.paddle.x + game.paddle.width;

            if (game.ball.y + game.ball.radius > paddleTop &&
                game.ball.y - game.ball.radius < paddleBottom &&
                game.ball.x > paddleLeft &&
                game.ball.x < paddleRight) {
                
                // 根据击球点计算反弹角度
                const hitPoint = (game.ball.x - game.paddle.x) / game.paddle.width;
                const angle = (hitPoint - 0.5) * Math.PI / 3; // ±60度范围
                
                // 考虑平板倾斜角度
                const totalAngle = angle + game.paddle.angle * Math.PI / 180;
                
                const speed = Math.sqrt(game.ball.dx**2 + game.ball.dy**2);
                game.ball.dx = Math.sin(totalAngle) * speed;
                game.ball.dy = -Math.cos(totalAngle) * speed;
                
                game.ball.y = paddleTop - game.ball.radius;
            }

            // 游戏结束检测
            if (game.ball.y > canvas.height) {
                resetBall();
            }
        }

        function resetBall() {
            game.ball.x = canvas.width / 2;
            game.ball.y = canvas.height / 2;
            game.ball.dx = 5 * (Math.random() > 0.5 ? 1 : -1);
            game.ball.dy = -5;
        }

        // 渲染
        function draw() {
            // 清空画布
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            
            // 绘制背景
            ctx.fillStyle = '#87CEEB';
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            
            // 绘制平板（带旋转）
            ctx.save();
            ctx.translate(game.paddle.x + game.paddle.width / 2, 
                         game.paddle.y + game.paddle.height / 2);
            ctx.rotate(game.paddle.angle * Math.PI / 180);
            ctx.fillStyle = '#333';
            ctx.fillRect(-game.paddle.width / 2, -game.paddle.height / 2, 
                        game.paddle.width, game.paddle.height);
            ctx.restore();
            
            // 绘制球
            ctx.beginPath();
            ctx.arc(game.ball.x, game.ball.y, game.ball.radius, 0, Math.PI * 2);
            ctx.fillStyle = '#FF6B6B';
            ctx.fill();
            ctx.strokeStyle = '#333';
            ctx.stroke();
            
            // 绘制陀螺仪数据
            ctx.fillStyle = 'rgba(0, 0, 0, 0.7)';
            ctx.font = '16px Arial';
            ctx.fillText(`前后倾斜: ${gyroData.beta.toFixed(1)}°`, 10, 30);
            ctx.fillText(`左右倾斜: ${gyroData.gamma.toFixed(1)}°`, 10, 60);
            ctx.fillText(`平板角度: ${game.paddle.angle.toFixed(1)}°`, 10, 90);
        }

        // 游戏循环
        function gameLoop() {
            update();
            draw();
            requestAnimationFrame(gameLoop);
        }

        // 点击页面开始游戏
        document.addEventListener('click', function() {
            if (!game.isDeviceReady) {
                requestDeviceOrientation();
            }
            gameLoop();
        });

        // 初始绘制
        draw();
    </script>
</body>
</html>
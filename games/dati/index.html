<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <link rel="stylesheet" href="/assets/css/basic.css">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>[é¢˜åº“apiå¤±æ•ˆ æš‚åœç»´æŠ¤]æ¯æ—¥çŸ¥è¯†æŒ‘æˆ˜ - å¤¸å…‹åšå®¢</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="/assets/css/room.css">
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
    <link rel="icon" href="/assets/img/logo_blue.png" type="image/png">
    <link rel="stylesheet" href="/assets/css/cursor.css">
    <script src="/assets/js/cursor-trail.js"></script>
    <style>
        .card {
            background: var(--message-bg);
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
        }

        .options {
            margin: 15px 0;
        }

        .option-btn {
            display: block;
            width: 100%;
            padding: 10px;
            margin: 5px 0;
            background: var(--input-bg);
            border: 1px solid var(--border-color);
            border-radius: 5px;
            cursor: pointer;
            transition: all 0.3s;
            color: var(--text-color);
            text-align: left;
        }

        .option-btn:hover {
            background: var(--primary-color);
            opacity: 0.8;
        }

        .selected {
            background: var(--primary-color);
            border-color: var(--primary-color);
        }

        #stats {
            background: var(--input-bg);
            padding: 15px;
            border-radius: 5px;
            margin-top: 20px;
        }

        #submitBtn {
            background: var(--primary-color);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            display: inline-block;
        }

        #resultMessage {
            display: inline-block;
            margin-left: 10px;
            font-weight: bold;
            font-size: 16px;
        }

        .success {
            color: #28a745;
        }

        .error {
            color: #dc3545;
        }

        .progress-container {
            width: 100%;
            max-width: 500px;
            margin: 20px auto;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .progress-bar {
            flex: 1;
            height: 10px;
            background: var(--input-bg);
            border-radius: 5px;
            margin: 0 10px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: var(--primary-color);
            width: 0%;
            transition: width 0.3s;
        }

        .score {
            font-weight: bold;
            min-width: 30px;
            text-align: center;
        }

        .question-container {
            width: 100%;
            max-width: 500px;
            margin: 0 auto;
            padding: 15px;
            background: var(--message-bg);
            border-radius: 10px;
        }

        .timer {
            font-size: 1.2rem;
            text-align: center;
            margin: 10px 0;
            color: var(--primary-color);
        }
    </style>
</head>

<body class="dark-mode">
    <div class="app-container">
        <!-- ä¾§è¾¹æ  -->
        <div class="sidebar" id="sidebar">
            <div class="sidebar-header">
                <div class="sidebar-title">ç­”é¢˜æˆ¿é—´</div>
                <button class="theme-toggle" id="themeToggle"><i class="fas fa-moon"></i></button>
            </div>

            <div class="room-list" id="roomList">
                <div class="empty-state">
                    <div class="empty-icon"><i class="fas fa-question-circle"></i></div>
                    <p>æš‚æ— æˆ¿é—´è®°å½•</p>
                </div>
            </div>

            <div class="join-room-container">
                <input type="text" class="join-room-input" id="roomInput" placeholder="è¾“å…¥æˆ¿é—´å·">
                <button class="join-room-btn" onclick="joinRoom()">åŠ å…¥æˆ¿é—´</button>
            </div>
        </div>

        <!-- ä¸»å†…å®¹åŒº -->
        <div class="main-content">
            <div class="game-header">
                <button class="mobile-menu-btn" id="mobileMenuBtn"><i class="fas fa-bars"></i></button>
                <div class="game-title" id="currentRoomTitle">æ¯æ—¥çŸ¥è¯†æŒ‘æˆ˜</div>
                <div style="width: 40px;"></div>
            </div>

            <div class="game-container" id="gameContainer">
                <!-- ä¸ªäººç­”é¢˜æ¨¡å¼ -->
                <div class="profile-setup" id="profileSetup">
                    <div class="profile-title">è®¾ç½®æ‚¨çš„ä¸ªäººèµ„æ–™</div>
                    <input type="text" class="profile-input" id="nicknameInput" placeholder="æ‚¨çš„æ˜µç§°">
                    <div class="color-picker" id="colorPicker">
                        <div class="color-option" style="background: #40E0D0" onclick="selectColor(this)"></div>
                        <div class="color-option" style="background: #FF6B6B" onclick="selectColor(this)"></div>
                        <div class="color-option" style="background: #7B68EE" onclick="selectColor(this)"></div>
                        <div class="color-option" style="background: #FFD700" onclick="selectColor(this)"></div>
                        <div class="color-option" style="background: #C7EDCC" onclick="selectColor(this)"></div>
                        <div class="color-option" style="background: #FAF9DE" onclick="selectColor(this)"></div>
                        <div class="color-option" style="background: #FFF2E2" onclick="selectColor(this)"></div>
                    </div>
                    <div class="role-selection">
                        <button class="role-btn selected" onclick="selectMode('solo')"><i class="fas fa-user"></i>
                            ä¸ªäººæ¨¡å¼</button>
                        <button class="role-btn" onclick="selectMode('player1')"><i class="fas fa-gamepad"></i>
                            ç©å®¶1</button>
                        <button class="role-btn" onclick="selectMode('player2')"><i class="fas fa-gamepad"></i>
                            ç©å®¶2</button>
                        <button class="role-btn" onclick="selectMode('spectator')"><i class="fas fa-eye"></i>
                            è§‚ä¼—</button>
                    </div>
                    <button class="profile-save-btn" onclick="saveProfile()">ä¿å­˜å¹¶å¼€å§‹</button>
                </div>

                <!-- ä¸ªäººç­”é¢˜å†…å®¹ -->
                <div id="soloContent" style="display:none;">
                    <div class="question-container">
                        <div id="question"></div>
                        <div class="options" id="options"></div>
                        <button onclick="submitAnswer()" id="submitBtn" disabled>æäº¤ç­”æ¡ˆ</button>
                        <div id="resultMessage" class="result-message"></div>
                        <div id="stats"></div>
                    </div>
                </div>

                <!-- å¯¹æˆ˜æ¨¡å¼å†…å®¹ -->
                <div id="battleContent" style="display:none;">
                    <div class="players-info">
                        <div class="player" id="player1">
                            <div class="player-avatar">P1</div>
                            <div>
                                <div class="player-name">ç­‰å¾…ç©å®¶1...</div>
                                <div class="player-role">ç©å®¶1</div>
                            </div>
                        </div>
                        <div class="player" id="player2">
                            <div class="player-avatar">P2</div>
                            <div>
                                <div class="player-name">ç­‰å¾…ç©å®¶2...</div>
                                <div class="player-role">ç©å®¶2</div>
                            </div>
                        </div>
                    </div>

                    <div class="progress-container">
                        <div class="score" id="score1">0</div>
                        <div class="progress-bar">
                            <div class="progress-fill" id="progress1"></div>
                        </div>
                        <div>VS</div>
                        <div class="progress-bar">
                            <div class="progress-fill" id="progress2"></div>
                        </div>
                        <div class="score" id="score2">0</div>
                    </div>

                    <div class="question-container">
                        <div class="timer" id="timer">10</div>
                        <div id="battleQuestion"></div>
                        <div class="options" id="battleOptions"></div>
                        <div class="game-status" id="battleStatus"></div>
                    </div>

                    <button class="restart-btn" id="restartBtn" style="display:none;"
                        onclick="requestRestart()">é‡æ–°å¼€å§‹</button>
                </div>
            </div>
        </div>
    </div>

    <div id="winnerOverlay" class="winner-overlay" style="display:none;">
        <div class="winner-box">
            <div class="winner-text">èƒœåˆ©è€…: <span class="winner-name" id="winnerName"></span></div>
            <button class="restart-btn" onclick="requestRestart()">å†æ¥ä¸€å±€</button>
        </div>
    </div>

    <script src="https://api.lsqkk.space/api/firebase-config?v=1"></script>
    <script>
        firebase.initializeApp(firebaseConfig);

        // å…¨å±€å˜é‡
        const TIME_LIMIT = 10;
        const WIN_SCORE = 100;

        let roomName = '';
        let gameRef = null;
        let playersRef = null;
        let questionRef = null;
        let userColor = localStorage.getItem('userColor') || '#40E0D0';
        let nickname = localStorage.getItem('nickname') || '';
        let gameMode = 'solo';
        let recentRooms = JSON.parse(localStorage.getItem('recentRooms') || '[]');
        let currentAnswer = '';
        let selectedOption = null;
        let selectedAnswer = '';
        let timer = null;
        let timeLeft = TIME_LIMIT;
        let player1 = null;
        let player2 = null;
        let score1 = 0;
        let score2 = 0;
        let gameActive = false;
        let currentQuestion = null;
        let answeredPlayers = [];

        // ç»Ÿè®¡ä¿¡æ¯
        let stats = {
            total: 0,
            correct: 0,
            date: new Date().toLocaleDateString()
        };

        // DOM åŠ è½½å®Œæˆååˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function () {
            initTheme();
            document.getElementById('mobileMenuBtn').addEventListener('click', toggleSidebar);
            document.getElementById('themeToggle').addEventListener('click', toggleTheme);
            updateRecentRoomsList();

            if (nickname) {
                document.getElementById('nicknameInput').value = nickname;
            }

            document.querySelectorAll('.color-option').forEach(opt => {
                opt.classList.toggle('selected', opt.style.background === userColor);
            });

            loadStats();
            if (gameMode === 'solo') {
                getQuestion();
            }
        });

        // åˆå§‹åŒ–ä¸»é¢˜
        function initTheme() {
            const savedTheme = localStorage.getItem('theme') || 'dark';
            document.body.className = savedTheme + '-mode';
            updateThemeIcon(savedTheme);
        }

        // åˆ‡æ¢ä¸»é¢˜
        function toggleTheme() {
            const isDark = document.body.classList.contains('dark-mode');
            const newTheme = isDark ? 'light' : 'dark';
            document.body.classList.remove(isDark ? 'dark-mode' : 'light-mode');
            document.body.classList.add(newTheme + '-mode');
            localStorage.setItem('theme', newTheme);
            updateThemeIcon(newTheme);
        }

        // æ›´æ–°ä¸»é¢˜å›¾æ ‡
        function updateThemeIcon(theme) {
            const icon = document.getElementById('themeToggle').querySelector('i');
            icon.className = theme === 'dark' ? 'fas fa-moon' : 'fas fa-sun';
        }

        // åˆ‡æ¢ä¾§è¾¹æ ï¼ˆç§»åŠ¨ç«¯ï¼‰
        function toggleSidebar() {
            document.getElementById('sidebar').classList.toggle('open');
        }

        // æ›´æ–°æœ€è¿‘æˆ¿é—´åˆ—è¡¨
        function updateRecentRoomsList() {
            const roomList = document.getElementById('roomList');

            if (recentRooms.length === 0) {
                roomList.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-icon"><i class="fas fa-question-circle"></i></div>
                        <p>æš‚æ— æˆ¿é—´è®°å½•</p>
                    </div>
                `;
                return;
            }

            roomList.innerHTML = '';
            recentRooms.forEach(room => {
                const roomItem = document.createElement('div');
                roomItem.className = 'room-item';
                roomItem.innerHTML = `<i class="fas fa-door-open room-icon"></i><span>${room}</span>`;
                roomItem.addEventListener('click', () => {
                    document.getElementById('roomInput').value = room;
                    joinRoom();
                });
                roomList.appendChild(roomItem);
            });
        }

        // æ·»åŠ æœ€è¿‘æˆ¿é—´
        function addRecentRoom(room) {
            if (!recentRooms.includes(room)) {
                recentRooms.unshift(room);
                if (recentRooms.length > 5) {
                    recentRooms = recentRooms.slice(0, 5);
                }
                localStorage.setItem('recentRooms', JSON.stringify(recentRooms));
                updateRecentRoomsList();
            }
        }

        // é€‰æ‹©æ¨¡å¼
        function selectMode(mode) {
            document.querySelectorAll('.role-btn').forEach(btn => {
                btn.classList.remove('selected');
            });
            event.target.classList.add('selected');
            gameMode = mode;
        }

        // åŠ å…¥æˆ¿é—´
        function joinRoom() {
            roomName = document.getElementById('roomInput').value.trim();
            if (!roomName) return;

            addRecentRoom(roomName);
            document.getElementById('currentRoomTitle').textContent = `æˆ¿é—´: ${roomName}`;
            document.getElementById('sidebar').classList.remove('open');

            if (nickname && gameMode) {
                initializeGame();
            }
        }

        // é€‰æ‹©é¢œè‰²
        function selectColor(element) {
            document.querySelectorAll('.color-option').forEach(opt => {
                opt.classList.remove('selected');
            });
            element.classList.add('selected');
            userColor = element.style.backgroundColor;
        }

        // ä¿å­˜ä¸ªäººèµ„æ–™
        function saveProfile() {
            nickname = document.getElementById('nicknameInput').value.trim();
            if (!nickname) {
                alert('è¯·å¡«å†™æ˜µç§°');
                return;
            }

            localStorage.setItem('nickname', nickname);
            localStorage.setItem('userColor', userColor);

            if (gameMode === 'solo') {
                startSoloMode();
            } else {
                initializeGame();
            }
        }

        // å¼€å§‹å•äººæ¨¡å¼
        function startSoloMode() {
            document.getElementById('profileSetup').style.display = 'none';
            document.getElementById('soloContent').style.display = 'block';
            document.getElementById('currentRoomTitle').textContent = 'æ¯æ—¥çŸ¥è¯†æŒ‘æˆ˜';
            getQuestion();
        }

        // åˆå§‹åŒ–æ¸¸æˆ
        function initializeGame() {
            document.getElementById('profileSetup').style.display = 'none';
            document.getElementById('battleContent').style.display = 'block';

            gameRef = firebase.database().ref(`quiz_battle/${roomName}`);
            playersRef = gameRef.child('players');
            questionRef = gameRef.child('question');

            const myPlayerInfo = {
                nickname: nickname,
                color: userColor,
                role: gameMode,
                timestamp: Date.now()
            };

            // åŠ å…¥æ¸¸æˆ
            playersRef.child(gameMode).set(myPlayerInfo);

            // ç›‘å¬ç©å®¶å˜åŒ–
            playersRef.on('value', snapshot => {
                const players = snapshot.val() || {};
                player1 = players.player1 || null;
                player2 = players.player2 || null;

                updatePlayerInfo();
                checkGameStart();
            });

            // ç›‘å¬é—®é¢˜å˜åŒ–
            questionRef.on('value', snapshot => {
                const questionData = snapshot.val() || {};

                if (questionData.question) {
                    currentQuestion = questionData;
                    displayBattleQuestion(questionData);

                    if (questionData.winner) {
                        showWinner(questionData.winner);
                    }
                }
            });

            // åˆå§‹åŒ–å¯¹æˆ˜çŠ¶æ€
            if (gameMode === 'player1' || gameMode === 'player2') {
                document.getElementById('battleOptions').addEventListener('click', handleBattleAnswer);
            }
        }

        // æ›´æ–°ç©å®¶ä¿¡æ¯æ˜¾ç¤º
        function updatePlayerInfo() {
            // æ›´æ–°ç©å®¶1ä¿¡æ¯
            const player1El = document.getElementById('player1');
            if (player1) {
                player1El.innerHTML = `
                    <div class="player-avatar" style="background: ${player1.color}">${player1.nickname[0].toUpperCase()}</div>
                    <div>
                        <div class="player-name">${player1.nickname}</div>
                        <div class="player-role">ç©å®¶1 ${gameMode === 'player1' ? '(ä½ )' : ''}</div>
                    </div>
                `;
            } else {
                player1El.innerHTML = `
                    <div class="player-avatar">P1</div>
                    <div>
                        <div class="player-name">ç­‰å¾…ç©å®¶1...</div>
                        <div class="player-role">ç©å®¶1</div>
                    </div>
                `;
            }

            // æ›´æ–°ç©å®¶2ä¿¡æ¯
            const player2El = document.getElementById('player2');
            if (player2) {
                player2El.innerHTML = `
                    <div class="player-avatar" style="background: ${player2.color}">${player2.nickname[0].toUpperCase()}</div>
                    <div>
                        <div class="player-name">${player2.nickname}</div>
                        <div class="player-role">ç©å®¶2 ${gameMode === 'player2' ? '(ä½ )' : ''}</div>
                    </div>
                `;
            } else {
                player2El.innerHTML = `
                    <div class="player-avatar">P2</div>
                    <div>
                        <div class="player-name">ç­‰å¾…ç©å®¶2...</div>
                        <div class="player-role">ç©å®¶2</div>
                    </div>
                `;
            }
        }

        // æ£€æŸ¥æ¸¸æˆæ˜¯å¦å¯ä»¥å¼€å§‹
        function checkGameStart() {
            if (player1 && player2 && !gameActive) {
                gameActive = true;
                score1 = 0;
                score2 = 0;
                updateScores();

                if (gameMode === 'player1' || gameMode === 'player2') {
                    document.getElementById('restartBtn').style.display = 'block';
                } else {
                    document.getElementById('restartBtn').style.display = 'none';
                }

                startNewQuestion();
            }
        }

        // å¼€å§‹æ–°é—®é¢˜
        function startNewQuestion() {
            answeredPlayers = [];
            timeLeft = TIME_LIMIT;
            updateTimer();

            if (timer) clearInterval(timer);
            timer = setInterval(() => {
                timeLeft--;
                updateTimer();

                if (timeLeft <= 0) {
                    clearInterval(timer);
                    endQuestion();
                }
            }, 1000);

            getBattleQuestion();
        }

        // æ›´æ–°è®¡æ—¶å™¨æ˜¾ç¤º
        function updateTimer() {
            document.getElementById('timer').textContent = timeLeft;
        }

        // è·å–å¯¹æˆ˜é—®é¢˜
        async function getBattleQuestion() {
            try {
                const response = await fetch('https://xiaoapi.cn/API/game_dati.php?id=1828222534&msg=å¼€å§‹æ¸¸æˆ');
                const data = await response.json();

                if (data.code === 200) {
                    questionRef.set({
                        question: data.data,
                        answers: {},
                        winner: null
                    });
                } else {
                    throw new Error('APIè¿”å›é”™è¯¯');
                }
            } catch (error) {
                console.error('è·å–é¢˜ç›®å¤±è´¥:', error);
                setTimeout(getBattleQuestion, 2000);
            }
        }

        // æ˜¾ç¤ºå¯¹æˆ˜é—®é¢˜
        function displayBattleQuestion(data) {
            const questionData = data.question;
            currentAnswer = questionData.answer;

            document.getElementById('battleQuestion').innerHTML = `<p>${questionData.msg.replace(/\n/g, '<br>')}</p>`;

            const optionsContainer = document.getElementById('battleOptions');
            optionsContainer.innerHTML = questionData.option.split('\n').map(opt => `
                <button class="option-btn" data-answer="${opt[0]}">${opt}</button>
            `).join('');

            // æ›´æ–°çŠ¶æ€æ˜¾ç¤º
            document.getElementById('battleStatus').textContent = gameMode === 'spectator' ?
                'è§‚æˆ˜ä¸­...' : `ä½ æœ‰ ${timeLeft} ç§’æ—¶é—´ç­”é¢˜`;
        }

        // å¤„ç†å¯¹æˆ˜ç­”é¢˜
        function handleBattleAnswer(event) {
            if (!gameActive || answeredPlayers.includes(gameMode)) return;

            const target = event.target.closest('.option-btn');
            if (!target) return;

            const answer = target.getAttribute('data-answer');
            const isCorrect = answer === currentAnswer;

            // è®°å½•ç­”æ¡ˆ
            questionRef.child('answers').child(gameMode).set({
                answer: answer,
                correct: isCorrect,
                timestamp: Date.now()
            });

            // æ·»åŠ åˆ°å·²ç­”ç©å®¶åˆ—è¡¨
            answeredPlayers.push(gameMode);

            // æ£€æŸ¥æ˜¯å¦åŒæ–¹éƒ½å·²ç­”
            questionRef.child('answers').once('value', snapshot => {
                const answers = snapshot.val() || {};
                if (Object.keys(answers).length === 2) {
                    endQuestion();
                }
            });
        }

        // ç»“æŸå½“å‰é—®é¢˜
        function endQuestion() {
            clearInterval(timer);

            questionRef.child('answers').once('value', snapshot => {
                const answers = snapshot.val() || {};
                const players = Object.keys(answers);

                // è®¡ç®—å¾—åˆ†
                const correctPlayers = players.filter(p => answers[p].correct);
                const sortedPlayers = players.sort((a, b) =>
                    answers[a].timestamp - answers[b].timestamp);

                // ç»™ç¬¬ä¸€ä¸ªç­”å¯¹çš„ç©å®¶10åˆ†ï¼Œç¬¬äºŒä¸ª5åˆ†
                correctPlayers.forEach((player, index) => {
                    if (player === 'player1') {
                        score1 += index === 0 ? 10 : 5;
                    } else {
                        score2 += index === 0 ? 10 : 5;
                    }
                });

                // ç»™ç­”é”™çš„ç©å®¶æ‰£5åˆ†
                players.filter(p => !answers[p].correct).forEach(player => {
                    if (player === 'player1') {
                        score1 = Math.max(0, score1 - 5);
                    } else {
                        score2 = Math.max(0, score2 - 5);
                    }
                });

                updateScores();

                // æ£€æŸ¥æ˜¯å¦æœ‰ç©å®¶è¾¾åˆ°èƒœåˆ©åˆ†æ•°
                let winner = null;
                if (score1 >= WIN_SCORE) {
                    winner = 'player1';
                } else if (score2 >= WIN_SCORE) {
                    winner = 'player2';
                }

                if (winner) {
                    questionRef.update({ winner: winner });
                } else {
                    // 3ç§’åè¿›å…¥ä¸‹ä¸€é¢˜
                    setTimeout(startNewQuestion, 3000);
                }
            });
        }

        // æ›´æ–°åˆ†æ•°æ˜¾ç¤º
        function updateScores() {
            document.getElementById('score1').textContent = score1;
            document.getElementById('score2').textContent = score2;
            document.getElementById('progress1').style.width = `${(score1 / WIN_SCORE) * 100}%`;
            document.getElementById('progress2').style.width = `${(score2 / WIN_SCORE) * 100}%`;
        }

        // æ˜¾ç¤ºèƒœåˆ©è€…
        function showWinner(winner) {
            gameActive = false;
            clearInterval(timer);

            const winnerName = winner === 'player1' ?
                (player1 ? player1.nickname : 'ç©å®¶1') :
                (player2 ? player2.nickname : 'ç©å®¶2');

            document.getElementById('winnerName').textContent = winnerName;
            document.getElementById('winnerOverlay').style.display = 'flex';
        }

        // è¯·æ±‚é‡æ–°å¼€å§‹æ¸¸æˆ
        function requestRestart() {
            if (confirm('ç¡®å®šè¦é‡æ–°å¼€å§‹æ¸¸æˆå—?')) {
                score1 = 0;
                score2 = 0;
                updateScores();
                questionRef.set({});
                document.getElementById('winnerOverlay').style.display = 'none';
                startNewQuestion();
            }
        }

        // ä»localStorageåŠ è½½ç»Ÿè®¡ä¿¡æ¯
        function loadStats() {
            const saved = localStorage.getItem('quizStats');
            if (saved) {
                const savedStats = JSON.parse(saved);
                if (savedStats.date === new Date().toLocaleDateString()) {
                    stats = savedStats;
                }
            }
        }

        // ä¿å­˜ç»Ÿè®¡ä¿¡æ¯
        function saveStats() {
            stats.date = new Date().toLocaleDateString();
            localStorage.setItem('quizStats', JSON.stringify(stats));
            if (stats.correct >= 10) {
                localStorage.setItem('dailyAchievement', new Date().toLocaleDateString());
            }
        }

        // è·å–é—®é¢˜ï¼ˆå•äººæ¨¡å¼ï¼‰
        async function getQuestion() {
            try {
                const response = await fetch('https://xiaoapi.cn/API/game_dati.php?id=1828222534&msg=å¼€å§‹æ¸¸æˆ');
                const data = await response.json();

                if (data.code === 200) {
                    currentAnswer = data.data.answer;
                    displayQuestion(data.data);
                } else {
                    throw new Error('APIè¿”å›é”™è¯¯');
                }
            } catch (error) {
                console.error('è·å–é¢˜ç›®å¤±è´¥:', error);
                showMessage('è·å–é¢˜ç›®å¤±è´¥ï¼Œè¯·é‡è¯•', 'error');
                setTimeout(getQuestion, 5000);
            }
        }

        // æ˜¾ç¤ºé—®é¢˜ï¼ˆå•äººæ¨¡å¼ï¼‰
        function displayQuestion(data) {
            document.getElementById('question').innerHTML = `<p>${data.msg.replace(/\n/g, '<br>')}</p>`;
            document.getElementById('options').innerHTML = data.option.split('\n').map(opt => `
                <button class="option-btn" onclick="selectOption(this, '${opt[0]}')" data-answer="${opt[0]}">${opt}</button>
            `).join('');
            updateStatsDisplay();
        }

        // é€‰æ‹©é€‰é¡¹ï¼ˆå•äººæ¨¡å¼ï¼‰
        function selectOption(btn, value) {
            if (selectedOption) selectedOption.classList.remove('selected');
            selectedOption = btn;
            selectedAnswer = value;
            selectedOption.classList.add('selected');
            document.getElementById('submitBtn').disabled = false;
        }

        // æäº¤ç­”æ¡ˆï¼ˆå•äººæ¨¡å¼ï¼‰
        async function submitAnswer() {
            if (!selectedOption) return;

            const isCorrect = selectedAnswer === currentAnswer;
            stats.total++;
            if (isCorrect) {
                stats.correct++;
                playSound('correct');
                showMessage('ğŸ‰ å›ç­”æ­£ç¡®ï¼', 'success');
            } else {
                playSound('wrong');
                showMessage('âŒ å›ç­”é”™è¯¯', 'error');
                displayCorrectAnswer(currentAnswer);
            }

            saveStats();

            if (selectedOption) {
                selectedOption.classList.remove('selected');
            }
            selectedOption = null;
            selectedAnswer = '';
            document.getElementById('submitBtn').disabled = true;

            await getQuestion();
        }

        // æ˜¾ç¤ºæ­£ç¡®ç­”æ¡ˆåŠå…¶å†…å®¹
        function displayCorrectAnswer(correctAnswer) {
            const optionsContainer = document.getElementById('options');
            const correctOption = optionsContainer.querySelector(`button[data-answer="${correctAnswer}"]`);
            if (correctOption) {
                const correctText = correctOption.textContent.trim();
                const msgDiv = document.getElementById('resultMessage');
                msgDiv.innerHTML += ` æ­£ç¡®ç­”æ¡ˆæ˜¯ï¼š${correctAnswer} - ${correctText}`;
            }
        }

        // æ›´æ–°ç»Ÿè®¡æ˜¾ç¤º
        function updateStatsDisplay() {
            document.getElementById('stats').innerHTML = `
                ä»Šæ—¥ç­”é¢˜ç»Ÿè®¡ï¼š
                ç­”é¢˜æ•°ï¼š${stats.total}æ¬¡ | 
                æ­£ç¡®ç‡ï¼š${stats.total ? ((stats.correct / stats.total) * 100).toFixed(1) : 0}% |
                æ­£ç¡®æ•°ï¼š${stats.correct}
            `;
        }

        // æ˜¾ç¤ºæç¤ºä¿¡æ¯
        function showMessage(text, type) {
            const msgDiv = document.getElementById('resultMessage');
            msgDiv.textContent = text;
            msgDiv.className = type;
            setTimeout(() => msgDiv.textContent = '', 2000);
        }

        // æ’­æ”¾éŸ³æ•ˆ
        function playSound(type) {
            const audio = new Audio();
            audio.src = type === 'correct' ? '3.MP3' : '2.MP3';
            audio.play();
        }
    </script>
    <script src="/assets/js/disable-right-click.js"></script>
</body>

</html>
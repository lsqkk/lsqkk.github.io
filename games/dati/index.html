<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <title>答题对战 - 夸克挑战</title>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
  <style>
    body{font-family:'Microsoft YaHei',sans-serif;max-width:800px;margin:20px auto;padding:20px;background:#f0f8ff}
    .card{background:white;padding:20px;border-radius:10px;box-shadow:0 2px 5px rgba(0,0,0,0.1);margin-bottom:20px}
    .options{margin:15px 0}
    .option-btn{display:block;width:100%;padding:10px;margin:5px 0;background:#f8f9fa;border:1px solid #ddd;border-radius:5px;cursor:pointer;transition:all 0.3s;color:black}
    .option-btn:hover{background:#e9ecef}
    .selected{background:#cfe2ff;border-color:#9ec5fe}
    #submitBtn{background:#0d6efd;color:white;border:none;padding:10px 20px;border-radius:5px;cursor:pointer;display:inline-block}
    #resultMessage{display:inline-block;margin-left:10px;font-weight:bold;font-size:16px}
    .success{color:#28a745}.error{color:#dc3545}
    #stats,#battleStats{background:#e2e3e5;padding:15px;border-radius:5px;margin-top:20px}
    #roomInput{padding:8px;width:150px;border:1px solid #ccc;border-radius:5px;margin-right:5px}
    #joinBtn{padding:8px 15px;border:none;border-radius:5px;background:#20c997;color:white;cursor:pointer}
    #scores{display:flex;justify-content:space-between;margin:10px 0}
    .scoreBox{background:#f8f9fa;padding:10px;border-radius:5px;flex:1;text-align:center;margin:0 5px}
  </style>
</head>
<body>
<div class="card">
  <h2>答题对战 - 夸克挑战</h2>
  <div>
    <input type="text" id="roomInput" placeholder="房间号"><button id="joinBtn">加入房间</button>
  </div>
  <div id="scores" style="display:none">
    <div class="scoreBox" id="player1Box">玩家1: <span id="score1">0</span></div>
    <div class="scoreBox" id="player2Box">玩家2: <span id="score2">0</span></div>
  </div>
  <div id="question"></div>
  <div class="options" id="options"></div>
  <button onclick="submitAnswer()" id="submitBtn" disabled>提交答案</button>
  <div id="resultMessage"></div>
  <div id="stats"></div>
</div>
<script>
const firebaseConfig = {apiKey:"AIzaSyAeSI1akqwsPBrVyv7YKirV06fqdkL3YNI",authDomain:"quark-b7305.firebaseapp.com",projectId:"quark-b7305",storageBucket:"quark-b7305.appspot.com",messagingSenderId:"843016834358",appId:"1:843016834358:web:9438c729be28c4d492f797"};
firebase.initializeApp(firebaseConfig);
const db = firebase.database();
let room = null, playerId = null, questionIndex = 0, currentAnswer = '', selectedOption = null, selectedAnswer = '', inBattle = false, scores = {player1: 0, player2: 0};
let stats = {total: 0, correct: 0, date: new Date().toLocaleDateString()};
function loadStats() {
  const saved = localStorage.getItem('quizStats');
  if (saved) { const s = JSON.parse(saved); if (s.date === stats.date) stats = s; }
}
function saveStats() {
  stats.date = new Date().toLocaleDateString();
  localStorage.setItem('quizStats', JSON.stringify(stats));
}
function showMessage(text, type) {
  const msg = document.getElementById('resultMessage');
  msg.textContent = text; msg.className = type; setTimeout(() => msg.textContent = '', 2000);
}
function updateStatsDisplay() {
  document.getElementById('stats').innerHTML = `今日答题统计：答题数：${stats.total}次 | 正确率：${stats.total ? ((stats.correct/stats.total)*100).toFixed(1) : 0}% | 正确数：${stats.correct}`;
}
async function getQuestion() {
  try {
    const res = await fetch('https://xiaoapi.cn/API/game_dati.php?id=1828222534&msg=开始游戏');
    const data = await res.json();
    if (data.code !== 200) throw new Error('API返回错误');
    currentAnswer = data.data.answer;
    displayQuestion(data.data);
    if (inBattle) db.ref(`quizBattle/${room}/questions/${questionIndex}`).set(data.data);
  } catch(e) { showMessage('获取题目失败', 'error'); setTimeout(getQuestion, 5000); }
}
function displayQuestion(data) {
  document.getElementById('question').innerHTML = `<p>${data.msg.replace(/\n/g, '<br>')}</p>`;
  const opts = data.option.split('\n').map(opt => `<button class="option-btn" onclick="selectOption(this, '${opt[0]}')" data-answer="${opt[0]}">${opt}</button>`).join('');
  document.getElementById('options').innerHTML = opts;
  updateStatsDisplay();
}
function selectOption(btn, value) {
  if (selectedOption) selectedOption.classList.remove('selected');
  selectedOption = btn; selectedAnswer = value;
  selectedOption.classList.add('selected');
  document.getElementById('submitBtn').disabled = false;
}
function submitAnswer() {
  if (!selectedOption) return;
  const isCorrect = selectedAnswer === currentAnswer;
  stats.total++;
  if (isCorrect) { stats.correct++; playSound('correct'); showMessage('🎉 回答正确！','success'); updateScore(10); }
  else { playSound('wrong'); showMessage('❌ 回答错误','error'); updateScore(-5); }
  saveStats();
  selectedOption.classList.remove('selected');
  selectedOption = null; selectedAnswer = '';
  document.getElementById('submitBtn').disabled = true;
  questionIndex++;
  if (inBattle) {
    db.ref(`quizBattle/${room}/nextIndex`).set(questionIndex);
  } else getQuestion();
}
function updateScore(delta) {
  if (!inBattle) return;
  scores[playerId] += delta;
  if (scores[playerId] >= 100) db.ref(`quizBattle/${room}/winner`).set(playerId);
  else db.ref(`quizBattle/${room}/scores`).set(scores);
}
function displayWinner(winner) {
  alert(`🎉 ${winner === playerId ? '你' : '对方'} 获胜了！`);
}
function syncQuestion(index) {
  db.ref(`quizBattle/${room}/questions/${index}`).once('value').then(snapshot => {
    if (snapshot.exists()) {
      const data = snapshot.val();
      currentAnswer = data.answer;
      displayQuestion(data);
    } else {
      getQuestion();
    }
  });
}
document.getElementById('joinBtn').onclick = () => {
  const input = document.getElementById('roomInput').value.trim();
  if (!input) return;
  room = input;
  const roomRef = db.ref(`quizBattle/${room}`);
  roomRef.once('value', snap => {
    const val = snap.val();
    if (val?.winner) return alert('对局已结束');
    if (!val || !val.players) {
      playerId = 'player1';
      scores = {player1: 0, player2: 0};
      roomRef.set({players: {player1: true}, scores});
    } else if (!val.players.player2) {
      playerId = 'player2';
      val.players.player2 = true;
      roomRef.child('players').set(val.players);
    } else {
      playerId = 'spectator';
      inBattle = false;
      alert('你是观众');
    }
    inBattle = playerId === 'player1' || playerId === 'player2';
    if (inBattle) {
      document.getElementById('scores').style.display = 'flex';
      roomRef.child('scores').on('value', snap => {
        const sc = snap.val();
        if (sc) { scores = sc; document.getElementById('score1').textContent = sc.player1; document.getElementById('score2').textContent = sc.player2; }
      });
      roomRef.child('nextIndex').on('value', snap => {
        const idx = snap.val();
        if (typeof idx === 'number') {
          questionIndex = idx;
          syncQuestion(idx);
        }
      });
      roomRef.child('winner').on('value', snap => { if (snap.exists()) displayWinner(snap.val()); });
    }
    getQuestion();
  });
};
function playSound(type) {
  const audio = new Audio(type === 'correct' ? '3.MP3' : '2.MP3');
  audio.play();
}
loadStats();
updateStatsDisplay();
</script>
</body>
</html>

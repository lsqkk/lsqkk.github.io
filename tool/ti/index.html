<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ€æ”¿é¢˜åº“æŠ½æµ‹ - å¤¸å…‹åšå®¢</title>
    <link rel="stylesheet" href="/assets/css/basic.css">
    <link rel="stylesheet" href="/assets/css/cursor.css">
    <script src="/assets/js/cursor-trail.js"></script>
    <link rel="stylesheet" href="/assets/css/nav.css">
    <script src="/assets/js/nav.js"></script>
    <script src="/assets/js/disable-right-click.js"></script>
    <style>
        :root {
            --glass-bg: rgba(255, 255, 255, 0.05);
            --glass-border: rgba(255, 255, 255, 0.1);
            --accent-color: #ffffff;
            --text-main: #e0e0e0;
            --text-dim: #888;
        }

        body {
            background-color: #000;
            color: var(--text-main);
            font-family: "PingFang SC", "Microsoft YaHei", sans-serif;
            margin: 0;
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
        }

        .glass-card {
            background: var(--glass-bg);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border: 1px solid var(--glass-border);
            border-radius: 12px;
            padding: 2.5rem;
            width: 90%;
            max-width: 650px;
            margin-top: 80px;
            box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.5);
        }

        h1 {
            font-weight: 300;
            letter-spacing: 4px;
            text-align: center;
            margin-bottom: 2.5rem;
            color: #fff;
        }

        .config-section,
        .quiz-section,
        .stats-section {
            display: flex;
            flex-direction: column;
            gap: 1.5rem;
        }

        .row {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 15px;
        }

        select,
        button,
        input[type="checkbox"] {
            background: rgba(255, 255, 255, 0.08);
            border: 1px solid var(--glass-border);
            color: #fff;
            padding: 10px 18px;
            border-radius: 6px;
            outline: none;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        button:hover {
            background: rgba(255, 255, 255, 0.15);
            border-color: rgba(255, 255, 255, 0.3);
        }

        .primary-btn {
            background: #fff;
            color: #000;
            font-weight: 600;
            border: none;
            padding: 14px;
            margin-top: 10px;
        }

        .primary-btn:hover {
            background: #e0e0e0;
            transform: translateY(-1px);
        }

        #question-display {
            font-size: 1.5rem;
            line-height: 1.5;
            text-align: center;
            min-height: 140px;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
            border-bottom: 1px solid var(--glass-border);
        }

        .hint-text {
            color: var(--text-dim);
            font-size: 0.9rem;
            text-align: center;
            margin-top: 10px;
        }

        .hidden {
            display: none !important;
        }

        /* ç»Ÿè®¡è¡¨æ ·å¼ */
        .stats-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }

        .stats-table th {
            color: var(--text-dim);
            font-weight: 400;
            text-align: left;
            border-bottom: 1px solid var(--glass-border);
            padding: 10px;
        }

        .stats-table td {
            padding: 12px 10px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.03);
            font-size: 0.9rem;
        }

        .tag-yes {
            color: #50fa7b;
            margin-right: 5px;
        }

        .tag-no {
            color: #ff5555;
            margin-right: 5px;
        }

        .progress-bar {
            font-size: 0.8rem;
            color: var(--text-dim);
            text-align: right;
        }
    </style>
</head>

<body>
    <div class="glass-card">
        <h1 id="main-title">é¢˜åº“æŠ½æµ‹</h1>

        <div id="config-ui" class="config-section">
            <div class="row">
                <span>ç« èŠ‚é€‰æ‹©</span>
                <div style="display:flex; align-items:center; gap:8px;">
                    <select id="start-chap"></select>
                    <span style="color:var(--text-dim)">è‡³</span>
                    <select id="end-chap"></select>
                </div>
            </div>
            <div class="row">
                <span>æ˜¾ç¤ºå›ç­”æ¡æ•°æé†’ (a)</span>
                <input type="checkbox" id="show-a" checked>
            </div>
            <button class="primary-btn" onclick="startQuiz()">å¼€å§‹æŠ½é¢˜</button>
            <button onclick="toggleStats()" style="background: transparent;">æŸ¥çœ‹å†å²ç»Ÿè®¡</button>
        </div>

        <div id="quiz-ui" class="quiz-section hidden">
            <div class="progress-bar" id="quiz-progress"></div>
            <div id="question-display">å‡†å¤‡ä¸­...</div>
            <div id="answer-hint" class="hint-text"></div>

            <div class="row" style="margin-top: 20px;">
                <button class="primary-btn" style="flex:1; background:transparent; color:#fff; border:1px solid #444;"
                    onclick="handleResult(false)">ä¸ä¼š / æ¨¡ç³Š</button>
                <button class="primary-btn" style="flex:1;" onclick="handleResult(true)">è¿™é¢˜æˆ‘ä¼š</button>
            </div>
            <button onclick="exitQuiz()"
                style="margin-top: 15px; background:transparent; border:none; color:var(--text-dim); font-size: 0.8rem;">ç»“æŸæœ¬è½®å¹¶è¿”å›</button>
        </div>

        <div id="stats-ui" class="stats-section hidden">
            <div id="stats-container" style="max-height: 450px; overflow-y: auto;"></div>
            <button onclick="location.reload()" class="primary-btn">è¿”å›ä¸»èœå•</button>
        </div>
    </div>

    <script>
        let db = null;
        let masterPool = []; // åˆå§‹é€‰å®šçš„æ€»é¢˜æ± 
        let masteredIds = new Set(); // æœ¬è½®å·²ç­”ä¼šçš„é¢˜ç›®ID
        let currentQuestion = null;
        let queue = []; // é”™é¢˜å¾…é‡ç°é˜Ÿåˆ—
        let historyData = JSON.parse(localStorage.getItem('study_stats_v2') || '{}');

        // åˆå§‹åŒ–åŠ è½½
        fetch('ti.json')
            .then(res => res.json())
            .then(data => {
                db = data;
                initSelectors();
            });

        function initSelectors() {
            const startSel = document.getElementById('start-chap');
            const endSel = document.getElementById('end-chap');
            db.chaps.forEach(c => {
                let opt = `<option value="${c.chap}">${c.chapName}</option>`;
                startSel.innerHTML += opt;
                endSel.innerHTML += opt;
            });
            endSel.value = db.chaps[db.chaps.length - 1].chap;
        }

        function startQuiz() {
            const s = parseInt(document.getElementById('start-chap').value);
            const e = parseInt(document.getElementById('end-chap').value);
            masterPool = [];
            masteredIds.clear();
            queue = [];

            db.chaps.forEach(c => {
                if (c.chap >= s && c.chap <= e) {
                    c.sections.forEach(sec => {
                        sec.qs.forEach((q, idx) => {
                            const id = `q-${c.chap}-${sec.sec}-${idx}`;
                            masterPool.push({ ...q, id, chapName: c.chapName });
                        });
                    });
                }
            });

            if (masterPool.length === 0) return alert("é€‰å®šèŒƒå›´å†…æ— é¢˜ç›®");

            document.getElementById('config-ui').classList.add('hidden');
            document.getElementById('quiz-ui').classList.remove('hidden');
            nextQuestion();
        }

        function nextQuestion() {
            // è®¡ç®—è¿˜å‰©å¤šå°‘é¢˜æ²¡æŒæ¡
            const remainingPool = masterPool.filter(q => !masteredIds.has(q.id));

            if (remainingPool.length === 0 && queue.length === 0) {
                document.getElementById('question-display').innerHTML = "ğŸ‰ å·²å®Œæˆæœ¬è½®æ‰€æœ‰é¢˜ç›®ï¼";
                document.getElementById('answer-hint').innerText = "";
                return;
            }

            // æ›´æ–°è¿›åº¦æ¡
            document.getElementById('quiz-progress').innerText = `å·²æŒæ¡: ${masteredIds.size} / æ€»æ•°: ${masterPool.length}`;

            // 1. ä¼˜å…ˆæ£€æŸ¥é”™é¢˜é‡ç°é˜Ÿåˆ—
            if (queue.length > 0 && queue[0].wait <= 0) {
                currentQuestion = queue.shift().data;
            }
            // 2. å¦‚æœé‡ç°é˜Ÿåˆ—è¿˜æ²¡åˆ°æ—¶å€™ï¼Œæˆ–è€…ä¸ºç©ºï¼Œåˆ™ä»å‰©ä½™æ± å­æŠ½é¢˜
            else {
                if (remainingPool.length > 0) {
                    // é€»è¾‘ï¼šåŸºäºé‡è¦ç¨‹åº¦ l è¿›è¡ŒåŠ æƒéšæœºæŠ½æ ·
                    let weightedPool = [];
                    remainingPool.forEach(q => {
                        for (let i = 0; i < (q.l || 1); i++) weightedPool.push(q);
                    });
                    const idx = Math.floor(Math.random() * weightedPool.length);
                    currentQuestion = weightedPool[idx];
                } else {
                    // å¦‚æœåªå‰©ä¸‹é‡ç°é˜Ÿåˆ—é‡Œçš„é¢˜äº†ï¼Œå¼ºåˆ¶å–å‡º
                    currentQuestion = queue.shift().data;
                }

                // é˜Ÿåˆ—ä¸­å…¶ä»–é¢˜ç›®çš„ç­‰å¾…å€¼å‡ä¸€
                queue.forEach(item => item.wait--);
            }

            renderQuestion();
        }

        function renderQuestion() {
            document.getElementById('question-display').innerText = currentQuestion.q;
            const showA = document.getElementById('show-a').checked;
            document.getElementById('answer-hint').innerText = showA ? `éœ€å›ç­”ç‚¹æ•°ï¼š${currentQuestion.a}` : '';
        }

        function handleResult(isKnown) {
            const id = currentQuestion.id;

            // æ›´æ–°æŒä¹…åŒ–ç»Ÿè®¡
            if (!historyData[id]) historyData[id] = { count: 0, logs: [] };
            historyData[id].count++;
            historyData[id].logs.push(isKnown ? 1 : 0);
            if (historyData[id].logs.length > 5) historyData[id].logs.shift();
            localStorage.setItem('study_stats_v2', JSON.stringify(historyData));

            if (isKnown) {
                // æ ‡è®°ä¸ºå·²æŒæ¡ï¼Œæœ¬è½®ä¸å†å‡ºç°ï¼ˆé™¤éåœ¨é”™é¢˜é˜Ÿåˆ—ä¸­è¿˜æ²¡æ¸…ç©ºï¼‰
                masteredIds.add(id);
                // å¦‚æœè¯¥é¢˜åœ¨é”™é¢˜é˜Ÿåˆ—ä¸­ï¼Œç§»é™¤å®ƒ
                queue = queue.filter(item => item.data.id !== id);
            } else {
                // å¦‚æœç‚¹â€œä¸ä¼šâ€ï¼Œæ”¾å…¥é‡ç°é˜Ÿåˆ—ï¼Œ4é¢˜å·¦å³åé‡ç°
                // å³ä¾¿ä¹‹å‰ç­”è¿‡â€œä¼šâ€ï¼Œåªè¦ç‚¹äº†ä¸€æ¬¡â€œä¸ä¼šâ€ï¼Œå®ƒå°±ä¼šé‡æ–°è¿›å…¥å¾ªç¯
                masteredIds.delete(id);
                const waitTime = 3 + Math.floor(Math.random() * 2);
                queue.push({ data: currentQuestion, wait: waitTime });
            }

            nextQuestion();
        }

        function toggleStats() {
            const container = document.getElementById('stats-container');
            let html = `<h3>å†å²è®°å½•</h3><table class="stats-table">
                        <tr><th>é¢˜ç›®</th><th>æŠ½å–</th><th>è¿‘å†µ</th></tr>`;

            const sortedIds = Object.keys(historyData).reverse();
            if (sortedIds.length === 0) html += '<tr><td colspan="3">æš‚æ— è®°å½•</td></tr>';

            sortedIds.forEach(id => {
                const item = historyData[id];
                const qText = findQuestionTextById(id);
                const logHtml = item.logs.map(l =>
                    `<span class="${l == 1 ? 'tag-yes' : 'tag-no'}">${l == 1 ? 'â—' : 'â—‹'}</span>`
                ).join('');
                html += `<tr><td>${qText}</td><td>${item.count}</td><td>${logHtml}</td></tr>`;
            });
            html += '</table>';
            container.innerHTML = html;

            document.getElementById('config-ui').classList.add('hidden');
            document.getElementById('stats-ui').classList.remove('hidden');
            document.getElementById('main-title').innerText = "ç»Ÿè®¡æ•°æ®";
        }

        function findQuestionTextById(id) {
            try {
                const p = id.split('-');
                const chap = db.chaps.find(c => c.chap == p[1]);
                const sec = chap.sections.find(s => s.sec == p[2]);
                return sec.qs[p[3]].q;
            } catch (e) { return "æœªçŸ¥é¢˜ç›®"; }
        }

        function exitQuiz() {
            if (confirm("ç¡®å®šç»“æŸæœ¬è½®å—ï¼Ÿæœ¬è½®æŒæ¡è¿›åº¦å°†æ¸…ç©ºã€‚")) location.reload();
        }
    </script>
</body>

</html>
<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chat Analyzer 聊天记录高频词&词云 | 夸克博客</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="css/nav.css">
    <script src="/js/nav.js"></script>
    <style>
        /* 全局样式 */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Microsoft YaHei', sans-serif;
            background: linear-gradient(135deg, #f5f7fa 0%, #e4e8f0 100%);
            color: #333;
            line-height: 1.6;
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        /* 毛玻璃卡片效果 */
        .glass-card {
            background: rgba(255, 255, 255, 0.85);
            backdrop-filter: blur(15px);
            -webkit-backdrop-filter: blur(15px);
            border-radius: 20px;
            border: 1px solid rgba(255, 255, 255, 0.3);
            box-shadow: 0 15px 35px rgba(0, 0, 0, 0.05),
                0 5px 15px rgba(0, 0, 0, 0.03),
                inset 0 1px 0 rgba(255, 255, 255, 0.6);
            padding: 30px;
            margin-bottom: 30px;
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }

        .glass-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.08),
                0 8px 20px rgba(0, 0, 0, 0.05),
                inset 0 1px 0 rgba(255, 255, 255, 0.6);
        }

        /* 标题样式 */
        .page-title {
            text-align: center;
            margin-bottom: 40px;
            color: #1a1a1a;
        }

        .page-title h1 {
            font-size: 2.5rem;
            font-weight: 700;
            margin-bottom: 10px;
            background: linear-gradient(90deg, #333, #666);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .page-title p {
            font-size: 1.1rem;
            color: #666;
            max-width: 800px;
            margin: 0 auto;
        }

        /* 安全提示 */
        .security-banner {
            background: rgba(255, 255, 255, 0.9);
            border-left: 4px solid #4CAF50;
            padding: 15px 20px;
            margin-bottom: 30px;
            border-radius: 8px;
            display: flex;
            align-items: flex-start;
            gap: 12px;
        }

        .security-icon {
            color: #4CAF50;
            font-size: 1.2rem;
            margin-top: 2px;
        }

        .security-content h3 {
            color: #2c3e50;
            margin-bottom: 5px;
            font-size: 1.1rem;
        }

        .security-content p {
            color: #555;
            font-size: 0.95rem;
        }

        /* 配置区域 */
        .config-section {
            margin-bottom: 30px;
        }

        .section-title {
            font-size: 1.4rem;
            color: #333;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 2px solid rgba(0, 0, 0, 0.08);
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .section-title i {
            color: #555;
        }

        .config-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
        }

        .config-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .config-group label {
            font-weight: 600;
            color: #444;
            font-size: 0.95rem;
        }

        .config-group input,
        .config-group select {
            padding: 12px 15px;
            border: 1px solid rgba(0, 0, 0, 0.1);
            border-radius: 10px;
            font-size: 1rem;
            background: rgba(255, 255, 255, 0.9);
            transition: all 0.3s ease;
        }

        .config-group input:focus,
        .config-group select:focus {
            outline: none;
            border-color: rgba(0, 0, 0, 0.3);
            box-shadow: 0 0 0 3px rgba(0, 0, 0, 0.05);
        }

        .checkbox-group {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-top: 10px;
        }

        .checkbox-group input[type="checkbox"] {
            width: 18px;
            height: 18px;
        }

        /* 文件上传区域 */
        .upload-area {
            border: 2px dashed rgba(0, 0, 0, 0.1);
            border-radius: 15px;
            padding: 40px 20px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-bottom: 20px;
            background: rgba(255, 255, 255, 0.7);
        }

        .upload-area:hover {
            border-color: rgba(0, 0, 0, 0.2);
            background: rgba(255, 255, 255, 0.9);
        }

        .upload-area.drag-over {
            border-color: #555;
            background: rgba(255, 255, 255, 0.95);
        }

        .upload-icon {
            font-size: 3rem;
            color: #666;
            margin-bottom: 15px;
        }

        .upload-text {
            color: #555;
            margin-bottom: 10px;
        }

        .upload-hint {
            color: #888;
            font-size: 0.9rem;
        }

        #fileInput {
            display: none;
        }

        /* 按钮样式 */
        .btn {
            padding: 14px 28px;
            border: none;
            border-radius: 12px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }

        .btn-primary {
            background: linear-gradient(135deg, #333 0%, #555 100%);
            color: white;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        }

        .btn-primary:hover {
            background: linear-gradient(135deg, #222 0%, #444 100%);
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.15);
            transform: translateY(-2px);
        }

        .btn-primary:disabled {
            background: linear-gradient(135deg, #999 0%, #bbb 100%);
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .btn-secondary {
            background: rgba(0, 0, 0, 0.05);
            color: #333;
            border: 1px solid rgba(0, 0, 0, 0.1);
        }

        .btn-secondary:hover {
            background: rgba(0, 0, 0, 0.1);
        }

        .action-buttons {
            display: flex;
            gap: 15px;
            justify-content: center;
            margin-top: 20px;
        }

        /* 结果展示区域 */
        .results-section {
            display: none;
        }

        .results-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
            flex-wrap: wrap;
            gap: 15px;
        }

        .stats-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            padding: 20px;
            text-align: center;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.03);
            border: 1px solid rgba(0, 0, 0, 0.05);
        }

        .stat-value {
            font-size: 2.2rem;
            font-weight: 700;
            color: #333;
            margin: 10px 0;
        }

        .stat-label {
            color: #666;
            font-size: 0.9rem;
        }

        /* 词云容器 */
        .wordcloud-container {
            margin: 30px 0;
            text-align: center;
        }

        #wordcloudCanvas {
            max-width: 100%;
            height: auto;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.05);
            background: white;
            padding: 20px;
        }

        /* 高频词列表 */
        .word-list-container {
            margin-top: 30px;
        }

        .word-list {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 15px;
            max-height: 400px;
            overflow-y: auto;
            padding: 15px;
            background: rgba(255, 255, 255, 0.7);
            border-radius: 12px;
        }

        .word-item {
            display: flex;
            justify-content: space-between;
            padding: 12px 15px;
            background: white;
            border-radius: 8px;
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.03);
            border: 1px solid rgba(0, 0, 0, 0.05);
        }

        .word-text {
            font-weight: 600;
            color: #333;
        }

        .word-count {
            color: #666;
            font-weight: 500;
        }

        /* 文件下载区域 */
        .download-section {
            margin-top: 40px;
            padding-top: 30px;
            border-top: 1px solid rgba(0, 0, 0, 0.08);
        }

        .download-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .download-card {
            background: rgba(255, 255, 255, 0.9);
            border-radius: 12px;
            padding: 20px;
            text-align: center;
            transition: transform 0.3s ease;
            border: 1px solid rgba(0, 0, 0, 0.08);
        }

        .download-card:hover {
            transform: translateY(-5px);
        }

        .download-icon {
            font-size: 2.5rem;
            color: #555;
            margin-bottom: 15px;
        }

        .download-btn {
            margin-top: 15px;
            width: 100%;
        }

        /* 进度条 */
        .progress-container {
            margin: 30px 0;
            display: none;
        }

        .progress-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
        }

        .progress-bar {
            height: 8px;
            background: rgba(0, 0, 0, 0.08);
            border-radius: 4px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #333, #555);
            border-radius: 4px;
            width: 0%;
            transition: width 0.3s ease;
        }

        /* 响应式设计 */
        @media (max-width: 768px) {
            .container {
                padding: 15px;
            }

            .glass-card {
                padding: 20px;
            }

            .page-title h1 {
                font-size: 2rem;
            }

            .config-grid {
                grid-template-columns: 1fr;
            }

            .action-buttons {
                flex-direction: column;
            }

            .stats-cards {
                grid-template-columns: 1fr;
            }

            .word-list {
                grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            }
        }

        /* 加载动画 */
        .loader {
            display: none;
            text-align: center;
            padding: 40px;
        }

        .spinner {
            width: 50px;
            height: 50px;
            border: 4px solid rgba(0, 0, 0, 0.1);
            border-left-color: #333;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }

        /* 页脚 */
        .footer {
            text-align: center;
            margin-top: 50px;
            padding-top: 30px;
            border-top: 1px solid rgba(0, 0, 0, 0.08);
            color: #666;
            font-size: 0.9rem;
        }

        .code-link {
            color: #555;
            text-decoration: none;
            font-weight: 600;
            border-bottom: 1px dashed #888;
        }

        .code-link:hover {
            color: #333;
            border-bottom-style: solid;
        }
    </style>
</head>

<body>
    <div class="container">
        <!-- 主标题 -->
        <div class="page-title">
            <h1>Chat Analyzer </h1>
            <p>聊天记录高频词&词云生成 · 数据安全 · 支持词云生成与结果导出</p>
        </div>

        <!-- 安全提示 -->
        <div class="glass-card security-banner">
            <div class="security-icon">
                <i class="fas fa-shield-alt"></i>
            </div>
            <div class="security-content">
                <h3>100% 隐私保护</h3>
                <p>
                    <strong>本工具完全在您的浏览器中运行</strong>，所有数据处理都在本地进行，不会上传到任何服务器。
                    您可以右键查看网页源代码验证，或断开网络连接后使用。您的聊天记录数据绝对安全。
                </p>
            </div>
        </div>

        <!-- 配置区域 -->
        <div class="glass-card config-section">
            <div class="section-title">
                <i class="fas fa-sliders-h"></i>
                <span>分析配置</span>
            </div>

            <div class="config-grid">
                <div class="config-group">
                    <label for="minFrequency">最小出现次数阈值</label>
                    <input type="number" id="minFrequency" min="1" max="1000" value="20">
                    <span style="color: #888; font-size: 0.9rem;">仅统计出现次数超过此值的词汇</span>
                </div>

                <div class="config-group">
                    <label for="maxWords">词云最大词汇数</label>
                    <input type="number" id="maxWords" min="10" max="500" value="200">
                    <span style="color: #888; font-size: 0.9rem;">控制词云中显示的词汇数量</span>
                </div>

                <div class="config-group">
                    <label for="wordcloudColor">词云配色方案</label>
                    <select id="wordcloudColor">
                        <option value="colorful">多彩渐变</option>
                        <option value="rainbow">彩虹色</option>
                        <option value="pastel">柔和色调</option>
                        <option value="vibrant">鲜艳色调</option>
                    </select>
                </div>
            </div>

            <div class="checkbox-group">
                <input type="checkbox" id="punctuationStats" checked>
                <label for="punctuationStats">统计纯标点消息（整行都是句号或问号）</label>
            </div>
        </div>

        <!-- 文件上传区域 -->
        <div class="glass-card">
            <div class="section-title">
                <i class="fas fa-file-upload"></i>
                <span>上传聊天记录文件</span>
            </div>

            <div class="upload-area" id="uploadArea">
                <div class="upload-icon">
                    <i class="fas fa-cloud-upload-alt"></i>
                </div>
                <div class="upload-text">
                    <strong>点击或拖拽文件到此处</strong>
                </div>
                <div class="upload-hint">
                    支持.txt格式，UTF-8编码，建议文件大小不超过10MB
                </div>
                <input type="file" id="fileInput" accept=".txt">
            </div>

            <div id="fileInfo"
                style="display: none; margin-top: 15px; padding: 15px; background: rgba(0,0,0,0.03); border-radius: 10px;">
                <div style="display: flex; align-items: center; gap: 10px;">
                    <i class="fas fa-file-alt" style="color: #555;"></i>
                    <div>
                        <strong id="fileName"></strong>
                        <div id="fileSize" style="color: #666; font-size: 0.9rem;"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- 进度条 -->
        <div class="progress-container" id="progressContainer">
            <div class="progress-header">
                <span>分析进度</span>
                <span id="progressText">0%</span>
            </div>
            <div class="progress-bar">
                <div class="progress-fill" id="progressFill"></div>
            </div>
        </div>

        <!-- 加载动画 -->
        <div class="loader" id="loader">
            <div class="spinner"></div>
            <p>正在分析聊天记录，请稍候...</p>
            <p id="loaderDetail" style="color: #666; font-size: 0.9rem; margin-top: 10px;"></p>
        </div>

        <!-- 操作按钮 -->
        <div class="action-buttons">
            <button class="btn btn-primary" id="analyzeBtn" disabled>
                <i class="fas fa-chart-bar"></i>
                开始分析
            </button>
            <button class="btn btn-secondary" id="resetBtn">
                <i class="fas fa-redo"></i>
                重置
            </button>
        </div>

        <!-- 结果展示区域 -->
        <div class="results-section" id="resultsSection">
            <div class="glass-card">
                <div class="results-header">
                    <div>
                        <h2 style="color: #333; margin-bottom: 5px;">分析结果</h2>
                        <p style="color: #666;" id="resultsSummary"></p>
                    </div>
                    <div style="color: #666; font-size: 0.9rem;">
                        <i class="far fa-clock"></i>
                        分析完成时间: <span id="analysisTime"></span>
                    </div>
                </div>

                <!-- 统计卡片 -->
                <div class="stats-cards">
                    <div class="stat-card">
                        <div class="stat-label">高频词数量</div>
                        <div class="stat-value" id="statWordCount">0</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">纯句号消息</div>
                        <div class="stat-value" id="statPeriodCount">0</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">纯问号消息</div>
                        <div class="stat-value" id="statQuestionCount">0</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">总行数</div>
                        <div class="stat-value" id="statTotalLines">0</div>
                    </div>
                </div>

                <!-- 词云展示 -->
                <div class="wordcloud-container">
                    <h3 style="color: #333; margin-bottom: 20px; text-align: center;">
                        <i class="fas fa-cloud" style="margin-right: 10px;"></i>词云图
                    </h3>
                    <canvas id="wordcloudCanvas" width="1000" height="600"></canvas>
                </div>

                <!-- 高频词列表 -->
                <div class="word-list-container">
                    <h3 style="color: #333; margin-bottom: 20px;">
                        <i class="fas fa-list-ol" style="margin-right: 10px;"></i>高频词 Top 50
                    </h3>
                    <div class="word-list" id="wordList"></div>
                </div>
            </div>

            <!-- 文件下载区域 -->
            <div class="download-section">
                <h3 style="color: #333; margin-bottom: 20px; text-align: center;">
                    <i class="fas fa-download" style="margin-right: 10px;"></i>下载分析结果
                </h3>

                <div class="download-grid">
                    <div class="download-card">
                        <div class="download-icon">
                            <i class="fas fa-file-alt"></i>
                        </div>
                        <h4>详细分析结果</h4>
                        <p style="color: #666; font-size: 0.9rem; margin-top: 5px;">
                            包含高频词完整列表和统计信息
                        </p>
                        <button class="btn btn-secondary download-btn" id="downloadDetailed">
                            <i class="fas fa-download"></i> 下载 (.txt)
                        </button>
                    </div>

                    <div class="download-card">
                        <div class="download-icon">
                            <i class="fas fa-list"></i>
                        </div>
                        <h4>高频词汇表</h4>
                        <p style="color: #666; font-size: 0.9rem; margin-top: 5px;">
                            纯词汇列表，每行一个词
                        </p>
                        <button class="btn btn-secondary download-btn" id="downloadVocab">
                            <i class="fas fa-download"></i> 下载 (.txt)
                        </button>
                    </div>

                    <div class="download-card">
                        <div class="download-icon">
                            <i class="fas fa-chart-pie"></i>
                        </div>
                        <h4>分析摘要</h4>
                        <p style="color: #666; font-size: 0.9rem; margin-top: 5px;">
                            包含统计摘要和配置信息
                        </p>
                        <button class="btn btn-secondary download-btn" id="downloadSummary">
                            <i class="fas fa-download"></i> 下载 (.txt)
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- 页脚 -->
        <div class="footer">
            <p>
                本工具使用纯前端技术实现，基于
                <a href="https://github.com/timdream/wordcloud2.js" target="_blank" class="code-link">wordcloud2.js</a>
                和原生JavaScript。
            </p>
            <p style="margin-top: 10px;">
                完全在浏览器中运行，确保数据隐私安全。
                <a href="#" onclick="showSourceCode(); return false;" class="code-link">查看源码验证</a>
            </p>
        </div>
    </div>

    <!-- 引入wordcloud2.js库 -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/wordcloud2.js/1.1.0/wordcloud2.min.js"></script>

    <script>
        // 全局变量
        let chatData = '';
        let wordFrequencies = {};
        let specialCounts = { period: 0, question: 0 };
        let analysisResults = {};
        let stopwords = new Set();

        // 初始化排除词列表（与Python版本一致的核心排除词）
        function initStopwords() {
            const defaultStopwords = [
                // 中文常用单字
                '的', '了', '和', '是', '就', '都', '而', '及', '与', '或',
                '在', '中', '我', '你', '他', '她', '它', '们',
                '这', '那', '哪', '谁', '什么', '怎么', '为什么',
                '啊', '哦', '嗯', '哈', '啦', '呀', '吧', '吗', '呢',
                '不', '没', '有', '也', '又', '再',
                '上', '下', '左', '右', '前', '后', '里', '外',
                '一', '二', '三', '四', '五', '六', '七', '八', '九', '十',
                '很', '最', '太', '更', '非常', '特别',

                // 常见无意义词
                '这个', '那个', '一个', '一些', '一种', '一样',
                '时候', '时间', '开始', '然后', '最后',
                '可以', '可能', '可是', '但是', '虽然', '如果',
                '因为', '所以', '而且', '那么',
                '这样', '那样', '怎么', '什么', '为什么',
                '有点', '有些', '有点', '有些',
                '自己', '别人', '大家', '有人',
                '知道', '觉得', '认为', '以为',
                '看到', '听见', '听到', '想到',
                '今天', '明天', '昨天', '现在', '以前', '以后',
                '还有', '还有', '还是', '还有',
                '这里', '那里', '哪里', '这边', '那边',
                '的话', '的说', '的是', '了了',
            ];

            defaultStopwords.forEach(word => stopwords.add(word));
        }

        // 显示源码验证
        function showSourceCode() {
            alert('您可以右键点击页面，选择"查看页面源代码"来验证本工具的实现。\n\n所有代码都在这个HTML文件中，没有外部API调用，确保您的数据安全。');
        }

        // 文件上传处理
        document.addEventListener('DOMContentLoaded', function () {
            initStopwords();

            const uploadArea = document.getElementById('uploadArea');
            const fileInput = document.getElementById('fileInput');
            const fileInfo = document.getElementById('fileInfo');
            const fileName = document.getElementById('fileName');
            const fileSize = document.getElementById('fileSize');
            const analyzeBtn = document.getElementById('analyzeBtn');

            // 点击上传区域触发文件选择
            uploadArea.addEventListener('click', () => fileInput.click());

            // 拖放功能
            uploadArea.addEventListener('dragover', (e) => {
                e.preventDefault();
                uploadArea.classList.add('drag-over');
            });

            uploadArea.addEventListener('dragleave', () => {
                uploadArea.classList.remove('drag-over');
            });

            uploadArea.addEventListener('drop', (e) => {
                e.preventDefault();
                uploadArea.classList.remove('drag-over');

                if (e.dataTransfer.files.length) {
                    fileInput.files = e.dataTransfer.files;
                    handleFileSelect();
                }
            });

            // 文件选择变化
            fileInput.addEventListener('change', handleFileSelect);

            function handleFileSelect() {
                if (fileInput.files.length === 0) return;

                const file = fileInput.files[0];

                // 验证文件类型
                if (!file.name.toLowerCase().endsWith('.txt')) {
                    alert('请选择.txt格式的文本文件');
                    fileInput.value = '';
                    return;
                }

                // 显示文件信息
                fileName.textContent = file.name;
                fileSize.textContent = formatFileSize(file.size);
                fileInfo.style.display = 'block';

                // 启用分析按钮
                analyzeBtn.disabled = false;

                // 读取文件内容
                const reader = new FileReader();
                reader.onload = function (e) {
                    chatData = e.target.result;
                };
                reader.readAsText(file, 'UTF-8');
            }

            // 开始分析按钮
            analyzeBtn.addEventListener('click', startAnalysis);

            // 重置按钮
            document.getElementById('resetBtn').addEventListener('click', resetAnalysis);

            // 下载按钮
            document.getElementById('downloadDetailed').addEventListener('click', () => downloadFile('detailed'));
            document.getElementById('downloadVocab').addEventListener('click', () => downloadFile('vocab'));
            document.getElementById('downloadSummary').addEventListener('click', () => downloadFile('summary'));
        });

        // 格式化文件大小
        function formatFileSize(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }

        // 开始分析
        function startAnalysis() {
            if (!chatData) {
                alert('请先上传聊天记录文件');
                return;
            }

            // 获取配置
            const minFrequency = parseInt(document.getElementById('minFrequency').value) || 20;
            const enablePunctuationStats = document.getElementById('punctuationStats').checked;

            // 显示进度条和加载动画
            document.getElementById('progressContainer').style.display = 'block';
            document.getElementById('loader').style.display = 'block';
            document.getElementById('analyzeBtn').disabled = true;

            // 重置结果区域
            document.getElementById('resultsSection').style.display = 'none';

            // 分析过程（模拟进度）
            simulateProgress();

            // 实际分析（使用setTimeout避免阻塞UI）
            setTimeout(() => {
                performAnalysis(minFrequency, enablePunctuationStats);
            }, 100);
        }

        // 模拟进度显示
        function simulateProgress() {
            let progress = 0;
            const progressFill = document.getElementById('progressFill');
            const progressText = document.getElementById('progressText');
            const loaderDetail = document.getElementById('loaderDetail');

            const interval = setInterval(() => {
                progress += Math.random() * 15;
                if (progress > 95) progress = 95;

                progressFill.style.width = `${progress}%`;
                progressText.textContent = `${Math.round(progress)}%`;

                // 更新加载详情
                if (progress < 30) {
                    loaderDetail.textContent = '正在读取文件内容...';
                } else if (progress < 60) {
                    loaderDetail.textContent = '正在进行分词处理...';
                } else {
                    loaderDetail.textContent = '正在统计词频和生成词云...';
                }

                if (progress >= 100) {
                    clearInterval(interval);
                }
            }, 200);

            return interval;
        }

        // 执行分析
        function performAnalysis(minFrequency, enablePunctuationStats) {
            // 重置数据
            wordFrequencies = {};
            specialCounts = { period: 0, question: 0 };

            const lines = chatData.split('\n');
            let totalLines = lines.length;
            let processedLines = 0;

            // 中文分词简单实现（模拟jieba功能）
            function simpleChineseSegment(text) {
                // 移除URL
                text = text.replace(/https?:\/\/\S+/g, '');
                // 移除邮箱
                text = text.replace(/\S+@\S+/g, '');
                // 保留中文、英文、数字和基本标点
                text = text.replace(/[^\w\u4e00-\u9fff\s\.\,\!\?，。！？]/g, '');
                // 合并多个空格
                text = text.replace(/\s+/g, ' ').trim();

                if (!text) return [];

                // 简单的分词逻辑（实际应用中应该使用更复杂的分词算法）
                let words = [];
                let currentWord = '';

                for (let char of text) {
                    // 如果是中文或数字，添加到当前词
                    if (/[\u4e00-\u9fff0-9]/.test(char)) {
                        currentWord += char;
                    }
                    // 如果是英文，添加到当前词
                    else if (/[a-zA-Z]/.test(char)) {
                        currentWord += char;
                    }
                    // 如果是分隔符，结束当前词
                    else if (currentWord) {
                        words.push(currentWord);
                        currentWord = '';
                    }
                }

                // 添加最后一个词
                if (currentWord) {
                    words.push(currentWord);
                }

                return words;
            }

            // 处理每一行
            for (let line of lines) {
                processedLines++;

                // 更新进度（每处理100行更新一次）
                if (processedLines % 100 === 0) {
                    const progress = Math.min(95, (processedLines / totalLines) * 90);
                    document.getElementById('progressFill').style.width = `${progress}%`;
                    document.getElementById('progressText').textContent = `${Math.round(progress)}%`;
                }

                const trimmedLine = line.trim();

                // 检查纯标点消息（如果开启）
                if (enablePunctuationStats) {
                    // 检查是否整行都是句号
                    if (/^[。]+$/.test(trimmedLine)) {
                        specialCounts.period++;
                        continue;
                    }

                    // 检查是否整行都是问号
                    if (/^[？]+$/.test(trimmedLine)) {
                        specialCounts.question++;
                        continue;
                    }
                }

                // 分词和统计
                const words = simpleChineseSegment(trimmedLine);

                for (let word of words) {
                    if (word) {
                        wordFrequencies[word] = (wordFrequencies[word] || 0) + 1;
                    }
                }
            }

            // 过滤和排序
            const filteredWords = {};
            let totalWords = 0;

            for (let [word, freq] of Object.entries(wordFrequencies)) {
                if (freq >= minFrequency && !stopwords.has(word)) {
                    filteredWords[word] = freq;
                    totalWords++;
                }
            }

            // 转换为数组并排序
            const sortedWords = Object.entries(filteredWords)
                .sort((a, b) => b[1] - a[1]);

            // 添加特殊标点到结果（如果达到阈值）
            const finalResults = [...sortedWords];

            if (enablePunctuationStats) {
                if (specialCounts.period >= minFrequency) {
                    finalResults.push(['[整行都是句号]', specialCounts.period]);
                }
                if (specialCounts.question >= minFrequency) {
                    finalResults.push(['[整行都是问号]', specialCounts.question]);
                }

                // 重新排序
                finalResults.sort((a, b) => b[1] - a[1]);
            }

            // 保存分析结果
            analysisResults = {
                words: finalResults,
                specialCounts,
                totalLines,
                filteredCount: finalResults.length,
                minFrequency,
                enablePunctuationStats,
                timestamp: new Date().toLocaleString('zh-CN')
            };

            // 完成进度
            document.getElementById('progressFill').style.width = '100%';
            document.getElementById('progressText').textContent = '100%';

            // 显示结果
            setTimeout(displayResults, 500);
        }

        // 显示分析结果
        function displayResults() {
            // 隐藏进度和加载动画
            document.getElementById('progressContainer').style.display = 'none';
            document.getElementById('loader').style.display = 'none';

            // 更新统计信息
            document.getElementById('statWordCount').textContent = analysisResults.filteredCount;
            document.getElementById('statPeriodCount').textContent = analysisResults.specialCounts.period;
            document.getElementById('statQuestionCount').textContent = analysisResults.specialCounts.question;
            document.getElementById('statTotalLines').textContent = analysisResults.totalLines;

            // 更新摘要
            document.getElementById('resultsSummary').textContent =
                `共分析 ${analysisResults.totalLines} 行，发现 ${analysisResults.filteredCount} 个高频词（出现次数 ≥ ${analysisResults.minFrequency}）`;

            document.getElementById('analysisTime').textContent = analysisResults.timestamp;

            // 显示高频词列表
            const wordListContainer = document.getElementById('wordList');
            wordListContainer.innerHTML = '';

            const topWords = analysisResults.words.slice(0, 50);
            for (let [word, freq] of topWords) {
                const wordItem = document.createElement('div');
                wordItem.className = 'word-item';
                wordItem.innerHTML = `
                    <span class="word-text">${word}</span>
                    <span class="word-count">${freq}</span>
                `;
                wordListContainer.appendChild(wordItem);
            }

            // 生成词云
            generateWordCloud();

            // 显示结果区域
            document.getElementById('resultsSection').style.display = 'block';

            // 滚动到结果区域
            document.getElementById('resultsSection').scrollIntoView({ behavior: 'smooth' });

            // 重新启用分析按钮
            document.getElementById('analyzeBtn').disabled = false;
        }

        // 生成词云
        function generateWordCloud() {
            const canvas = document.getElementById('wordcloudCanvas');
            const ctx = canvas.getContext('2d');

            // 清空画布
            ctx.clearRect(0, 0, canvas.width, canvas.height);

            // 准备词云数据
            const wordcloudData = [];
            const maxWords = parseInt(document.getElementById('maxWords').value) || 200;
            const colorScheme = document.getElementById('wordcloudColor').value;

            // 过滤掉特殊标记
            const wordsForCloud = analysisResults.words
                .filter(item => !item[0].startsWith('[整行都是'))
                .slice(0, maxWords);

            // 计算最大和最小频率
            const maxFreq = wordsForCloud.length > 0 ? wordsForCloud[0][1] : 1;
            const minFreq = wordsForCloud.length > 0 ? wordsForCloud[wordsForCloud.length - 1][1] : 1;

            // 准备数据
            for (let [word, freq] of wordsForCloud) {
                // 计算权重（相对大小）
                const weight = 0.3 + 0.7 * (freq - minFreq) / (maxFreq - minFreq || 1);

                wordcloudData.push([word, Math.max(10, weight * 100)]);
            }

            if (wordcloudData.length === 0) {
                // 如果没有数据，显示提示
                ctx.fillStyle = '#333';
                ctx.font = '24px sans-serif';
                ctx.textAlign = 'center';
                ctx.fillText('没有足够的高频词生成词云', canvas.width / 2, canvas.height / 2);
                return;
            }

            // 根据配色方案设置颜色
            // 根据配色方案设置颜色
            let colorFunction;
            switch (colorScheme) {
                case 'rainbow':
                    colorFunction = () => {
                        const colors = ['#FF6B6B', '#4ECDC4', '#45B7D1', '#96CEB4', '#FFEAA7', '#DDA0DD', '#98D8C8'];
                        return colors[Math.floor(Math.random() * colors.length)];
                    };
                    break;
                case 'pastel':
                    colorFunction = () => {
                        const colors = ['#FFB6C1', '#87CEEB', '#98FB98', '#DDA0DD', '#FFD700', '#F0E68C'];
                        return colors[Math.floor(Math.random() * colors.length)];
                    };
                    break;
                case 'vibrant':
                    colorFunction = () => {
                        const colors = ['#FF0000', '#00FF00', '#0000FF', '#FF00FF', '#FFFF00', '#00FFFF'];
                        return colors[Math.floor(Math.random() * colors.length)];
                    };
                    break;
                case 'colorful':
                default:
                    colorFunction = () => {
                        const hue = Math.floor(Math.random() * 360);
                        return `hsl(${hue}, 70%, 60%)`;
                    };
            }

            // 使用wordcloud2生成词云
            WordCloud(canvas, {
                list: wordcloudData,
                gridSize: Math.round(16 * canvas.width / 1024),
                weightFactor: 1,
                fontFamily: 'Microsoft YaHei, sans-serif',
                color: colorFunction,
                rotateRatio: 0.1,
                rotationSteps: 2,
                backgroundColor: 'white',
                shuffle: false,
                shape: 'circle',
                ellipticity: 0.9,
                drawOutOfBound: false,
                shrinkToFit: true,
                minSize: 8
            });
        }

        // 下载文件
        function downloadFile(type) {
            if (!analysisResults.words || analysisResults.words.length === 0) {
                alert('请先完成分析');
                return;
            }

            let content = '';
            let filename = '';
            const timestamp = new Date().toISOString().slice(0, 19).replace(/[:T]/g, '-');

            switch (type) {
                case 'detailed':
                    filename = `高频词分析结果_${timestamp}.txt`;
                    content = generateDetailedContent();
                    break;
                case 'vocab':
                    filename = `高频词汇表_${timestamp}.txt`;
                    content = generateVocabContent();
                    break;
                case 'summary':
                    filename = `分析摘要_${timestamp}.txt`;
                    content = generateSummaryContent();
                    break;
            }

            // 创建下载链接
            const blob = new Blob([content], { type: 'text/plain;charset=utf-8' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        // 生成详细内容
        function generateDetailedContent() {
            let content = `高频词分析结果 (出现次数 ≥ ${analysisResults.minFrequency})\n`;
            content += '='.repeat(50) + '\n\n';

            // 特殊标点统计
            if (analysisResults.enablePunctuationStats &&
                (analysisResults.specialCounts.period >= analysisResults.minFrequency ||
                    analysisResults.specialCounts.question >= analysisResults.minFrequency)) {
                content += "特殊标点统计 (整行都是该标点):\n";
                content += '-'.repeat(40) + '\n';

                if (analysisResults.specialCounts.period >= analysisResults.minFrequency) {
                    content += `[整行都是句号]: ${analysisResults.specialCounts.period.toString().padStart(6)}\n`;
                }

                if (analysisResults.specialCounts.question >= analysisResults.minFrequency) {
                    content += `[整行都是问号]: ${analysisResults.specialCounts.question.toString().padStart(6)}\n`;
                }

                content += '\n';
            }

            // 高频词汇
            content += "高频词汇:\n";
            content += '-'.repeat(40) + '\n';

            for (let [word, freq] of analysisResults.words) {
                if (!word.startsWith('[整行都是')) {
                    content += `${word.padEnd(15)} ${freq.toString().padStart(6)}\n`;
                }
            }

            return content;
        }

        // 生成词汇表内容
        function generateVocabContent() {
            let content = '';

            for (let [word, freq] of analysisResults.words) {
                if (!word.startsWith('[整行都是')) {
                    content += `${word}\n`;
                }
            }

            return content;
        }

        // 生成摘要内容
        function generateSummaryContent() {
            let content = "聊天记录高频词分析摘要\n";
            content += '='.repeat(50) + '\n\n';
            content += `分析时间: ${analysisResults.timestamp}\n`;
            content += `最小出现次数阈值: ${analysisResults.minFrequency}\n`;
            content += `纯标点统计: ${analysisResults.enablePunctuationStats ? '开启' : '关闭'}\n`;
            content += `发现的高频词数量: ${analysisResults.filteredCount}\n`;
            content += `使用的排除词数量: ${stopwords.size}\n\n`;

            // 特殊标点统计
            if (analysisResults.enablePunctuationStats) {
                content += "特殊标点统计:\n";
                content += '-'.repeat(30) + '\n';
                content += `整行都是句号: ${analysisResults.specialCounts.period}次\n`;
                content += `整行都是问号: ${analysisResults.specialCounts.question}次\n\n`;
            }

            // 词汇长度分布
            const lengthDist = {};
            for (let [word, freq] of analysisResults.words) {
                if (!word.startsWith('[整行都是')) {
                    const length = word.length;
                    lengthDist[length] = (lengthDist[length] || 0) + 1;
                }
            }

            content += "词汇长度分布:\n";
            const sortedLengths = Object.keys(lengthDist).sort((a, b) => a - b);
            for (let length of sortedLengths) {
                content += `  长度${length}: ${lengthDist[length]}个\n`;
            }

            return content;
        }

        // 重置分析
        function resetAnalysis() {
            chatData = '';
            wordFrequencies = {};
            specialCounts = { period: 0, question: 0 };
            analysisResults = {};

            // 重置UI
            document.getElementById('fileInput').value = '';
            document.getElementById('fileInfo').style.display = 'none';
            document.getElementById('resultsSection').style.display = 'none';
            document.getElementById('progressContainer').style.display = 'none';
            document.getElementById('loader').style.display = 'none';
            document.getElementById('analyzeBtn').disabled = true;

            // 清空词云
            const canvas = document.getElementById('wordcloudCanvas');
            const ctx = canvas.getContext('2d');
            ctx.clearRect(0, 0, canvas.width, canvas.height);

            // 清空词列表
            document.getElementById('wordList').innerHTML = '';

            alert('已重置所有数据，可以重新上传文件进行分析。');
        }
    </script>
</body>

</html>